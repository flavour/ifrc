/*
 2018-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires moment.js
 requires jQuery fullCalendar plugin
 requires qTip2
 requires jQuery UI datepicker
*/
(function(c,r){function q(){this.items={};this.slices=[]}var t=0;q.prototype.store=function(a,d,b){var e={};b.forEach(function(a){this.items[a.id]=e[a.id]=a},this);b=this.slices;a=[moment(a),moment(d),e];b.push(a);b.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<b.length){var k=[];a=b.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(k.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),c.extend({},
a[2],b[2])]});k.push(a);this.slices=k}};q.prototype.retrieve=function(a,d){a=moment(a);d=moment(d);for(var b=this.slices,e=b.length,c,g,f=[],h=0;h<e;h++)if(c=b[h],c[0].isSameOrBefore(a)&&c[1].isSameOrAfter(d)){b=c[2];for(g in b)if(e=b[g],c=moment(e.start),!c.isAfter(d)){if(e.end){if(moment(e.end).isBefore(a))continue}else if(c.isSameOrBefore(moment(a).subtract(1,"days")))continue;f.push(e)}return f}return null};q.prototype.updateItem=function(a,d){(a=this.items[a])&&d&&c.extend(a,d)};q.prototype.deleteItem=
function(a){this.slices.forEach(function(c){delete c[2][a]});delete this.items[a]};q.prototype.clear=function(){this.slices=[];this.items={}};c.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null,aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",defaultTimedEventDuration:"00:30:00",businessHours:!1,timeFormat:null,labelEdit:"Edit",labelDelete:"Delete",deleteConfirmation:"Do you want to delete this entry?",firstDay:1,refreshIconClass:"fa fa-refresh",
calendarIconClass:"fa fa-calendar"},_create:function(){this.id=t;t+=1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,d=a.resources,b=c(this.element),e=b.attr("id");this._unbindEvents();var k=!1,g=!1;d.forEach(function(a){a.insertable&&(k=!0);a.useTime||(g=!0)});if(a.useTime){var f="month,agendaWeek,agendaDay reload";var h="agendaWeek"}else f=
"month,basicWeek reload",h="month";var m=this,l=c("#"+e+"-date-picker");c(this.element).fullCalendar({aspectRatio:a.aspectRatio,nowIndicator:a.nowIndicator,slotDuration:a.slotDuration,snapDuration:a.snapDuration,displayEventEnd:!1,defaultTimedEventDuration:a.defaultTimedEventDuration,allDaySlot:g,firstDay:a.firstDay,timeFormat:a.timeFormat,slotLabelFormat:a.timeFormat,businessHours:a.businessHours,selectable:k,editable:!0,eventDrop:function(a,b,c){m._updateItem(a,c)},eventResize:function(a,b,c){m._updateItem(a,
c)},customButtons:{reload:{text:"Reload",click:function(){m.reload()}},calendar:{text:"Calendar",click:function(){l.datepicker("show")}}},header:{left:f,center:"title",right:"calendar today prev,next"},defaultView:h,eventRender:function(a,b){m._eventRender(a,b)},eventDestroy:function(a,b){m._eventDestroy(a,b)},select:function(a,b,c){m._selectDate(a,b,c)},unselect:function(){c(m.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",locale:a.locale,timezone:"local"});e=c("<i>").addClass(a.refreshIconClass);
f=c("<i>").addClass(a.calendarIconClass);this.reloadButton=c(".fc-reload-button").empty().append(e);e=c(".fc-calendar-button").empty().append(f);l.datepicker("option",{showOn:"focus",showButtonPanel:!0,firstDay:a.firstDay}).insertBefore(e).on("change",function(){var a=l.datepicker("getDate");a&&b.fullCalendar("gotoDate",a)});l.datepicker("widget").hide();a=c('<div class="inline-throbber">').css({visibility:"hidden"});c(".fc-header-toolbar .fc-left",this.element).append(a);this.throbber=a;this.resources=
[];d&&d.forEach(function(a,b){this._addResource(a,b)},this);this._bindEvents()},_addResource:function(a,d){var b=c.extend({},a,{_cache:new q});this.resources.push(b);a=b.timeout;a===r&&(a=this.options.timeout);var e=this;c(this.element).fullCalendar("addEventSource",{id:""+d,allDayDefault:!b.useTime,editable:!!b.editable,startEditable:!!b.startEditable,durationEditable:!!b.end&&!!b.durationEditable,events:function(a,c,d,h){e._fetchItems(b,a,c,d,h)}})},_eventRender:function(a,d){var b=this;c(d).qtip({content:{title:function(c,
d){return b._itemTitle(a,d)},text:function(c,d){return b._itemDisplay(a,d)},button:!0},position:{at:"center right",my:"left center",effect:!1,viewport:c(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}})},_eventDestroy:function(a,d){c(d).qtip("destroy",!0)},_itemTitle:function(a){var c=[a.start.format(a.allDay&&"L"||"L LT")];a.end&&(a=moment(a.end).endOf("minute"),c.push(a.format("LT")));
return c.join(" - ")},_itemDisplay:function(a,d){var b=c('<div class="s3-organizer-popup">'),e=this.options,k=e.resources[a.source.id];c("<h6>").html(a.popupTitle).appendTo(b);var g=k.columns,f=a.description;g&&f&&g.forEach(function(a){var d=a[0];a=a[1];f[d]!==r&&(a&&c("<label>").text(a).appendTo(b),c("<p>").html(f[d]).appendTo(b))});var h=c(this.element).attr("id");g=this.eventNamespace;var m=this,l=[],n=k.baseURL;if(n){if(k.editable&&!1!==a.editable){var p=document.createElement("a");p.href=n;p.pathname+=
"/"+a.id+"/update.popup";p.search=p.search?p.search+("&refresh="+h):"?refresh="+h;h=c('<a class="action-btn s3_modal">').text(e.labelEdit).attr("href",p.href);h.on("click"+g,function(){d.hide()});l.push(h)}k.deletable&&!1!==a.deletable&&(h=c('<a class="action-btn delete-btn-ajax">').text(e.labelDelete),h.on("click"+g,function(){confirm(e.deleteConfirmation)&&(d.hide(),m._deleteItem(a,function(){d.destroy()}));return!1}),l.push(h))}l.length&&c("<div>").append(l).appendTo(b);return b},_selectDate:function(a,
d,b){var e=this;c(this.element).qtip({content:{text:function(b,c){return e._selectResource(a,d,b,c)}},position:{target:"mouse",at:"center right",my:"left center",effect:!1,viewport:c(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});c(this.element).qtip("show",b)},_selectResource:function(a,d,b,e){e.set("style.classes","s3-organizer-create");b=this.options.resources;var k=this.eventNamespace,
g=c(this.element).attr("id"),f=c("<div>");b.forEach(function(b){if(b.insertable){var h=c('<a class="action-btn s3_modal">'),l=b.labelCreate,n=b.baseURL;if(n&&l){b=h.get(0);var p=[];b.href=n;b.pathname+="/create.popup";g&&p.push("refresh="+encodeURIComponent(g));n=a.toISOString()+"--"+moment(d).subtract(1,"seconds").toISOString();p.push("organizer="+encodeURIComponent(n));b.search=b.search?b.search+("&"+p.join("&")):"?"+p.join("&");h.text(l).appendTo(f).on("click"+k,function(){e.hide()})}}});return f},
_fetchItems:function(a,d,b,e,k){if(e=a._cache.retrieve(d,b))k(e);else{e=this.options;this._showThrobber();var g;a.filterForm?g=c("#"+a.filterForm):e.filterForm&&(g=c("#"+e.filterForm));var f=S3.search.getCurrentFilters(g).filter(function(b){b=b[0].split("__")[0];return b!==a.start&&b!==a.end});if(g=a.ajaxURL){g=S3.search.filterURL(g,f);f=encodeURIComponent(d.toISOString()+"--"+b.toISOString());g=-1!=g.indexOf("?")?g+("&$interval="+f):g+("?$interval="+f);f=a.timeout;var h=c.ajaxS3;f===r&&(f=e.timeout);
c.searchS3!==r&&(h=c.searchS3);if(e=a.openRequest)e.onreadystatechange=null,e.abort();var m=this;a.openRequest=h({timeout:f,url:g,dataType:"json",type:"GET",success:function(c){c=m._decodeServerData(a,c);m._hideThrobber();a._cache.store(d,b,c);k(c)},error:function(a,b,c){m._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},_decodeServerData:function(a,d){var b=d.c;d=d.r;var e=[],k=0,g=a.colors;b&&b.constructor===Array&&(k=b.length);d.forEach(function(d){var h=
{},f=d.d;if(k&&f&&f.constructor===Array){var l=f.length;if(l<=k)for(var n=0;n<l;n++)h[b[n]]=f[n]}(f=d.e)&&(f=a.useTime?moment(f).add(1,"seconds").toISOString():moment(f).add(1,"days").startOf("day").toISOString());l=d.t;h={id:d.id,title:c("<div>").html(l).text(),popupTitle:l,start:d.s,end:f,description:h};d.pe||(h.editable=!1);d.pd||(h.deletable=!1);g&&d.c&&(d=g[d.c],d!==r&&(h.color=d));e.push(h)});return e},_updateItem:function(a,c){var b=this.resources[a.source.id],d=this,k={id:a.id,s:a.start.toISOString()};
b.end&&(k.e=b.useTime?moment(a.end).subtract(1,"seconds").toISOString():moment(a.end).subtract(1,"days").endOf("day").toISOString());this._sendItems(b,{u:[k]},function(){b.reloadOnUpdate?d.reload():b._cache.updateItem(a.id,{start:a.start,end:a.end})},c)},_deleteItem:function(a,d){var b=this.resources[a.source.id],e={id:a.id},k=c(this.element);this._sendItems(b,{d:[e]},function(){k.fullCalendar("removeEvents",function(b){return b.source.id==a.source.id&&b.id==a.id});b._cache.deleteItem(a.id);"function"===
typeof d&&d()})},_sendItems:function(a,d,b,e){var k=c('input[name="_formkey"]',this.element).val();d=JSON.stringify(c.extend({k:k},d));this._showThrobber();var g=this;c.ajaxS3({type:"POST",url:a.ajaxURL,data:d,dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){"function"===typeof b&&b();g._hideThrobber()},error:function(){"function"===typeof e&&e();g._hideThrobber()}})},reload:function(){this.resources.forEach(function(a){a._cache.clear()});c(this.element).fullCalendar("refetchEvents")},
_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
