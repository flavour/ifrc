var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(p,t,r){p!=Array.prototype&&p!=Object.prototype&&(p[t]=r.value)};$jscomp.getGlobal=function(p){return"undefined"!=typeof window&&window===p?p:"undefined"!=typeof global&&null!=global?global:p};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(p){return $jscomp.SYMBOL_PREFIX+(p||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var p=$jscomp.global.Symbol.iterator;p||(p=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[p]&&$jscomp.defineProperty(Array.prototype,p,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(p){var t=0;return $jscomp.iteratorPrototype(function(){return t<p.length?{done:!1,value:p[t++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(p){$jscomp.initSymbolIterator();p={next:p};p[$jscomp.global.Symbol.iterator]=function(){return this};return p};$jscomp.iteratorFromArray=function(p,t){$jscomp.initSymbolIterator();p instanceof String&&(p+="");var r=0,w={next:function(){if(r<p.length){var B=r++;return{value:t(B,p[B]),done:!1}}w.next=function(){return{done:!0,value:void 0}};return w.next()}};w[Symbol.iterator]=function(){return w};return w};
$jscomp.polyfill=function(p,t,r,w){if(t){r=$jscomp.global;p=p.split(".");for(w=0;w<p.length-1;w++){var B=p[w];B in r||(r[B]={});r=r[B]}p=p[p.length-1];w=r[p];t=t(w);t!=w&&null!=t&&$jscomp.defineProperty(r,p,{configurable:!0,writable:!0,value:t})}};$jscomp.polyfill("Array.prototype.keys",function(p){return p?p:function(){return $jscomp.iteratorFromArray(this,function(p){return p})}},"es6-impl","es3");
$jscomp.findInternal=function(p,t,r){p instanceof String&&(p=String(p));for(var w=p.length,B=0;B<w;B++){var K=p[B];if(t.call(r,K,B,p))return{i:B,v:K}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(p){return p?p:function(p,r){return $jscomp.findInternal(this,p,r).v}},"es6-impl","es3");
$jscomp.polyfill("Array.prototype.fill",function(p){return p?p:function(p,r,w){var t=this.length||0;0>r&&(r=Math.max(0,t+r));if(null==w||w>t)w=t;w=Number(w);0>w&&(w=Math.max(0,t+w));for(r=Number(r||0);r<w;r++)this[r]=p;return this}},"es6-impl","es3");S3.gis.maps={};S3.gis.timeouts={};S3.gis.proj4326=new OpenLayers.Projection("EPSG:4326");OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";
OpenLayers.ProxyHost=S3.Ap.concat("/gis/proxy?url=");
(function(){var p=new OpenLayers.Format.GeoJSON;p.ignoreExtraDims=!0;var t=S3.Ap.concat("/static/img/markers/"),r=S3.gis.proj4326;S3.gis.show_map=function(b,a){b||(b="default_map");void 0==a&&(a=S3.gis.options[b]);var c=a.projection;var d=new OpenLayers.Projection("EPSG:"+c);a.projection_current=d;900913==c?(a.maxExtent=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7),a.maxResolution=156543.0339,a.units="m"):4326==c?(a.maxExtent=new OpenLayers.Bounds(-180,-90,180,90),
a.maxResolution=1.40625,a.units="degrees"):(c=a.maxExtent.split(","),a.maxExtent=new OpenLayers.Bounds(c[0],c[1],c[2],c[3]),a.maxResolution="auto");c=a.lat;var e=a.lon;if(void 0!=c&&void 0!=e)c=new OpenLayers.LonLat(e,c),c.transform(r,d);else{var f=OpenLayers.Bounds.fromArray(a.bbox);c=f.getCenterLonLat()}a.center=c;void 0===a.cluster_label&&(a.cluster_label=!0);var g=ga(b,a);g.Z_INDEX_BASE.Popup=900;var h=$("#"+b+"_panel");h.css("width","100%");$(window).resize(function(){var a=h.width();g.s3.mapWin.setWidth(a)});
a.renderTo=b+"_panel";ha(g);f&&(f.transform(r,d),g.zoomToExtent(f));g.events.on({movestart:function(a){S3.hideAlerts("warning")}});$.when(w(b)).then(function(a){s3_debug(a);$.when(B(S3.gis.maps[b].baseLayer)).then(function(a){s3_debug(a);I(null,g);setTimeout(function v(){try{g.tileManager.tileQueue[g.id].length?setTimeout(v,250):g.s3.loaded=!0}catch(x){setTimeout(function(){g.s3.loaded=!0},5E4)}},1)},function(a){s3_debug(a)},function(a){L(b);s3_debug(a)})},function(a){s3_debug(a)},function(a){s3_debug(a)});
return g};var w=function(b){var a=new jQuery.Deferred,c=S3.gis.maps[b].s3.layers_loading;setTimeout(function e(){0==c.length?a.resolve("Layers loaded"):"pending"===a.state()&&(a.notify("waiting for Layers to load..."),setTimeout(e,250))},1);return a.promise()},B=function(b){if(void 0==b.numLoadingTiles)return!0;var a=new jQuery.Deferred;b.events.register("loadend","",function(){0==b.numLoadingTiles?a.resolve("Tiles loaded"):"pending"===a.state()&&a.reject("Tile loading failed")});return a.promise()},
K=function(b,a,c){var d=a.toArray();a=d[0];var e=d[1],f=d[2],d=d[3];c=c||.05;var g=(c-Math.abs(f-a))/2;0<g&&(a-=g,f+=g);g=(c-Math.abs(d-e))/2;0<g&&(e-=g,d+=g);c/=7;e=Math.max(e-c,-90);d=Math.min(d+c,90);a=new OpenLayers.Bounds(a-c,e,f+c,d);a.transform(r,b.getProjectionObject());b.zoomToExtent(a)};S3.gis.zoomBounds=K;var M=function(b){b=b.object;var a=b.getDataExtent();if(a){var c=b.map;a.transform(c.getProjectionObject(),r);K(c,a)}for(var c=b.strategies,d=0,e=c.length;d<e;d++)if(a=c[d],"OpenLayers.Strategy.AttributeCluster"==
a.CLASS_NAME){a.activate();a.features=b.features;a.recluster();break}b.events.un({loadend:M})};S3.gis.search_layer_loadend=M;S3.gis.refreshLayer=function(b,a){var c=S3.gis.maps,d,e,f;for(d in c){var g=c[d];var h=g.layers;var l=0;for(e=h.length;l<e;l++)if((f=h[l])&&f.s3_layer_id==b){if(a&&a.length){var k=f.protocol.url;k=S3.search.filterURL(k,a);k={data:[],type:"GET",url:k};S3.search.searchRewriteAjaxOptions(k,"form");var m=f.protocol.options;m.params=k.data;m.readWithPOST=!0;m.url=k.url}if(g.s3.mapWin.isVisible()){f.events.on({loadend:M});
k=f.strategies;var v=k.length;for(m=0;m<v;m++){var x=k[m];if("OpenLayers.Strategy.AttributeCluster"==x.CLASS_NAME){x.deactivate();break}}if(f.visibility)for(m=0;m<v;m++){if(x=k[m],"OpenLayers.Strategy.BBOX"==x.CLASS_NAME||"OpenLayers.Strategy.ZoomBBOX"==x.CLASS_NAME){x.bounds=null;x.triggerRead();break}}else f.setVisibility(!0);void 0!=g.s3.layerRefreshed&&g.s3.layerRefreshed(f)}}}};var ga=function(b,a){var c=i18n.gis_name_map?!0:!1;var d=new OpenLayers.TileManager;c=new OpenLayers.Map("center",{controls:[],
displayProjection:r,projection:a.projection_current,fallThrough:c,maxResolution:a.maxResolution,maxExtent:a.maxExtent,numZoomLevels:a.numZoomLevels,theme:null,tileManager:d,units:a.units});S3.gis.maps[b]=c;c.s3={};c.s3.id=b;c.s3.options=a;c.s3.plugins=[];c.registerPlugin=function(a){a.map=this;this.s3.plugins.push(a)};ia(c);ja(c);return c},ha=function(b){var a,c=b.s3,d=c.options,e=new GeoExt.MapPanel({xtype:"gx_mappanel",map:b,center:d.center,zoom:d.zoom,plugins:[]});c.mapPanel=e;var f={};f.map=e;
c.portal=f;if(d.legend||d.layers_wms){var f=b.layers,g=e.layers.data.items;for(a=0;a<f.length;a++)f[a].legendURL&&(g[a].data.legendURL=f[a].legendURL),f[a].legendTitle&&(g[a].data.title=f[a].legendTitle),f[a].queryable&&(g[a].data.queryable=1)}f=ka(b);g=[f];d.wms_browser_url&&(a=la(b))&&g.push(a);d.legend&&("float"==d.legend?a=ma(b):(a=new GeoExt.LegendPanel({title:i18n.gis_legend,defaults:{},autoScroll:!0,collapsible:!0,collapseMode:"mini"}),g.push(a)),e.legendPanel=a);e=c.plugins;a=0;for(var h=
e.length;a<h;++a)e[a].setup(b),e[a].addToMapWindow(g);c.west_panel_items=g;d.window?S(b):T(b);var l=c.westPanelContainer;l.fireEvent("collapse");window.setTimeout(function(){l.fireEvent("expand")},300);f.root.eachChild(function(){this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||I(this.layer)});else this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||I(this.layer)})})})});Ext.QuickTips.init()},T=function(b){var a=b.s3,c=a.options,d=U(b);
b=V(b);c=new Ext.Panel({renderTo:c.renderTo,autoWidth:!0,titleCollapse:!0,height:c.map_height,layout:"border",items:[d,b]});a.mapWin=c};S3.gis.addMapPanel=T;var S=function(b){var a=b.s3,c=a.options,d=U(b),e=V(b),d=new Ext.Window({cls:"gis-map-window",collapsible:!1,constrain:!0,closable:!c.windowNotClosable,closeAction:"hide",autoScroll:!0,maximizable:c.maximizable,titleCollapse:!1,height:c.map_height,width:c.map_width,layout:"border",items:[d,e]});d.on("beforehide",function(a){a.maximized&&a.restore()});
d.on("move",function(a){b.events.clearMouseCache()});d.on("resize",function(b,c,d){842>d?$("#"+a.id).removeClass("a0 a1 a2 a3").addClass("a4"):1191>d?$("#"+a.id).removeClass("a0 a1 a2 a4").addClass("a3"):1684>d?$("#"+a.id).removeClass("a0 a1 a3 a4").addClass("a2"):2384>d?$("#"+a.id).removeClass("a0 a2 a3 a4").addClass("a1"):$("#"+a.id).removeClass("a1 a2 a3 a4").addClass("a0")});c.windowHide||(d.show(),d.maximize());a.mapWin=d};S3.gis.addMapWindow=S;var U=function(b){b=b.s3;var a=b.options.west_collapsed||
!1,c=new Ext.Panel({header:!1,border:!1,split:!0,items:b.west_panel_items});autoWidth=Ext.isChrome?!1:!0;a=new Ext.Panel({cls:"gis_west",region:"west",header:!1,border:!0,autoWidth:autoWidth,width:250,collapsible:!0,collapseMode:"mini",collapsed:a,items:[c]});return b.westPanelContainer=a},V=function(b){var a=b.s3,c=a.options;if(c.toolbar)var d=na(b);else{if(c.draw_feature){var e="active"==c.draw_feature?!0:!1;N(b,null,e)}c.draw_line&&(e="active"==c.draw_line?!0:!1,O(b,null,e));c.draw_polygon&&(e=
"active"==c.draw_polygon?!0:!1,P(b,null,e,!0));c.draw_circle&&(e="active"==c.draw_circle?!0:!1,Q(b,null,e));e=b.s3;var f=e.id;if(!$("#"+f+" .layer_throbber").length){var g='<div class="layer_throbber float hide';e.options.save&&(g+=" save");g+='"></div>';$("#"+f).append(g)}}"float"==c.save&&oa(b);b=new Ext.Panel({layout:"card",region:"center",cls:"mappnlcntr",defaults:{border:!1},items:[a.mapPanel],activeItem:0,tbar:d,scope:this});return a.mapPanelContainer=b},ka=function(b){GeoExt.tree.LayerNodeUIS3=
Ext.extend(GeoExt.tree.LayerNodeUI,{onClick:function(a){if(a.getTarget(".x-tree-node-cb",1)){var b=this.node,c=this.node.attributes,d=c.checkedGroup;d&&"baselayer"!==d?(d=!c.checked,c.checked=d,b.ui.checkbox.checked=d,b.layer.setVisibility(d),this.enforceOneVisible()):this.toggleCheck(this.isChecked())}else GeoExt.tree.LayerNodeUI.superclass.onClick.apply(this,arguments)},enforceOneVisible:function(){var a=this.node.attributes,b=a.checkedGroup;if(b&&"baselayer"!==b){var c=this.node.layer,d=this.node.getOwnerTree().getChecked();
Ext.each(d,function(d){var e=d.layer;d.hidden||d.attributes.checkedGroup!==b||e!=c&&a.checked&&e.setVisibility(!1)})}}});GeoExt.tree.LayerNodeS3=Ext.extend(GeoExt.tree.LayerNode,{constructor:function(a){this.defaultUI=GeoExt.tree.LayerNodeUIS3;GeoExt.tree.LayerNodeS3.superclass.constructor.apply(this,arguments)}});Ext.tree.TreePanel.nodeTypes.gx_layer=GeoExt.tree.LayerNodeS3;var a=b.s3,c=a.options;var d=c.hide_base?!1:!0;var e=c.hide_overlays?!1:!0;var f=c.folders_closed?!1:!0;var g=c.folders_radio?
!0:!1;var h=c.wms_browser_url||c.legend&&"float"!=c.legend?!0:!1;var l=a.mapPanel.layers,k=[],m={click:function(a){var b=a.attributes;if("baselayer"==b.checkedGroup)a.ui.toggleCheck(!a.ui.isChecked());else{var c=!b.checked;b.checked=c;a.ui.checkbox.checked=c;a.layer.setVisibility(c)}}},v=function(){var b=a.westPanelContainer;b.fireEvent("collapse");window.setTimeout(function(){b.fireEvent("expand")},300)},x={collapse:function(a){v()},expand:function(a){v()}};d&&k.push({text:i18n.gis_base_layers,nodeType:"gx_baselayercontainer",
layerStore:l,loader:{baseAttrs:{listeners:m},filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!0===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,listeners:x,singleClickExpand:!0,expanded:f});e&&k.push({text:i18n.gis_overlays,nodeType:"gx_overlaylayercontainer",layerStore:l,loader:{baseAttrs:{listeners:m},filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!1===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,listeners:x,singleClickExpand:!0,expanded:f});
d=b.s3.dirs;var n=d.length;if(n){GeoExt.tree.LayerLoaderS3=function(a){Ext.apply(this,a);GeoExt.tree.LayerLoaderS3.superclass.constructor.call(this)};Ext.extend(GeoExt.tree.LayerLoaderS3,GeoExt.tree.LayerLoader,{load:function(a,b){if(this.fireEvent("beforeload",this,a)){for(this.removeStoreHandlers();a.firstChild;)a.removeChild(a.firstChild);this.uiProviders||(this.uiProviders=a.getOwnerTree().getLoader().uiProviders);this.store||(this.store=GeoExt.MapPanel.guess().layers);this.store.each(function(b){this.addLayerNode(a,
b)},this);this.addStoreHandlers(a);var c=a.attributes.children,d=c.length;if(d)for(var e,f,g=0;g<d;g++)e=c[g],e=new Ext.tree.TreePanel.nodeTypes[e.nodeType](e),(f=a.item(0))?a.insertBefore(e,f):a.appendChild(e);"function"==typeof b&&b();this.fireEvent("load",this,a)}}});e={};var p,r,u;for(p=0;p<n;p++){var z=d[p];var w=z.split("/");var t=w.length;for(r=0;r<t;r++){var D=0==r?e:D[A];var A=w[r];D.hasOwnProperty(A)||(D[A]={})}}for(z in e){A=e[z];D=[];for(u in A)A={listeners:m},g&&(A.checkedGroup=u),A=
new GeoExt.tree.LayerLoaderS3({baseAttrs:A,filter:function(a,b){return function(c){if("undefined"!==c.data.layer.dir)return c.data.layer.dir===a+"/"+b}}(z,u)}),A={text:u,nodeType:"gx_layercontainer",layerStore:l,children:[],loader:A,leaf:!1,listeners:x,singleClickExpand:!0,expanded:f},D.push(A);A={listeners:m};g&&(A.checkedGroup=z);A=new GeoExt.tree.LayerLoaderS3({baseAttrs:A,filter:function(a){return function(b){if("undefined"!==b.data.layer.dir)return b.data.layer.dir===a}}(z)});A={text:z,nodeType:"gx_layercontainer",
layerStore:l,children:D,loader:A,leaf:!1,listeners:x,singleClickExpand:!0,expanded:f};k.push(A)}}g=new Ext.tree.AsyncTreeNode({expanded:!0,children:k});f=(c=c.clearlayers&"toolbar"!=c.clearlayers)||i18n.gis_properties||i18n.gis_uploadlayer?new Ext.Toolbar:null;h=new Ext.tree.TreePanel({title:i18n.gis_layers,loaderloader:new Ext.tree.TreeLoader({applyLoader:!1}),root:g,rootVisible:!1,split:!0,collapsible:h,collapseMode:"mini",lines:!1,tbar:f,enableDD:!1});new Ext.tree.TreeSorter(h,{sortType:function(a,
b){return"gx_baselayercontainer"==b.attributes.nodeType?" ":"gx_overlaylayercontainer"==b.attributes.nodeType?"!":b.text}});i18n.gis_uploadlayer&&pa(b,h);i18n.gis_properties&&qa(b,h);c&&W(b,h.getTopToolbar());return h},la=function(b){var a=b.s3.options,c=new Ext.tree.AsyncTreeNode({expanded:!0,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+a.wms_browser_url,layerOptions:{buffer:1,singleTile:!1,ratio:1,wrapDateLine:!0},layerParams:{TRANSPARENT:"TRUE"},createNode:function(a){a.checked=
a.leaf?!1:void 0;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[a])}})});return new Ext.tree.TreePanel({title:a.wms_browser_name,root:c,rootVisible:!1,split:!0,autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1,listeners:{checkchange:function(a,c){!0===c?b.addLayer(a.attributes.layer):b.removeLayer(a.attributes.layer)}}})},L=function(b){$("#"+b+" .layer_throbber").show().removeClass("hide")},I=function(b,a){if(b){var c=b.map.s3;var d=c.layers_loading;d.pop(b.s3_layer_id)}else c=
a.s3,d=a.s3.layers_loading;0===d.length&&$("#"+c.id+" .layer_throbber").hide().addClass("hide")},E=function(b){var a=b.object;b=a.map.s3;L(b.id);a=a.s3_layer_id;b=b.layers_loading;b.pop(a);b.push(a)},F=function(b){var a=b.object;if((b=b.response)&&b.priv){var c=b.priv;try{var d=JSON.parse(c.responseText).s3}catch(C){}if(void 0!=d){if(void 0!=d.level){var e=a.strategies;b=0;for(var f=e.length;b<f;b++){var g=e[b];if("OpenLayers.Strategy.ZoomBBOX"==g.CLASS_NAME){g.level=d.level;break}}}if(void 0!=d.style){var h=
!0;d=d.style;b=J(a.map,d);var l=b[1];a.legendURL=l;a.styleMap=b[0];a.s3_popup_format=d.popup_format;a.s3_style=d.style;a.s3_url_format=d.url_format;e=a.strategies;b=0;for(f=e.length;b<f;b++)if(g=e[b],"OpenLayers.Strategy.AttributeCluster"==g.CLASS_NAME){if(b=void 0!=d.cluster_threshold?d.cluster_threshold:2)d=d.cluster_distance||20,g.active&&d==g.distance&&b==g.threshold||(g.distance=d,g.threshold=b,g.activate(),g.features=a.features,g.recluster());else if(g.active){g.deactivate();d=a.features;var k=
[],m=[];g=d.length;for(b=0;b<g;b++)if(d[b].cluster){f=d[b];var v=f.cluster;var x=v.length;for(e=0;e<x;e++)m.push(v[e]);k.push(f)}a.removeFeatures(k);a.addFeatures(m)}break}}}I(a);if(509==c.status)S3.showAlert(i18n.gis_too_many_features,"warning");else if((b=a.s3_style)&&"[object Array]"===Object.prototype.toString.call(b)&&1==b.length){var n=ra(a);h=!0}if(void 0!=h){d=a.features;g=d.length;for(b=0;b<g;b++)a.drawFeature(d[b]);if(h=a.map.s3.mapPanel.legendPanel)for(c=h.items.items,g=a.s3_layer_id,d=
c.length,b=0;b<d;b++)if(a=c[b],a.layer&&a.layer.s3_layer_id==g){void 0!=n?"gx_vectorlegend"==a.xtype?(a.rules=n,a.update()):(n=a.layerRecord,h.removeLegend(n),h.addLegend(n,b)):void 0!=l&&("gx_urllegend"==a.xtype?(a.layerRecord.data.legendURL=l,a.update()):(n=a.layerRecord,n.data.legendURL=l,h.removeLegend(n),h.addLegend(n,b)));break}}}else I(a)},ra=function(b){var a=b.s3_style[0],c=a.prop,d=b.features,e,f=d.length,g=[];for(e=0;e<f;e++)g.push(d[e].attributes[c]);g.sort(function(a,b){return a-b});
var h={};$.each(g,function(){h[this]=1});c=Object.keys(h).length;if(5<=c){c=5;var l=["ffffb2","fecc5c","fd8d3c","f03b20","bd0026"]}else 4==c?l=["ffffb2","fecc5c","fd8d3c","e31a1c"]:3==c?l=["ffeda0","feb24c","f03b20"]:2==c?l=["ffeda0","f03b20"]:1==c&&(l=["feb24c"]);var k=Math.round(f/c),m=k,d=[g[0]];for(e=1;e<c;e++)d[e]=g[m]||g[f-1],m+=k;d.push(g[f-1]);m=[];for(e=0;e<c;e++)f=d[e],g=d[e+1],k=$.extend({},a),k.fill=l[e],k.low=f,k.high=g,k.label=f==g?f.toString():f+" - "+g,m.push(k);l=X({style:m,cluster_threshold:0,
opacity:.9});return b.styleMap.styles["default"].rules=l},G=function(b){Y(b.object.map)},ia=function(b){var a=b.s3,c=a.options;a.dirs=[];a.layers_loading=[];a.layers_nopopups=[];if(c.layers_osm)for(var d=c.layers_osm,a=d.length;0<a;a--)sa(b,d[a-1]);try{google&&ta(b)}catch(f){}c.Bing&&ua(b);if(c.layers_tms)for(d=c.layers_tms,a=d.length;0<a;a--)va(b,d[a-1]);if(c.layers_wms)for(d=c.layers_wms,a=d.length;0<a;a--)wa(b,d[a-1]);if(c.layers_xyz)for(d=c.layers_xyz,a=d.length;0<a;a--)xa(b,d[a-1]);c.EmptyLayer&&
(a=new OpenLayers.Layer(c.EmptyLayer.name,{isBaseLayer:!0,displayInLayerSwitcher:!0,s3_layer_id:c.EmptyLayer.id,s3_layer_type:"empty"}),b.addLayer(a),c.EmptyLayer.base&&b.setBaseLayer(a));if(c.layers_js)for(d=c.layers_js,a=d.length;0<a;a--)eval(b,d[a-1]);if(c.layers_theme)for(d=c.layers_theme,a=d.length;0<a;a--)H(b,d[a-1]);if(c.layers_geojson)for(d=c.layers_geojson,a=d.length;0<a;a--)H(b,d[a-1]);if(c.layers_gpx)for(d=c.layers_gpx,a=d.length;0<a;a--)ya(b,d[a-1]);if(c.layers_arcrest)for(d=c.layers_arcrest,
a=d.length;0<a;a--)za(b,d[a-1]);c.CoordinateGrid&&Aa(b);if(c.layers_georss)for(d=c.layers_georss,a=d.length;0<a;a--)H(b,d[a-1]);if(c.layers_kml)for(d=c.layers_kml,a=d.length;0<a;a--)Ba(b,d[a-1]);c.OWM&&Ca(b);if(c.layers_shapefile)for(d=c.layers_shapefile,a=d.length;0<a;a--)H(b,d[a-1]);if(c.layers_wfs)for(d=c.layers_wfs,a=d.length;0<a;a--)Da(b,d[a-1]);if(c.feature_queries)for(d=c.feature_queries,a=d.length;0<a;a--)H(b,d[a-1]);if(c.feature_resources)for(d=c.feature_resources,a=d.length;0<a;a--)H(b,
d[a-1]);if(c.layers_feature)for(d=c.layers_feature,a=d.length;0<a;a--)H(b,d[a-1]);if(c.features||c.draw_feature||c.draw_polygon||c.draw_circle||navigator.geolocation)var e=Ea(b);if(c.features)for(c=c.features,b=b.getProjectionObject(),a=0;a<c.length;a++)d=p.parseFeature(c[a]),d.geometry.transform(r,b),e.addFeatures([d])},za=function(b,a){var c=a.name,d=[a.url];var e=void 0!=a.layers?a.layers.join():0;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,b.s3.dirs)&&b.s3.dirs.push(f)}else f="";var g=void 0!=
a.base?a.base:!1;var h=void 0!=a.format?a.format:"png";var l=void 0!=a.transparent?a.transparent:!0;var k=void 0!=a.visibility?a.visibility:!0;l=new OpenLayers.Layer.ArcGIS93Rest(c,d,{layers:"show:"+e,isBaseLayer:g,transparent:l,format:h,dir:f,s3_layer_id:a.id,s3_layer_type:"arcrest"});l.setVisibility(k);b.addLayer(l);a._base&&b.setBaseLayer(l)},ua=function(b){var a=b.s3.options.Bing,c=a.ApiKey;if(a.Aerial){var d=new OpenLayers.Layer.Bing({key:c,type:"Aerial",name:a.Aerial.name,s3_layer_id:a.Aerial.id,
s3_layer_type:"bing"});b.addLayer(d);"aerial"==a.Base&&b.setBaseLayer(d)}a.Road&&(d=new OpenLayers.Layer.Bing({key:c,type:"Road",name:a.Road.name,s3_layer_id:a.Road.id,s3_layer_type:"bing"}),b.addLayer(d),"road"==a.Base&&b.setBaseLayer(d));a.Hybrid&&(d=new OpenLayers.Layer.Bing({key:c,type:"AerialWithLabels",name:a.Hybrid.name,s3_layer_id:a.Hybrid.id,s3_layer_type:"bing"}),b.addLayer(d),"hybrid"==a.Base&&b.setBaseLayer(d))},Aa=function(b){var a=b.s3.options.CoordinateGrid,a=new OpenLayers.Control.Graticule({layerName:a.name,
visible:a.visibility});b.addControl(a)},Ea=function(b){var a=b.s3.options;if(a.draw_feature)var c=a.marker_default;if(a.draft_style)var d=a.draft_style;d=J(b,{marker:c,style:d,opacity:.9});d=new OpenLayers.Layer.Vector(i18n.gis_draft_layer,{displayInLayerSwitcher:!1,legendURL:d[1],styleMap:d[0]});d.setVisibility(!0);b.addLayer(d);return b.s3.draftLayer=d},H=function(b,a){var c=b.s3;var d=a.name;a.no_popups&&c.layers_nopopups.push(d);var e=a.url;var f=-1!==e.indexOf("$search")?!0:!1;var g=void 0!=
a.refresh?a.refresh:900;if(void 0!=a.dir){var h=a.dir;-1==$.inArray(h,c.dirs)&&c.dirs.push(h)}else h="";c=void 0!=a.visibility?a.visibility:!0;var l=void 0!=a.cluster_attribute?a.cluster_attribute:"colour";var k=void 0!=a.cluster_distance?a.cluster_distance:20;var m=void 0!=a.cluster_threshold?a.cluster_threshold:2;var v=void 0!=a.projection?a.projection:4326;v=4326==v?r:new OpenLayers.Projection("EPSG:"+v);var x=void 0!=a.type?a.type:"feature";var n='<div class="gis_layer_legend"><div class="gis_legend_title">'+
d+"</div>";void 0!=a.desc&&(n+='<div class="gis_legend_desc">'+a.desc+"</div>");if(void 0!=a.src||void 0!=a.src_url){var C='<div class="gis_legend_src">';void 0!=a.src_url?(C+='<a href="'+a.src_url+'" target="_blank">',C=void 0!=a.src?C+a.src:C+a.src_url,C+="</a>"):C+=a.src;n+=C+"</div>"}var n=n+"</div>",y=J(b,a),C=y[0],y=y[1],u=[new OpenLayers.Strategy.ZoomBBOX({ratio:1.5})];g&&u.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*g}));(m||a.cluster)&&u.push(new OpenLayers.Strategy.AttributeCluster({attribute:l,
distance:k,threshold:m}));h=new OpenLayers.Layer.Vector(d,{dir:h,projection:v,protocol:new OpenLayers.Protocol.HTTP({url:e,format:p,readWithPOST:f}),legendURL:y,strategies:u,styleMap:C,s3_layer_id:a.id,s3_layer_type:x,s3_style:a.style,s3_url_format:a.url_format});h.legendTitle=n;void 0!=a.popup_format&&(h.s3_popup_format=a.popup_format);h.setVisibility(c);h.events.on({loadstart:E,loadend:F,visibilitychanged:G});b.addLayer(h)},ta=function(b){var a=b.s3.options.Google;if(a.MapMaker||a.MapMakerHybrid){if(a.Satellite){var c=
new OpenLayers.Layer.Google(a.Satellite.name,{type:G_SATELLITE_MAP,sphericalMercator:!0,s3_layer_id:a.Satellite.id,s3_layer_type:"google"});b.addLayer(c);"satellite"==a.Base&&b.setBaseLayer(c)}a.Maps&&(c=new OpenLayers.Layer.Google(a.Maps.name,{type:G_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),b.addLayer(c),"maps"==a.Base&&b.setBaseLayer(c));a.Hybrid&&(c=new OpenLayers.Layer.Google(a.Hybrid.name,{type:G_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),
b.addLayer(c),"maps"==a.Base&&b.setBaseLayer(c));a.Terrain&&(c=new OpenLayers.Layer.Google(a.Terrain.name,{type:G_PHYSICAL_MAP,sphericalMercator:!0,s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),b.addLayer(c),"terrain"==a.Base&&b.setBaseLayer(c));a.MapMaker&&(c=new OpenLayers.Layer.Google(a.MapMaker.name,{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:c.id,s3_layer_type:"google"}),b.addLayer(c),"mapmaker"==a.Base&&b.setBaseLayer(c));a.MapMakerHybrid&&(c=new OpenLayers.Layer.Google(a.MapMakerHybrid.name,
{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:c.id,s3_layer_type:"google"}),b.addLayer(c),"mapmakerhybrid"==a.Base&&b.setBaseLayer(c))}else a.Satellite&&(c=new OpenLayers.Layer.Google(a.Satellite.name,{type:"satellite",numZoomLevels:22,s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),b.addLayer(c),"satellite"==a.Base&&b.setBaseLayer(c)),a.Maps&&(c=new OpenLayers.Layer.Google(a.Maps.name,{numZoomLevels:20,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),b.addLayer(c),"maps"==a.Base&&
b.setBaseLayer(c)),a.Hybrid&&(c=new OpenLayers.Layer.Google(a.Hybrid.name,{type:"hybrid",numZoomLevels:20,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),b.addLayer(c),"hybrid"==a.Base&&b.setBaseLayer(c)),a.Terrain&&(c=new OpenLayers.Layer.Google(a.Terrain.name,{type:"terrain",s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),b.addLayer(c),"terrain"==a.Base&&b.setBaseLayer(c))},ya=function(b,a){var c=a.name,d=a.url;var e=a.marker;var f=t+e.i,g=e.h,h=e.w;var l=void 0!=a.waypoints?a.waypoints:!0;var k=
void 0!=a.tracks?a.tracks:!0;var m=void 0!=a.routes?a.routes:!0;e=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var v=a.dir;-1==$.inArray(v,b.s3.dirs)&&b.s3.dirs.push(v)}else v="";var x=void 0!=a.opacity?a.opacity:1;var n=void 0!=a.cluster_distance?a.cluster_distance:20;var p=void 0!=a.cluster_threshold?a.cluster_threshold:2;var y=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);l?(y.graphicOpacity=x,y.graphicWidth=h,y.graphicHeight=g,y.graphicXOffset=-(h/2),y.graphicYOffset=
-g,y.externalGraphic=f):y.externalGraphic="";y.strokeColor="blue";y.strokeWidth=6;y.strokeOpacity=x;c=new OpenLayers.Layer.Vector(c,{dir:v,projection:r,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:n,threshold:p})],legendURL:f,s3_layer_id:a.id,s3_layer_type:"gpx",style:y,protocol:new OpenLayers.Protocol.HTTP({url:d,format:new OpenLayers.Format.GPX({extractAttributes:!0,extractWaypoints:l,extractTracks:k,extractRoutes:m})})});c.setVisibility(e);c.events.on({loadstart:E,
loadend:F,visibilitychanged:G});b.addLayer(c)},Ba=function(b,a){var c=b.s3;var d=a.name,e=a.url;var f=void 0!=a.title?a.title:"name";var g=void 0!=a.body?a.body:"description";var h=void 0!=a.refresh?a.refresh:900;var l=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var k=a.dir;-1==$.inArray(k,c.dirs)&&c.dirs.push(k)}else k="";var m=void 0!=a.cluster_distance?a.cluster_distance:20;c=void 0!=a.cluster_threshold?a.cluster_threshold:2;var v=J(b,a)[0],x=new OpenLayers.Format.KML({extractStyles:!0,
extractAttributes:!0,maxDepth:2}),n=[new OpenLayers.Strategy.Fixed];h&&n.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*h}));c&&n.push(new OpenLayers.Strategy.Cluster({distance:m,threshold:c}));k=new OpenLayers.Layer.Vector(d,{dir:k,projection:r,protocol:new OpenLayers.Protocol.HTTP({url:e,format:x}),strategies:n,styleMap:v,s3_layer_id:a.id,s3_layer_type:"kml",s3_style:a.style});k.title=f;k.body=g;k.setVisibility(l);k.events.on({loadstart:E,loadend:F,visibilitychanged:G});b.addLayer(k)},
sa=function(b,a){var c=a.name,d=[a.url1];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,b.s3.dirs)&&b.s3.dirs.push(f)}else f="";f=new OpenLayers.Layer.TMS(c,d,{dir:f,type:"png",getURL:Fa,displayOutsideMaxExtent:!0,numZoomLevels:void 0!=a.zoomLevels?a.zoomLevels:19,isBaseLayer:void 0!=a.base?a.base:!0,s3_layer_id:a.id,s3_layer_type:"openstreetmap"});void 0!=a.attribution&&(f.attribution=a.attribution);
f.setVisibility(e);f.events.on({loadstart:E,loadend:F});b.addLayer(f);a._base&&b.setBaseLayer(f)},Fa=function(b){var a=this.map.getResolution(),c=Math.round((b.left-this.maxExtent.left)/(a*this.tileSize.w));b=Math.round((this.maxExtent.top-b.top)/(a*this.tileSize.h));var a=this.map.getZoom(),d=Math.pow(2,a);if(0>b||b>=d)return OpenLayers.Util.getImagesLocation()+"404.png";c=a+"/"+(c%d+d)%d+"/"+b+"."+this.type;b=this.url;b instanceof Array&&(b=this.selectUrl(c,b));return b+c},Ca=function(b){var a=
b.s3.options.OWM;if(a.station){var c=new OpenLayers.Layer.Vector.OWMStations(a.station.name,{dir:a.station.dir,s3_layer_id:a.station.id,s3_layer_type:"openweathermap"});c.setVisibility(a.station.visibility);c.events.on({featureselected:c.onSelect,featureunselected:c.onUnselect,loadstart:E,loadend:F,visibilitychanged:G});b.addLayer(c)}a.city&&(c=new OpenLayers.Layer.Vector.OWMWeather(a.city.name,{dir:a.city.dir,s3_layer_id:a.city.id,s3_layer_type:"openweathermap"}),c.setVisibility(a.city.visibility),
c.events.on({featureselected:c.onSelect,featureunselected:c.onUnselect,loadstart:E,loadend:F,visibilitychanged:G}),b.addLayer(c))},va=function(b,a){var c=a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=a.layername;var f=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,b.s3.dirs)&&b.s3.dirs.push(g)}else g="";g=new OpenLayers.Layer.TMS(c,d,{dir:g,s3_layer_id:a.id,s3_layer_type:"tms",layername:e,type:void 0!=a.format?a.format:"png",
numZoomLevels:f});void 0!=a.attribution&&(g.attribution=a.attribution);g.events.on({loadstart:E,loadend:F});b.addLayer(g);a._base&&b.setBaseLayer(g)},Da=function(b,a){var c=a.name,d=a.url;void 0!=a.username&&void 0!=a.password&&(d=d.replace("://","://"+a.username+":"+a.password+"@"));var e=a.title,f=a.featureType;var g=void 0!=a.featureNS?a.featureNS:null;var h=void 0!=a.schema?a.schema:null;var l=void 0!=a.version?a.version:"1.1.0";var k=void 0!=a.geometryName?a.geometryName:"the_geom";var m=void 0!=
a.visibility?a.visibility:!0;if(void 0!=a.dir){var v=a.dir;-1==$.inArray(v,b.s3.dirs)&&b.s3.dirs.push(v)}else v="";var x=void 0!=a.cluster_attribute?a.cluster_attribute:"colour";var n=void 0!=a.cluster_distance?a.cluster_distance:20;var p=void 0!=a.cluster_threshold?a.cluster_threshold:2;var y=void 0!=a.refresh?a.refresh:!1;var u=[new OpenLayers.Strategy.BBOX({ratio:1.5})];y&&u.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*y}));p&&u.push(new OpenLayers.Strategy.AttributeCluster({attribute:x,
distance:n,threshold:p}));void 0!=a.projection?(y=a.projection,p="EPSG:"+y):(y="4326",p="EPSG:4326");l=new OpenLayers.Protocol.WFS({version:l,srsName:p,url:d,featureType:f,featureNS:g,geometryName:k,schema:h});k='<div class="gis_layer_legend"><div class="gis_legend_title">'+c+"</div>";void 0!=a.desc&&(k+='<div class="gis_legend_desc">'+a.desc+"</div>");if(void 0!=a.src||void 0!=a.src_url)h='<div class="gis_legend_src">',void 0!=a.src_url?(h+='<a href="'+a.src_url+'" target="_blank">',h=void 0!=a.src?
h+a.src:h+a.src_url,h+="</a>"):h+=a.src,k+=h+"</div>";k+="</div>";g=J(b,a);h=g[0];g=g[1];y="4326"==y?r:new OpenLayers.Projection("EPSG:"+y);v=new OpenLayers.Layer.Vector(c,{maxFeatures:1E3,strategies:u,dir:v,legendURL:g,projection:y,protocol:l,styleMap:h,s3_layer_id:a.id,s3_layer_type:"wfs",s3_style:a.style});v.legendTitle=k;v.title=e;v.setVisibility(m);v.events.on({loadstart:E,loadend:F,visibilitychanged:G});b.addLayer(v)},wa=function(b,a){var c=a.name,d=a.url;a.username&&a.password&&(d=d.replace("://",
"://"+a.username+":"+a.password+"@"));var e=a.layers;var f=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,b.s3.dirs)&&b.s3.dirs.push(g)}else g="";var h=void 0!=a.base?a.base:!1;var l=void 0!=a.transparent?a.transparent:!0;var k=void 0!=a.format?a.format:"image/png";var m=void 0!=a.version?a.version:"1.1.1";var v=a.map?a.map:"";var x=a.style?a.style:"";var n=void 0!=a.bgcolor?"0x"+a.bgcolor:"";var p=void 0!=a.buffer?a.buffer:0;var r=void 0!=a.tiled?a.tiled:!1;var u=
void 0!=a.opacity?a.opacity:1;var z=void 0!=a.queryable?a.queryable:1;var w='<div class="gis_layer_legend"><div class="gis_legend_title">'+c+"</div>";void 0!=a.desc&&(w+='<div class="gis_legend_desc">'+a.desc+"</div>");if(b.s3.options.metadata){if(void 0!=a.post_id)if(i18n.gis_metadata){var t=i18n.gis_metadata;var D=S3.Ap.concat("/cms/page/"+a.post_id)}else t=i18n.gis_metadata_edit,D=S3.Ap.concat("/cms/post/"+a.post_id+"/update?layer_id="+a.id);else i18n.gis_metadata_create?(t=i18n.gis_metadata_create,
D=S3.Ap.concat("/cms/post/create?layer_id="+a.id)):t="";t&&(w+='<div class="gis_legend_src"><a href="'+D+'" target="_blank">'+t+"</a></div>")}else if(void 0!=a.src||void 0!=a.src_url)t='<div class="gis_legend_src">',void 0!=a.src_url?(t+='<a href="'+a.src_url+'" target="_blank">',t=void 0!=a.src?t+a.src:t+a.src_url,t+="</a>"):t+=a.src,w+=t+"</div>";w+="</div>";if(void 0!=a.legendURL)var A=a.legendURL;z=new OpenLayers.Layer.WMS(c,d,{layers:e,transparent:l},{dir:g,wrapDateLine:!0,isBaseLayer:h,s3_layer_id:a.id,
s3_layer_type:"wms",queryable:z,visibility:f});v&&(z.params.MAP=v);k&&(z.params.FORMAT=k);m&&(z.params.VERSION=m);x&&(z.params.STYLES=x);n&&(z.params.BGCOLOR=n);r&&(z.params.TILED=!0,z.params.TILESORIGIN=[b.maxExtent.left,b.maxExtent.bottom]);h||(z.opacity=u,z.buffer=p?p:0);z.legendTitle=w;A&&(z.legendURL=A);z.events.on({loadstart:E,loadend:F,visibilitychanged:G});b.addLayer(z);a._base&&b.setBaseLayer(z)},xa=function(b,a){var c=a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);
var e=a.layername;var f=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,b.s3.dirs)&&b.s3.dirs.push(g)}else g="";g=new OpenLayers.Layer.XYZ(c,d,{dir:g,s3_layer_id:a.id,s3_layer_type:"xyz",layername:e,type:void 0!=a.format?a.format:"png",numZoomLevels:f});void 0!=a.attribution&&(g.attribution=a.attribution);g.events.on({loadstart:E,loadend:F});b.addLayer(g);a._base&&b.setBaseLayer(g)},ja=function(b){var a=b.s3.options,c=new OpenLayers.Control.Navigation;a.no_zoom_wheel&&
(c.zoomWheelEnabled=!1);b.addControl(c);void 0==a.zoomcontrol&&b.addControl(new OpenLayers.Control.Zoom);b.addControl(new OpenLayers.Control.ArgParser);b.addControl(new OpenLayers.Control.Attribution);void 0==a.scaleline&&b.addControl(new OpenLayers.Control.ScaleLine);"mgrs"==a.mouse_position?b.addControl(new OpenLayers.Control.MGRSMousePosition):a.mouse_position&&b.addControl(new OpenLayers.Control.MousePosition);void 0==a.permalink&&b.addControl(new OpenLayers.Control.Permalink);if(void 0==a.overview){var a=
{},c=b.options,d;for(d in c)"controls"!=d&&(a[d]=c[d]);b.addControl(new OpenLayers.Control.OverviewMap({mapOptions:a}))}Ga(b)},Ga=function(b){b.events.register("featureover",this,Ha);b.events.register("featureout",this,Z);b.events.register("featureclick",this,Ia)},Ha=function(b){var a=b.feature,c=a.layer;a.renderIntent="select";c.drawFeature(a);if(-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(c.name)){var d=c.map;
-1==d.s3.layers_nopopups.indexOf(c.name)&&(S3.gis.timeouts[a.id]=setTimeout(function(){if(!a.cluster&&a.geometry){var b=a.attributes,f=a.geometry.getBounds().getCenterLonLat();if(void 0!=c.s3_popup_format){_.templateSettings={interpolate:/\{(.+?)\}/g};var g=c.s3_popup_format;var h=_.template(g);for(var l={},k=g.split("{"),m=0;m<k.length;m++)g=k[m].split("}")[0],l[g]="";_.defaults(b,l);h=h(b)}else void 0!=b.popup?h=b.popup:void 0!=b.name?h=b.name:void 0!=c.title&&(b=b[c.title],h="object"==typeof b?
b.value:b);h&&(OpenLayers.Popup.Tooltip=OpenLayers.Class(OpenLayers.Popup,{displayClass:"gis_tooltip",contentDisplayClass:"gis_tooltip_content",CLASS_NAME:"OpenLayers.Popup.Tooltip"}),f=new OpenLayers.Popup.Tooltip(a.id+"_tooltip",f,new OpenLayers.Size(80,12),h),f.autoSize=!0,a.popup=f,d.addPopup(f))}},500))}},Z=function(b){b=b.feature;var a=b.layer,c=a.map;b&&(b.renderIntent="default",a.drawFeature(b));-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(a.name)&&
-1==c.s3.layers_nopopups.indexOf(a.name)&&b&&(clearTimeout(S3.gis.timeouts[b.id]),b.popup&&"OpenLayers.Popup.Tooltip"==b.popup.CLASS_NAME&&(b.popup&&(c.removePopup(b.popup),b.popup.destroy()),delete b.popup),$("#"+b.id+"_tooltip").remove())},ba=function(b,a,c,d){var e=b.id+"_popup";d&&a?(0===a.indexOf("http://")&&(a=OpenLayers.ProxyHost+encodeURIComponent(a)),c='<iframe src="'+a+'" onload="S3.gis.popupLoaded(\''+e+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>'):
void 0==c&&(c=i18n.gis_loading+'...<div class="throbber"></div>');var f=b.geometry.getBounds().getCenterLonLat();c=new OpenLayers.Popup.FramedCloud(e,f,new OpenLayers.Size(400,400),c,null,!0,Ja);b.popup=c;c.feature=b;c.maxSize=new OpenLayers.Size(750,660);f=b.layer.map;b.map=f;f.addPopup(c);d||void 0==a||aa(a,e+"_contentDiv",c);return c};S3.gis.addPopup=ba;S3.gis.popupLoaded=function(b){$("#"+b+"_contentDiv iframe").contents().find("#popup form").show();var a=S3.gis.maps,c,d;for(c in a){var e=a[c];
var f=e.popups;var g=0;for(d=f.length;g<d;g++)e=f[g],e.id==b&&e.updateSize(!0)}};var aa=function(b,a,c){0===b.indexOf("http://")&&(b=OpenLayers.ProxyHost+encodeURIComponent(b));$.ajaxS3({url:b,dataType:"html",success:function(b){try{$("#"+a).html(b),c.updateSize(),$("#"+a+" a.btn.iframe").click(function(){var b=$(this).attr("href");0===b.indexOf("http://")&&(b=OpenLayers.ProxyHost+encodeURIComponent(b));var c=a.slice(0,-11),b='<iframe src="'+b+'" onload="S3.gis.popupLoaded(\''+c+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>';
$("#"+a).html(b);return!1})}catch(e){}},error:function(b,e,f){msg="UNAUTHORIZED"==f?i18n.gis_requires_login:b.responseText;$("#"+a+"_contentDiv").html(msg);c.updateSize()}})},Ia=function(b){var a=b.feature,c=a.layer;var d=c.map;var e=d.s3;if(-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(c.name)&&-1==e.layers_nopopups.indexOf(c.name))if("openweathermap"==c.s3_layer_type){var f=c.options.getPopupHtml(a.attributes.station);
var g=new OpenLayers.Popup("Popup",a.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(c.options.popupX,c.options.popupY),f,"Station",!1);a.popup=g;g.feature=a;d.addPopup(g,!0)}else{var h=a.geometry;if("OpenLayers.Geometry.Point"!=h.CLASS_NAME){d=0;for(var l=e.clicking.length;d<l;++d)if("OpenLayers.Geometry.Point"==e.clicking[d].geometry.CLASS_NAME)return}Z(b);a.renderIntent="select";c.drawFeature(a);d=c.s3_layer_type;h=h.getBounds().getCenterLonLat();l=a.id+"_popup";b=void 0!=c.title?c.title:
"name";if(a.cluster){var k=a.cluster;var m=i18n.gis_cluster_multiple+":<ul>";var v=k.length,x=e.id;for(d=0;d<v;d++){var n=k[d].attributes;if(void 0!=c.s3_popup_format){_.templateSettings={interpolate:/\{(.+?)\}/g};e=c.s3_popup_format;g=_.template(e);var p={},r=e.split("{");for(e=0;e<r.length;e++){var u=r[e].split("}")[0];p[u]=""}_.defaults(n,p);e=g(n).split("<br/>",1)[0]}else e=void 0!=n.popup?n.popup.split("<br/>",1)[0]:n[b];void 0!=n.url?m+="<li><a href='javascript:S3.gis.loadClusterPopup(\""+x+
'", "'+n.url+'", "'+l+"\")'>"+e+"</a></li>":void 0!=c.s3_url_format?(_.templateSettings={interpolate:/\{(.+?)\}/g},g=_.template(c.s3_url_format),n.id.constructor===Array&&(n.id=n.id[0]),g=g(n),m+="<li><a href='javascript:S3.gis.loadClusterPopup(\""+x+'", "'+g+'", "'+l+"\")'>"+e+"</a></li>"):m+="<li>"+e+"</li>"}g=null;m+="</ul>";m+="<div align='center'><a href='javascript:S3.gis.zoomToSelectedFeature(\""+x+'", '+h.lon+","+h.lat+", 3)'>"+i18n.gis_zoomin+"</a></div>"}else if("kml"==d){n=a.attributes;
if(void 0!=a.style.balloonStyle)m=a.style.balloonStyle.replace(/{([^{}]*)}/g,function(a,b){var c=n[b];return"string"===typeof c||"number"===typeof c?c:a});else for(d=typeof n[b],d="object"==d?n[b].value:n[b],m="<h3>"+d+"</h3>",c=c.body.split(" "),e=0;e<c.length;e++){d=typeof n[c[e]];if("object"==d){b=n[c[e]].displayName;""===b&&(b=c[e]);d=n[c[e]].value;var t='<div class="gis_popup_row"><div class="gis_popup_label">'+b+':</div><div class="gis_popup_cell">'+d+"</div></div>"}else t=void 0!=n[c[e]]?'<div class="gis_popup_row">'+
n[c[e]]+"</div>":"";m+=t}-1!=m.search("<script")&&(m="Content contained Javascript! Escaped content below.<br />"+m.replace(/</g,"<"))}else if("gpx"!=d)if("shapefile"==d||"geojson"==d)n=a.attributes,m="<div>",$.each(n,function(a,b){"id_orig"==a&&(a="id");t='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_cell">'+b+"</div></div>";m+=t}),m+="</div>";else if("wfs"==d)n=a.attributes,d=n[b],m="<h3>"+d+"</h3>",$.each(n,function(a,b){t='<div class="gis_popup_row"><div class="gis_popup_label">'+
a+':</div><div class="gis_popup_val">'+b+"</div></div>";m+=t});else if(void 0!=a.attributes.url)g=a.attributes.url;else if(void 0!=c.s3_url_format)_.templateSettings={interpolate:/\{(.+?)\}/g},g=_.template(c.s3_url_format),a.attributes.id.constructor===Array&&(a.attributes.id=a.attributes.id[0]),g=g(a.attributes);else{n=a.attributes;e=void 0==n.name?"":"<h3>"+n.name+"</h3>";c=void 0==n.description?"":"<p>"+n.description+"</p>";d=void 0==n.link?"":'<a href="'+n.link+'" target="_blank">'+n.link+"</a>";
if(void 0==n.data)b="";else if(0===n.data.indexOf("http://")){var w=!0;f=S3.uid();b='<div id="'+f+'">'+i18n.gis_loading+"...<div class='throbber'></div></div>"}else b="<p>"+n.data+"</p>";h=void 0==n.image?"":0===n.image.indexOf("http://")?'<img src="'+n.image+'" height=300 width=300>':"";m=e+c+d+b+h}g=ba(a,g,m);w&&aa(a.attributes.data,f,g)}},Ja=function(b){if(b=this.feature){var a=b.layer;b.renderIntent="default";a&&a.drawFeature(b);b.popup&&(a&&a.map.removePopup(b.popup),b.popup.destroy(),delete b.popup);
if(b.id)$("#"+b.id+"_popup").remove();else{var c=b.map;if(c)for(var d=c.popups,e=d.length-1;-1<e;e--)c.removePopup(d[e])}a&&a.name==i18n.gis_draft_layer&&b.destroy()}};S3.gis.loadClusterPopup=function(b,a,c){var d="#"+c+"_contentDiv",e=$(d);e.html(i18n.gis_loading+"...<div class='throbber'></div>");var f=S3.gis.maps[b];$.getS3(a,function(a){e.html(a);f.popups[0].updateSize();a=$(d+" .dropdown-toggle");a.length&&(e.parent().css("overflow","visible").parent().css("overflow","visible"),a.dropdown())},
"html")};S3.gis.zoomToSelectedFeature=function(b,a,c,d){b=S3.gis.maps[b];a=new OpenLayers.LonLat(a,c);c=b.getZoom();b.setCenter(a,c+d);for(d=0;d<b.popups.length;d++)b.removePopup(b.popups[d])};var na=function(b){var a,c=b.s3,d=c.options,e=new Ext.Toolbar({height:34});e.map=b;c.portal.toolbar=e;OpenLayers.Control.ZoomToMaxExtentS3=OpenLayers.Class(OpenLayers.Control.Button,{trigger:function(){var a=new OpenLayers.Bounds.fromArray(d.restrictedExtent);a.transform(r,b.getProjectionObject());b.zoomToExtent(a)},
CLASS_NAME:"OpenLayers.Control.ZoomToMaxExtentS3"});var f=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtentS3,map:b,iconCls:"zoomfull",tooltip:i18n.gis_zoomfull}),g;if("active"==d.draw_polygon){var h=!0;var l=g=a=c=!1}else"active"==d.draw_line?(c=!0,l=h=a=g=!1):"active"==d.draw_feature?(g=!0,l=h=a=c=!1):"active"==d.draw_circle?(h=a=c=g=!1,l=!0):(a=!0,l=h=g=c=!1);e.add(f);i18n.gis_geoLocate&&navigator.geolocation&&Ka(e);if(void 0===d.nav){var f=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:!0}),
map:b,iconCls:"zoomout",tooltip:i18n.gis_zoomout,toggleGroup:"controls"}),k=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox,map:b,iconCls:"zoomin",tooltip:i18n.gis_zoominbutton,toggleGroup:"controls"});a=new GeoExt.Action({control:new OpenLayers.Control.Navigation,map:b,iconCls:"pan-off",tooltip:i18n.gis_pan,allowDepress:!0,toggleGroup:"controls",pressed:a});e.add(f);e.add(k);e.add(a);e.addSeparator();La(e)}d.print&&(e.addSeparator(),Ma(e));d.save&&"float"!=d.save&&(e.addSeparator(),Na(e));
e.addSeparator();Oa(e);"toolbar"==d.clear_layers&&W(b,e);d.mgrs_url&&Pa(e);if(d.draw_feature||d.draw_line||d.draw_polygon||d.draw_circle){e.addSeparator();if(a=S3.gis.poi_resources)var m=a.length;if(d.draw_feature)if(a)for(f=0;f<m;f++)k=a[f],"point"==k.t&&N(b,e,g,k);else N(b,e,g);if(d.draw_line)if(a)for(f=0;f<m;f++)k=a[f],"line"==k.t&&O(b,e,c,k);else O(b,e,c);if(d.draw_polygon)if(a)for(f=0;f<m;f++)k=a[f],"line"==k.t&&P(b,e,h,!0,k);else P(b,e,h,!0);if(d.draw_circle)if(a)for(f=0;f<m;f++)k=a[f],"circle"==
k.t&&Q(b,e,l,k);else Q(b,e,l);d.color_picker&&Qa(b,e)}i18n.gis_get_feature_info&&Ra(b);i18n.gis_potlatch&&Sa(e);d.Google&&d.Google.StreetviewButton&&Ta(e);d.geonames&&(m=!1===d.nav?d.map_width-500:d.map_width-680,m=Math.min(350,m),m=new GeoExt.ux.GeoNamesSearchCombo({map:b,width:m,listWidth:m,minChars:2,emptyText:i18n.gis_search,username:d.geonames}),e.addSeparator(),e.add(m));m=new Ext.BoxComponent({cls:"layer_throbber hide"});e.add(m);return e},Ka=function(b){var a=b.map,c=a.s3.draftLayer,d={fillColor:"#000",
fillOpacity:.1,strokeWidth:0},e=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:7E3}});a.addControl(e);e.events.register("locationupdated",this,function(b){c.removeAllFeatures();var e=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(b.point.x,b.point.y),b.position.coords.accuracy/2,40,0),{},d);c.addFeatures([new OpenLayers.Feature.Vector(b.point,{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,
fillOpacity:0,pointRadius:10}),e]);a.zoomToExtent(c.getDataExtent());Ua(a,e)});e.events.register("locationfailed",this,function(){OpenLayers.Console.log("Location detection failed")});var f=new Ext.Button({iconCls:"geolocation",tooltip:i18n.gis_geoLocate,handler:function(){c.removeAllFeatures();e.activate()}});b.addButton(f)},Ua=function(b,a){var c=a.geometry.getCentroid(),d=a.geometry.getBounds(),e=Math.abs((d.right-d.left)/2),f=0,g="up";window.resizeInterval=window.setInterval(function(){16<f&&
clearInterval(window.resizeInterval);var d=.03*e/e;switch(f){case 4:case 12:g="down";break;case 8:g="up"}"up"!==g&&(d=-Math.abs(d));a.geometry.resize(1+d,c);b.s3.draftLayer.drawFeature(a);f++},50,c,e)},Ta=function(b){var a=b.map;StreetviewClicker=new (OpenLayers.Class(OpenLayers.Control,{defaults:{pixelTolerance:1,stopSingle:!0},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,
{click:this.trigger},this.handlerOptions)},trigger:function(b){(b=a.getLonLatFromViewPortPx(b.xy))||(b=a.getCenter());a.s3.sv_popup&&a.s3.sv_popup.anc&&a.s3.sv_popup.close();a.s3.sv_popup=new GeoExt.Popup({title:a.s3.options.Google.StreetviewTitle,location:b,width:300,height:300,collapsible:!0,map:a.s3.mapPanel,items:[new gxp.GoogleStreetViewPanel]});a.s3.sv_popup.show()}}))({autoactivate:!1});a.addControl(StreetviewClicker);var c=new Ext.Button({iconCls:"streetview",tooltip:a.s3.options.Google.StreetviewButton,
allowDepress:!0,enableToggle:!0,toggleGroup:"controls",toggleHandler:function(a,b){!0===b?StreetviewClicker.activate():StreetviewClicker.deactivate()}});b.addSeparator();b.addButton(c)},Oa=function(b){var a=b.map,c=new OpenLayers.Style;c.addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:5,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#f5902e"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#f5902e",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,
strokeOpacity:1,strokeColor:"#f5902e",fillColor:"white",fillOpacity:.5}}})]);var c=new OpenLayers.StyleMap({"default":c}),d=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:c}}});d.events.on({measure:function(a){alert(i18n.gis_length_message+" "+a.measure.toFixed(2)+" "+a.units)}});d=new GeoExt.Action({control:d,map:a,iconCls:"measure-off",tooltip:i18n.gis_length_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"});b.add(d);
!1===a.s3.options.area&&(c=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:c}}}),c.events.on({measure:function(a){alert(i18n.gis_area_message+" "+a.measure.toFixed(2)+" "+a.units+"2")}}),a=new GeoExt.Action({control:c,map:a,iconCls:"measure-area",tooltip:i18n.gis_area_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"}),b.add(a))},ma=function(b){var a=b.s3.id;$("#"+a).append('<div class="map_legend_div"><div class="map_legend_tab right"></div><div class="map_legend_panel"></div></div>');
var c=new GeoExt.LegendPanel({title:i18n.gis_legend,autoScroll:!0,border:!1}),d=$("#"+a+" .map_legend_panel"),d=Ext.get(d[0]);c.render(d);$("#"+a+" .map_legend_tab").click(function(){if($(this).hasClass("right")){var a=b.s3.id,c=$("#"+a+" .map_legend_panel").outerWidth();$("#"+a+" .map_legend_div").animate({marginRight:"-"+c+"px"});$("#"+a+" .map_legend_tab").removeClass("right").addClass("left")}else Y(b)});return c},Y=function(b){b=b.s3.id;$("#"+b+" .map_legend_div").animate({marginRight:0});$("#"+
b+" .map_legend_tab").removeClass("left").addClass("right")},La=function(b){var a=new OpenLayers.Control.NavigationHistory;b.map.addControl(a);a.activate();var c=new Ext.Button({iconCls:"back",tooltip:i18n.gis_navPrevious,handler:a.previous.trigger}),a=new Ext.Button({iconCls:"next",tooltip:i18n.gis_navNext,handler:a.next.trigger});b.addButton(c);b.addButton(a)},N=function(b,a,c,d){OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(a){return!0},CLASS_NAME:"OpenLayers.Handler.PointS3"});
var e=b.s3.draftLayer,f=new OpenLayers.Control.DrawFeature(e,OpenLayers.Handler.PointS3,{featureAdded:function(a){for(b.s3.lastDraftFeature?b.s3.lastDraftFeature.destroy():1<e.features.length&&e.features[0].destroy();0<b.popups.length;)b.removePopup(b.popups[0]);void 0!=b.s3.pointPlaced&&b.s3.pointPlaced(a,d);b.s3.lastDraftFeature=a}});if(a){var g=d&&d.l?d.l:i18n.gis_draw_feature;var h=b.s3.id,l=new GeoExt.Action({control:f,handler:function(){if(l.items[0].pressed){$("#"+h+"_panel .olMapViewport").addClass("crosshair");
var a=$("#"+h+"_panel .gis_colorpicker");a.length&&a.spectrum("disable")}else $("#"+h+"_panel .olMapViewport").removeClass("crosshair")},map:b,iconCls:"drawpoint-off",tooltip:g,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:c});a.add(l);c&&($("#"+h+"_panel .olMapViewport").addClass("crosshair"),a=$("#"+h+"_panel .gis_colorpicker"),a.length&&a.spectrum("disable"));b.s3.pointButton=l}else b.addControl(f),c&&(f.activate(),$("#"+b.s3.id+"_panel .olMapViewport").addClass("crosshair"))},
O=function(b,a,c,d){var e=b.s3.draftLayer,f=new OpenLayers.Control.DrawFeature(e,OpenLayers.Handler.Path,{featureAdded:function(a){for(b.s3.lastDraftFeature?b.s3.lastDraftFeature.destroy():1<e.features.length&&e.features[0].destroy();0<b.popups.length;)b.removePopup(b.popups[0]);void 0!=b.s3.pointPlaced&&b.s3.pointPlaced(a,d);b.s3.lastDraftFeature=a}});if(a){var g=d&&d.l?d.l:i18n.gis_draw_line;var h=b.s3.id;var l=new GeoExt.Action({control:f,handler:function(){if(l.items[0].pressed){$("#"+h+"_panel .olMapViewport").addClass("crosshair");
var a=$("#"+h+"_panel .gis_colorpicker");a.length&&a.spectrum("enable")}else $("#"+h+"_panel .olMapViewport").removeClass("crosshair"),a=$("#"+h+"_panel .gis_colorpicker"),a.length&&a.spectrum("disable")},map:b,iconCls:"drawline-off",tooltip:g,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:c,activateOnEnable:!0,deactivateOnDisable:!0});a.add(l);b.s3.lineButton=l}else b.addControl(f),c&&(f.activate(),$("#"+b.s3.id+"_panel .olMapViewport").addClass("crosshair"))},P=function(b,a,c,d,
e){var f=b.s3,g=f.draftLayer;d=new OpenLayers.Control.DrawFeature(g,d?OpenLayers.Handler.Polygon:OpenLayers.Handler.RegularPolygon,{handlerOptions:d?{sides:4,snapAngle:90}:{},featureAdded:function(a){f.lastDraftFeature?f.lastDraftFeature.destroy():1<g.features.length&&g.features[0].destroy();var c=$("#gis_location_wkt");if(c.length){var d=a.geometry.transform(b.getProjectionObject(),r).toString();c.val(d);$("#gis_location_lat").val("");$("#gis_location_lon").val("")}for(;0<b.popups.length;)b.removePopup(b.popups[0]);
void 0!=f.pointPlaced&&f.pointPlaced(a,e);f.lastDraftFeature=a}});var h=f.id;if(a){var l=e&&e.l?e.l:i18n.gis_draw_polygon;var k=new GeoExt.Action({control:d,handler:function(){var a=k.items[0];a.pressed?(k.setIconClass("drawpolygonclear-off"),a.tooltip=i18n.gis_draw_polygon_clear,a.setTooltip(i18n.gis_draw_polygon_clear),$("#"+h+"_panel .olMapViewport").addClass("crosshair"),a=$("#"+h+"_panel .gis_colorpicker"),a.length&&a.spectrum("enable")):(k.setIconClass("drawpolygon-off"),a.tooltip=l,a.setTooltip(l),
$("#"+h+"_panel .olMapViewport").removeClass("crosshair"),a=$("#"+h+"_panel .gis_colorpicker"),a.length&&a.spectrum("disable"),f.lastDraftFeature?f.lastDraftFeature.destroy():1<g.features.length&&g.features[0].destroy(),void 0!=f.polygonButtonOff&&f.polygonButtonOff())},map:b,iconCls:"drawpolygon-off",tooltip:l,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:c,activateOnEnable:!0,deactivateOnDisable:!0});a.add(k);f.polygonButton=k}else b.addControl(d),c&&(d.activate(),$("#"+h+"_panel .olMapViewport").addClass("crosshair"),
ca(h,d))},ca=function(b,a){if(void 0===a){var c,d=S3.gis.maps[b].controls;var e=0;for(c=d.length;e<c&&(a=d[e],"OpenLayers.Control.DrawFeature"!=a.CLASS_NAME);e++);}$("#"+b).append('<div class="map_polygon_panel">Click anywhere on the map to begin drawing. Double click to complete the area or click the Finish button below.<div class="map_polygon_buttons"><a class="button small map_polygon_finish">Finish</a><a class="button small map_polygon_clear">Clear</a></div></div>');var f=S3.gis.maps[b].s3;$("#"+
b+" .map_polygon_finish").click(function(){a.finishSketch();void 0!=f.polygonPanelFinish?f.polygonPanelFinish():(f.lastDraftFeature?f.lastDraftFeature.destroy():1<f.draftLayer.features.length&&f.draftLayer.features[0].destroy(),a.deactivate(),$("#"+b+"_panel .olMapViewport").removeClass("crosshair"))});$("#"+b+" .map_polygon_clear").click(function(){f.lastDraftFeature?f.lastDraftFeature.destroy():1<f.draftLayer.features.length&&f.draftLayer.features[0].destroy();a.deactivate();$("#"+b+"_panel .olMapViewport").removeClass("crosshair");
void 0!=f.polygonPanelClear&&f.polygonPanelClear()});return a};S3.gis.addPolygonPanel=ca;var Q=function(b,a,c,d){var e=b.s3.draftLayer,f=new OpenLayers.Control.DrawFeature(e,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:1E3},featureAdded:function(a){for(b.s3.lastDraftFeature?b.s3.lastDraftFeature.destroy():1<e.features.length&&e.features[0].destroy();0<b.popups.length;)b.removePopup(b.popups[0]);void 0!=b.s3.pointPlaced&&b.s3.pointPlaced(a,d);b.s3.lastDraftFeature=a}});if(a){var g=d&&d.l?
d.l:i18n.gis_draw_circle;var h=b.s3.id;var l=new GeoExt.Action({control:f,handler:function(){if(l.items[0].pressed){$("#"+h+"_panel .olMapViewport").addClass("crosshair");var a=$("#"+h+"_panel .gis_colorpicker");a.length&&a.spectrum("enable")}else $("#"+h+"_panel .olMapViewport").removeClass("crosshair"),a=$("#"+h+"_panel .gis_colorpicker"),a.length&&a.spectrum("disable")},map:b,iconCls:"drawcircle-on",tooltip:g,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:c,activateOnEnable:!0,
deactivateOnDisable:!0});a.add(l);b.s3.circleButton=l}else b.addControl(f),c&&(f.activate(),$("#"+b.s3.id+"_panel .olMapViewport").addClass("crosshair"))},Va=function(b){var a=new jQuery.Deferred,c=S3.gis.maps[b].s3;setTimeout(function e(){void 0!=c.mapWin?a.resolve("loaded"):"pending"===a.state()&&(a.notify("waiting for JS to load..."),setTimeout(e,500))},1);return a.promise()},da=function(b){b=parseInt(b,16);return[b>>16&255,b>>8&255,b&255].join()},Qa=function(b,a){var c=b.s3,d=c.id;var e=(e=c.options.draft_style)?
e.fillOpacity?"rgba("+da(e.fill)+","+e.fillOpacity+")":"rgb("+da(e.fill)+")":"";e=new Ext.Toolbar.Item({html:'<input class="gis_colorpicker" name="colour" value="'+e+'"/>'});a.add(e);$.when(Va(d)).then(function(a){$("#"+d+"_panel .gis_colorpicker").spectrum({showInput:!0,showInitial:!0,preferredFormat:"rgb",showPaletteOnly:!0,togglePaletteOnly:!0,palette:"rgba(255, 0, 0, .5);rgba(255, 165, 0, .5);rgba(255, 255, 0, .5);rgba(0, 255, 0, .5);rgba(0, 0, 255, .5);rgba(255, 255, 255, .5);rgba(0, 0, 0, .5)".split(";"),
showAlpha:!0,cancelText:i18n.gis_cancelText,chooseText:i18n.gis_chooseText,togglePaletteMoreText:i18n.gis_togglePaletteMoreText,togglePaletteLessText:i18n.gis_togglePaletteLessText,clearText:i18n.gis_clearText,noColorSelectedText:i18n.gis_noColorSelectedText,change:function(a){var d={fill:Number(16777216+65536*Math.round(a._r)+256*Math.round(a._g)+Math.round(a._b)).toString(16).substring(1)};1!=a._a&&(d.fillOpacity=a._a);a=J(b,{style:d,opacity:.9})[0];d=c.draftLayer;d.styleMap=a;d.redraw()}})},function(a){s3_debug(a)},
function(a){s3_debug(a)})},Sa=function(b){var a=b.map,c=new Ext.Button({iconCls:"potlatch",tooltip:i18n.gis_potlatch,handler:function(){var b=a.getZoom();if(14>b)alert(i18n.gis_osm_zoom_closer);else{var c=a.getCenter();c.transform(a.getProjectionObject(),r);b=S3.Ap.concat("/gis/potlatch2/potlatch2.html")+"?lat="+c.lat+"&lon="+c.lon+"&zoom="+b;window.open(b)}}});b.addSeparator();b.addButton(c)},Ma=function(b){var a=b.map,c=a.s3.id,d=new Ext.Button({iconCls:"print",tooltip:i18n.gis_print_tip,menu:{xtype:"menu",
plain:!0,items:[{xtype:"form",bodyPadding:5,items:[{xtype:"combo",allowBlank:!1,displayField:"label",fieldLabel:i18n.gis_paper_size,getListParent:function(){return this.el.up(".x-menu")},hiddenName:"size",id:c+"_paper_size",lazyInit:!1,mode:"local",selectOnFocus:!0,store:new Ext.data.ArrayStore({id:0,fields:["size","label"],data:[["Letter","Letter (2550 x 3300)"],["A4","A4 (2480 x 3508)"],["A3","A3 (3508 x 4962)"],["A2","A2 (4962 x 7017)"],["A1","A1 (7017 x 9933)"],["A0","A0 (9933 x 14061)"]]}),triggerAction:"all",
typeAhead:!0,value:"Letter",valueField:"size"},{xtype:"button",text:i18n.gis_print,handler:function(){var b=$("#x-form-el-"+c+'_paper_size input[name="size"]').val();if("Letter"==b){var d=2550;var g=3300}else"A4"==b?(d=2480,g=3508):"A3"==b?(d=3508,g=4962):"A2"==b?(d=4962,g=7017):"A1"==b?(d=7017,g=9933):"A0"==b&&(d=9933,g=14061);var h=a.getExtent();g=new OpenLayers.Size(g,d);h=Math.max(h.getWidth()/g.w,h.getHeight()/g.h);h=a.baseLayer.getZoomForResolution(h);h=R(a,!0,h);b=S3.Ap.concat("/gis/screenshot/"+
h+"?size="+b);window.open(b)}}]}]}});b.addButton(d)},Na=function(b){var a=new Ext.Button({iconCls:"save",tooltip:i18n.gis_save,handler:function(){R(b.map)}});b.addButton(a)},oa=function(b){var a=b.s3,c=a.id;if(!$("#"+c+" .map_save_panel").length){var d='<div class="fleft"><div class="map_save_name">';(a=a.options.config_name)&&(d+=a);d='<div class="map_save_panel off">'+(d+"</div></div>")+'<div class="btn map_save_button"><div class="map_save_label">'+i18n.gis_save_map+"</div></div></div>";$("#"+
c).append(d);a&&$("#"+c+" .map_save_panel").removeClass("off");$("#"+c+" .map_save_button").click(function(){ea(b)})}},ea=function(b){var a=b.s3.id;$("#"+a+" .map_save_panel").removeClass("off");$("#"+a+" .map_save_panel .saved").remove();$("#"+a+" .map_save_panel .fleft").show();$("#"+a+" .map_save_label").html(i18n.save);fa(b)},fa=function(b){var a=b.s3;var c=a.id,d=a.options,e=d.config_id;var f=d.config_name?d.config_name:"";var g=$("#"+c+" .map_save_button"),h=c+"_save";a=$("#"+h);a.length||(a=
'<div class="hint">'+('<label for="'+h+'">'+i18n.gis_name_map+"</label>")+('<input id="'+h+'" value="'+f+'">')+"</div>",f='<div class="new_map"><input type="checkbox" class="checkbox"'+(e?"":' disabled="disabled" checked="checked"')+">"+i18n.gis_new_map+"</div>",$("#"+c+" .map_save_panel .fleft").html(a+f),$("#"+c+" .map_save_panel label").labelOver("over"));g.unbind("click").click(function(){R(b);var a=$("#"+c+"_save").val();$("#"+c+" .map_save_name").html(a);d.config_name=a;a=d.pe_id?"?~.pe_id__belongs="+
d.pe_id:"";a='<div class="saved"><p><i>'+i18n.saved+'</i></p><p><a href="'+S3.Ap.concat("/gis/config")+a+'">'+i18n.gis_my_maps+"</a></p></div>";$("#"+c+" .map_save_panel .fleft").hide().before(a);$("#"+c+" .map_save_panel .checkbox").prop("checked",!1).prop("disabled",!1);g.unbind("click").click(function(){ea(b)})});var l=$("#"+c+" .map_save_panel");$("html").unbind("click.cancelSave").bind("click.cancelSave",function(){l.addClass("off");g.unbind("click").click(function(){l.removeClass("off").unbind("click");
fa(b)})});l.click(function(a){a.stopPropagation()})},R=function(b,a,c){var d=b.s3;var e=d.id;L(e);var f=Wa(b),g=JSON.stringify,h=g(f.layers),g=g(f.plugins);c={lat:f.lat,lon:f.lon,zoom:c||f.zoom,layers:h,plugins:g};var l=d.options;l.pe_id&&(c.pe_id=l.pe_id);if(a)e=!1,c.temp=1;else{d=$("#"+e+"_save");var k=l.config_id;d.length?(c.hide=1,c.name=d.val(),e=k?!$("#"+e+' .map_save_panel input[type="checkbox"]').prop("checked"):!1):e=k?!0:!1}e=e?S3.Ap.concat("/gis/config/"+k+".url/update"):S3.Ap.concat("/gis/config.url/create");
$.ajaxS3({async:!1,url:e,type:"POST",data:c,dataType:"json",success:function(b,c){k=b.id;if(!a&&k){l.config_id=k;if(history.pushState)if(document.location.search){var d=document.location.search.split("?")[1].split("&");for(var e,f=0;f<d.length;f++)if(e=d[f].split("="),"config"==decodeURIComponent(e[0])&&decodeURIComponent(e[1])!=k){d[f]="config="+k;d=document.location.pathname+"?"+d.join("&");window.history.pushState({},document.title,d);break}}else if(document.location.pathname==S3.Ap.concat("/gis/index")||
document.location.pathname==S3.Ap.concat("/gis/map_viewing_client"))d=document.location.pathname+"?config="+k,window.history.pushState({},document.title,d);d=S3.Ap.concat("/gis/config/",k,"/layer_entity");$("#gis_menu_config").attr("href",d)}}});I(null,b);return k},Wa=function(b){var a={},c=b.getCenter();c.transform(b.getProjectionObject(),r);a.lon=c.lon;a.lat=c.lat;a.zoom=b.getZoom();var d=[],e,f,g=b.baseLayer.s3_layer_id;Ext.iterate(b.layers,function(a,b,c){e=a.s3_layer_id;f={id:e};a.visibility&&
(f.visible=a.visibility);e==g&&(f.base=!0);a.s3_style&&(f.style=a.s3_style);a.dir&&(f.dir=a.dir);d.push(f)});a.layers=d;var h=[];Ext.iterate(b.s3.plugins,function(a,b,c){a.getState&&h.push(a.getState())});a.plugins=h;return a},Pa=function(b){var a=b.map,c=a.s3.options;selectPdfControl=new OpenLayers.Control;OpenLayers.Util.extend(selectPdfControl,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{done:this.getPdf});this.box.activate()},response:function(a){this.w.destroy();a=(new OpenLayers.Format.GML).read(a.responseText);
var b=a.length+" pdfs. <br /><ul>";if(a.length)for(var c=0;c<a.length;c++)var d=a[c],b=b+("<li><a href='"+a[c].attributes.url+"'>"+(d.attributes.utm_zone+d.attributes.grid_zone+d.attributes.grid_square+d.attributes.easting+d.attributes.northing)+"</a></li>");this.w=new Ext.Window({html:b+"</ul>",width:300,title:"Results",height:200});this.w.show()},getPdf:function(b){var d=a.getProjectionObject(),e=a.getLonLatFromPixel(new OpenLayers.Pixel(b.left,b.bottom)).transform(d,r);b=a.getLonLatFromPixel(new OpenLayers.Pixel(b.right,
b.top)).transform(d,r);bbox=(new OpenLayers.Bounds(e.lon,e.lat,b.lon,b.lat)).toBBOX();OpenLayers.Request.GET({url:c.mgrs_url+"&bbox="+bbox,callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({html:"Searching "+c.mgrs_name+", please wait.",width:200,title:"Please Wait."});this.w.show()}});var d="Select "+c.mgrs_name,d=new GeoExt.Action({text:d,control:selectPdfControl,map:a,allowDepress:!1,toggleGroup:"controls",tooltip:d});b.addSeparator();b.add(d)},Ra=function(b){var a=
new gxp.plugins.WMSGetFeatureInfo({actionTarget:"toolbar",outputTarget:"map",outputConfig:{width:400,height:200},toggleGroup:"controls",infoActionTip:i18n.gis_get_feature_info,popupTitle:i18n.gis_feature_info});a.target=b.s3;a.addActions()},pa=function(b,a){var c=new gxp.plugins.AddLayers({actionTarget:"treepanel.tbar",addActionTip:"Add layers",addActionMenuText:"Add layers",addServerText:"Add a New Server",doneText:"Done",upload:{url:null},uploadText:i18n.gis_uploadlayer,relativeUploadOnly:!1}),
d=new GeoExt.data.LayerStore;c.target=a;a.proxy=OpenLayers.ProxyHost;a.layerSources={};a.layerSources.local=new gxp.plugins.LayerSource({title:"local",store:d});c.addActions()[0].enable();c=new gxp.plugins.RemoveLayer({actionTarget:"treepanel.tbar",removeActionTip:"Remove layer"});c.target=a;a.mapPanel=b.s3.mapPanel;c.addActions()},qa=function(b,a){var c=b.s3.propertiesWindow,d=new Ext.Button({iconCls:"gxp-icon-layerproperties",tooltip:i18n.gis_properties,handler:function(){var d=a.root.findChildBy(function(a){return a.isSelected()?
a.leaf?!0:!1:!1},null,!0);if(d){var f=d.layer.s3_layer_type,g=S3.Ap.concat("/gis/layer_"+f+".plain?layer_"+f+".layer_id="+d.layer.s3_layer_id+"&update=1");Ext.Ajax.request({url:g,method:"GET",success:function(a,e){c&&c.close();if("feature"==f){var g=new Ext.TabPanel({activeTab:0,items:[{title:"Layer Properties",html:a.responseText},{title:"Filter",id:"s3_gis_layer_filter_tab",html:""}]});g.items.items[1].on("activate",function(){var a;Ext.iterate(b.s3.layers_feature,function(b,c,e){b.id==d.layer.s3_layer_id&&
(a=b.url.replace(/.geojson.+/,"/search.plain"))});Ext.get("s3_gis_layer_filter_tab").load({url:a,discardUrl:!1,callback:function(){S3.redraw()},text:"Loading...",timeout:30,scripts:!1})})}else g=new Ext.Panel({title:"Layer Properties",html:a.responseText});c=new Ext.Window({width:400,layout:"fit",items:[g]});c.show();$("#plain form").submit(function(){var a=$('#plain input[name="id"]').val(),a=S3.Ap.concat("/gis/layer_"+f+"/"+a+".plain/update"),b=$("#plain input"),c=[];Ext.iterate(b,function(a,b,
d){b.id&&-1!=b.id.indexOf("gis_layer_")&&c.push(b.id)});b=[];for(i=0;i<c.length;i++)(q=$("#"+c[i]).serialize())&&b.push(q);(q=$('#plain input[name="id"]').serialize())&&b.push(q);(q=$('#plain input[name="_formkey"]').serialize())&&b.push(q);(q=$('#plain input[name="_formname"]').serialize())&&b.push(q);0<b.length&&(b=b.join("&"),$.ajaxS3({type:"POST",url:a,data:b,success:function(a){$("#plain").html(a)}}));return!1});S3.addTooltips();S3.autocomplete.normal("role","admin","group","gis_layer_"+f+"_role_required")}})}}});
a.getTopToolbar().add(d)},W=function(b,a){var c=new Ext.Button({iconCls:"icon-clearlayers",tooltip:i18n.gis_clearlayers,handler:function(){layers=b.layers;i=0;for(len=layers.length;i<len;i++)layer=layers[i],layer.isBaseLayer||layer.setVisibility(!1)}});a.add(c)},J=function(b,a){if(void 0!=a.marker){var c=a.marker;var d=t+c.i;var e=c.h;var f=c.w}else d="";var g=a.opacity||1,h=a.style;var l="[object Array]"===Object.prototype.toString.call(h)?!0:!1;var k=b.s3.options;c=new OpenLayers.Style({label:"${label}",
labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:"${fillOpacity}",strokeColor:"${stroke}",strokeDashstyle:"${strokeDashstyle}",strokeWidth:"${strokeWidth}",strokeOpacity:"${strokeOpacity}",graphicHeight:"${graphicHeight}",graphicWidth:"${graphicWidth}",graphicName:"${graphicName}",graphicOpacity:g,graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicZIndex:"${graphicZIndex}",externalGraphic:"${externalGraphic}",zIndex:"${zIndex}"},{context:{graphicWidth:function(a){var b=
1;a.cluster||(a.attributes.marker_width?b=a.attributes.marker_width:h&&!l&&void 0==h.externalGraphic&&void 0==f&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=k.marker_default.w:void 0!=f&&(b=f));return b},graphicHeight:function(a){var b=1;a.cluster||(a.attributes.marker_height?b=a.attributes.marker_height:h&&!l&&void 0==h.externalGraphic&&void 0==e&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=k.marker_default.h:void 0!=e&&(b=e));return b},graphicXOffset:function(a){var b=-1;a.cluster||
(a.attributes.marker_width?b=-(a.attributes.marker_width/2):h&&!l&&void 0==h.externalGraphic&&void 0==f&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=-(k.marker_default.w/2):void 0!=f&&(b=-(f/2)));return b},graphicYOffset:function(a){var b=-1;a.cluster||(a.attributes.marker_height?b=-a.attributes.marker_height:h&&!l&&void 0==h.externalGraphic&&void 0==e&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=-k.marker_default.h:void 0!=e&&(b=-e));return b},graphicName:function(a){var b="circle";
a.cluster||(a.attributes.shape?b=a.attributes.shape:h&&!l&&void 0!=h.graphic&&(b=h.graphic));return b},externalGraphic:function(a){var b="";if(!a.cluster)if(a.attributes.marker_url)b=a.attributes.marker_url;else if(h){if(!l)if(void 0!=h.externalGraphic)b=S3.Ap.concat("/static/"+h.externalGraphic);else if("OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME){if(d)return d;b=t+k.marker_default.i}}else if("OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME)return d;return b},radius:function(a){var b=10;
a.cluster?b=Math.min(a.attributes.count/2,8)+10:a.attributes.size?b=a.attributes.size:h&&!l&&(b=h.size);return b},fill:function(a){if(a.cluster)var b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#"+(k.cluster_fill||"8087ff");else a.attributes.colour?b=a.attributes.colour:a.attributes.style?(b=a.attributes.style.fill,b=void 0!=b?"#"+b:"#000000"):h?(l||(b=h.fill),b=void 0!=b?"#"+b:"#000000"):b="#f5902e";return b},fillOpacity:function(a){if(a.cluster)var b=a.cluster[0].attributes.opacity?
a.cluster[0].attributes.opacity:g;else a.attributes.opacity?b=a.attributes.opacity:a.attributes.style?b=a.attributes.style.fillOpacity:h&&!l&&(b=h.fillOpacity);return b||g},stroke:function(a){if(a.cluster)var b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#"+(k.cluster_stroke||"2b2f76");else a.attributes.colour?b=a.attributes.colour:a.attributes.style?(a=a.attributes.style,b=a.stroke||a.fill,b=void 0!=b?"#"+b:"#000000"):h?(l||(b=h.stroke||h.fill),b=void 0!=b?"#"+b:"#000000"):b="#f5902e";
return b},strokeOpacity:function(a){if(a.cluster)var b=a.cluster[0].attributes.opacity?a.cluster[0].attributes.opacity:g;else a.attributes.opacity?b=a.attributes.opacity:h&&!l&&(b=h.strokeOpacity);return b||g},strokeDashstyle:function(a){if(h&&!l)var b=h.strokeDashstyle;return b||"solid"},strokeWidth:function(a){var b=2;a.cluster?a.cluster[0].attributes.strokeWidth&&(b=a.cluster[0].attributes.strokeWidth):h&&!l&&(b=h.strokeWidth);return b||2},label:function(a){if(a.cluster){if(k.cluster_label&&1<
a.attributes.count)var b=a.attributes.count}else a.layer&&void 0!=a.layer.s3_style&&(a=a.layer.s3_style,!l&&a.show_label&&(b=a.label));return b||""},zIndex:function(a){return"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?10:"OpenLayers.Geometry.Line"==a.geometry.CLASS_NAME?5:0},graphicZIndex:function(a){return"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?10:"OpenLayers.Geometry.Line"==a.geometry.CLASS_NAME?5:0}}});if(l){var m=X(a);c.addRules(m)}1!=g?(m=Math.min(2*g,.8),m={fillOpacity:m,graphicOpacity:m}):
m={fillColor:"#"+(k.select_fill||"ffdc33"),strokeColor:"#"+(k.select_stroke||"ff9933")};return[new OpenLayers.StyleMap({"default":c,select:m}),d]},X=function(b){var a=[],c,d,e,f,g,h,l,k,m,p,r,n;$.each(b.style,function(w,u){var v={};void 0!=u.fallback?(v.title=u.fallback,elsefilter=v.elseFilter=!0):(c=void 0!=u.prop?u.prop:"value",void 0!=u.cat?(d=u.cat,v.title=u.label||d,v.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:c,value:d})):(v.title=u.label||u.low+
"-"+u.high,v.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:c,lowerBoundary:u.low,upperBoundary:u.high})));void 0!=u.externalGraphic?(g=!0,m=!1):void 0!=u.size?(g=!0,m=!1):g=!1;void 0!=u.fill?(m=!1,e="#"+u.fill):void 0!=u.stroke&&(m=!0,e="#"+u.stroke);f=void 0!=u.fillOpacity?u.fillOpacity:b.opacity||1;p=void 0!=u.strokeOpacity?u.strokeOpacity:1;graphic=void 0!=u.graphic?u.graphic:"square";r=void 0!=u.strokeWidth?u.strokeWidth:2;n={fillColor:e,fillOpacity:f,
strokeColor:e,strokeOpacity:p,strokeWidth:r,graphicName:graphic};if(g){if(void 0!=u.externalGraphic){h=S3.Ap.concat("/static/"+u.externalGraphic);var x=new Image;x.src=h;l=x.height;k=x.width;n.externalGraphic=h;n.graphicHeight=l;n.graphicWidth=k;n.graphicXOffset=-(k/2);n.graphicYOffset=-l}n.pointRadius=u.size||10;n.graphicZIndex=10;n.zIndex=10;n.Point=n}else m&&(n.graphicZIndex=5,n.zIndex=5,n.Line=n,void 0!=u.strokeDashstyle&&(n.strokeDashstyle=u.strokeDashstyle));v.symbolizer=n;t=new OpenLayers.Rule(v);
a.push(t)});if(0!=b.cluster_threshold){var t=new OpenLayers.Rule({elseFilter:!0,title:" "});a.push(t)}return a}})();
