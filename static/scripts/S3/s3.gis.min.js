S3.gis.maps={};S3.gis.timeouts={};S3.gis.proj4326=new OpenLayers.Projection("EPSG:4326");OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";OpenLayers.ProxyHost=S3.Ap.concat("/gis/proxy?url=");
(function(){var D=new OpenLayers.Format.GeoJSON;D.ignoreExtraDims=!0;var E=S3.Ap.concat("/static/img/markers/"),u=S3.gis.proj4326;S3.gis.show_map=function(c,a){c||(c="default_map");void 0==a&&(a=S3.gis.options[c]);var b=a.projection,d=new OpenLayers.Projection("EPSG:"+b);a.projection_current=d;900913==b?(a.maxExtent=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7),a.maxResolution=156543.0339,a.units="m"):4326==b?(a.maxExtent=new OpenLayers.Bounds(-180,-90,180,90),a.maxResolution=
1.40625,a.units="degrees"):(b=a.maxExtent.split(","),a.maxExtent=new OpenLayers.Bounds(b[0],b[1],b[2],b[3]),a.maxResolution="auto");var b=a.lat,e=a.lon;if(void 0!=b&&void 0!=e){var f,b=new OpenLayers.LonLat(e,b);b.transform(u,d)}else f=OpenLayers.Bounds.fromArray(a.bbox),b=f.getCenterLonLat();a.center=b;void 0===a.cluster_label&&(a.cluster_label=!0);b=Z(c,a);b.Z_INDEX_BASE.Popup=800;a.renderTo=c+"_panel";aa(b);f&&(f.transform(u,d),b.zoomToExtent(f));b.events.on({movestart:function(a){S3.hideAlerts("warning")}});
$.when(ba(c)).then(function(a){setTimeout(function(){S3.gis.maps[c].s3.loaded=!0},800)},function(a){s3_debug(a)},function(a){s3_debug(a)});return b};var ba=function(c){var a=new jQuery.Deferred,b=S3.gis.maps[c].s3.layers_loading;setTimeout(function e(){0==b.length?a.resolve("loaded"):"pending"===a.state()&&(a.notify("waiting for Layers to load..."),setTimeout(e,500))},1);return a.promise()},I=function(c,a){var b=a.toArray(),d=b[0],e=b[1],f=b[2],b=b[3],g=(.05-(f-d))/2;0<g&&(d-=g,f+=g);g=(.05-(b-e))/
2;0<g&&(e-=g,b+=g);a=new OpenLayers.Bounds(d-.007,e-.007,f+.007,b+.007);a.transform(u,c.getProjectionObject());c.zoomToExtent(a)};S3.gis.zoomBounds=I;var F=function(c){c=c.object;var a=c.getDataExtent();if(a){var b=c.map;a.transform(b.getProjectionObject(),u);I(b,a)}for(var b=c.strategies,d=0,e=b.length;d<e;d++)if(a=b[d],"OpenLayers.Strategy.AttributeCluster"==a.CLASS_NAME){a.activate();a.features=c.features;a.recluster();break}c.events.un({loadend:F})};S3.gis.search_layer_loadend=F;S3.gis.refreshLayer=
function(c,a){var b=S3.gis.maps,d,e,f,g,h,l,m,n,p,k;for(d in b)for(e=b[d],f=e.layers,g=0,h=f.length;g<h;g++)if(l=f[g],l.s3_layer_id==c&&(m=l.protocol.url,m=S3.search.filterURL(m,a),l.protocol.options.url=m,e.s3.mapWin.isVisible())){l.events.on({loadend:F});m=l.strategies;p=m.length;for(n=0;n<p;n++)if(k=m[n],"OpenLayers.Strategy.AttributeCluster"==k.CLASS_NAME){k.deactivate();break}if(l.visibility)for(n=0;n<p;n++){if(k=m[n],"OpenLayers.Strategy.BBOX"==k.CLASS_NAME){k.bounds=null;k.triggerRead();break}}else l.setVisibility(!0)}};
var Z=function(c,a){var b=new OpenLayers.Map("center",{controls:[],displayProjection:u,projection:a.projection_current,fallThrough:i18n.gis_name_map?!0:!1,theme:null,maxResolution:a.maxResolution,maxExtent:a.maxExtent,numZoomLevels:a.numZoomLevels,units:a.units});S3.gis.maps[c]=b;b.s3={};b.s3.id=c;b.s3.options=a;b.s3.plugins=[];b.registerPlugin=function(a){a.map=this;this.s3.plugins.push(a)};ca(b);da(b);return b},aa=function(c){var a=c.s3,b=a.options,d=new GeoExt.MapPanel({xtype:"gx_mappanel",map:c,
center:b.center,zoom:b.zoom,plugins:[]});a.mapPanel=d;var e={};e.map=d;a.portal=e;if(b.legend||b.layers_wms)for(var e=c.layers,f=d.layers.data.items,g=0;g<e.length;g++)e[g].legendURL&&(f[g].data.legendURL=e[g].legendURL),e[g].legendTitle&&(f[g].data.title=e[g].legendTitle),e[g].queryable&&(f[g].data.queryable=1);e=ea(c);f=[e];b.wms_browser_url&&(g=fa(c))&&f.push(g);b.legend&&("float"==b.legend?g=ga(c):(g=new GeoExt.LegendPanel({title:i18n.gis_legend,defaults:{},autoScroll:!0,collapsible:!0,collapseMode:"mini"}),
f.push(g)),d.legendPanel=g);for(var d=a.plugins,g=0,h=d.length;g<h;++g)d[g].setup(c),d[g].addToMapWindow(f);a.west_panel_items=f;b.window?J(c):K(c);var l=a.westPanelContainer;l.fireEvent("collapse");window.setTimeout(function(){l.fireEvent("expand")},300);e.root.eachChild(function(){this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||G(this.layer)});else this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||G(this.layer)})})})});Ext.QuickTips.init()},
K=function(c){var a=c.s3,b=a.options,d=L(c);c=M(c);b=new Ext.Panel({renderTo:b.renderTo,autoWidth:!0,titleCollapse:!0,height:b.map_height,layout:"border",items:[d,c]});a.mapWin=b};S3.gis.addMapPanel=K;var J=function(c){var a=c.s3,b=a.options,d=L(c),e=M(c),d=new Ext.Window({cls:"gis-map-window",collapsible:!1,constrain:!0,closable:!b.windowNotClosable,closeAction:"hide",autoScroll:!0,maximizable:b.maximizable,titleCollapse:!1,height:b.map_height,width:b.map_width,layout:"border",items:[d,e]});d.on("beforehide",
function(a){a.maximized&&a.restore()});d.on("move",function(a){c.events.clearMouseCache()});b.windowHide||(d.show(),d.maximize());a.mapWin=d};S3.gis.addMapWindow=J;var L=function(c){c=c.s3;var a=c.options.west_collapsed||!1,b=new Ext.Panel({header:!1,border:!1,split:!0,items:c.west_panel_items});autoWidth=Ext.isChrome?!1:!0;a=new Ext.Panel({cls:"gis_west",region:"west",header:!1,border:!0,autoWidth:autoWidth,width:250,collapsible:!0,collapseMode:"mini",collapsed:a,items:[b]});return c.westPanelContainer=
a},M=function(c){var a=c.s3,b=a.options;if(b.toolbar){var d,e=c.s3,f=e.options;d=new Ext.Toolbar({height:34});d.map=c;e.portal.toolbar=d;var g=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtent,map:c,iconCls:"zoomfull",tooltip:i18n.gis_zoomfull}),h,l,m;"active"==f.draw_polygon?(m=!0,l=h=e=!1):("active"==f.draw_line?(e=!0,h=l=!1):"active"==f.draw_feature?(l=!0,h=e=!1):(h=!0,l=e=!1),m=!1);d.add(g);i18n.gis_geoLocate&&navigator.geolocation&&ha(d);if(void 0===f.nav){var g=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:!0}),
map:c,iconCls:"zoomout",tooltip:i18n.gis_zoomout,toggleGroup:"controls"}),n=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox,map:c,iconCls:"zoomin",tooltip:i18n.gis_zoominbutton,toggleGroup:"controls"});h=new GeoExt.Action({control:new OpenLayers.Control.Navigation,map:c,iconCls:"pan-off",tooltip:i18n.gis_pan,allowDepress:!0,toggleGroup:"controls",pressed:h});d.add(g);d.add(n);d.add(h);d.addSeparator();g=new OpenLayers.Control.NavigationHistory;d.map.addControl(g);g.activate();h=new Ext.Toolbar.Button({iconCls:"back",
tooltip:i18n.gis_navPrevious,handler:g.previous.trigger});g=new Ext.Toolbar.Button({iconCls:"next",tooltip:i18n.gis_navNext,handler:g.next.trigger});d.addButton(h);d.addButton(g)}f.print&&(d.addSeparator(),ia(d));f.save&&"float"!=f.save&&(d.addSeparator(),ja(d));d.addSeparator();ka(d);"toolbar"==f.clear_layers&&N(c,d);f.mgrs_url&&la(d);if(f.draw_feature||f.draw_polygon)d.addSeparator(),f.draw_feature&&O(c,d,l),f.draw_line&&P(c,d,e,!0),f.draw_polygon&&Q(c,d,m,!0);i18n.gis_get_feature_info&&(e=new gxp.plugins.WMSGetFeatureInfo({actionTarget:"toolbar",
outputTarget:"map",outputConfig:{width:400,height:200},toggleGroup:"controls",infoActionTip:i18n.gis_get_feature_info,popupTitle:i18n.gis_feature_info}),e.target=c.s3,e.addActions());i18n.gis_potlatch&&ma(d);f.Google&&f.Google.StreetviewButton&&na(d);try{f.Google.Earth&&google&oa(d)}catch(p){}f.geonames&&(e=Math.min(350,!1===f.nav?f.map_width-500:f.map_width-680),f=new GeoExt.ux.GeoNamesSearchCombo({map:c,width:e,listWidth:e,minChars:2,emptyText:i18n.gis_search,username:f.geonames}),d.addSeparator(),
d.add(f));f=new Ext.BoxComponent({cls:"layer_throbber hide"});d.add(f)}else b.draw_feature&&(f="active"==b.draw_feature?!0:!1,O(c,null,f)),b.draw_line&&(f="active"==b.draw_line?!0:!1,P(c,null,f)),b.draw_polygon&&(f="active"==b.draw_polygon?!0:!1,Q(c,null,f,!0)),f=c.s3,e=f.id,$("#"+e+" .layer_throbber").length||(l='<div class="layer_throbber float hide',f.options.save&&(l+=" save"),l+='"></div>',$("#"+e).append(l));"float"==b.save&&pa(c);c=new Ext.Panel({layout:"card",region:"center",cls:"mappnlcntr",
defaults:{border:!1},items:[a.mapPanel],activeItem:0,tbar:d,scope:this});a.mapPanelContainer=c;b.Google&&b.Google.Earth&&(b=new gxp.GoogleEarthPanel({mapPanel:a.mapPanel}),c.items.items.push(b),a.googleEarthPanel=b,S3.gis.googleEarthPanel=b);return c},ea=function(c){GeoExt.tree.LayerNodeUIS3=Ext.extend(GeoExt.tree.LayerNodeUI,{onClick:function(a){if(a.getTarget(".x-tree-node-cb",1)){var b=this.node,c=this.node.attributes,d=c.checkedGroup;d&&"baselayer"!==d?(d=!c.checked,c.checked=d,b.ui.checkbox.checked=
d,b.layer.setVisibility(d),this.enforceOneVisible()):this.toggleCheck(this.isChecked())}else GeoExt.tree.LayerNodeUI.superclass.onClick.apply(this,arguments)},enforceOneVisible:function(){var a=this.node.attributes,b=a.checkedGroup;if(b&&"baselayer"!==b){var c=this.node.layer,d=this.node.getOwnerTree().getChecked();Ext.each(d,function(d){var e=d.layer;d.hidden||d.attributes.checkedGroup!==b||e!=c&&a.checked&&e.setVisibility(!1)})}}});GeoExt.tree.LayerNodeS3=Ext.extend(GeoExt.tree.LayerNode,{constructor:function(a){this.defaultUI=
GeoExt.tree.LayerNodeUIS3;GeoExt.tree.LayerNodeS3.superclass.constructor.apply(this,arguments)}});Ext.tree.TreePanel.nodeTypes.gx_layer=GeoExt.tree.LayerNodeS3;var a=c.s3,b=a.options,d=b.hide_overlays?!1:!0,e=b.folders_closed?!1:!0,f=b.folders_radio?!0:!1,g=b.wms_browser_url||b.legend&&"float"!=b.legend?!0:!1,h=a.mapPanel.layers,l=[],m={click:function(a){var b=a.attributes;if("baselayer"==b.checkedGroup)a.ui.toggleCheck(!a.ui.isChecked());else{var c=!b.checked;b.checked=c;a.ui.checkbox.checked=c;
a.layer.setVisibility(c)}}},n=function(){var b=a.westPanelContainer;b.fireEvent("collapse");window.setTimeout(function(){b.fireEvent("expand")},300)},p={collapse:function(a){n()},expand:function(a){n()}};!b.hide_base&&l.push({text:i18n.gis_base_layers,nodeType:"gx_baselayercontainer",layerStore:h,loader:{baseAttrs:{listeners:m},filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!0===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,listeners:p,singleClickExpand:!0,expanded:e});
d&&l.push({text:i18n.gis_overlays,nodeType:"gx_overlaylayercontainer",layerStore:h,loader:{baseAttrs:{listeners:m},filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!1===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,listeners:p,singleClickExpand:!0,expanded:e});var k=c.s3.dirs,r=k.length;if(r){GeoExt.tree.LayerLoaderS3=function(a){Ext.apply(this,a);GeoExt.tree.LayerLoaderS3.superclass.constructor.call(this)};Ext.extend(GeoExt.tree.LayerLoaderS3,GeoExt.tree.LayerLoader,
{load:function(a,b){if(this.fireEvent("beforeload",this,a)){for(this.removeStoreHandlers();a.firstChild;)a.removeChild(a.firstChild);this.uiProviders||(this.uiProviders=a.getOwnerTree().getLoader().uiProviders);this.store||(this.store=GeoExt.MapPanel.guess().layers);this.store.each(function(b){this.addLayerNode(a,b)},this);this.addStoreHandlers(a);var c=a.attributes.children,d=c.length;if(d)for(var e,f,g=0;g<d;g++)e=c[g],e=new Ext.tree.TreePanel.nodeTypes[e.nodeType](e),(f=a.item(0))?a.insertBefore(e,
f):a.appendChild(e);"function"==typeof b&&b();this.fireEvent("load",this,a)}}});var s,v,t,R,x,d={},w,u,y;for(w=0;w<r;w++)for(v=k[w],t=v.split("/"),R=t.length,u=0;u<R;u++)s=0==u?d:s[x],x=t[u],s.hasOwnProperty(x)||(s[x]={});for(v in d){k=d[v];s=[];for(y in k)k={listeners:m},f&&(k.checkedGroup=y),k=new GeoExt.tree.LayerLoaderS3({baseAttrs:k,filter:function(a,b){return function(c){if("undefined"!==c.data.layer.dir)return c.data.layer.dir===a+"/"+b}}(v,y)}),k={text:y,nodeType:"gx_layercontainer",layerStore:h,
children:[],loader:k,leaf:!1,listeners:p,singleClickExpand:!0,expanded:e},s.push(k);k={listeners:m};f&&(k.checkedGroup=v);k=new GeoExt.tree.LayerLoaderS3({baseAttrs:k,filter:function(a){return function(b){if("undefined"!==b.data.layer.dir)return b.data.layer.dir===a}}(v)});k={text:v,nodeType:"gx_layercontainer",layerStore:h,children:s,loader:k,leaf:!1,listeners:p,singleClickExpand:!0,expanded:e};l.push(k)}}e=new Ext.tree.AsyncTreeNode({expanded:!0,children:l});f=(b=b.clearlayers&"toolbar"!=b.clearlayers)||
i18n.gis_properties||i18n.gis_uploadlayer?new Ext.Toolbar:null;g=new Ext.tree.TreePanel({title:i18n.gis_layers,loaderloader:new Ext.tree.TreeLoader({applyLoader:!1}),root:e,rootVisible:!1,split:!0,collapsible:g,collapseMode:"mini",lines:!1,tbar:f,enableDD:!1});new Ext.tree.TreeSorter(g,{sortType:function(a,b){return"gx_baselayercontainer"==b.attributes.nodeType?" ":"gx_overlaylayercontainer"==b.attributes.nodeType?"!":b.text}});i18n.gis_uploadlayer&&qa(c,g);i18n.gis_properties&&ra(c,g);b&&N(c,g.getTopToolbar());
return g},fa=function(c){var a=c.s3.options,b=new Ext.tree.AsyncTreeNode({expanded:!0,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+a.wms_browser_url,layerOptions:{buffer:1,singleTile:!1,ratio:1,wrapDateLine:!0},layerParams:{TRANSPARENT:"TRUE"},createNode:function(a){a.checked=a.leaf?!1:void 0;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[a])}})});return new Ext.tree.TreePanel({title:a.wms_browser_name,root:b,rootVisible:!1,split:!0,autoScroll:!0,
collapsible:!0,collapseMode:"mini",lines:!1,listeners:{checkchange:function(a,b){!0===b?c.addLayer(a.attributes.layer):c.removeLayer(a.attributes.layer)}}})},y=function(c){var a=c.object;c=a.map.s3;$("#"+c.id+" .layer_throbber").show().removeClass("hide");a=a.s3_layer_id;c=c.layers_loading;c.pop(a);c.push(a)},G=function(c){var a=c.map.s3,b=a.layers_loading;b.pop(c.s3_layer_id);0===b.length&&$("#"+a.id+" .layer_throbber").hide().addClass("hide")},A=function(c){var a=c.object;G(a);void 0!=c.response&&
509==c.response.priv.status?S3.showAlert(i18n.gis_too_many_features,"warning"):(c=a.s3_style)&&"[object Array]"===Object.prototype.toString.call(c)&&1==c.length&&sa(a)},sa=function(c){var a=c.s3_style[0],b=a.prop,d=c.features,e,f=d.length,g=[];for(e=0;e<f;e++)g.push(d[e].attributes[b]);g.sort(function(a,b){return a-b});var h={};$.each(g,function(){h[this]=1});b=Object.keys(h).length;if(5<=b)var b=5,l=["ffffb2","fecc5c","fd8d3c","f03b20","bd0026"];else 4==b?l=["ffffb2","fecc5c","fd8d3c","e31a1c"]:
3==b?l=["ffeda0","feb24c","f03b20"]:2==b?l=["ffeda0","f03b20"]:1==b&&(l=["feb24c"]);var m=Math.round(f/b),n=m,p=[g[0]];for(e=1;e<b;e++)p[e]=g[n]||g[f-1],n+=m;p.push(g[f-1]);var k=[];for(e=0;e<b;e++)g=p[e],m=p[e+1],n=$.extend({},a),n.fill=l[e],n.low=g,n.high=m,n.label=g==m?g.toString():g+" - "+m,k.push(n);a=S({style:k,cluster_threshold:0});c.styleMap.styles["default"].rules=a;for(e=0;e<f;e++)c.drawFeature(d[e]);if(e=c.map.s3.mapPanel.legendPanel)for(d=e.items.items,f=c.s3_layer_id,l=d.length,e=0;e<
l;e++)if(c=d[e],c.layer.s3_layer_id==f){c.rules=a;c.update();break}},B=function(c){T(c.object.map)},ca=function(c){var a=c.s3,b=a.options;a.dirs=[];a.layers_loading=[];a.layers_nopopups=[];if(b.layers_osm)for(var d=b.layers_osm,a=d.length;0<a;a--)ta(c,d[a-1]);try{google&ua(c)}catch(e){}b.Bing&&va(c);if(b.layers_tms)for(d=b.layers_tms,a=d.length;0<a;a--)wa(c,d[a-1]);if(b.layers_wms)for(d=b.layers_wms,a=d.length;0<a;a--)xa(c,d[a-1]);if(b.layers_xyz)for(d=b.layers_xyz,a=d.length;0<a;a--)ya(c,d[a-1]);
b.EmptyLayer&&(a=new OpenLayers.Layer(b.EmptyLayer.name,{isBaseLayer:!0,displayInLayerSwitcher:!0,s3_layer_id:b.EmptyLayer.id,s3_layer_type:"empty"}),c.addLayer(a),b.EmptyLayer.base&&c.setBaseLayer(a));if(b.layers_js)for(d=b.layers_js,a=d.length;0<a;a--)eval(c,d[a-1]);if(b.layers_theme)for(d=b.layers_theme,a=d.length;0<a;a--)z(c,d[a-1]);if(b.layers_geojson)for(d=b.layers_geojson,a=d.length;0<a;a--)z(c,d[a-1]);if(b.layers_gpx)for(d=b.layers_gpx,a=d.length;0<a;a--)za(c,d[a-1]);if(b.layers_arcrest)for(d=
b.layers_arcrest,a=d.length;0<a;a--)Aa(c,d[a-1]);b.CoordinateGrid&&Ba(c);if(b.layers_georss)for(d=b.layers_georss,a=d.length;0<a;a--)z(c,d[a-1]);if(b.layers_kml)for(d=b.layers_kml,a=d.length;0<a;a--)Ca(c,d[a-1]);b.OWM&&Da(c);if(b.layers_shapefile)for(d=b.layers_shapefile,a=d.length;0<a;a--)z(c,d[a-1]);if(b.layers_wfs)for(d=b.layers_wfs,a=d.length;0<a;a--)Ea(c,d[a-1]);if(b.feature_queries)for(d=b.feature_queries,a=d.length;0<a;a--)z(c,d[a-1]);if(b.feature_resources)for(d=b.feature_resources,a=d.length;0<
a;a--)z(c,d[a-1]);if(b.layers_feature)for(d=b.layers_feature,a=d.length;0<a;a--)z(c,d[a-1]);if(b.features||b.draw_feature||b.draw_polygon||navigator.geolocation)var f=Fa(c);if(b.features)for(b=b.features,c=c.getProjectionObject(),a=0;a<b.length;a++)d=D.parseFeature(b[a]),d.geometry.transform(u,c),f.addFeatures([d])},Aa=function(c,a){var b=a.name,d=[a.url],e=void 0!=a.layers?a.layers.join():0;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,c.s3.dirs)&&c.s3.dirs.push(f)}else f="";var g=void 0!=a.visibility?
a.visibility:!0,b=new OpenLayers.Layer.ArcGIS93Rest(b,d,{layers:"show:"+e,isBaseLayer:void 0!=a.base?a.base:!1,transparent:void 0!=a.transparent?a.transparent:!0,dir:f,s3_layer_id:a.id,s3_layer_type:"arcrest"});b.setVisibility(g);c.addLayer(b);a._base&&c.setBaseLayer(b)},va=function(c){var a=c.s3.options.Bing,b=a.ApiKey,d;a.Aerial&&(d=new OpenLayers.Layer.Bing({key:b,type:"Aerial",name:a.Aerial.name,s3_layer_id:a.Aerial.id,s3_layer_type:"bing"}),c.addLayer(d),"aerial"==a.Base&&c.setBaseLayer(d));
a.Road&&(d=new OpenLayers.Layer.Bing({key:b,type:"Road",name:a.Road.name,s3_layer_id:a.Road.id,s3_layer_type:"bing"}),c.addLayer(d),"road"==a.Base&&c.setBaseLayer(d));a.Hybrid&&(d=new OpenLayers.Layer.Bing({key:b,type:"AerialWithLabels",name:a.Hybrid.name,s3_layer_id:a.Hybrid.id,s3_layer_type:"bing"}),c.addLayer(d),"hybrid"==a.Base&&c.setBaseLayer(d))},Ba=function(c){var a=c.s3.options.CoordinateGrid;c.addLayer(new OpenLayers.Layer.cdauth.CoordinateGrid(null,{name:a.name,shortName:"grid",visibility:a.visibility,
s3_layer_id:a.id,s3_layer_type:"coordinate"}))},Fa=function(c){var a=c.s3.options;if(a.draw_polygon&&!a.draw_feature)var b;else b=a.marker_default;a=C(c,{marker:b});a=new OpenLayers.Layer.Vector(i18n.gis_draft_layer,{displayInLayerSwitcher:!1,legendURL:a[1],styleMap:a[0]});a.setVisibility(!0);c.addLayer(a);return c.s3.draftLayer=a},z=function(c,a){var b=c.s3,d=a.name;a.no_popups&&b.layers_nopopups.push(d);var e=a.url,f=void 0!=a.refresh?a.refresh:900;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,
b.dirs)&&b.dirs.push(g)}else g="";var b=void 0!=a.visibility?a.visibility:!0,h=void 0!=a.cluster_attribute?a.cluster_attribute:"colour",l=void 0!=a.cluster_distance?a.cluster_distance:20,m=void 0!=a.cluster_threshold?a.cluster_threshold:2,n=void 0!=a.projection?a.projection:4326,n=4326==n?u:new OpenLayers.Projection("EPSG:"+n),p=void 0!=a.type?a.type:"feature",k='<div class="gis_layer_legend"><div class="gis_legend_title">'+d+"</div>";void 0!=a.desc&&(k+='<div class="gis_legend_desc">'+a.desc+"</div>");
if(void 0!=a.src||void 0!=a.src_url){var r='<div class="gis_legend_src">';void 0!=a.src_url?(r+='<a href="'+a.src_url+'" target="_blank">',r=void 0!=a.src?r+a.src:r+a.src_url,r+="</a>"):r+=a.src;k+=r+"</div>"}var k=k+"</div>",s=C(c,a),r=s[0],s=s[1],v=[new OpenLayers.Strategy.BBOX({ratio:1.5})];f&&v.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*f}));m&&v.push(new OpenLayers.Strategy.AttributeCluster({attribute:h,distance:l,threshold:m}));d=new OpenLayers.Layer.Vector(d,{dir:g,projection:n,
protocol:new OpenLayers.Protocol.HTTP({url:e,format:D}),legendURL:s,strategies:v,styleMap:r,s3_layer_id:a.id,s3_layer_type:p,s3_style:a.style});d.legendTitle=k;d.setVisibility(b);d.events.on({loadstart:y,loadend:A,visibilitychanged:B});c.addLayer(d)},ua=function(c){var a=c.s3.options.Google,b;a.MapMaker||a.MapMakerHybrid?(a.Satellite&&(b=new OpenLayers.Layer.Google(a.Satellite.name,{type:G_SATELLITE_MAP,sphericalMercator:!0,s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),c.addLayer(b),"satellite"==
a.Base&&c.setBaseLayer(b)),a.Maps&&(b=new OpenLayers.Layer.Google(a.Maps.name,{type:G_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),c.addLayer(b),"maps"==a.Base&&c.setBaseLayer(b)),a.Hybrid&&(b=new OpenLayers.Layer.Google(a.Hybrid.name,{type:G_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),c.addLayer(b),"maps"==a.Base&&c.setBaseLayer(b)),a.Terrain&&(b=new OpenLayers.Layer.Google(a.Terrain.name,{type:G_PHYSICAL_MAP,sphericalMercator:!0,
s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),c.addLayer(b),"terrain"==a.Base&&c.setBaseLayer(b)),a.MapMaker&&(b=new OpenLayers.Layer.Google(a.MapMaker.name,{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:b.id,s3_layer_type:"google"}),c.addLayer(b),"mapmaker"==a.Base&&c.setBaseLayer(b)),a.MapMakerHybrid&&(b=new OpenLayers.Layer.Google(a.MapMakerHybrid.name,{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:b.id,s3_layer_type:"google"}),c.addLayer(b),"mapmakerhybrid"==a.Base&&
c.setBaseLayer(b))):(a.Satellite&&(b=new OpenLayers.Layer.Google(a.Satellite.name,{type:"satellite",numZoomLevels:22,s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),c.addLayer(b),"satellite"==a.Base&&c.setBaseLayer(b)),a.Maps&&(b=new OpenLayers.Layer.Google(a.Maps.name,{numZoomLevels:20,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),c.addLayer(b),"maps"==a.Base&&c.setBaseLayer(b)),a.Hybrid&&(b=new OpenLayers.Layer.Google(a.Hybrid.name,{type:"hybrid",numZoomLevels:20,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),
c.addLayer(b),"hybrid"==a.Base&&c.setBaseLayer(b)),a.Terrain&&(b=new OpenLayers.Layer.Google(a.Terrain.name,{type:"terrain",s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),c.addLayer(b),"terrain"==a.Base&&c.setBaseLayer(b)))},za=function(c,a){var b=a.name,d=a.url,e=a.marker,f=E+e.i,g=e.h,h=e.w,l=void 0!=a.waypoints?a.waypoints:!0,m=void 0!=a.tracks?a.tracks:!0,n=void 0!=a.routes?a.routes:!0,e=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var p=a.dir;-1==$.inArray(p,c.s3.dirs)&&c.s3.dirs.push(p)}else p=
"";var k=void 0!=a.opacity?a.opacity:1,r=void 0!=a.cluster_distance?a.cluster_distance:20,s=void 0!=a.cluster_threshold?a.cluster_threshold:2,v=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);l?(v.graphicOpacity=k,v.graphicWidth=h,v.graphicHeight=g,v.graphicXOffset=-(h/2),v.graphicYOffset=-g,v.externalGraphic=f):v.externalGraphic="";v.strokeColor="blue";v.strokeWidth=6;v.strokeOpacity=k;b=new OpenLayers.Layer.Vector(b,{dir:p,projection:u,strategies:[new OpenLayers.Strategy.Fixed,
new OpenLayers.Strategy.Cluster({distance:r,threshold:s})],legendURL:f,s3_layer_id:a.id,s3_layer_type:"gpx",style:v,protocol:new OpenLayers.Protocol.HTTP({url:d,format:new OpenLayers.Format.GPX({extractAttributes:!0,extractWaypoints:l,extractTracks:m,extractRoutes:n})})});b.setVisibility(e);b.events.on({loadstart:y,loadend:A,visibilitychanged:B});c.addLayer(b)},Ca=function(c,a){var b=c.s3,d=a.name,e=a.url,f=void 0!=a.title?a.title:"name",g=void 0!=a.body?a.body:"description",h=void 0!=a.refresh?a.refresh:
900,l=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var m=a.dir;-1==$.inArray(m,b.dirs)&&b.dirs.push(m)}else m="";var b=void 0!=a.cluster_distance?a.cluster_distance:20,n=void 0!=a.cluster_threshold?a.cluster_threshold:2,p=C(c,a)[0],k=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2}),r=[new OpenLayers.Strategy.Fixed];h&&r.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*h}));n&&r.push(new OpenLayers.Strategy.Cluster({distance:b,threshold:n}));d=new OpenLayers.Layer.Vector(d,
{dir:m,projection:u,protocol:new OpenLayers.Protocol.HTTP({url:e,format:k}),strategies:r,styleMap:p,s3_layer_id:a.id,s3_layer_type:"kml",s3_style:a.style});d.title=f;d.body=g;d.setVisibility(l);d.events.on({loadstart:y,loadend:A,visibilitychanged:B});c.addLayer(d)},ta=function(c,a){var b=a.name,d=[a.url1];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,c.s3.dirs)&&c.s3.dirs.push(f)}else f="";b=new OpenLayers.Layer.TMS(b,
d,{dir:f,type:"png",getURL:Ga,displayOutsideMaxExtent:!0,numZoomLevels:void 0!=a.zoomLevels?a.zoomLevels:19,isBaseLayer:void 0!=a.base?a.base:!0,s3_layer_id:a.id,s3_layer_type:"openstreetmap"});void 0!=a.attribution&&(b.attribution=a.attribution);b.setVisibility(e);c.addLayer(b);a._base&&c.setBaseLayer(b)},Ga=function(c){var a=this.map.getResolution(),b=Math.round((c.left-this.maxExtent.left)/(a*this.tileSize.w));c=Math.round((this.maxExtent.top-c.top)/(a*this.tileSize.h));var a=this.map.getZoom(),
d=Math.pow(2,a);if(0>c||c>=d)return OpenLayers.Util.getImagesLocation()+"404.png";b=a+"/"+(b%d+d)%d+"/"+c+"."+this.type;c=this.url;c instanceof Array&&(c=this.selectUrl(b,c));return c+b},Da=function(c){var a=c.s3.options.OWM,b;a.station&&(b=new OpenLayers.Layer.Vector.OWMStations(a.station.name,{dir:a.station.dir,s3_layer_id:a.station.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.station.visibility),b.events.on({featureselected:b.onSelect,featureunselected:b.onUnselect,loadstart:y,loadend:A,
visibilitychanged:B}),c.addLayer(b));a.city&&(b=new OpenLayers.Layer.Vector.OWMWeather(a.city.name,{dir:a.city.dir,s3_layer_id:a.city.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.city.visibility),b.events.on({featureselected:b.onSelect,featureunselected:b.onUnselect,loadstart:y,loadend:A,visibilitychanged:B}),c.addLayer(b))},wa=function(c,a){var b=a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=a.layername,f=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=
a.dir){var g=a.dir;-1==$.inArray(g,c.s3.dirs)&&c.s3.dirs.push(g)}else g="";b=new OpenLayers.Layer.TMS(b,d,{dir:g,s3_layer_id:a.id,s3_layer_type:"tms",layername:e,type:void 0!=a.format?a.format:"png",numZoomLevels:f});void 0!=a.attribution&&(b.attribution=a.attribution);c.addLayer(b);a._base&&c.setBaseLayer(b)},Ea=function(c,a){var b=a.name,d=a.url;void 0!=a.username&&void 0!=a.password&&(d=d.replace("://","://"+a.username+":"+a.password+"@"));var e=a.title,f=a.featureType,g=void 0!=a.featureNS?a.featureNS:
null,h=void 0!=a.schema?a.schema:null,l=void 0!=a.version?a.version:"1.1.0",m=void 0!=a.geometryName?a.geometryName:"the_geom",n=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var p=a.dir;-1==$.inArray(p,c.s3.dirs)&&c.s3.dirs.push(p)}else p="";var k=void 0!=a.cluster_attribute?a.cluster_attribute:"colour",r=void 0!=a.cluster_distance?a.cluster_distance:20,s=void 0!=a.cluster_threshold?a.cluster_threshold:2,v=void 0!=a.refresh?a.refresh:!1,t=[new OpenLayers.Strategy.BBOX({ratio:1.5})];v&&t.push(new OpenLayers.Strategy.Refresh({force:!0,
interval:1E3*v}));s&&t.push(new OpenLayers.Strategy.AttributeCluster({attribute:k,distance:r,threshold:s}));void 0!=a.projection?(k=a.projection,r="EPSG:"+k):(k="4326",r="EPSG:4326");f=new OpenLayers.Protocol.WFS({version:l,srsName:r,url:d,featureType:f,featureNS:g,geometryName:m,schema:h});d='<div class="gis_layer_legend"><div class="gis_legend_title">'+b+"</div>";void 0!=a.desc&&(d+='<div class="gis_legend_desc">'+a.desc+"</div>");if(void 0!=a.src||void 0!=a.src_url)g='<div class="gis_legend_src">',
void 0!=a.src_url?(g+='<a href="'+a.src_url+'" target="_blank">',g=void 0!=a.src?g+a.src:g+a.src_url,g+="</a>"):g+=a.src,d+=g+"</div>";d+="</div>";h=C(c,a);g=h[0];h=h[1];k="4326"==k?u:new OpenLayers.Projection("EPSG:"+k);b=new OpenLayers.Layer.Vector(b,{maxFeatures:1E3,strategies:t,dir:p,legendURL:h,projection:k,protocol:f,styleMap:g,s3_layer_id:a.id,s3_layer_type:"wfs",s3_style:a.style});b.legendTitle=d;b.title=e;b.setVisibility(n);b.events.on({loadstart:y,loadend:A,visibilitychanged:B});c.addLayer(b)},
xa=function(c,a){var b=a.name,d=a.url;a.username&&a.password&&(d=d.replace("://","://"+a.username+":"+a.password+"@"));var e=a.layers,f=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,c.s3.dirs)&&c.s3.dirs.push(g)}else g="";var h=void 0!=a.base?a.base:!1,l=void 0!=a.transparent?a.transparent:!0,m=void 0!=a.format?a.format:"image/png",n=void 0!=a.version?a.version:"1.1.1",p=a.map?a.map:"",k=a.style?a.style:"",r=void 0!=a.bgcolor?"0x"+a.bgcolor:"",s=void 0!=a.buffer?
a.buffer:0,v=void 0!=a.tiled?a.tiled:!1,t=void 0!=a.opacity?a.opacity:1,u=void 0!=a.queryable?a.queryable:1,x='<div class="gis_layer_legend"><div class="gis_legend_title">'+b+"</div>";void 0!=a.desc&&(x+='<div class="gis_legend_desc">'+a.desc+"</div>");if(c.s3.options.metadata){if(void 0!=a.post_id)if(i18n.gis_metadata)var w=i18n.gis_metadata,z=S3.Ap.concat("/cms/page/"+a.post_id);else w=i18n.gis_metadata_edit,z=S3.Ap.concat("/cms/post/"+a.post_id+"/update?layer_id="+a.id);else i18n.gis_metadata_create?
(w=i18n.gis_metadata_create,z=S3.Ap.concat("/cms/post/create?layer_id="+a.id)):w="";w&&(x+='<div class="gis_legend_src"><a href="'+z+'" target="_blank">'+w+"</a></div>")}else if(void 0!=a.src||void 0!=a.src_url)w='<div class="gis_legend_src">',void 0!=a.src_url?(w+='<a href="'+a.src_url+'" target="_blank">',w=void 0!=a.src?w+a.src:w+a.src_url,w+="</a>"):w+=a.src,w+="</div>",x+=w;x+="</div>";if(void 0!=a.legendURL)var C=a.legendURL;b=new OpenLayers.Layer.WMS(b,d,{layers:e,transparent:l},{dir:g,wrapDateLine:!0,
isBaseLayer:h,s3_layer_id:a.id,s3_layer_type:"wms",queryable:u,visibility:f});p&&(b.params.MAP=p);m&&(b.params.FORMAT=m);n&&(b.params.VERSION=n);k&&(b.params.STYLES=k);r&&(b.params.BGCOLOR=r);v&&(b.params.TILED=!0,b.params.TILESORIGIN=[c.maxExtent.left,c.maxExtent.bottom]);h||(b.opacity=t,b.buffer=s?s:0);b.legendTitle=x;C&&(b.legendURL=C);b.events.on({loadstart:y,loadend:A,visibilitychanged:B});c.addLayer(b);a._base&&c.setBaseLayer(b)},ya=function(c,a){var b=a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);
void 0!=a.url3&&d.push(a.url3);var e=a.layername,f=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,c.s3.dirs)&&c.s3.dirs.push(g)}else g="";b=new OpenLayers.Layer.XYZ(b,d,{dir:g,s3_layer_id:a.id,s3_layer_type:"xyz",layername:e,type:void 0!=a.format?a.format:"png",numZoomLevels:f});void 0!=a.attribution&&(b.attribution=a.attribution);c.addLayer(b);a._base&&c.setBaseLayer(b)},da=function(c){var a=c.s3.options,b=new OpenLayers.Control.Navigation;a.no_zoom_wheel&&(b.zoomWheelEnabled=
!1);c.addControl(b);void 0==a.zoomcontrol&&c.addControl(new OpenLayers.Control.Zoom);c.addControl(new OpenLayers.Control.ArgParser);c.addControl(new OpenLayers.Control.Attribution);void 0==a.scaleline&&c.addControl(new OpenLayers.Control.ScaleLine);"mgrs"==a.mouse_position?c.addControl(new OpenLayers.Control.MGRSMousePosition):a.mouse_position&&c.addControl(new OpenLayers.Control.MousePosition);void 0==a.permalink&&c.addControl(new OpenLayers.Control.Permalink);if(void 0==a.overview){var a={},b=c.options,
d;for(d in b)"controls"!=d&&(a[d]=b[d]);c.addControl(new OpenLayers.Control.OverviewMap({mapOptions:a}))}Ha(c)},Ha=function(c){c.events.register("featureover",this,Ia);c.events.register("featureout",this,U);c.events.register("featureclick",this,Ja)},Ia=function(c){var a=c.feature,b=a.layer;if(-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(b.name)){a.renderIntent="select";b.drawFeature(a);var d=b.map;-1==d.s3.layers_nopopups.indexOf(b.name)&&
(S3.gis.timeouts[a.id]=setTimeout(function(){if(!a.cluster&&a.geometry){var c=a.attributes,f=a.geometry.getBounds().getCenterLonLat(),g;void 0!=c.popup?g=c.popup:void 0!=c.name?g=c.name:void 0!=b.title&&(c=c[b.title],g="object"==typeof c?c.value:c);g&&(OpenLayers.Popup.Tooltip=OpenLayers.Class(OpenLayers.Popup,{displayClass:"gis_tooltip",contentDisplayClass:"gis_tooltip_content",CLASS_NAME:"OpenLayers.Popup.Tooltip"}),f=new OpenLayers.Popup.Tooltip(a.id+"_tooltip",f,new OpenLayers.Size(80,12),g),
f.autoSize=!0,a.popup=f,d.addPopup(f))}},500))}},U=function(c){c=c.feature;var a=c.layer,b=a.map;-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(a.name)&&(-1!=b.s3.layers_nopopups.indexOf(a.name)&&"OpenLayers.Popup.Tooltip"==c.popup.CLASS_NAME?(c.renderIntent="default",a.drawFeature(c)):c&&(clearTimeout(S3.gis.timeouts[c.id]),c.popup?"OpenLayers.Popup.Tooltip"==c.popup.CLASS_NAME&&(c.renderIntent="default",a.drawFeature(c),
c.popup&&(b.removePopup(c.popup),c.popup.destroy()),delete c.popup):(c.renderIntent="default",a.drawFeature(c)),$("#"+c.id+"_tooltip").remove()))},W=function(c,a,b,d){var e=c.id+"_popup";d?(0===a.indexOf("http://")&&(a=OpenLayers.ProxyHost+encodeURIComponent(a)),b='<iframe src="'+a+'" onload="S3.gis.popupLoaded(\''+e+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>'):void 0==b&&(b=i18n.gis_loading+'...<div class="throbber"></div>');var f=c.geometry.getBounds().getCenterLonLat();
b=new OpenLayers.Popup.FramedCloud(e,f,new OpenLayers.Size(400,400),b,null,!0,Ka);c.popup=b;b.feature=c;b.maxSize=new OpenLayers.Size(750,660);c.layer.map.addPopup(b);d||void 0==a||V(a,e+"_contentDiv",b);return b};S3.gis.addPopup=W;S3.gis.popupLoaded=function(c){$("#"+c+"_contentDiv iframe").contents().find("#popup form").show();var a=S3.gis.maps,b,d,e,f,g;for(b in a)for(d=a[b],e=d.popups,f=0,g=e.length;f<g;f++)d=e[f],d.id==c&&d.updateSize(!0)};var V=function(c,a,b){0===c.indexOf("http://")&&(c=OpenLayers.ProxyHost+
encodeURIComponent(c));$.ajaxS3({url:c,dataType:"html",success:function(c){try{$("#"+a).html(c),b.updateSize(),$("#"+a+" a.btn.iframe").click(function(){var b=$(this).attr("href");0===b.indexOf("http://")&&(b=OpenLayers.ProxyHost+encodeURIComponent(b));var c=a.slice(0,-11),b='<iframe src="'+b+'" onload="S3.gis.popupLoaded(\''+c+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>';$("#"+a).html(b);return!1})}catch(e){}},error:function(c,e,f){msg="UNAUTHORIZED"==f?i18n.gis_requires_login:
c.responseText;$("#"+a+"_contentDiv").html(msg);b.updateSize()}})},Ja=function(c){var a=c.feature,b=a.layer,d=b.map.s3;if(-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(b.name)&&-1==d.layers_nopopups.indexOf(b.name)){var e=a.geometry;if("OpenLayers.Geometry.Point"!=e.CLASS_NAME)for(var f=0,g=d.clicking.length;f<g;++f)if("OpenLayers.Geometry.Point"==d.clicking[f].geometry.CLASS_NAME)return;U(c);a.renderIntent="select";
b.drawFeature(a);f=b.s3_layer_type;c=e.getBounds().getCenterLonLat();var g=a.id+"_popup",e=void 0!=b.title?b.title:"name",h,l,m;if(a.cluster){var n=a.cluster;h=i18n.gis_cluster_multiple+":<ul>";for(var p=n.length,d=d.id,f=0;f<p;f++){var k=n[f].attributes,b=void 0!=k.popup?k.popup.split("<br />",1)[0]:k[e];h=void 0!=k.url?h+("<li><a href='javascript:S3.gis.loadClusterPopup(\""+d+'", "'+k.url+'", "'+g+"\")'>"+b+"</a></li>"):h+("<li>"+b+"</li>")}h+="</ul>";h+="<div align='center'><a href='javascript:S3.gis.zoomToSelectedFeature(\""+
d+'", '+c.lon+","+c.lat+", 3)'>"+i18n.gis_zoomin+"</a></div>"}else if("kml"==f){k=a.attributes;if(void 0!=a.style.balloonStyle)h=a.style.balloonStyle.replace(/{([^{}]*)}/g,function(a,b){var c=k[b];return"string"===typeof c||"number"===typeof c?c:a});else{f=typeof k[e];f="object"==f?k[e].value:k[e];h="<h3>"+f+"</h3>";for(var b=b.body.split(" "),r,d=0;d<b.length;d++)f=typeof k[b[d]],"object"==f?(f=k[b[d]].displayName,""===f&&(f=b[d]),e=k[b[d]].value,r='<div class="gis_popup_row"><div class="gis_popup_label">'+
f+':</div><div class="gis_popup_cell">'+e+"</div></div>"):r=void 0!=k[b[d]]?'<div class="gis_popup_row">'+k[b[d]]+"</div>":"",h+=r}-1!=h.search("<script")&&(h="Content contained Javascript! Escaped content below.<br />"+h.replace(/</g,"<"))}else if("gpx"!=f)if("shapefile"==f)k=a.attributes,h="<div>",$.each(k,function(a,b){"id_orig"==a&&(a="id");r='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_cell">'+b+"</div></div>";h+=r}),h+="</div>";else if("wfs"==f)k=
a.attributes,f=k[e],h="<h3>"+f+"</h3>",$.each(k,function(a,b){r='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_val">'+b+"</div></div>";h+=r});else if(void 0!=a.attributes.url)m=a.attributes.url;else{k=a.attributes;b=void 0==k.name?"":"<h3>"+k.name+"</h3>";f=void 0==k.description?"":"<p>"+k.description+"</p>";d=void 0==k.link?"":'<a href="'+k.link+'" target="_blank">'+k.link+"</a>";if(void 0==k.data)e="";else if(0===k.data.indexOf("http://")){l=!0;var s=
S3.uid(),e='<div id="'+s+'">'+i18n.gis_loading+"...<div class='throbber'></div></div>"}else e="<p>"+k.data+"</p>";c=void 0==k.image?"":0===k.image.indexOf("http://")?'<img src="'+k.image+'" height=300 width=300>':"";h=b+f+d+e+c}m=W(a,m,h);l&&V(a.attributes.data,s,m)}},Ka=function(c){if(c=this.feature){var a=c.layer;c.renderIntent="default";a&&a.drawFeature(c);c.popup&&(a&&a.map.removePopup(c.popup),c.popup.destroy());delete c.popup;$("#"+c.id+"_popup").remove();a&&a.name==i18n.gis_draft_layer&&c.destroy()}};
S3.gis.loadClusterPopup=function(c,a,b){var d="#"+b+"_contentDiv",e=$(d);e.html(i18n.gis_loading+"...<div class='throbber'></div>");var f=S3.gis.maps[c];$.getS3(a,function(a){e.html(a);f.popups[0].updateSize();a=$(d+" .dropdown-toggle");a.length&&(e.parent().css("overflow","visible").parent().css("overflow","visible"),a.dropdown())},"html")};S3.gis.zoomToSelectedFeature=function(c,a,b,d){c=S3.gis.maps[c];a=new OpenLayers.LonLat(a,b);d=c.getZoom()+d;c.setCenter(a,d);for(d=0;d<c.popups.length;d++)c.removePopup(c.popups[d])};
var ha=function(c){var a=c.map,b=a.s3.draftLayer,d={fillColor:"#000",fillOpacity:.1,strokeWidth:0},e=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:7E3}});a.addControl(e);e.events.register("locationupdated",this,function(c){b.removeAllFeatures();var e=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(c.point.x,c.point.y),c.position.coords.accuracy/2,40,0),{},d);b.addFeatures([new OpenLayers.Feature.Vector(c.point,
{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),e]);a.zoomToExtent(b.getDataExtent());La(a,e)});e.events.register("locationfailed",this,function(){OpenLayers.Console.log("Location detection failed")});var f=new Ext.Toolbar.Button({iconCls:"geolocation",tooltip:i18n.gis_geoLocate,handler:function(){b.removeAllFeatures();e.activate()}});c.addButton(f)},La=function(c,a){var b=a.geometry.getCentroid(),d=a.geometry.getBounds(),e=Math.abs((d.right-d.left)/2),f=0,
g="up";window.resizeInterval=window.setInterval(function(){16<f&&clearInterval(window.resizeInterval);var d=.03*e/e;switch(f){case 4:case 12:g="down";break;case 8:g="up"}"up"!==g&&(d=-Math.abs(d));a.geometry.resize(1+d,b);c.s3.draftLayer.drawFeature(a);f++},50,b,e)},oa=function(c){var a=c.map,b=a.s3,d=new Ext.Toolbar.Button({iconCls:"googleearth",tooltip:b.options.Google.Earth,enableToggle:!0,toggleHandler:function(c,d){!0===d?(b.mapPanelContainer.getLayout().setActiveItem(1),b.mapWin.items.items[0].collapse(),
b.googleEarthPanel.on("pluginready",function(){var b=a.s3.options.layers_feature;if(b)for(var c=0;c<b.length;c++){var d=b[c];if(void 0!=d.visibility?d.visibility:1)d=S3.public_url+d.url.replace("geojson","kml"),google.earth.fetchKml(a.s3.googleEarthPanel.earth,d,Ma)}})):(b.mapPanelContainer.getLayout().setActiveItem(0),b.mapWin.items.items[0].expand())}});c.addSeparator();c.addButton(d)},Ma=function(c){c&&S3.gis.googleEarthPanel.earth.getFeatures().appendChild(c)},na=function(c){var a=c.map;StreetviewClicker=
new (OpenLayers.Class(OpenLayers.Control,{defaults:{pixelTolerance:1,stopSingle:!0},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(b){(b=a.getLonLatFromViewPortPx(b.xy))||(b=a.getCenter());a.s3.sv_popup&&a.s3.sv_popup.anc&&a.s3.sv_popup.close();a.s3.sv_popup=new GeoExt.Popup({title:a.s3.options.Google.StreetviewTitle,
location:b,width:300,height:300,collapsible:!0,map:a.s3.mapPanel,items:[new gxp.GoogleStreetViewPanel]});a.s3.sv_popup.show()}}))({autoactivate:!1});a.addControl(StreetviewClicker);var b=new Ext.Toolbar.Button({iconCls:"streetview",tooltip:a.s3.options.Google.StreetviewButton,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",toggleHandler:function(a,b){!0===b?StreetviewClicker.activate():StreetviewClicker.deactivate()}});c.addSeparator();c.addButton(b)},ka=function(c){var a=c.map,b=new OpenLayers.Style;
b.addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:5,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#f5902e"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#f5902e",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#f5902e",fillColor:"white",fillOpacity:.5}}})]);var b=new OpenLayers.StyleMap({"default":b}),d=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}});
d.events.on({measure:function(a){alert(i18n.gis_length_message+" "+a.measure.toFixed(2)+" "+a.units)}});d=new GeoExt.Action({control:d,map:a,iconCls:"measure-off",tooltip:i18n.gis_length_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"});c.add(d);!1===a.s3.options.area&&(b=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}}),b.events.on({measure:function(a){alert(i18n.gis_area_message+" "+a.measure.toFixed(2)+
" "+a.units+"2")}}),a=new GeoExt.Action({control:b,map:a,iconCls:"measure-area",tooltip:i18n.gis_area_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"}),c.add(a))},ga=function(c){var a=c.s3.id;$("#"+a).append('<div class="map_legend_div"><div class="map_legend_tab right"></div><div class="map_legend_panel"></div></div>');var b=new GeoExt.LegendPanel({title:i18n.gis_legend,autoScroll:!0,border:!1}),d=$("#"+a+" .map_legend_panel"),d=Ext.get(d[0]);b.render(d);$("#"+a+" .map_legend_tab").click(function(){if($(this).hasClass("right")){var a=
c.s3.id,b=$("#"+a+" .map_legend_panel").outerWidth();$("#"+a+" .map_legend_div").animate({marginRight:"-"+b+"px"});$("#"+a+" .map_legend_tab").removeClass("right").addClass("left")}else T(c)});return b},T=function(c){c=c.s3.id;$("#"+c+" .map_legend_div").animate({marginRight:0});$("#"+c+" .map_legend_tab").removeClass("left").addClass("right")},O=function(c,a,b){OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(a){return!0},CLASS_NAME:"OpenLayers.Handler.PointS3"});
var d=c.s3.draftLayer,e=new OpenLayers.Control.DrawFeature(d,OpenLayers.Handler.PointS3,{featureAdded:function(a){c.s3.lastDraftFeature?c.s3.lastDraftFeature.destroy():1<d.features.length&&d.features[0].destroy();void 0!=c.s3.pointPlaced&&c.s3.pointPlaced(a);c.s3.lastDraftFeature=a}});if(a){var f=new GeoExt.Action({control:e,handler:function(){f.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:c,iconCls:"drawpoint-off",tooltip:i18n.gis_draw_feature,
allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:b});a.add(f);c.s3.pointButton=f}else c.addControl(e),b&&(e.activate(),$(".olMapViewport").addClass("crosshair"))},P=function(c,a,b){var d=c.s3.draftLayer,e=new OpenLayers.Control.DrawFeature(d,OpenLayers.Handler.Path,{featureAdded:function(a){c.s3.lastDraftFeature?c.s3.lastDraftFeature.destroy():1<d.features.length&&d.features[0].destroy();void 0!=c.s3.pointPlaced&&c.s3.pointPlaced(a);c.s3.lastDraftFeature=a}});if(a){var f=new GeoExt.Action({control:e,
handler:function(){f.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:c,iconCls:"drawline-off",tooltip:i18n.gis_draw_line,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:b,activateOnEnable:!0,deactivateOnDisable:!0});a.add(f);c.s3.lineButton=f}else c.addControl(e),b&&(e.activate(),$(".olMapViewport").addClass("crosshair"))},Q=function(c,a,b,d){var e=c.s3.draftLayer;d=new OpenLayers.Control.DrawFeature(e,d?OpenLayers.Handler.Polygon:
OpenLayers.Handler.RegularPolygon,{handlerOptions:d?{sides:4,snapAngle:90}:{},featureAdded:function(a){c.s3.lastDraftFeature?c.s3.lastDraftFeature.destroy():1<e.features.length&&e.features[0].destroy();var b=$("#gis_location_wkt");if(b.length){var d=a.geometry.transform(c.getProjectionObject(),u).toString();b.val(d);$("#gis_location_lat").val("");$("#gis_location_lon").val("")}else b=$("#gis_search_polygon_input"),b.length&&(d=a.geometry.transform(c.getProjectionObject(),u).toString(),b.val(d).trigger("change"));
void 0!=c.s3.pointPlaced&&c.s3.pointPlaced(a);void 0!=c.s3.pointPlaced&&c.s3.pointPlaced(a);c.s3.lastDraftFeature=a}});if(a){var f=new GeoExt.Action({control:d,handler:function(){f.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:c,iconCls:"drawpolygon-off",tooltip:i18n.gis_draw_polygon,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:b,activateOnEnable:!0,deactivateOnDisable:!0});a.add(f);c.s3.polygonButton=f}else c.addControl(d),
b&&(d.activate(),$(".olMapViewport").addClass("crosshair"))},ma=function(c){var a=c.map,b=new Ext.Toolbar.Button({iconCls:"potlatch",tooltip:i18n.gis_potlatch,handler:function(){var b=a.getZoom();if(14>b)alert(i18n.gis_osm_zoom_closer);else{var c=a.getCenter();c.transform(a.getProjectionObject(),u);b=S3.Ap.concat("/gis/potlatch2/potlatch2.html")+"?lat="+c.lat+"&lon="+c.lon+"&zoom="+b;window.open(b)}}});c.addSeparator();c.addButton(b)},ia=function(c){var a=new Ext.Toolbar.Button({iconCls:"print",tooltip:i18n.gis_print,
handler:function(){var a=H(c.map,!0),a=S3.Ap.concat("/gis/screenshot/")+a;window.open(a)}});c.addButton(a)},ja=function(c){var a=new Ext.Toolbar.Button({iconCls:"save",tooltip:i18n.gis_save,handler:function(){H(c.map)}});c.addButton(a)},pa=function(c){var a=c.s3,b=a.id;if(!$("#"+b+" .map_save_panel").length){var d='<div class="fleft"><div class="map_save_name">';(a=a.options.config_name)&&(d+=a);d='<div class="map_save_panel off">'+(d+"</div></div>")+'<div class="btn map_save_button"><div class="map_save_label">'+
i18n.gis_save_map+"</div></div></div>";$("#"+b).append(d);a&&$("#"+b+" .map_save_panel").removeClass("off");$("#"+b+" .map_save_button").click(function(){X(c)})}},X=function(c){var a=c.s3.id;$("#"+a+" .map_save_panel").removeClass("off");$("#"+a+" .map_save_panel .saved").remove();$("#"+a+" .map_save_panel .fleft").show();$("#"+a+" .map_save_label").html(i18n.save);Y(c)},Y=function(c){var a=c.s3,b=a.id,d=a.options,e=d.config_id,f=d.config_name?d.config_name:"",g=$("#"+b+" .map_save_button"),h=b+"_save",
a=$("#"+h);a.length||(a='<div class="hint">'+('<label for="'+h+'">'+i18n.gis_name_map+"</label>")+('<input id="'+h+'" value="'+f+'">')+"</div>",e='<div class="new_map"><input type="checkbox" class="checkbox"'+(e?"":' disabled="disabled" checked="checked"')+">"+i18n.gis_new_map+"</div>",$("#"+b+" .map_save_panel .fleft").html(a+e),$("#"+b+" .map_save_panel label").labelOver("over"));g.unbind("click").click(function(){H(c);var a=$("#"+b+"_save").val();$("#"+b+" .map_save_name").html(a);d.config_name=
a;a=d.pe_id?"?~.pe_id__belongs="+d.pe_id:"";a='<div class="saved"><p><i>'+i18n.saved+'</i></p><p><a href="'+S3.Ap.concat("/gis/config")+a+'">'+i18n.gis_my_maps+"</a></p></div>";$("#"+b+" .map_save_panel .fleft").hide().before(a);$("#"+b+" .map_save_panel .checkbox").prop("checked",!1).prop("disabled",!1);g.unbind("click").click(function(){X(c)})});var l=$("#"+b+" .map_save_panel");$("html").unbind("click.cancelSave").bind("click.cancelSave",function(){l.addClass("off");g.unbind("click").click(function(){l.removeClass("off").unbind("click");
Y(c)})});l.click(function(a){a.stopPropagation()})},H=function(c,a){var b=Na(c),d=JSON.stringify,e=d(b.layers),d=d(b.plugins),b={lat:b.lat,lon:b.lon,zoom:b.zoom,layers:e,plugins:d},e=c.s3,f=e.options;f.pe_id&&(b.pe_id=f.pe_id);if(a){var g,e=!1;b.temp=1}else e=e.id,d=$("#"+e+"_save"),g=f.config_id,d.length?(b.hide=1,b.name=d.val(),e=g?!$("#"+e+' .map_save_panel input[type="checkbox"]').prop("checked"):!1):e=g?!0:!1;e=e?S3.Ap.concat("/gis/config/"+g+".url/update"):S3.Ap.concat("/gis/config.url/create");
$.ajaxS3({async:!1,url:e,type:"POST",data:b,dataType:"json",success:function(b,c){g=b.id;if(!a&&g){f.config_id=g;if(history.pushState)if(document.location.search)for(var d=document.location.search.split("?")[1].split("&"),e=[],p=0;p<d.length;p++){if(e=d[p].split("="),"config"==decodeURIComponent(e[0])&&decodeURIComponent(e[1])!=g){d[p]="config="+g;d=document.location.pathname+"?"+d.join("&");window.history.pushState({},document.title,d);break}}else if(document.location.pathname==S3.Ap.concat("/gis/index")||
document.location.pathname==S3.Ap.concat("/gis/map_viewing_client"))d=document.location.pathname+"?config="+g,window.history.pushState({},document.title,d);d=S3.Ap.concat("/gis/config/",g,"/layer_entity");$("#gis_menu_config").attr("href",d)}}});return g},Na=function(c){var a={},b=c.getCenter();b.transform(c.getProjectionObject(),u);a.lon=b.lon;a.lat=b.lat;a.zoom=c.getZoom();var d=[],e,f,g=c.baseLayer.s3_layer_id;Ext.iterate(c.layers,function(a,b,c){e=a.s3_layer_id;f={id:e};a.visibility&&(f.visible=
a.visibility);e==g&&(f.base=!0);a.s3_style&&(f.style=a.s3_style);d.push(f)});a.layers=d;var h=[];Ext.iterate(c.s3.plugins,function(a,b,c){a.getState&&h.push(a.getState())});a.plugins=h;return a},la=function(c){var a=c.map,b=a.s3.options;selectPdfControl=new OpenLayers.Control;OpenLayers.Util.extend(selectPdfControl,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{done:this.getPdf});this.box.activate()},response:function(a){this.w.destroy();a=(new OpenLayers.Format.GML).read(a.responseText);
var b=a.length+" pdfs. <br /><ul>";if(a.length)for(var c=0;c<a.length;c++)var d=a[c],b=b+("<li><a href='"+a[c].attributes.url+"'>"+(d.attributes.utm_zone+d.attributes.grid_zone+d.attributes.grid_square+d.attributes.easting+d.attributes.northing)+"</a></li>");this.w=new Ext.Window({html:b+"</ul>",width:300,title:"Results",height:200});this.w.show()},getPdf:function(c){var d=a.getProjectionObject(),g=a.getLonLatFromPixel(new OpenLayers.Pixel(c.left,c.bottom)).transform(d,u);c=a.getLonLatFromPixel(new OpenLayers.Pixel(c.right,
c.top)).transform(d,u);bbox=(new OpenLayers.Bounds(g.lon,g.lat,c.lon,c.lat)).toBBOX();OpenLayers.Request.GET({url:b.mgrs_url+"&bbox="+bbox,callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({html:"Searching "+b.mgrs_name+", please wait.",width:200,title:"Please Wait."});this.w.show()}});var d="Select "+b.mgrs_name,d=new GeoExt.Action({text:d,control:selectPdfControl,map:a,allowDepress:!1,toggleGroup:"controls",tooltip:d});c.addSeparator();c.add(d)},qa=function(c,a){var b=
new gxp.plugins.AddLayers({actionTarget:"treepanel.tbar",addActionTip:"Add layers",addActionMenuText:"Add layers",addServerText:"Add a New Server",doneText:"Done",upload:{url:null},uploadText:i18n.gis_uploadlayer,relativeUploadOnly:!1}),d=new GeoExt.data.LayerStore;b.target=a;a.proxy=OpenLayers.ProxyHost;a.layerSources={};a.layerSources.local=new gxp.plugins.LayerSource({title:"local",store:d});b.addActions()[0].enable();b=new gxp.plugins.RemoveLayer({actionTarget:"treepanel.tbar",removeActionTip:"Remove layer"});
b.target=a;a.mapPanel=c.s3.mapPanel;b.addActions()},ra=function(c,a){var b=c.s3.propertiesWindow,d=new Ext.Toolbar.Button({iconCls:"gxp-icon-layerproperties",tooltip:i18n.gis_properties,handler:function(){var d=a.root.findChildBy(function(a){return a.isSelected()?a.leaf?!0:!1:!1},null,!0);if(d){var f=d.layer.s3_layer_type,g=S3.Ap.concat("/gis/layer_"+f+".plain?layer_"+f+".layer_id="+d.layer.s3_layer_id+"&update=1");Ext.Ajax.request({url:g,method:"GET",success:function(a,g){b&&b.close();var m;"feature"==
f?(m=new Ext.TabPanel({activeTab:0,items:[{title:"Layer Properties",html:a.responseText},{title:"Filter",id:"s3_gis_layer_filter_tab",html:""}]}),m.items.items[1].on("activate",function(){var a;Ext.iterate(c.s3.layers_feature,function(b,c,f){b.id==d.layer.s3_layer_id&&(a=b.url.replace(/.geojson.+/,"/search.plain"))});Ext.get("s3_gis_layer_filter_tab").load({url:a,discardUrl:!1,callback:function(){S3.redraw()},text:"Loading...",timeout:30,scripts:!1})})):m=new Ext.Panel({title:"Layer Properties",html:a.responseText});
b=new Ext.Window({width:400,layout:"fit",items:[m]});b.show();$("#plain form").submit(function(){var a=$('#plain input[name="id"]').val(),a=S3.Ap.concat("/gis/layer_"+f+"/"+a+".plain/update"),b=$("#plain input"),c=[];Ext.iterate(b,function(a,b,d){b.id&&-1!=b.id.indexOf("gis_layer_")&&c.push(b.id)});b=[];for(i=0;i<c.length;i++)(q=$("#"+c[i]).serialize())&&b.push(q);(q=$('#plain input[name="id"]').serialize())&&b.push(q);(q=$('#plain input[name="_formkey"]').serialize())&&b.push(q);(q=$('#plain input[name="_formname"]').serialize())&&
b.push(q);0<b.length&&(b=b.join("&"),$.ajaxS3({type:"POST",url:a,data:b,success:function(a){$("#plain").html(a)}}));return!1});S3.addTooltips();S3.autocomplete("role","admin","group","gis_layer_"+f+"_role_required")}})}}});a.getTopToolbar().add(d)},N=function(c,a){var b=new Ext.Toolbar.Button({iconCls:"icon-clearlayers",tooltip:i18n.gis_clearlayers,handler:function(){layers=c.layers;i=0;for(len=layers.length;i<len;i++)layer=layers[i],layer.isBaseLayer||layer.setVisibility(!1)}});a.add(b)},C=function(c,
a){if(void 0!=a.marker)var b=a.marker,d=E+b.i,e=b.h,f=b.w;else d="";var g=a.opacity||1,h=a.style,l="[object Array]"===Object.prototype.toString.call(h)?!0:!1,m=c.s3.options,b=new OpenLayers.Style({label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:"${fillOpacity}",strokeColor:"${stroke}",strokeWidth:"${strokeWidth}",strokeOpacity:"${strokeOpacity}",graphicHeight:"${graphicHeight}",graphicWidth:"${graphicWidth}",graphicName:"${graphicName}",graphicOpacity:g,graphicXOffset:"${graphicXOffset}",
graphicYOffset:"${graphicYOffset}",graphicZIndex:"${graphicZIndex}",externalGraphic:"${externalGraphic}",zIndex:"${zIndex}"},{context:{graphicWidth:function(a){var b=1;a.cluster||(a.attributes.marker_width?b=a.attributes.marker_width:h&&!l&&void 0==h.externalGraphic&&void 0==f&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=m.marker_default.w:void 0!=f&&(b=f));return b},graphicHeight:function(a){var b=1;a.cluster||(a.attributes.marker_height?b=a.attributes.marker_height:h&&!l&&void 0==h.externalGraphic&&
void 0==e&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=m.marker_default.h:void 0!=e&&(b=e));return b},graphicXOffset:function(a){var b=-1;a.cluster||(a.attributes.marker_width?b=-(a.attributes.marker_width/2):h&&!l&&void 0==h.externalGraphic&&void 0==f&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=-(m.marker_default.w/2):void 0!=f&&(b=-(f/2)));return b},graphicYOffset:function(a){var b=-1;a.cluster||(a.attributes.marker_height?b=-a.attributes.marker_height:h&&!l&&void 0==h.externalGraphic&&
void 0==e&&"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?b=-m.marker_default.h:void 0!=e&&(b=-e));return b},graphicName:function(a){var b="circle";a.cluster||(a.attributes.shape?b=a.attributes.shape:h&&!l&&void 0!=h.graphic&&(b=h.graphic));return b},externalGraphic:function(a){var b="";if(!a.cluster)if(a.attributes.marker_url)b=a.attributes.marker_url;else if(h){if(!l)if(void 0!=h.externalGraphic)b=S3.Ap.concat("/static/"+h.externalGraphic);else if("OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME){if(d)return d;
b=E+m.marker_default.i}}else return d;return b},radius:function(a){var b=10;a.cluster?b=Math.min(a.attributes.count/2,8)+10:a.attributes.size?b=a.attributes.size:h&&!l&&(b=h.size);return b},fill:function(a){var b;a.cluster?b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#"+(m.cluster_fill||"8087ff"):a.attributes.colour?b=a.attributes.colour:h?(l||(b=h.fill),b=void 0!=b?"#"+b:"#000000"):b="#f5902e";return b},fillOpacity:function(a){var b;a.cluster?b=a.cluster[0].attributes.opacity?
a.cluster[0].attributes.opacity:g:a.attributes.opacity?b=a.attributes.opacity:h&&!l&&(b=h.fillOpacity);return b||g},stroke:function(a){var b;a.cluster?b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#"+(m.cluster_stroke||"2b2f76"):a.attributes.colour?b=a.attributes.colour:h?(l||(b=h.stroke||h.fill),b=void 0!=b?"#"+b:"#000000"):b="#f5902e";return b},strokeOpacity:function(a){var b;a.cluster?b=a.cluster[0].attributes.opacity?a.cluster[0].attributes.opacity:g:a.attributes.opacity?b=
a.attributes.opacity:h&&!l&&(b=h.strokeOpacity);return b||g},strokeWidth:function(a){var b=2;a.cluster?a.cluster[0].attributes.strokeWidth&&(b=a.cluster[0].attributes.strokeWidth):h&&!l&&(b=h.strokeWidth);return b||2},label:function(a){var b;a.cluster?m.cluster_label&&1<a.attributes.count&&(b=a.attributes.count):a.layer&&void 0!=a.layer.s3_style&&(a=a.layer.s3_style,!l&&a.show_label&&(b=a.label));return b||""},zIndex:function(a){return"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?10:"OpenLayers.Geometry.Line"==
a.geometry.CLASS_NAME?5:0},graphicZIndex:function(a){return"OpenLayers.Geometry.Point"==a.geometry.CLASS_NAME?10:"OpenLayers.Geometry.Line"==a.geometry.CLASS_NAME?5:0}}});if(l){var n=S(a);b.addRules(n)}return[new OpenLayers.StyleMap({"default":b,select:1!=g?{graphicOpacity:1}:{fillColor:"#"+(m.select_fill||"ffdc33"),strokeColor:"#"+(m.select_stroke||"ff9933")}}),d]},S=function(c){var a=[],b,d,e,f,g,h,l,m,n,p,k,r,s;$.each(c.style,function(v,t){var u={};void 0!=t.fallback?(u.title=t.fallback,elsefilter=
u.elseFilter=!0):(b=void 0!=t.prop?t.prop:"value",void 0!=t.cat?(e=t.cat,u.title=t.label||e,u.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:b,value:e})):(u.title=t.label||t.low+"-"+t.high,u.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:b,lowerBoundary:t.low,upperBoundary:t.high})));void 0!=t.externalGraphic?(h=!0,p=!1):void 0!=t.size?(h=!0,p=!1):h=!1;void 0!=t.fill?(p=!1,f="#"+t.fill):void 0!=t.stroke&&(p=
!0,f="#"+t.stroke);g=void 0!=t.fillOpacity?t.fillOpacity:c.opacity||1;k=void 0!=t.strokeOpacity?t.strokeOpacity:1;graphic=void 0!=t.graphic?t.graphic:"square";r=void 0!=t.strokeWidth?t.strokeWidth:2;s={fillColor:f,fillOpacity:g,strokeColor:f,strokeOpacity:k,strokeWidth:r,graphicName:graphic};if(h){if(void 0!=t.externalGraphic){l=S3.Ap.concat("/static/"+t.externalGraphic);var x=new Image;x.src=l;m=x.height;n=x.width;s.externalGraphic=l;s.graphicHeight=m;s.graphicWidth=n;s.graphicXOffset=-(n/2);s.graphicYOffset=
-m}s.pointRadius=t.size||10;s.graphicZIndex=10;s.zIndex=10;s.Point=s}else p&&(s.graphicZIndex=5,s.zIndex=5,s.Line=s);u.symbolizer=s;d=new OpenLayers.Rule(u);a.push(d)});0!=c.cluster_threshold&&(d=new OpenLayers.Rule({elseFilter:!0,title:" "}),a.push(d));return a}})();
