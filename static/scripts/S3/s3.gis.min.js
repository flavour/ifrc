OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";OpenLayers.ProxyHost=S3.Ap.concat("/gis/proxy?url=");S3.gis.maps={};S3.gis.ajax_loader=S3.Ap.concat("/static/img/ajax-loader.gif");S3.gis.marker_url=S3.Ap.concat("/static/img/markers/");S3.gis.format_geojson=new OpenLayers.Format.GeoJSON;S3.gis.proj4326=new OpenLayers.Projection("EPSG:4326");S3.gis.cluster_distance=20;S3.gis.cluster_threshold=2;
(function(){function N(c){var a=this.map.getResolution(),b=Math.round((c.left-this.maxExtent.left)/(a*this.tileSize.w));c=Math.round((this.maxExtent.top-c.top)/(a*this.tileSize.h));var a=this.map.getZoom(),d=Math.pow(2,a);if(0>c||c>=d)return OpenLayers.Util.getImagesLocation()+"404.png";b=a+"/"+(b%d+d)%d+"/"+c+"."+this.type;c=this.url;c instanceof Array&&(c=this.selectUrl(b,c));return c+b}function O(c){c=c.feature;if(!c.cluster){var a=c.layer.map,b=a.s3.lastFeature,d=a.s3.tooltipPopup;if(null===c.popup){null!==
d&&void 0!==d&&(a.removePopup(d),d.destroy(),null!==b&&delete b.popup,d=null);var b=c.geometry.getBounds().getCenterLonLat(),e=c.attributes,g;void 0!=e.popup?g=e.popup:void 0!=e.name?g=e.name:void 0!=c.layer.title&&(g=e[c.layer.title],g="object"==typeof g?g.value:g);g&&(d=new OpenLayers.Popup("activetooltip",b,new OpenLayers.Size(80,12),g,!1));null!==d&&void 0!==d&&(d.contentDiv.style.backgroundColor="ffffcb",d.contentDiv.style.overflow="hidden",d.contentDiv.style.padding="3px",d.contentDiv.style.margin=
"10px",d.closeOnMove=!0,d.autoSize=!0,d.opacity=0.7,c.popup=d,a.addPopup(d))}}}function G(c){c=c.feature;if(null!==c&&null!==c.popup){var a=c.layer.map;a.removePopup(c.popup);c.popup.destroy();delete c.popup;a.s3.tooltipPopup=null;a.s3.lastFeature=null}}function H(c,a,b){$.ajax({url:c,success:function(c){$("#"+a).html(c);b.updateSize()},error:function(c,e,g){msg="UNAUTHORIZED"==g?i18n.gis_requires_login:c.responseText;$("#"+a+"_contentDiv").html(msg);b.updateSize()},dataType:"html"})}function E(c){G(c);
c=c.feature;var a=c.layer,b=a.s3_layer_type,d=a.map,e=c.geometry.getBounds().getCenterLonLat(),g=S3.uid(),a=void 0!=a.title?a.title:"name",k,m,p;if(c.cluster){var l=c.cluster;k=i18n.gis_cluster_multiple+":<ul>";for(var n=l.length,s=d.s3.id,h=0;h<n;h++){var f=l[h].attributes,b=void 0!=f.popup?f.popup.split("<br />",1)[0]:f[a];k=void 0!=f.url?k+("<li><a href='javascript:s3_gis_loadClusterPopup(\""+s+'", "'+f.url+'", "'+g+"\")'>"+b+"</a></li>"):k+("<li>"+b+"</li>")}k+="</ul>";k+="<div align='center'><a href='javascript:s3_gis_zoomToSelectedFeature(\""+
s+'", '+e.lon+","+e.lat+", 3)'>"+i18n.gis_zoomin+"</a></div>"}else if("kml"==b){f=c.attributes;if(void 0!=c.style.balloonStyle)k=c.style.balloonStyle.replace(/{([^{}]*)}/g,function(a,b){var c=f[b];return"string"===typeof c||"number"===typeof c?c:a});else{l=typeof f[a];b="object"==l?f[a].value:f[a];k="<h3>"+b+"</h3>";for(var b=c.layer.body.split(" "),t,a=0;a<b.length;a++)l=typeof f[b[a]],"object"==l?(l=f[b[a]].displayName,""===l&&(l=b[a]),n=f[b[a]].value,t='<div class="gis_popup_row"><div class="gis_popup_label">'+
l+':</div><div class="gis_popup_cell">'+n+"</div></div>"):t=void 0!=f[b[a]]?'<div class="gis_popup_row">'+f[b[a]]+"</div>":"",k+=t}-1!=k.search("<script")&&(k="Content contained Javascript! Escaped content below.<br />"+k.replace(/</g,"<"))}else if("gpx"!=b)if("shapefile"==b)f=c.attributes,k="<div>",$.each(f,function(a,b){"id_orig"==a&&(a="id");t='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_cell">'+b+"</div></div>";k+=t}),k+="</div>";else if("wfs"==b)f=
c.attributes,b=f[a],k="<h3>"+b+"</h3>",$.each(f,function(a,b){t='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_val">'+b+"</div></div>";k+=t});else if(void 0!=c.attributes.url)p=c.attributes.url,k=i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 />";else{f=c.attributes;b=void 0==f.name?"":"<h3>"+f.name+"</h3>";a=void 0==f.description?"":"<p>"+f.description+"</p>";l=void 0==f.link?"":'<a href="'+f.link+'" target="_blank">'+f.link+"</a>";if(void 0==
f.data)n="";else if(0===f.data.indexOf("http://")){m=!0;var r=S3.uid(),n='<div id="'+r+'">'+i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 /></div>"}else n="<p>"+f.data+"</p>";s=void 0==f.image?"":0===f.image.indexOf("http://")?'<img src="'+f.image+'" height=300 width=300>':"";k=b+a+l+n+s}e=new OpenLayers.Popup.FramedCloud(g,e,new OpenLayers.Size(200,200),k,null,!0,P);void 0!=p?H(p,g+"_contentDiv",e):m&&H(c.attributes.data,r,e);c.popup=e;d.addPopup(e)}function F(c){c=c.feature;c.popup&&
(c.layer.map.removePopup(c.popup),c.popup.destroy(),delete c.popup)}function P(c){for(c=c.feature.layer.map;c.popups.length;)c.removePopup(c.popups[0])}function Q(c,a){var b=a.geometry.getCentroid(),d=a.geometry.getBounds(),e=Math.abs((d.right-d.left)/2),g=0,k="up";window.resizeInterval=window.setInterval(function(){16<g&&clearInterval(window.resizeInterval);var d=0.03*e/e;switch(g){case 4:case 12:k="down";break;case 8:k="up"}"up"!==k&&(d=-Math.abs(d));a.geometry.resize(1+d,b);c.s3.draftLayer.drawFeature(a);
g++},50,b,e)}function R(c){c&&S3.gis.googleEarthPanel.earth.getFeatures().appendChild(c)}function S(c){var a={},b=c.getCenter();b.transform(c.getProjectionObject(),S3.gis.proj4326);a.lon=b.lon;a.lat=b.lat;a.zoom=c.getZoom();var d=[],e,g,k=c.baseLayer.s3_layer_id;Ext.iterate(c.layers,function(a,b,c){e=a.s3_layer_id;g={id:e};a.visibility&&(g.visible=a.visibility);e==k&&(g.base=!0);a.s3_style&&(g.style=a.s3_style);d.push(g)});a.layers=d;var m=[];Ext.iterate(c.s3.plugins,function(a,b,c){a.getState&&m.push(a.getState())});
a.plugins=m;return a}S3.gis.show_map=function(c,a){void 0==c&&(c="default");void 0==a&&(a={});var b=S3.gis;a.map_height=b.map_height;a.map_width=b.map_width;a.zoom=b.zoom;var d=b.lat,e=b.lon,g=b.bottom_left,k=b.top_right,m=new OpenLayers.Projection("EPSG:"+b.projection);a.projection=m;a.maxResolution=b.maxResolution;var p=b.maxExtent;a.maxExtent=new OpenLayers.Bounds(p[0],p[1],p[2],p[3]);a.numZoomLevels=b.numZoomLevels;a.units=b.units;a.draw_feature=b.draw_feature;a.draw_polygon=b.draw_polygon;a.loc_select=
b.loc_select;a.mouse_position=b.mouse_position;a.osm_oauth=b.osm_oauth;a.overview=b.overview;a.permalink=b.permalink;a.scaleline=b.scaleline;a.zoomcontrol=b.zoomcontrol;a.toolbar=b.toolbar;a.mgrs_name=b.mgrs_name;a.mgrs_url=b.mgrs_url;a.wms_browser_name=b.wms_browser_name;a.wms_browser_url=b.wms_browser_url;a.window=b.window;a.windowHide=b.windowHide;a.maximizable=b.maximizable;a.windowNotClosable=b.windowNotClosable;a.west_collapsed=b.west_collapsed;var l;if(d&&e){var n=new OpenLayers.LonLat(e,d);
n.transform(S3.gis.proj4326,m)}else g&&k&&(g=new OpenLayers.LonLat(g[0],g[1]),g.transform(S3.gis.proj4326,m),l=g.lon,g=g.lat,k=new OpenLayers.LonLat(k[0],k[1]),k.transform(S3.gis.proj4326,m),l=OpenLayers.Bounds.fromArray([l,g,k.lon,k.lat]),n=l.getCenterLonLat());a.center=n;k=T(c,a);a.renderTo="map_panel";U(k);l&&k.zoomToExtent(l);return k};var T=function(c,a){var b=new OpenLayers.Map("center",{controls:[],displayProjection:S3.gis.proj4326,projection:a.projection,theme:null,maxResolution:a.maxResolution,
maxExtent:a.maxExtent,numZoomLevels:a.numZoomLevels,units:a.units});S3.gis.maps[c]=b;b.s3={};b.s3.id=c;b.s3.options=a;b.s3.plugins=[];b.registerPlugin=function(a){a.map=this;this.s3.plugins.push(a)};b.showThrobber=function(a){$(".layer_throbber").show().removeClass("hide");this.s3.layers_loading.pop(a);this.s3.layers_loading.push(a)};b.hideThrobber=function(a){this.s3.layers_loading.pop(a);0===this.s3.layers_loading.length&&$(".layer_throbber").hide().addClass("hide")};V(b);W(b);return b},U=function(c){var a=
c.s3,b=a.options,d=new GeoExt.MapPanel({height:b.map_height,width:b.map_width,xtype:"gx_mappanel",map:c,center:b.center,zoom:b.zoom,plugins:[]});a.mapPanel=d;var e={};e.map=d;a.portal=e;if(i18n.gis_legend||b.layers_wms)for(e=0;e<c.layers.length;e++)c.layers[e].legendURL&&(d.layers.data.items[e].data.legendURL=c.layers[e].legendURL),c.layers[e].queryable&&(d.layers.data.items[e].data.queryable=1);d=X(c);e=[d];if(b.wms_browser_url){var g=Y(c);g&&e.push(g)}i18n.gis_legend&&(g=new GeoExt.LegendPanel({title:i18n.gis_legend,
defaults:{labelCls:"mylabel",style:"padding:4px"},bodyStyle:"padding:4px",autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1}),e.push(g));for(var g=a.plugins,k=0,m=g.length;k<m;++k)g[k].setup(c),g[k].addToMapWindow(e);a.west_panel_items=e;b.window?I(c):J(c);d.root.eachChild(function(){this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||c.hideThrobber(this.layer.s3_layer_id)});else this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||
c.hideThrobber(this.layer.s3_layer_id)})})})});Ext.QuickTips.init()},J=function(c){var a=c.s3,b=a.options,d=K(c);c=L(c);b=new Ext.Panel({renderTo:b.renderTo,autoScroll:!0,titleCollapse:!0,height:b.map_height,width:b.map_width,layout:"border",items:[d,c]});a.mapWin=b};S3.gis.addMapPanel=J;var I=function(c){var a=c.s3,b=a.options,d=K(c);c=L(c);d=new Ext.Window({cls:"gis-map-window",collapsible:!1,constrain:!0,closable:!b.windowNotClosable,closeAction:"hide",autoScroll:!0,maximizable:b.maximizable,titleCollapse:!1,
height:b.map_height,width:b.map_width,layout:"border",items:[d,c]});d.on("beforehide",function(a){a.maximized&&a.restore()});b.windowHide||(d.show(),d.maximize());a.mapWin=d};S3.gis.addMapWindow=I;var K=function(c){c=c.s3;var a=c.options.west_collapsed||!1,b=new Ext.Panel({cls:"map_tools",header:!1,border:!1,split:!0,items:c.west_panel_items}),a=new Ext.Panel({region:"west",header:!1,border:!0,width:250,autoScroll:!0,collapsible:!0,collapseMode:"mini",collapsed:a,items:[b]});return c.westPanelContainer=
a},L=function(c){var a=c.s3,b=a.options;if(b.toolbar){var d,e=c.s3.options;d=new Ext.Toolbar({height:34});d.map=c;var g=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtent,map:c,iconCls:"zoomfull",tooltip:i18n.gis_zoomfull}),k=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:!0}),map:c,iconCls:"zoomout",tooltip:i18n.gis_zoomout,toggleGroup:"controls"}),m=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox,map:c,iconCls:"zoomin",tooltip:i18n.gis_zoominbutton,toggleGroup:"controls"}),
p,l,n;"active"==e.draw_polygon?(p=!0,n=l=!1):("active"==e.draw_feature?(n=!0,l=!1):(l=!0,n=!1),p=!1);d.add(g);navigator.geolocation&&Z(d);void 0===e.loc_select&&(g=new GeoExt.Action({control:new OpenLayers.Control.Navigation,map:c,iconCls:"pan-off",tooltip:i18n.gis_pan,allowDepress:!0,toggleGroup:"controls",pressed:l}),d.add(k),d.add(m),d.add(g),d.addSeparator(),m=new OpenLayers.Control.NavigationHistory,d.map.addControl(m),m.activate(),k=new Ext.Toolbar.Button({iconCls:"back",tooltip:i18n.gis_navPrevious,
handler:m.previous.trigger}),m=new Ext.Toolbar.Button({iconCls:"next",tooltip:i18n.gis_navNext,handler:m.next.trigger}),d.addButton(k),d.addButton(m));void 0===e.loc_select&&S3.auth&&aa(d);d.addSeparator();ba(d);e.mgrs_url&&ca(d);if(e.draw_feature||e.draw_polygon)d.addSeparator(),e.draw_feature&&M(d,n),e.draw_polygon&&da(d,p,!0);i18n.gis_get_feature_info&&(p=new gxp.plugins.WMSGetFeatureInfo({actionTarget:"gis_toolbar",outputTarget:"map",outputConfig:{width:400,height:200},toggleGroup:"controls",
format:"grid",infoActionTip:i18n.gis_get_feature_info,popupTitle:i18n.gis_feature_info}),p.target=c.s3,p.addActions());e.osm_oauth&&ea(d);e.Google&&e.Google.StreetviewButton&&fa(d);try{e.Google.Earth&&google&ga(d)}catch(s){}i18n.gis_search&&(e=Math.min(350,e.loc_select?e.map_width-500:e.map_width-680),c=new GeoExt.ux.GeoNamesSearchCombo({map:c,width:e,listWidth:e,minChars:2,emptyText:i18n.gis_search}),d.addSeparator(),d.add(c));c=new Ext.BoxComponent({autoEl:{tag:"img",src:S3.gis.ajax_loader},cls:"layer_throbber hide"});
d.add(c)}else b.draw_feature&&M(null,"active"==b.draw_feature?!0:!1);d=new Ext.Panel({layout:"card",region:"center",cls:"mappnlcntr",defaults:{border:!1},items:[a.mapPanel],activeItem:0,tbar:d,scope:this});a.mapPanelContainer=d;b.Google&&b.Google.Earth&&(b=new gxp.GoogleEarthPanel({mapPanel:a.mapPanel}),d.items.items.push(b),a.googleEarthPanel=b,S3.gis.googleEarthPanel=b);return d},X=function(c){for(var a=c.s3.mapPanel.layers,b=[{text:i18n.gis_base_layers,nodeType:"gx_baselayercontainer",layerStore:a,
loader:{filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!0===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,expanded:!0},{text:i18n.gis_overlays,nodeType:"gx_overlaylayercontainer",layerStore:a,loader:{filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!1===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,expanded:!0}],d=c.s3.dirs,e=0;e<d.length;e++){var g={text:d[e],nodeType:"gx_layercontainer",layerStore:a,loader:{filter:function(a){return function(b){if("undefined"!==
b.data.layer.dir)return b.data.layer.dir===a}}(d[e])},leaf:!1,expanded:!0};b.push(g)}a=new Ext.tree.AsyncTreeNode({expanded:!0,children:b});b=i18n.gis_uploadlayer||i18n.gis_properties?new Ext.Toolbar:null;a=new Ext.tree.TreePanel({title:i18n.gis_layers,loader:new Ext.tree.TreeLoader({applyLoader:!1}),root:a,rootVisible:!1,split:!0,autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1,tbar:b,enableDD:!0});i18n.gis_uploadlayer&&ha(c,a);i18n.gis_properties&&ia(c,a);return a},Y=function(c){var a=
new Ext.tree.AsyncTreeNode({expanded:!0,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+S3.gis.wms_browser_url,layerOptions:{buffer:1,singleTile:!1,ratio:1,wrapDateLine:!0},layerParams:{TRANSPARENT:"TRUE"},createNode:function(a){a.checked=a.leaf?!1:void 0;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[a])}})});return new Ext.tree.TreePanel({title:c.s3.options.wms_browser_name,root:a,rootVisible:!1,split:!0,autoScroll:!0,collapsible:!0,collapseMode:"mini",
lines:!1,listeners:{checkchange:function(a,d){!0===d?c.addLayer(a.attributes.layer):c.removeLayer(a.attributes.layer)}}})},V=function(c){var a=c.s3,b=S3.gis,d=a.options;d.features=b.features;d.layers_arcrest=b.layers_arcrest;d.layers_feature=b.layers_feature;d.layers_feature_query=b.layers_feature_query;d.layers_feature_resource=b.layers_feature_resource;d.layers_geojson=b.layers_geojson;d.layers_georss=b.layers_georss;d.layers_gpx=b.layers_gpx;d.layers_kml=b.layers_kml;d.layers_osm=b.layers_osm;
d.layers_shapefile=b.layers_shapefile;d.layers_theme=b.layers_theme;d.layers_tms=b.layers_tms;d.layers_wfs=b.layers_wfs;d.layers_wms=b.layers_wms;d.layers_xyz=b.layers_xyz;d.Bing=b.Bing;d.CoordinateGrid=b.CoordinateGrid;d.EmptyLayer=b.EmptyLayer;d.Google=b.Google;d.OWM=b.OWM;a.layers_all=[];a.dirs=[];a.layers_loading=[];a.common_cluster_strategy=new OpenLayers.Strategy.AttributeClusterMultiple({attribute:"colour",distance:S3.gis.cluster_distance,threshold:S3.gis.cluster_threshold});if(d.layers_osm){b=
d.layers_osm;for(a=b.length;0<a;a--){var e=c,g=b[a-1],k=g.name,m=[g.url1];void 0!=g.url2&&m.push(g.url2);void 0!=g.url3&&m.push(g.url3);var p=void 0,p=void 0!=g.visibility?g.visibility:!0,l=void 0;void 0!=g.dir?(l=g.dir,-1==$.inArray(l,e.s3.dirs)&&e.s3.dirs.push(l)):l="";var n=void 0,n=void 0!=g.base?g.base:!0,s=void 0,s=void 0!=g.zoomLevels?g.zoomLevels:19,k=new OpenLayers.Layer.TMS(k,m,{dir:l,type:"png",getURL:N,displayOutsideMaxExtent:!0,numZoomLevels:s,isBaseLayer:n,s3_layer_id:g.id,s3_layer_type:"openstreetmap"});
void 0!=g.attribution&&(k.attribution=g.attribution);k.setVisibility(p);e.addLayer(k);g._base&&e.setBaseLayer(k)}}try{var a=google,h=c.s3.options.Google,f;h.MapMaker||h.MapMakerHybrid?(h.Satellite&&(f=new OpenLayers.Layer.Google(h.Satellite.name,{type:G_SATELLITE_MAP,sphericalMercator:!0,s3_layer_id:h.Satellite.id,s3_layer_type:"google"}),c.addLayer(f),"satellite"==h.Base&&c.setBaseLayer(f)),h.Maps&&(f=new OpenLayers.Layer.Google(h.Maps.name,{type:G_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:h.Maps.id,
s3_layer_type:"google"}),c.addLayer(f),"maps"==h.Base&&c.setBaseLayer(f)),h.Hybrid&&(f=new OpenLayers.Layer.Google(h.Hybrid.name,{type:G_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:h.Hybrid.id,s3_layer_type:"google"}),c.addLayer(f),"maps"==h.Base&&c.setBaseLayer(f)),h.Terrain&&(f=new OpenLayers.Layer.Google(h.Terrain.name,{type:G_PHYSICAL_MAP,sphericalMercator:!0,s3_layer_id:h.Terrain.id,s3_layer_type:"google"}),c.addLayer(f),"terrain"==h.Base&&c.setBaseLayer(f)),h.MapMaker&&(f=new OpenLayers.Layer.Google(h.MapMaker.name,
{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:f.id,s3_layer_type:"google"}),c.addLayer(f),"mapmaker"==h.Base&&c.setBaseLayer(f)),h.MapMakerHybrid&&(f=new OpenLayers.Layer.Google(h.MapMakerHybrid.name,{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:f.id,s3_layer_type:"google"}),c.addLayer(f),"mapmakerhybrid"==h.Base&&c.setBaseLayer(f))):(h.Satellite&&(f=new OpenLayers.Layer.Google(h.Satellite.name,{type:"satellite",numZoomLevels:22,s3_layer_id:h.Satellite.id,s3_layer_type:"google"}),
c.addLayer(f),"satellite"==h.Base&&c.setBaseLayer(f)),h.Maps&&(f=new OpenLayers.Layer.Google(h.Maps.name,{numZoomLevels:20,s3_layer_id:h.Maps.id,s3_layer_type:"google"}),c.addLayer(f),"maps"==h.Base&&c.setBaseLayer(f)),h.Hybrid&&(f=new OpenLayers.Layer.Google(h.Hybrid.name,{type:"hybrid",numZoomLevels:20,s3_layer_id:h.Hybrid.id,s3_layer_type:"google"}),c.addLayer(f),"hybrid"==h.Base&&c.setBaseLayer(f)),h.Terrain&&(f=new OpenLayers.Layer.Google(h.Terrain.name,{type:"terrain",s3_layer_id:h.Terrain.id,
s3_layer_type:"google"}),c.addLayer(f),"terrain"==h.Base&&c.setBaseLayer(f)));a&NaN}catch(t){}d.Bing&&(a=c.s3.options.Bing,h=a.ApiKey,a.Aerial&&(f=new OpenLayers.Layer.Bing({key:h,type:"Aerial",name:a.Aerial.name,s3_layer_id:a.Aerial.id,s3_layer_type:"bing"}),c.addLayer(f),"aerial"==a.Base&&c.setBaseLayer(f)),a.Road&&(f=new OpenLayers.Layer.Bing({key:h,type:"Road",name:a.Road.name,s3_layer_id:a.Road.id,s3_layer_type:"bing"}),c.addLayer(f),"road"==a.Base&&c.setBaseLayer(f)),a.Hybrid&&(f=new OpenLayers.Layer.Bing({key:h,
type:"AerialWithLabels",name:a.Hybrid.name,s3_layer_id:a.Hybrid.id,s3_layer_type:"bing"}),c.addLayer(f),"hybrid"==a.Base&&c.setBaseLayer(f)));if(d.layers_tms){h=d.layers_tms;for(a=h.length;0<a;a--)f=c,b=h[a-1],e=b.name,g=[b.url],void 0!=b.url2&&g.push(b.url2),void 0!=b.url3&&g.push(b.url3),p=b.layername,k=void 0,k=void 0!=b.zoomLevels?b.zoomLevels:19,m=void 0,void 0!=b.dir?(m=b.dir,-1==$.inArray(m,f.s3.dirs)&&f.s3.dirs.push(m)):m="",l=void 0,l=void 0!=b.format?b.format:"png",e=new OpenLayers.Layer.TMS(e,
g,{dir:m,s3_layer_id:b.id,s3_layer_type:"tms",layername:p,type:l,numZoomLevels:k}),void 0!=b.attribution&&(e.attribution=b.attribution),f.addLayer(e),b._base&&f.setBaseLayer(e)}if(d.layers_wms){h=d.layers_wms;for(a=h.length;0<a;a--){f=c;var b=h[a-1],r=b.name,v=b.url;void 0!=b.username&&void 0!=b.password&&(v=v.replace("://","://"+b.username+":"+b.password+"@"));var u=b.layers,w=void 0,w=void 0!=b.visibility?b.visibility:!0,x=void 0;void 0!=b.dir?(x=b.dir,-1==$.inArray(x,f.s3.dirs)&&f.s3.dirs.push(x)):
x="";var e=void 0,e=void 0!=b.base?b.base:!1,z=void 0,z=void 0!=b.transparent?b.transparent:!0,g=void 0,g=void 0!=b.format?b.format:"image/png",p=void 0,p=void 0!=b.version?b.version:"1.1.1",k=void 0,k=void 0!=b.map?b.map:"",m=void 0,m=void 0!=b.style?b.style:"",l=void 0,l=void 0!=b.bgcolor?"0x"+b.bgcolor:"",n=void 0,n=void 0!=b.buffer?b.buffer:0,s=void 0,s=void 0!=b.tiled?b.tiled:!1,C=void 0,C=void 0!=b.opacity?b.opacity:1,D=void 0,D=void 0!=b.queryable?b.queryable:1,y=void 0;void 0!=b.legendURL&&
(y=b.legendURL);r=new OpenLayers.Layer.WMS(r,v,{layers:u,transparent:z},{dir:x,wrapDateLine:!0,isBaseLayer:e,s3_layer_id:b.id,s3_layer_type:"wms",queryable:D,visibility:w});k&&(r.params.MAP=k);g&&(r.params.FORMAT=g);p&&(r.params.VERSION=p);m&&(r.params.STYLES=m);l&&(r.params.BGCOLOR=l);s&&(r.params.TILED=!0,r.params.TILESORIGIN=[f.maxExtent.left,f.maxExtent.bottom]);e||(r.opacity=C,r.buffer=n?n:0);y&&(r.legendURL=y);f.addLayer(r);b._base&&f.setBaseLayer(r)}}if(d.layers_xyz){h=d.layers_xyz;for(a=h.length;0<
a;a--)f=c,b=h[a-1],e=b.name,g=[b.url],void 0!=b.url2&&g.push(b.url2),void 0!=b.url3&&g.push(b.url3),p=b.layername,k=void 0,k=void 0!=b.zoomLevels?b.zoomLevels:19,m=void 0,void 0!=b.dir?(m=b.dir,-1==$.inArray(m,f.s3.dirs)&&f.s3.dirs.push(m)):m="",l=void 0,l=void 0!=b.format?b.format:"png",e=new OpenLayers.Layer.XYZ(e,g,{dir:m,s3_layer_id:b.id,s3_layer_type:"xyz",layername:p,type:l,numZoomLevels:k}),void 0!=b.attribution&&(e.attribution=b.attribution),f.addLayer(e),b._base&&f.setBaseLayer(e)}d.EmptyLayer&&
(a=new OpenLayers.Layer(d.EmptyLayer.name,{isBaseLayer:!0,displayInLayerSwitcher:!0,s3_layer_id:d.EmptyLayer.id,s3_layer_type:"empty"}),c.addLayer(a),d.EmptyLayer.base&&c.setBaseLayer(a));try{addJSLayers()}catch(na){}if(d.layers_theme){h=d.layers_theme;for(a=h.length;0<a;a--)A(c,h[a-1])}if(d.layers_geojson){h=d.layers_geojson;for(a=h.length;0<a;a--)A(c,h[a-1])}if(d.layers_gpx){h=d.layers_gpx;for(a=h.length;0<a;a--)ja(c,h[a-1])}if(d.layers_arcrest){h=d.layers_arcrest;for(a=h.length;0<a;a--)f=c,b=h[a-
1],g=b.name,p=[b.url],k=void 0,k=void 0!=b.layers?b.layers.join():0,m=void 0,void 0!=b.dir?(m=b.dir,-1==$.inArray(m,f.s3.dirs)&&f.s3.dirs.push(m)):m="",l=void 0,l=void 0!=b.base?b.base:!1,n=void 0,n=void 0!=b.transparent?b.transparent:!0,e=void 0,e=void 0!=b.visibility?b.visibility:!0,g=new OpenLayers.Layer.ArcGIS93Rest(g,p,{layers:"show:"+k,isBaseLayer:l,transparent:n,dir:m,s3_layer_id:b.id,s3_layer_type:"arcrest"}),g.setVisibility(e),f.addLayer(g),b._base&&f.setBaseLayer(g)}d.CoordinateGrid&&(a=
c.s3.options.CoordinateGrid,c.addLayer(new OpenLayers.Layer.cdauth.CoordinateGrid(null,{name:a.name,shortName:"grid",visibility:a.visibility,s3_layer_id:a.id,s3_layer_type:"coordinate"})));if(d.layers_georss){h=d.layers_georss;for(a=h.length;0<a;a--)A(c,h[a-1])}if(d.layers_kml){c.s3.format_kml=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2});h=d.layers_kml;for(a=h.length;0<a;a--)ka(c,h[a-1])}d.OWM&&la(c);if(d.layers_shapefile){h=d.layers_shapefile;for(a=h.length;0<a;a--)A(c,
h[a-1])}if(d.layers_wfs){h=d.layers_wfs;for(a=h.length;0<a;a--)ma(c,h[a-1])}if(d.layers_feature_query){h=d.layers_feature_query;for(a=h.length;0<a;a--)A(c,h[a-1])}if(d.layers_feature_resource){h=d.layers_feature_resource;for(a=h.length;0<a;a--)A(c,h[a-1])}if(d.layers_feature){h=d.layers_feature;for(a=h.length;0<a;a--)A(c,h[a-1])}if(d.features||d.draw_feature||d.draw_polygon||navigator.geolocation){var B;B=S3.gis.marker_url+S3.gis.marker_default;a=S3.gis.marker_default_height;h=S3.gis.marker_default_width;
f=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);f.graphicOpacity=1;f.graphicWidth=h;f.graphicHeight=a;f.graphicXOffset=-(h/2);f.graphicYOffset=-a;f.externalGraphic=B;B=new OpenLayers.Layer.Vector(i18n.gis_draft_layer,{style:f,displayInLayerSwitcher:!1});B.setVisibility(!0);c.addLayer(B);c.s3.draftLayer=B}if(d.features){d=d.features;c=c.getProjectionObject();h=S3.gis.proj4326;for(a=0;a<d.length;a++)f=parseFeature(d[a]),f.geometry.transform(h,c),B.addFeatures([f])}},A=function(c,
a){var b=a.name,d=a.url,e;if(void 0!=a.marker_image){e=S3.gis.marker_url+a.marker_image;var g=a.marker_height,k=a.marker_width}else e="";var m;m=void 0!=a.refresh?a.refresh:900;var p;void 0!=a.dir?(p=a.dir,-1==$.inArray(p,c.s3.dirs)&&c.s3.dirs.push(p)):p="";var l;l=void 0!=a.visibility?a.visibility:!0;var n;n=void 0!=a.opacity?a.opacity:1;var s;s=void 0!=a.cluster_attribute?a.cluster_attribute:"colour";var h;h=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;var f;f=void 0!=a.cluster_threshold?
a.cluster_threshold:S3.gis.cluster_threshold;var t;t=void 0!=a.projection?a.projection:4326;t=4326==t?S3.gis.proj4326:new OpenLayers.Projection("EPSG:"+t);var r;r=void 0!=a.type?a.type:"feature";var v=a.style,u=new OpenLayers.Style({label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:"${fillOpacity}",strokeColor:"${stroke}",strokeWidth:"${strokeWidth}",strokeOpacity:n,graphicWidth:"${graphicWidth}",graphicHeight:"${graphicHeight}",graphicXOffset:"${graphicXOffset}",
graphicYOffset:"${graphicYOffset}",graphicOpacity:n,graphicName:"${graphicName}",externalGraphic:"${externalGraphic}"},{context:{graphicWidth:function(a){return a.cluster?k:a.attributes.marker_width?a.attributes.marker_width:k},graphicHeight:function(a){return a.cluster?g:a.attributes.marker_height?a.attributes.marker_height:g},graphicXOffset:function(a){return a.cluster?-(k/2):a.attributes.marker_width?-(a.attributes.marker_width/2):-(k/2)},graphicYOffset:function(a){return a.cluster?-g:a.attributes.marker_height?
-a.attributes.marker_height:-g},graphicName:function(a){return a.cluster?"circle":a.attributes.shape?a.attributes.shape:"circle"},externalGraphic:function(a){var b;if(a.cluster)b="";else if(a.attributes.marker_url)b=a.attributes.marker_url;else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))void 0!=c.external_graphic&&(b=S3.Ap.concat("/static/"+c.external_graphic));else{var d,f;$.each(c,function(c,g){d=void 0!=g.attrib?g.attrib:
"value";f=a.attributes[d];if(void 0!=g.cat){if(f==g.cat)return b=S3.Ap.concat("/static/"+g.external_graphic)||e,!1}else if(f>=g.low&&f<g.high)return b=S3.Ap.concat("/static/"+g.external_graphic)||e,!1})}}return b},radius:function(a){return a.cluster?Math.min(a.attributes.count/2,8)+10:a.attributes.size?a.attributes.size:10},fill:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#8087ff";else if(a.attributes.colour)b=a.attributes.colour;else if(a.layer&&
void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.fill;else{var d,e;$.each(c,function(c,f){d=void 0!=f.attrib?f.attrib:"value";e=a.attributes[d];if(void 0!=f.cat){if(e==f.cat)return b=f.fill,!1}else if(e>=f.low&&e<f.high)return b=f.fill,!1})}b=void 0!=b?"#"+b:"#000000"}else b="#f5902e";return b},fillOpacity:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.opacity?a.cluster[0].attributes.opacity:n;else if(a.attributes.opacity)b=a.attributes.opacity;
else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.fill_opacity;else{var d,f;$.each(c,function(c,e){d=void 0!=e.attrib?e.attrib:"value";f=a.attributes[d];if(void 0!=e.cat){if(f==e.cat)return b=e.fill_opacity,!1}else if(f>=e.low&&f<e.high)return b=e.fill_opacity,!1})}}return b||n},stroke:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#2b2f76";else if(a.attributes.colour)b=a.attributes.colour;
else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.stroke||c.fill;else{var d,e;$.each(c,function(c,f){d=void 0!=f.attrib?f.attrib:"value";e=a.attributes[d];if(void 0!=f.cat){if(e==f.cat)return b=f.stroke||f.fill,!1}else if(e>=f.low&&e<f.high)return b=f.stroke||f.fill,!1})}b=void 0!=b?"#"+b:"#000000"}else b="#f5902e";return b},strokeWidth:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.stroke_width?a.cluster[0].attributes.stroke_width:
2;else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.stroke_width;else{var d,f;$.each(c,function(c,e){d=void 0!=e.attrib?e.attrib:"value";f=a.attributes[d];if(void 0!=e.cat){if(f==e.cat)return b=e.stroke_width,!1}else if(f>=e.low&&f<e.high)return b=e.stroke_width,!1})}}return b||2},label:function(a){var b;if(a.cluster)1<a.attributes.count&&(b=a.attributes.count);else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;
if("[object Array]"!==Object.prototype.toString.call(c))b=c.label;else{var d,f;$.each(c,function(c,e){d=void 0!=e.attrib?e.attrib:"value";f=a.attributes[d];if(void 0!=e.cat){if(f==e.cat)return b=e.label,!1}else if(f>=e.low&&f<e.high)return b=e.label,!1})}}return b||""}}});if("[object Array]"===Object.prototype.toString.call(v)){var w=[],x,z,C,D,y;$.each(v,function(a,b){x=void 0!=b.attrib?b.attrib:"value";void 0!=b.cat?(y=b.cat,C=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,
property:x,value:y})):(y=b.low+"-"+b.high,C=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:x,lowerBoundary:b.low,upperBoundary:b.high}));void 0!=b.fill?z="#"+b.fill:void 0!=b.stroke&&(z="#"+b.stroke);D=new OpenLayers.Rule({filter:C,symbolizer:{fillColor:z,strokeColor:z,graphicName:"square",pointRadius:10},title:y});w.push(D)});u.addRules(w)}u=new OpenLayers.StyleMap({"default":u,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}});b=new OpenLayers.Layer.Vector(b,
{dir:p,projection:t,strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*m}),new OpenLayers.Strategy.AttributeCluster({attribute:s,distance:h,threshold:f})],legendURL:e,s3_layer_id:a.id,s3_layer_type:r,s3_style:v,styleMap:u,protocol:new OpenLayers.Protocol.HTTP({url:d,format:S3.gis.format_geojson})});b.setVisibility(l);b.events.on({featureselected:E,featureunselected:F,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});
c.addLayer(b);c.s3.layers_all.push(b)},ja=function(c,a){var b=a.name,d=a.url,e=S3.gis.marker_url+a.marker_image,g=a.marker_height,k=a.marker_width,m;m=void 0!=a.waypoints?a.waypoints:!0;var p;p=void 0!=a.tracks?a.tracks:!0;var l;l=void 0!=a.routes?a.routes:!0;var n;n=void 0!=a.visibility?a.visibility:!0;var s;void 0!=a.dir?(s=a.dir,-1==$.inArray(s,c.s3.dirs)&&c.s3.dirs.push(s)):s="";var h;h=void 0!=a.opacity?a.opacity:1;var f;f=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;
var t;t=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold;var r=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);m?(r.graphicOpacity=h,r.graphicWidth=k,r.graphicHeight=g,r.graphicXOffset=-(k/2),r.graphicYOffset=-g,r.externalGraphic=e):r.externalGraphic="";r.strokeColor="blue";r.strokeWidth=6;r.strokeOpacity=h;b=new OpenLayers.Layer.Vector(b,{dir:s,projection:S3.gis.proj4326,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:f,
threshold:t})],s3_layer_id:a.id,s3_layer_type:"gpx",legendURL:e,style:r,protocol:new OpenLayers.Protocol.HTTP({url:d,format:new OpenLayers.Format.GPX({extractAttributes:!0,extractWaypoints:m,extractTracks:p,extractRoutes:l})})});b.setVisibility(n);b.events.on({featureselected:E,featureunselected:F,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});c.addLayer(b);c.s3.layers_all.push(b)},ka=function(c,a){var b=a.name,d=a.url,e=S3.gis.marker_url+
a.marker_image,g;g=void 0!=a.title?a.title:"name";var k;k=void 0!=a.body?a.body:"description";var m;m=void 0!=a.refresh?a.refresh:900;var p;p=void 0!=a.visibility?a.visibility:!0;var l;void 0!=a.dir?(l=a.dir,-1==$.inArray(l,c.s3.dirs)&&c.s3.dirs.push(l)):l="";var n;n=void 0!=a.opacity?a.opacity:1;var s;s=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;var h;h=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold;S3.gis.image=new Image;S3.gis.image.onload=s3_gis_scaleImage;
S3.gis.image.src=e;n=new OpenLayers.Style({label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:n,strokeColor:"${stroke}",strokeWidth:2,strokeOpacity:n,graphicWidth:"${graphicWidth}",graphicHeight:"${graphicHeight}",graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicOpacity:n,graphicName:"circle",externalGraphic:"${externalGraphic}"},{context:{graphicWidth:function(a){return a.cluster?"":S3.gis.image.width},graphicHeight:function(a){return a.cluster?
"":S3.gis.image.height},graphicXOffset:function(a){return a.cluster?"":-(S3.gis.image.width/2)},graphicYOffset:function(a){return a.cluster?"":-S3.gis.image.height},externalGraphic:function(a){return a.cluster?"":e},radius:function(a){return a.cluster?Math.min(a.attributes.count/2,8)+10:10},fill:function(a){return a.cluster?"#8087ff":"#f5902e"},stroke:function(a){return a.cluster?"#2b2f76":"#f5902e"},label:function(a){var b="";a.cluster&&1<a.attributes.count&&(b=a.attributes.count);return b}}});n=
new OpenLayers.StyleMap({"default":n,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}});b=new OpenLayers.Layer.Vector(b,{dir:l,projection:S3.gis.proj4326,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:s,threshold:h}),new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*m})],s3_layer_id:a.id,s3_layer_type:"kml",legendURL:e,styleMap:n,protocol:new OpenLayers.Protocol.HTTP({url:d,format:c.s3.format_kml})});b.title=g;b.body=k;b.setVisibility(p);b.events.on({featureselected:E,
featureunselected:F,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});c.addLayer(b);c.s3.layers_all.push(b)};s3_gis_scaleImage=function(){var c=S3.gis.image.height/S3.gis.image.width,a=Math.min(S3.gis.image.width,S3.gis.max_w),c=a*c;c>S3.gis.max_h&&(c=S3.gis.max_h,a*=a/c);S3.gis.image.height=c;S3.gis.image.width=a};var la=function(c){var a=S3.gis.OWM,b;a.station&&(b=new OpenLayers.Layer.Vector.OWMStations(a.station.name,{dir:a.station.dir,
s3_layer_id:a.station.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.station.visibility),b.events.on({featureselected:b.onSelect,featureunselected:b.onUnselect,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}}),c.addLayer(b),c.s3.layers_all.push(b));a.city&&(b=new OpenLayers.Layer.Vector.OWMWeather(a.city.name,{dir:a.city.dir,s3_layer_id:a.city.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.city.visibility),b.events.on({featureselected:b.onSelect,
featureunselected:b.onUnselect,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}}),c.addLayer(b),c.s3.layers_all.push(b))},ma=function(c,a){var b=a.name,d=a.url;void 0!=a.username&&void 0!=a.password&&(d=d.replace("://","://"+a.username+":"+a.password+"@"));var e=a.title,g=a.featureType,k=a.featureNS,m=a.schema,p;p=void 0!=a.version?a.version:"1.1.0";var l;l=void 0!=a.geometryName?a.geometryName:"the_geom";var n;n=void 0!=a.styleField?
a.styleField:"";var s;s=void 0!=a.styleValues?a.styleValues:{};var h;h=void 0!=a.visibility?a.visibility:!0;var f;void 0!=a.dir?(f=a.dir,-1==$.inArray(f,c.s3.dirs)&&c.s3.dirs.push(f)):f="";var t;t=void 0!=a.opacity?a.opacity:1;var r;r=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;var v;v=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold;var u,w;void 0!=a.projection?(u=a.projection,w="EPSG:"+u):(u="4326",w="EPSG:4326");d=new OpenLayers.Protocol.WFS({version:p,
srsName:w,url:d,featureType:g,featureNS:k,geometryName:l,schema:m});g={context:{radius:function(a){var b=12;a.cluster&&(b=Math.min(a.attributes.count/2,8)+12);return b},fill:function(a){var b="#f5902e";a.cluster&&(b="#8087ff");return b},stroke:function(a){var b="#f5902e";a.cluster&&(b="#2b2f76");return b},label:function(a){var b="";a.cluster&&1<a.attributes.count&&(b=a.attributes.count);return b}}};n&&s&&(g.context.fill=function(a){var b;$.each(s,function(c,d){c==a.attributes[n]&&(b=d)});b||(b="#f5902e");
a.cluster&&(b="#8087ff");return b},g.context.stroke=function(a){var b;$.each(s,function(c,d){c==a.attributes[n]&&(b=d)});b||(b="#f5902e");a.cluster&&(b="#2b2f76");return b});t=new OpenLayers.Style({label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:t/2,strokeColor:"${stroke}",strokeWidth:2,strokeOpacity:t},g);t=new OpenLayers.StyleMap({"default":t,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}});u="4326"==u?S3.gis.proj4326:new OpenLayers.Projection("EPSG:"+
u);b=new OpenLayers.Layer.Vector(b,{maxFeatures:1E3,strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Cluster({distance:r,threshold:v})],dir:f,s3_layer_id:a.id,s3_layer_type:"wfs",projection:u,protocol:d,styleMap:t});b.title=e;b.setVisibility(h);b.events.on({featureselected:E,featureunselected:F,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});c.addLayer(b);c.s3.layers_all.push(b)},W=function(c){var a=
c.s3.options;c.addControl(new OpenLayers.Control.Navigation);void 0==a.zoomcontrol&&c.addControl(new OpenLayers.Control.Zoom);c.addControl(new OpenLayers.Control.ArgParser);c.addControl(new OpenLayers.Control.Attribution);void 0==a.scaleline&&c.addControl(new OpenLayers.Control.ScaleLine);"mgrs"==a.mouse_position?c.addControl(new OpenLayers.Control.MGRSMousePosition):a.mouse_position&&c.addControl(new OpenLayers.Control.MousePosition);void 0==a.permalink&&c.addControl(new OpenLayers.Control.Permalink);
if(void 0==a.overview){var a={},b=c.options,d;for(d in b)"controls"!=d&&(a[d]=b[d]);c.addControl(new OpenLayers.Control.OverviewMap({mapOptions:a}))}a=c.s3.layers_all;d=new OpenLayers.Control.SelectFeature(a,{toggle:!0});a=new OpenLayers.Control.SelectFeature(a,{hover:!0,highlightOnly:!0,eventListeners:{featurehighlighted:O,featureunhighlighted:G}});c.addControl(a);c.addControl(d);a.activate();d.activate()},Z=function(c){var a=c.map,b=a.s3.draftLayer,d={fillColor:"#000",fillOpacity:0.1,strokeWidth:0},
e=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:7E3}});a.addControl(e);e.events.register("locationupdated",this,function(c){b.removeAllFeatures();var e=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(c.point.x,c.point.y),c.position.coords.accuracy/2,40,0),{},d);b.addFeatures([new OpenLayers.Feature.Vector(c.point,{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),
e]);a.zoomToExtent(b.getDataExtent());Q(a,e)});e.events.register("locationfailed",this,function(){OpenLayers.Console.log("Location detection failed")});var g=new Ext.Toolbar.Button({iconCls:"geolocation",tooltip:i18n.gis_geoLocate,handler:function(){b.removeAllFeatures();e.activate()}});c.addButton(g)},ga=function(c){var a=c.map,b=a.s3,d=new Ext.Toolbar.Button({iconCls:"googleearth",tooltip:b.options.Google.Earth,enableToggle:!0,toggleHandler:function(c,d){!0===d?(b.mapPanelContainer.getLayout().setActiveItem(1),
b.mapWin.items.items[0].collapse(),b.googleEarthPanel.on("pluginready",function(){var b=a.s3.options.layers_feature;if(b)for(var c=0;c<b.length;c++){var d=b[c];if(void 0!=d.visibility?d.visibility:1)d=S3.public_url+d.url.replace("geojson","kml"),google.earth.fetchKml(a.s3.googleEarthPanel.earth,d,R)}})):(b.mapPanelContainer.getLayout().setActiveItem(0),b.mapWin.items.items[0].expand())}});c.addSeparator();c.addButton(d)},fa=function(c){var a=c.map;StreetviewClicker=new (OpenLayers.Class(OpenLayers.Control,
{defaults:{pixelTolerance:1,stopSingle:!0},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(b){(b=a.getLonLatFromViewPortPx(b.xy))||(b=a.getCenter());a.s3.sv_popup&&a.s3.sv_popup.anc&&a.s3.sv_popup.close();a.s3.sv_popup=new GeoExt.Popup({title:a.s3.options.Google.StreetviewTitle,location:b,width:300,
height:300,collapsible:!0,map:a.s3.mapPanel,items:[new gxp.GoogleStreetViewPanel]});a.s3.sv_popup.show()}}))({autoactivate:!1});a.addControl(StreetviewClicker);var b=new Ext.Toolbar.Button({iconCls:"streetview",tooltip:a.s3.options.Google.StreetviewButton,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",toggleHandler:function(a,b){!0===b?StreetviewClicker.activate():StreetviewClicker.deactivate()}});c.addSeparator();c.addButton(b)},ba=function(c){var a=c.map,b=new OpenLayers.Style;b.addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:5,
graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#f5902e"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#f5902e",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#f5902e",fillColor:"white",fillOpacity:0.5}}})]);var b=new OpenLayers.StyleMap({"default":b}),d=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}});d.events.on({measure:function(a){alert(i18n.gis_length_message+
" "+a.measure.toFixed(2)+" "+a.units)}});d=new GeoExt.Action({control:d,map:a,iconCls:"measure-off",tooltip:i18n.gis_length_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"});c.add(d);void 0===a.s3.options.loc_select&&(b=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}}),b.events.on({measure:function(a){alert(i18n.gis_area_message+" "+a.measure.toFixed(2)+" "+a.units+"2")}}),a=new GeoExt.Action({control:b,map:a,
iconCls:"measure-area",tooltip:i18n.gis_area_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"}),c.add(a))},M=function(c,a){var b=c.map;OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(a){return!0},CLASS_NAME:"OpenLayers.Handler.PointS3"});var d=b.s3.draftLayer,e=new OpenLayers.Control.DrawFeature(d,OpenLayers.Handler.PointS3,{featureAdded:function(a){b.s3.lastDraftFeature?b.s3.lastDraftFeature.destroy():1<d.features.length&&d.features[0].destroy();
var c=$("#gis_location_lon");if(c.length){var e=a.geometry.getBounds().getCenterLonLat();e.transform(b.getProjectionObject(),S3.gis.proj4326);c.val(e.lon);$("#gis_location_lat").val(e.lat);$("#gis_location_wkt").val("")}b.s3.lastDraftFeature=a}});if(c){var g=new GeoExt.Action({control:e,handler:function(){g.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:b,iconCls:"drawpoint-off",tooltip:i18n.gis_draw_feature,allowDepress:!0,enableToggle:!0,
toggleGroup:"controls",pressed:a});c.add(g);b.s3.pointButton=g}else b.addControl(e),a&&(e.activate(),$(".olMapViewport").addClass("crosshair"))},da=function(c,a,b){var d=c.map,e=new GeoExt.Action({control:new OpenLayers.Control.DrawFeature(d.s3.draftLayer,b?OpenLayers.Handler.Polygon:OpenLayers.Handler.RegularPolygon,{handlerOptions:b?{sides:4,snapAngle:90}:{},featureAdded:function(a){d.s3.lastDraftFeature&&d.s3.lastDraftFeature.destroy();var b=a.geometry.transform(d.getProjectionObject(),S3.gis.proj4326).toString();
$("#gis_search_polygon_input").val(b).trigger("change");$("#gis_location_wkt").val(b);$("#gis_location_lat").val("");$("#gis_location_lon").val("");d.s3.lastDraftFeature=a}}),handler:function(){e.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:d,iconCls:"drawpolygon-off",tooltip:i18n.gis_draw_polygon,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:a,activateOnEnable:!0,deactivateOnDisable:!0});c.add(e);d.s3.polygonButton=
e},ea=function(c){var a=c.map,b=new Ext.Toolbar.Button({iconCls:"potlatch",tooltip:i18n.gis_potlatch,handler:function(){var b=a.getZoom();if(14>b)alert(a.s3.options.osm_oauth);else{var c=a.getCenter();c.transform(a.getProjectionObject(),S3.gis.proj4326);b=S3.Ap.concat("/gis/potlatch2/potlatch2.html")+"?lat="+c.lat+"&lon="+c.lon+"&zoom="+b;window.open(b)}}});c.addSeparator();c.addButton(b)},aa=function(c){var a=new Ext.Toolbar.Button({iconCls:"save",tooltip:i18n.gis_save,handler:function(){var a=S(map),
c=Ext.util.JSON.encode(a.layers),e=Ext.util.JSON.encode(a.plugins),g;g=S3.gis.config_id?S3.Ap.concat("/gis/config/"+S3.gis.config_id+".url/update"):S3.Ap.concat("/gis/config.url/create");Ext.Ajax.request({url:g,method:"POST",success:function(a,b){var c=Ext.decode(a.responseText).message.split("=",2)[1];c&&(S3.gis.config_id=c,c=S3.Ap.concat("/gis/config/",c,"/layer_entity"),$("#gis_menu_config").attr("href",c))},params:{lat:a.lat,lon:a.lon,zoom:a.zoom,layers:c,plugins:e}})}});c.addSeparator();c.addButton(a)},
ca=function(c){var a=c.map,b=a.s3.options;selectPdfControl=new OpenLayers.Control;OpenLayers.Util.extend(selectPdfControl,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{done:this.getPdf});this.box.activate()},response:function(a){this.w.destroy();a=(new OpenLayers.Format.GML).read(a.responseText);var b=a.length+" pdfs. <br /><ul>";if(a.length)for(var c=0;c<a.length;c++)var d=a[c],b=b+("<li><a href='"+a[c].attributes.url+"'>"+(d.attributes.utm_zone+d.attributes.grid_zone+d.attributes.grid_square+
d.attributes.easting+d.attributes.northing)+"</a></li>");this.w=new Ext.Window({html:b+"</ul>",width:300,title:"Results",height:200});this.w.show()},getPdf:function(c){var d=a.getLonLatFromPixel(new OpenLayers.Pixel(c.left,c.bottom)).transform(a.getProjectionObject(),S3.gis.proj4326);c=a.getLonLatFromPixel(new OpenLayers.Pixel(c.right,c.top)).transform(a.getProjectionObject(),S3.gis.proj4326);bbox=(new OpenLayers.Bounds(d.lon,d.lat,c.lon,c.lat)).toBBOX();OpenLayers.Request.GET({url:b.mgrs_url+"&bbox="+
bbox,callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({html:"Searching "+b.mgrs_name+", please wait.",width:200,title:"Please Wait."});this.w.show()}});var d="Select "+b.mgrs_name,d=new GeoExt.Action({text:d,control:selectPdfControl,map:a,allowDepress:!1,toggleGroup:"controls",tooltip:d});c.addSeparator();c.add(d)},ha=function(c,a){var b=new gxp.plugins.AddLayers({actionTarget:"treepanel.tbar",addActionTip:"Add layers",addActionMenuText:"Add layers",addServerText:"Add a New Server",
doneText:"Done",upload:{url:null},uploadText:i18n.gis_uploadlayer,relativeUploadOnly:!1}),d=new GeoExt.data.LayerStore;b.target=a;a.proxy=OpenLayers.ProxyHost;a.layerSources={};a.layerSources.local=new gxp.plugins.LayerSource({title:"local",store:d});b.addActions()[0].enable();b=new gxp.plugins.RemoveLayer({actionTarget:"treepanel.tbar",removeActionTip:"Remove layer"});b.target=a;a.mapPanel=c.s3.mapPanel;b.addActions()},ia=function(c,a){var b=c.s3.propertiesWindow,d=new Ext.Toolbar.Button({iconCls:"gxp-icon-layerproperties",
tooltip:i18n.gis_properties,handler:function(){var d=a.root.findChildBy(function(a){return a.isSelected()?a.leaf?!0:!1:!1},null,!0);if(d){var g=d.layer.s3_layer_type,k=S3.Ap.concat("/gis/layer_"+g+".plain?layer_"+g+".layer_id="+d.layer.s3_layer_id+"&update=1");Ext.Ajax.request({url:k,method:"GET",success:function(a,k){b&&b.close();var l;"feature"==g?(l=new Ext.TabPanel({activeTab:0,items:[{title:"Layer Properties",html:a.responseText},{title:"Filter",id:"s3_gis_layer_filter_tab",html:""}]}),l.items.items[1].on("activate",
function(){var a;Ext.iterate(c.s3.layers_feature,function(b,c,f){b.id==d.layer.s3_layer_id&&(a=b.url.replace(/.geojson.+/,"/search.plain"))});Ext.get("s3_gis_layer_filter_tab").load({url:a,discardUrl:!1,callback:function(){S3.addTooltips();S3.search.select_letter_label()},text:"Loading...",timeout:30,scripts:!1})})):l=new Ext.Panel({title:"Layer Properties",html:a.responseText});b=new Ext.Window({width:400,layout:"fit",items:[l]});b.show();$("#plain form").submit(function(){var a=$('#plain input[name="id"]').val(),
a=S3.Ap.concat("/gis/layer_"+g+"/"+a+".plain/update"),b=$("#plain input"),c=[];Ext.iterate(b,function(a,b,d){b.id&&-1!=b.id.indexOf("gis_layer_")&&c.push(b.id)});b=[];for(i=0;i<c.length;i++)(q=$("#"+c[i]).serialize())&&b.push(q);(q=$('#plain input[name="id"]').serialize())&&b.push(q);(q=$('#plain input[name="_formkey"]').serialize())&&b.push(q);(q=$('#plain input[name="_formname"]').serialize())&&b.push(q);0<b.length&&(b=b.join("&"),$.ajax({type:"POST",url:a,data:b,success:function(a){$("#plain").html(a)}}));
return!1});S3.addTooltips();S3.autocomplete("role","admin","group","gis_layer_"+g+"_role_required")}})}}});a.getTopToolbar().add(d)}})();
