var map;S3.gis.layers_all=[];S3.gis.format_geojson=new OpenLayers.Format.GeoJSON;S3.gis.dirs=[];S3.gis.ajax_loader=S3.Ap.concat("/static/img/ajax-loader.gif");S3.gis.marker_url=S3.Ap.concat("/static/img/markers/");OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";OpenLayers.ProxyHost=S3.Ap.concat("/gis/proxy?url=");S3.gis.proj4326=new OpenLayers.Projection("EPSG:4326");
S3.gis.projection_current=new OpenLayers.Projection("EPSG:"+S3.gis.projection);S3.gis.options={controls:[],displayProjection:S3.gis.proj4326,projection:S3.gis.projection_current,theme:null,units:S3.gis.units,maxResolution:S3.gis.maxResolution,maxExtent:new OpenLayers.Bounds(S3.gis.maxExtent[0],S3.gis.maxExtent[1],S3.gis.maxExtent[2],S3.gis.maxExtent[3]),numZoomLevels:S3.gis.numZoomLevels};S3.gis.cluster_distance=20;S3.gis.cluster_threshold=2;S3.gis.layers_loading=[];S3.gis.plugins=[];
function registerPlugin(a){S3.gis.plugins.push(a)}S3.gis.show_map=function(){S3.gis.lat&&S3.gis.lon?(S3.gis.center=new OpenLayers.LonLat(S3.gis.lon,S3.gis.lat),S3.gis.center.transform(S3.gis.proj4326,S3.gis.projection_current)):S3.gis.bottom_left&&S3.gis.top_right&&s3_gis_setCenter(S3.gis.bottom_left,S3.gis.top_right);addMap();addMapUI();S3.gis.bounds&&map.zoomToExtent(S3.gis.bounds);Ext.QuickTips.init();return map};
function s3_gis_setCenter(a,b){a=new OpenLayers.LonLat(a[0],a[1]);a.transform(S3.gis.proj4326,S3.gis.projection_current);var c=a.lon,f=a.lat;b=new OpenLayers.LonLat(b[0],b[1]);b.transform(S3.gis.proj4326,S3.gis.projection_current);S3.gis.bounds=OpenLayers.Bounds.fromArray([c,f,b.lon,b.lat]);S3.gis.center=S3.gis.bounds.getCenterLonLat()}function addMap(){map=new OpenLayers.Map("center",S3.gis.options);addLayers();addControls()}
function addMapUI(){S3.gis.mapPanel=new GeoExt.MapPanel({height:S3.gis.map_height,width:S3.gis.map_width,xtype:"gx_mappanel",map:map,center:S3.gis.center,zoom:S3.gis.zoom,plugins:[]});S3.gis.portal={};S3.gis.portal.map=S3.gis.mapPanel;if(i18n.gis_legend||S3.gis.layers_wms)for(var a=0;a<map.layers.length;a++)map.layers[a].legendURL&&(S3.gis.mapPanel.layers.data.items[a].data.legendURL=map.layers[a].legendURL),map.layers[a].queryable&&(S3.gis.mapPanel.layers.data.items[a].data.queryable=1);addLayerTree();
a=[S3.gis.layerTree];S3.gis.wms_browser_url&&(addWMSBrowser(),S3.gis.wmsBrowser&&a.push(S3.gis.wmsBrowser));i18n.gis_legend&&(S3.gis.legendPanel=new GeoExt.LegendPanel({title:i18n.gis_legend,defaults:{labelCls:"mylabel",style:"padding:4px"},bodyStyle:"padding:4px",autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1}),a.push(S3.gis.legendPanel));for(var b=0,c=S3.gis.plugins.length;b<c;++b)S3.gis.plugins[b].setup(map),S3.gis.plugins[b].addToMapWindow(a);S3.gis.mapWestPanel=new Ext.Panel({cls:"map_tools",
header:!1,border:!1,split:!0,items:a});S3.gis.window?addMapWindow():addMapPanel();S3.gis.layerTree.root.eachChild(function(){this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||hideThrobber(this.layer.s3_layer_id)});else this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||hideThrobber(this.layer.s3_layer_id)})})})})}
function addWestPanel(){void 0==S3.gis.west_collapsed&&(S3.gis.west_collapsed=!1);S3.gis.mapWestPanelContainer=new Ext.Panel({region:"west",header:!1,border:!0,width:250,autoScroll:!0,collapsible:!0,collapseMode:"mini",collapsed:S3.gis.west_collapsed,items:[S3.gis.mapWestPanel]})}
function addMapPanelContainer(){S3.gis.toolbar?addToolbar():S3.gis.draw_feature&&addPointControl(null,"active"==S3.gis.draw_feature?!0:!1);S3.gis.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",cls:"mappnlcntr",defaults:{border:!1},items:[S3.gis.mapPanel],activeItem:0,tbar:S3.gis.toolbar,scope:this});S3.gis.Google&&S3.gis.Google.Earth&&(S3.gis.googleEarthPanel=new gxp.GoogleEarthPanel({mapPanel:S3.gis.mapPanel}),S3.gis.mapPanelContainer.items.items.push(S3.gis.googleEarthPanel))}
function addMapPanel(){addWestPanel();addMapPanelContainer();S3.gis.mapWin=new Ext.Panel({renderTo:"map_panel",autoScroll:!0,titleCollapse:!0,height:S3.gis.map_height,width:S3.gis.map_width,layout:"border",items:[S3.gis.mapWestPanelContainer,S3.gis.mapPanelContainer]})}
function addMapWindow(){addWestPanel();addMapPanelContainer();var a=new Ext.Window({cls:"gis-map-window",collapsible:!1,constrain:!0,closable:!S3.gis.windowNotClosable,closeAction:"hide",autoScroll:!0,maximizable:S3.gis.maximizable,titleCollapse:!1,height:S3.gis.map_height,width:S3.gis.map_width,layout:"border",items:[S3.gis.mapWestPanelContainer,S3.gis.mapPanelContainer]});a.on("beforehide",function(a){a.maximized&&a.restore()});S3.gis.windowHide||(a.show(),a.maximize());S3.gis.mapWin=a}
function addLayerTree(){for(var a=[{text:i18n.gis_base_layers,nodeType:"gx_baselayercontainer",layerStore:S3.gis.mapPanel.layers,loader:{filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!0===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,expanded:!0},{text:i18n.gis_overlays,nodeType:"gx_overlaylayercontainer",layerStore:S3.gis.mapPanel.layers,loader:{filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!1===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},
leaf:!1,expanded:!0}],b=S3.gis.dirs,c=0;c<b.length;c++){var f={text:b[c],nodeType:"gx_layercontainer",layerStore:S3.gis.mapPanel.layers,loader:{filter:function(a){return function(b){if("undefined"!==b.data.layer.dir)return b.data.layer.dir===a}}(b[c])},leaf:!1,expanded:!0};a.push(f)}a=new Ext.tree.AsyncTreeNode({expanded:!0,children:a});b=i18n.gis_uploadlayer||i18n.gis_properties?new Ext.Toolbar:null;S3.gis.layerTree=new Ext.tree.TreePanel({title:i18n.gis_layers,loader:new Ext.tree.TreeLoader({applyLoader:!1}),
root:a,rootVisible:!1,split:!0,autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1,tbar:b,enableDD:!0});i18n.gis_uploadlayer&&addRemoveLayersControl();i18n.gis_properties&&addLayerPropertiesButton()}
function addWMSBrowser(){var a=new Ext.tree.AsyncTreeNode({expanded:!0,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+S3.gis.wms_browser_url,layerOptions:{buffer:1,singleTile:!1,ratio:1,wrapDateLine:!0},layerParams:{TRANSPARENT:"TRUE"},createNode:function(a){a.checked=a.leaf?!1:void 0;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[a])}})});S3.gis.wmsBrowser=new Ext.tree.TreePanel({title:S3.gis.wms_browser_name,root:a,rootVisible:!1,split:!0,autoScroll:!0,
collapsible:!0,collapseMode:"mini",lines:!1,listeners:{checkchange:function(a,c){!0===c?S3.gis.mapPanel.map.addLayer(a.attributes.layer):S3.gis.mapPanel.map.removeLayer(a.attributes.layer)}}})}
function addToolbar(){var a=new Ext.Toolbar({height:34}),b=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtent,map:map,iconCls:"zoomfull",tooltip:i18n.gis_zoomfull}),c=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:!0}),map:map,iconCls:"zoomout",tooltip:i18n.gis_zoomout,toggleGroup:"controls"}),f=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox,map:map,iconCls:"zoomin",tooltip:i18n.gis_zoomin,toggleGroup:"controls"}),e,d,l;"active"==S3.gis.draw_polygon?(e=!0,
l=d=!1):("active"==S3.gis.draw_feature?(l=!0,d=!1):(d=!0,l=!1),e=!1);S3.gis.panButton=new GeoExt.Action({control:new OpenLayers.Control.Navigation,map:map,iconCls:"pan-off",tooltip:i18n.gis_pan,allowDepress:!0,toggleGroup:"controls",pressed:d});a.add(b);navigator.geolocation&&addGeolocateControl(a);void 0===S3.gis.loc_select&&(a.add(c),a.add(f),a.add(S3.gis.panButton),a.addSeparator());void 0===S3.gis.loc_select&&addNavigationControl(a);void 0===S3.gis.loc_select&&S3.auth&&addSaveButton(a);a.addSeparator();
addMeasureControls(a);S3.gis.mgrs_url&&addPdfControl(a);if(S3.gis.draw_feature||S3.gis.draw_polygon)a.addSeparator(),S3.gis.draw_feature&&addPointControl(a,l),S3.gis.draw_polygon&&addPolygonControl(a,e,!0);i18n.gis_get_feature_info&&addWMSGetFeatureInfoControl(a);S3.gis.osm_oauth&&addPotlatchButton(a);S3.gis.Google&&S3.gis.Google.StreetviewButton&&addGoogleStreetviewControl(a);try{S3.gis.Google.Earth&&google&addGoogleEarthControl(a)}catch(n){}i18n.gis_search&&(b=Math.min(350,S3.gis.map_width-680),
b=new GeoExt.ux.GeoNamesSearchCombo({map:map,width:b,listWidth:b,minChars:2,emptyText:i18n.gis_search}),a.addSeparator(),a.add(b));b=new Ext.BoxComponent({autoEl:{tag:"img",src:S3.gis.ajax_loader},cls:"layer_throbber hide"});a.add(b);S3.gis.toolbar=a}
function addLayers(){var a;if(S3.gis.layers_osm){var b=S3.gis.layers_osm;for(a=b.length;0<a;a--)addOSMLayer(b[a-1])}try{google&addGoogleLayers()}catch(c){}S3.gis.Bing&&addBingLayers();if(S3.gis.layers_tms){b=S3.gis.layers_tms;for(a=b.length;0<a;a--)addTMSLayer(b[a-1])}if(S3.gis.layers_wms){b=S3.gis.layers_wms;for(a=b.length;0<a;a--)addWMSLayer(b[a-1])}if(S3.gis.layers_xyz){b=S3.gis.layers_xyz;for(a=b.length;0<a;a--)addXYZLayer(b[a-1])}S3.gis.EmptyLayer&&(a=new OpenLayers.Layer(S3.gis.EmptyLayer.name,
{isBaseLayer:!0,displayInLayerSwitcher:!0,s3_layer_id:S3.gis.EmptyLayer.id,s3_layer_type:"empty"}),map.addLayer(a),S3.gis.EmptyLayer.base&&map.setBaseLayer(a));try{addJSLayers()}catch(f){}if(S3.gis.layers_theme){b=S3.gis.layers_theme;for(a=b.length;0<a;a--)addGeoJSONLayer(b[a-1])}if(S3.gis.layers_geojson){b=S3.gis.layers_geojson;for(a=b.length;0<a;a--)addGeoJSONLayer(b[a-1])}if(S3.gis.layers_gpx){b=S3.gis.layers_gpx;for(a=b.length;0<a;a--)addGPXLayer(b[a-1])}if(S3.gis.layers_arcrest){b=S3.gis.layers_arcrest;
for(a=b.length;0<a;a--)addArcRESTLayer(b[a-1])}S3.gis.CoordinateGrid&&addCoordinateGrid();if(S3.gis.layers_georss){b=S3.gis.layers_georss;for(a=b.length;0<a;a--)addGeoJSONLayer(b[a-1])}if(S3.gis.layers_kml){S3.gis.format_kml=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2});b=S3.gis.layers_kml;for(a=b.length;0<a;a--)addKMLLayer(b[a-1])}S3.gis.OWM&&addOWMLayers();if(S3.gis.layers_shapefile){b=S3.gis.layers_shapefile;for(a=b.length;0<a;a--)addGeoJSONLayer(b[a-1])}if(S3.gis.layers_wfs){b=
S3.gis.layers_wfs;for(a=b.length;0<a;a--)addWFSLayer(b[a-1])}if(S3.gis.layers_feature_query){b=S3.gis.layers_feature_query;for(a=b.length;0<a;a--)addGeoJSONLayer(b[a-1])}if(S3.gis.layers_feature_resource){b=S3.gis.layers_feature_resource;for(a=b.length;0<a;a--)addGeoJSONLayer(b[a-1])}if(S3.gis.layers_feature){b=S3.gis.layers_feature;for(a=b.length;0<a;a--)addGeoJSONLayer(b[a-1])}(S3.gis.features||S3.gis.draw_feature||S3.gis.draw_polygon||navigator.geolocation)&&addDraftLayer();if(S3.gis.features){b=
map.getProjectionObject();for(a=0;a<S3.gis.features.length;a++){var e=S3.gis.format_geojson.parseFeature(S3.gis.features[a]);e.geometry.transform(S3.gis.proj4326,b);S3.gis.draftLayer.addFeatures([e])}}}
function addArcRESTLayer(a){var b=a.name,c=[a.url],f;f=void 0!=a.layers?a.layers.join():0;var e;void 0!=a.dir?(e=a.dir,-1==$.inArray(e,S3.gis.dirs)&&S3.gis.dirs.push(e)):e="";var d;d=void 0!=a.base?a.base:!1;var l;l=void 0!=a.transparent?a.transparent:!0;var n;n=void 0!=a.visibility?a.visibility:!0;b=new OpenLayers.Layer.ArcGIS93Rest(b,c,{layers:"show:"+f,isBaseLayer:d,transparent:l,dir:e,s3_layer_id:a.id,s3_layer_type:"arcrest"});b.setVisibility(n);map.addLayer(b);a._base&&map.setBaseLayer(b)}
function addBingLayers(){var a=S3.gis.Bing,b=a.ApiKey,c;a.Aerial&&(c=new OpenLayers.Layer.Bing({key:b,type:"Aerial",name:a.Aerial.name,s3_layer_id:a.Aerial.id,s3_layer_type:"bing"}),map.addLayer(c),"aerial"==a.Base&&map.setBaseLayer(c));a.Road&&(c=new OpenLayers.Layer.Bing({key:b,type:"Road",name:a.Road.name,s3_layer_id:a.Road.id,s3_layer_type:"bing"}),map.addLayer(c),"road"==a.Base&&map.setBaseLayer(c));a.Hybrid&&(c=new OpenLayers.Layer.Bing({key:b,type:"AerialWithLabels",name:a.Hybrid.name,s3_layer_id:a.Hybrid.id,
s3_layer_type:"bing"}),map.addLayer(c),"hybrid"==a.Base&&map.setBaseLayer(c))}function addCoordinateGrid(){map.addLayer(new OpenLayers.Layer.cdauth.CoordinateGrid(null,{name:S3.gis.CoordinateGrid.name,shortName:"grid",visibility:S3.gis.CoordinateGrid.visibility,s3_layer_id:S3.gis.CoordinateGrid.id,s3_layer_type:"coordinate"}))}
function addDraftLayer(){var a=S3.gis.marker_url+S3.gis.marker_default,b=S3.gis.marker_default_height,c=S3.gis.marker_default_width,f=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);f.graphicOpacity=1;f.graphicWidth=c;f.graphicHeight=b;f.graphicXOffset=-(c/2);f.graphicYOffset=-b;f.externalGraphic=a;S3.gis.draftLayer=new OpenLayers.Layer.Vector(i18n.gis_draft_layer,{style:f,displayInLayerSwitcher:!1});S3.gis.draftLayer.setVisibility(!0);map.addLayer(S3.gis.draftLayer)}
OpenLayers.Strategy.AttributeCluster=OpenLayers.Class(OpenLayers.Strategy.Cluster,{attribute:null,shouldCluster:function(a,b){var c=OpenLayers.Strategy.Cluster.prototype;return a.cluster[0].attributes[this.attribute]===b.attributes[this.attribute]&&c.shouldCluster.apply(this,arguments)},CLASS_NAME:"OpenLayers.Strategy.AttributeCluster"});
function addGeoJSONLayer(a){var b=a.name,c=a.url,f;if(void 0!=a.marker_image){f=S3.gis.marker_url+a.marker_image;var e=a.marker_height,d=a.marker_width}else f="";var l;l=void 0!=a.refresh?a.refresh:900;var n;void 0!=a.dir?(n=a.dir,-1==$.inArray(n,S3.gis.dirs)&&S3.gis.dirs.push(n)):n="";var k;k=void 0!=a.visibility?a.visibility:!0;var h;h=void 0!=a.opacity?a.opacity:1;var m;m=void 0!=a.cluster_attribute?a.cluster_attribute:"colour";var g;g=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;
var p;p=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold;var r;r=void 0!=a.projection?a.projection:4326;r=4326==r?S3.gis.proj4326:new OpenLayers.Projection("EPSG:"+r);var s;s=void 0!=a.type?a.type:"feature";var v=a.style,t=new OpenLayers.Style({label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:"${fillOpacity}",strokeColor:"${stroke}",strokeWidth:"${strokeWidth}",strokeOpacity:h,graphicWidth:"${graphicWidth}",graphicHeight:"${graphicHeight}",
graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicOpacity:h,graphicName:"${graphicName}",externalGraphic:"${externalGraphic}"},{context:{graphicWidth:function(a){return a.cluster?d:a.attributes.marker_width?a.attributes.marker_width:d},graphicHeight:function(a){return a.cluster?e:a.attributes.marker_height?a.attributes.marker_height:e},graphicXOffset:function(a){return a.cluster?-(d/2):a.attributes.marker_width?-(a.attributes.marker_width/2):-(d/2)},graphicYOffset:function(a){return a.cluster?
-e:a.attributes.marker_height?-a.attributes.marker_height:-e},graphicName:function(a){return a.cluster?"circle":a.attributes.shape?a.attributes.shape:"circle"},externalGraphic:function(a){var b;if(a.cluster)b="";else if(a.attributes.marker_url)b=a.attributes.marker_url;else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))void 0!=c.external_graphic&&(b=S3.Ap.concat("/static/"+c.external_graphic));else{var d,e;$.each(c,function(c,
g){d=void 0!=g.attrib?g.attrib:"value";e=a.attributes[d];if(void 0!=g.cat){if(e==g.cat)return b=S3.Ap.concat("/static/"+g.external_graphic)||f,!1}else if(e>=g.low&&e<g.high)return b=S3.Ap.concat("/static/"+g.external_graphic)||f,!1})}}return b},radius:function(a){return a.cluster?Math.min(a.attributes.count/2,8)+10:a.attributes.size?a.attributes.size:10},fill:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#8087ff";else if(a.attributes.colour)b=a.attributes.colour;
else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.fill;else{var f,d;$.each(c,function(c,e){f=void 0!=e.attrib?e.attrib:"value";d=a.attributes[f];if(void 0!=e.cat){if(d==e.cat)return b=e.fill,!1}else if(d>=e.low&&d<e.high)return b=e.fill,!1})}b=void 0!=b?"#"+b:"#000000"}else b="#f5902e";return b},fillOpacity:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.opacity?a.cluster[0].attributes.opacity:h;else if(a.attributes.opacity)b=
a.attributes.opacity;else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.fill_opacity;else{var f,d;$.each(c,function(c,e){f=void 0!=e.attrib?e.attrib:"value";d=a.attributes[f];if(void 0!=e.cat){if(d==e.cat)return b=e.fill_opacity,!1}else if(d>=e.low&&d<e.high)return b=e.fill_opacity,!1})}}return b||h},stroke:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#2b2f76";else if(a.attributes.colour)b=
a.attributes.colour;else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.stroke||c.fill;else{var f,e;$.each(c,function(c,d){f=void 0!=d.attrib?d.attrib:"value";e=a.attributes[f];if(void 0!=d.cat){if(e==d.cat)return b=d.stroke||d.fill,!1}else if(e>=d.low&&e<d.high)return b=d.stroke||d.fill,!1})}b=void 0!=b?"#"+b:"#000000"}else b="#f5902e";return b},strokeWidth:function(a){var b;if(a.cluster)b=a.cluster[0].attributes.stroke_width?
a.cluster[0].attributes.stroke_width:2;else if(a.layer&&void 0!=a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.stroke_width;else{var f,d;$.each(c,function(c,e){f=void 0!=e.attrib?e.attrib:"value";d=a.attributes[f];if(void 0!=e.cat){if(d==e.cat)return b=e.stroke_width,!1}else if(d>=e.low&&d<e.high)return b=e.stroke_width,!1})}}return b||2},label:function(a){var b;if(a.cluster)1<a.attributes.count&&(b=a.attributes.count);else if(a.layer&&void 0!=
a.layer.s3_style){var c=a.layer.s3_style;if("[object Array]"!==Object.prototype.toString.call(c))b=c.label;else{var f,e;$.each(c,function(c,d){f=void 0!=d.attrib?d.attrib:"value";e=a.attributes[f];if(void 0!=d.cat){if(e==d.cat)return b=d.label,!1}else if(e>=d.low&&e<d.high)return b=d.label,!1})}}return b||""}}});if("[object Array]"===Object.prototype.toString.call(v)){var u=[],y,w,z,A,x;$.each(v,function(a,b){y=void 0!=b.attrib?b.attrib:"value";void 0!=b.cat?(x=b.cat,z=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,
property:y,value:x})):(x=b.low+"-"+b.high,z=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:y,lowerBoundary:b.low,upperBoundary:b.high}));void 0!=b.fill?w="#"+b.fill:void 0!=b.stroke&&(w="#"+b.stroke);A=new OpenLayers.Rule({filter:z,symbolizer:{fillColor:w,strokeColor:w,graphicName:"square",pointRadius:10},title:x});u.push(A)});t.addRules(u)}t=new OpenLayers.StyleMap({"default":t,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}});a=new OpenLayers.Layer.Vector(b,
{dir:n,projection:r,strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*l}),new OpenLayers.Strategy.AttributeCluster({attribute:m,distance:g,threshold:p})],legendURL:f,s3_layer_id:a.id,s3_layer_type:s,s3_style:v,styleMap:t,protocol:new OpenLayers.Protocol.HTTP({url:c,format:S3.gis.format_geojson})});a.setVisibility(k);a.events.on({featureselected:onFeatureSelect,featureunselected:onFeatureUnselect,loadstart:function(a){showThrobber(a.object.s3_layer_id)},
loadend:function(a){hideThrobber(a.object.s3_layer_id)}});map.addLayer(a);S3.gis.layers_all.push(a)}
function addGoogleLayers(){var a=S3.gis.Google,b;a.MapMaker||a.MapMakerHybrid?(a.Satellite&&(b=new OpenLayers.Layer.Google(a.Satellite.name,{type:G_SATELLITE_MAP,sphericalMercator:!0,s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),map.addLayer(b),"satellite"==a.Base&&map.setBaseLayer(b)),a.Maps&&(b=new OpenLayers.Layer.Google(a.Maps.name,{type:G_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),map.addLayer(b),"maps"==a.Base&&map.setBaseLayer(b)),a.Hybrid&&(b=new OpenLayers.Layer.Google(a.Hybrid.name,
{type:G_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),map.addLayer(b),"maps"==a.Base&&map.setBaseLayer(b)),a.Terrain&&(b=new OpenLayers.Layer.Google(a.Terrain.name,{type:G_PHYSICAL_MAP,sphericalMercator:!0,s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),map.addLayer(b),"terrain"==a.Base&&map.setBaseLayer(b)),a.MapMaker&&(b=new OpenLayers.Layer.Google(a.MapMaker.name,{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:b.id,s3_layer_type:"google"}),map.addLayer(b),
"mapmaker"==a.Base&&map.setBaseLayer(b)),a.MapMakerHybrid&&(b=new OpenLayers.Layer.Google(a.MapMakerHybrid.name,{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:b.id,s3_layer_type:"google"}),map.addLayer(b),"mapmakerhybrid"==a.Base&&map.setBaseLayer(b))):(a.Satellite&&(b=new OpenLayers.Layer.Google(a.Satellite.name,{type:"satellite",numZoomLevels:22,s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),map.addLayer(b),"satellite"==a.Base&&map.setBaseLayer(b)),a.Maps&&(b=new OpenLayers.Layer.Google(a.Maps.name,
{numZoomLevels:20,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),map.addLayer(b),"maps"==a.Base&&map.setBaseLayer(b)),a.Hybrid&&(b=new OpenLayers.Layer.Google(a.Hybrid.name,{type:"hybrid",numZoomLevels:20,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),map.addLayer(b),"hybrid"==a.Base&&map.setBaseLayer(b)),a.Terrain&&(b=new OpenLayers.Layer.Google(a.Terrain.name,{type:"terrain",s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),map.addLayer(b),"terrain"==a.Base&&map.setBaseLayer(b)))}
function addGPXLayer(a){var b=a.name,c=a.url,f=S3.gis.marker_url+a.marker_image,e=a.marker_height,d=a.marker_width,l;l=void 0!=a.waypoints?a.waypoints:!0;var n;n=void 0!=a.tracks?a.tracks:!0;var k;k=void 0!=a.routes?a.routes:!0;var h;h=void 0!=a.visibility?a.visibility:!0;var m;void 0!=a.dir?(m=a.dir,-1==$.inArray(m,S3.gis.dirs)&&S3.gis.dirs.push(m)):m="";var g;g=void 0!=a.opacity?a.opacity:1;var p;p=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;var r;r=void 0!=a.cluster_threshold?
a.cluster_threshold:S3.gis.cluster_threshold;var s=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);l?(s.graphicOpacity=g,s.graphicWidth=d,s.graphicHeight=e,s.graphicXOffset=-(d/2),s.graphicYOffset=-e,s.externalGraphic=f):s.externalGraphic="";s.strokeColor="blue";s.strokeWidth=6;s.strokeOpacity=g;a=new OpenLayers.Layer.Vector(b,{dir:m,projection:S3.gis.proj4326,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:p,threshold:r})],s3_layer_id:a.id,
s3_layer_type:"gpx",legendURL:f,style:s,protocol:new OpenLayers.Protocol.HTTP({url:c,format:new OpenLayers.Format.GPX({extractAttributes:!0,extractWaypoints:l,extractTracks:n,extractRoutes:k})})});a.setVisibility(h);a.events.on({featureselected:onFeatureSelect,featureunselected:onFeatureUnselect,loadstart:function(a){showThrobber(a.object.s3_layer_id)},loadend:function(a){hideThrobber(a.object.s3_layer_id)}});map.addLayer(a);S3.gis.layers_all.push(a)}
function addKMLLayer(a){var b=a.name,c=a.url,f=S3.gis.marker_url+a.marker_image,e;e=void 0!=a.title?a.title:"name";var d;d=void 0!=a.body?a.body:"description";var l;l=void 0!=a.refresh?a.refresh:900;var n;n=void 0!=a.visibility?a.visibility:!0;var k;void 0!=a.dir?(k=a.dir,-1==$.inArray(k,S3.gis.dirs)&&S3.gis.dirs.push(k)):k="";var h;h=void 0!=a.opacity?a.opacity:1;var m;m=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;var g;g=void 0!=a.cluster_threshold?a.cluster_threshold:
S3.gis.cluster_threshold;S3.gis.image=new Image;S3.gis.image.onload=s3_gis_scaleImage;S3.gis.image.src=f;h=new OpenLayers.Style({label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:h,strokeColor:"${stroke}",strokeWidth:2,strokeOpacity:h,graphicWidth:"${graphicWidth}",graphicHeight:"${graphicHeight}",graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicOpacity:h,graphicName:"circle",externalGraphic:"${externalGraphic}"},{context:{graphicWidth:function(a){return a.cluster?
"":S3.gis.image.width},graphicHeight:function(a){return a.cluster?"":S3.gis.image.height},graphicXOffset:function(a){return a.cluster?"":-(S3.gis.image.width/2)},graphicYOffset:function(a){return a.cluster?"":-S3.gis.image.height},externalGraphic:function(a){return a.cluster?"":f},radius:function(a){return a.cluster?Math.min(a.attributes.count/2,8)+10:10},fill:function(a){return a.cluster?"#8087ff":"#f5902e"},stroke:function(a){return a.cluster?"#2b2f76":"#f5902e"},label:function(a){var b="";a.cluster&&
1<a.attributes.count&&(b=a.attributes.count);return b}}});h=new OpenLayers.StyleMap({"default":h,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}});a=new OpenLayers.Layer.Vector(b,{dir:k,projection:S3.gis.proj4326,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:m,threshold:g}),new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*l})],s3_layer_id:a.id,s3_layer_type:"kml",legendURL:f,styleMap:h,protocol:new OpenLayers.Protocol.HTTP({url:c,format:S3.gis.format_kml})});
a.title=e;a.body=d;a.setVisibility(n);a.events.on({featureselected:onFeatureSelect,featureunselected:onFeatureUnselect,loadstart:function(a){showThrobber(a.object.s3_layer_id)},loadend:function(a){hideThrobber(a.object.s3_layer_id)}});map.addLayer(a);S3.gis.layers_all.push(a)}var s3_gis_scaleImage=function(){var a=S3.gis.image.height/S3.gis.image.width,b=Math.min(S3.gis.image.width,S3.gis.max_w),a=b*a;a>S3.gis.max_h&&(a=S3.gis.max_h,b*=b/a);S3.gis.image.height=a;S3.gis.image.width=b};
function addOSMLayer(a){var b=a.name,c=[a.url1];void 0!=a.url2&&c.push(a.url2);void 0!=a.url3&&c.push(a.url3);var f;f=void 0!=a.visibility?a.visibility:!0;var e;void 0!=a.dir?(e=a.dir,-1==$.inArray(e,S3.gis.dirs)&&S3.gis.dirs.push(e)):e="";b=new OpenLayers.Layer.TMS(b,c,{dir:e,type:"png",getURL:osm_getTileURL,displayOutsideMaxExtent:!0,numZoomLevels:void 0!=a.zoomLevels?a.zoomLevels:19,isBaseLayer:void 0!=a.base?a.base:!0,s3_layer_id:a.id,s3_layer_type:"openstreetmap"});void 0!=a.attribution&&(b.attribution=
a.attribution);b.setVisibility(f);map.addLayer(b);a._base&&map.setBaseLayer(b)}function osm_getTileURL(a){var b=this.map.getResolution(),c=Math.round((a.left-this.maxExtent.left)/(b*this.tileSize.w));a=Math.round((this.maxExtent.top-a.top)/(b*this.tileSize.h));var b=this.map.getZoom(),f=Math.pow(2,b);if(0>a||a>=f)return OpenLayers.Util.getImagesLocation()+"404.png";c=b+"/"+(c%f+f)%f+"/"+a+"."+this.type;a=this.url;a instanceof Array&&(a=this.selectUrl(c,a));return a+c}
function addOWMLayers(){var a=S3.gis.OWM,b;a.station&&(b=new OpenLayers.Layer.Vector.OWMStations(a.station.name,{dir:a.station.dir,s3_layer_id:a.station.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.station.visibility),b.events.on({featureselected:b.onSelect,featureunselected:b.onUnselect,loadstart:function(a){showThrobber(a.object.s3_layer_id)},loadend:function(a){hideThrobber(a.object.s3_layer_id)}}),map.addLayer(b),S3.gis.layers_all.push(b));a.city&&(b=new OpenLayers.Layer.Vector.OWMWeather(a.city.name,
{dir:a.city.dir,s3_layer_id:a.city.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.city.visibility),b.events.on({featureselected:b.onSelect,featureunselected:b.onUnselect,loadstart:function(a){showThrobber(a.object.s3_layer_id)},loadend:function(a){hideThrobber(a.object.s3_layer_id)}}),map.addLayer(b),S3.gis.layers_all.push(b))}
function addTMSLayer(a){var b=a.name,c=[a.url];void 0!=a.url2&&c.push(a.url2);void 0!=a.url3&&c.push(a.url3);var f=a.layername,e;e=void 0!=a.zoomLevels?a.zoomLevels:19;var d;void 0!=a.dir?(d=a.dir,-1==$.inArray(d,S3.gis.dirs)&&S3.gis.dirs.push(d)):d="";b=new OpenLayers.Layer.TMS(b,c,{dir:d,s3_layer_id:a.id,s3_layer_type:"tms",layername:f,type:void 0!=a.format?a.format:"png",numZoomLevels:e});void 0!=a.attribution&&(b.attribution=a.attribution);map.addLayer(b);a._base&&map.setBaseLayer(b)}
function addWFSLayer(a){var b=a.name,c=a.url;void 0!=a.username&&void 0!=a.password&&(c=c.replace("://","://"+a.username+":"+a.password+"@"));var f=a.title,e=a.featureType,d=a.featureNS,l=a.schema,n;n=void 0!=a.version?a.version:"1.1.0";var k;k=void 0!=a.geometryName?a.geometryName:"the_geom";var h;h=void 0!=a.styleField?a.styleField:"";var m;m=void 0!=a.styleValues?a.styleValues:{};var g;g=void 0!=a.visibility?a.visibility:!0;var p;void 0!=a.dir?(p=a.dir,-1==$.inArray(p,S3.gis.dirs)&&S3.gis.dirs.push(p)):
p="";var r;r=void 0!=a.opacity?a.opacity:1;var s;s=void 0!=a.cluster_distance?a.cluster_distance:S3.gis.cluster_distance;var v;v=void 0!=a.cluster_threshold?a.cluster_threshold:S3.gis.cluster_threshold;var t,u;void 0!=a.projection?(t=a.projection,u="EPSG:"+t):(t="4326",u="EPSG:4326");c=new OpenLayers.Protocol.WFS({version:n,srsName:u,url:c,featureType:e,featureNS:d,geometryName:k,schema:l});e={context:{radius:function(a){var b=12;a.cluster&&(b=Math.min(a.attributes.count/2,8)+12);return b},fill:function(a){var b=
"#f5902e";a.cluster&&(b="#8087ff");return b},stroke:function(a){var b="#f5902e";a.cluster&&(b="#2b2f76");return b},label:function(a){var b="";a.cluster&&1<a.attributes.count&&(b=a.attributes.count);return b}}};h&&m&&(e.context.fill=function(a){var b;$.each(m,function(c,f){c==a.attributes[h]&&(b=f)});b||(b="#f5902e");a.cluster&&(b="#8087ff");return b},e.context.stroke=function(a){var b;$.each(m,function(c,f){c==a.attributes[h]&&(b=f)});b||(b="#f5902e");a.cluster&&(b="#2b2f76");return b});r=new OpenLayers.Style({label:"${label}",
labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:r/2,strokeColor:"${stroke}",strokeWidth:2,strokeOpacity:r},e);r=new OpenLayers.StyleMap({"default":r,select:{fillColor:"#ffdc33",strokeColor:"#ff9933"}});t="4326"==t?S3.gis.proj4326:new OpenLayers.Projection("EPSG:"+t);a=new OpenLayers.Layer.Vector(b,{maxFeatures:1E3,strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Cluster({distance:s,threshold:v})],dir:p,s3_layer_id:a.id,s3_layer_type:"wfs",projection:t,
protocol:c,styleMap:r});a.title=f;a.setVisibility(g);a.events.on({featureselected:onFeatureSelect,featureunselected:onFeatureUnselect,loadstart:function(a){showThrobber(a.object.s3_layer_id)},loadend:function(a){hideThrobber(a.object.s3_layer_id)}});map.addLayer(a);S3.gis.layers_all.push(a)}
function addWMSLayer(a){var b=a.name,c=a.url;void 0!=a.username&&void 0!=a.password&&(c=c.replace("://","://"+a.username+":"+a.password+"@"));var f=a.layers,e;e=void 0!=a.visibility?a.visibility:!0;var d;void 0!=a.dir?(d=a.dir,-1==$.inArray(d,S3.gis.dirs)&&S3.gis.dirs.push(d)):d="";var l;l=void 0!=a.base?a.base:!1;var n;n=void 0!=a.transparent?a.transparent:!0;var k;k=void 0!=a.format?a.format:"image/png";var h;h=void 0!=a.version?a.version:"1.1.1";var m;m=void 0!=a.map?a.map:"";var g;g=void 0!=a.style?
a.style:"";var p;p=void 0!=a.bgcolor?"0x"+a.bgcolor:"";var r;r=void 0!=a.buffer?a.buffer:0;var s;s=void 0!=a.tiled?a.tiled:!1;var v;v=void 0!=a.opacity?a.opacity:1;var t;t=void 0!=a.queryable?a.queryable:1;var u;void 0!=a.legendURL&&(u=a.legendURL);b=new OpenLayers.Layer.WMS(b,c,{layers:f,transparent:n},{dir:d,wrapDateLine:!0,isBaseLayer:l,s3_layer_id:a.id,s3_layer_type:"wms",queryable:t,visibility:e});m&&(b.params.MAP=m);k&&(b.params.FORMAT=k);h&&(b.params.VERSION=h);g&&(b.params.STYLES=g);p&&(b.params.BGCOLOR=
p);s&&(b.params.TILED=!0,b.params.TILESORIGIN=[map.maxExtent.left,map.maxExtent.bottom]);l||(b.opacity=v,b.buffer=r?r:0);u&&(b.legendURL=u);map.addLayer(b);a._base&&map.setBaseLayer(b)}
function addXYZLayer(a){var b=a.name,c=[a.url];void 0!=a.url2&&c.push(a.url2);void 0!=a.url3&&c.push(a.url3);var f=a.layername,e;e=void 0!=a.zoomLevels?a.zoomLevels:19;var d;void 0!=a.dir?(d=a.dir,-1==$.inArray(d,S3.gis.dirs)&&S3.gis.dirs.push(d)):d="";b=new OpenLayers.Layer.XYZ(b,c,{dir:d,s3_layer_id:a.id,s3_layer_type:"xyz",layername:f,type:void 0!=a.format?a.format:"png",numZoomLevels:e});void 0!=a.attribution&&(b.attribution=a.attribution);map.addLayer(b);a._base&&map.setBaseLayer(b)}
function showThrobber(a){$(".layer_throbber").show().removeClass("hide");S3.gis.layers_loading.pop(a);S3.gis.layers_loading.push(a)}function hideThrobber(a){S3.gis.layers_loading.pop(a);0===S3.gis.layers_loading.length&&$(".layer_throbber").hide().addClass("hide")}
function s3_gis_loadDetails(a,b,c){$.ajax({url:a,success:function(a){$("#"+b).html(a);c.updateSize()},error:function(a,e,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;$("#"+b+"_contentDiv").html(msg);c.updateSize()},dataType:"html"})}
function onFeatureSelect(a){s3_gis_tooltipUnselect(a);a=a.feature;var b=a.layer,c=b.s3_layer_type,f=a.geometry.getBounds().getCenterLonLat(),e=S3.uid(),b=void 0!=b.title?b.title:"name",d,l,n;if(a.cluster){var k=a.cluster;d=i18n.gis_cluster_multiple+":<ul>";for(var h=k.length,m=0;m<h;m++){var g=k[m].attributes,c=void 0!=g.popup?g.popup.split("<br />",1)[0]:g[b];d=void 0!=g.url?d+("<li><a href='javascript:s3_gis_loadClusterPopup(\""+g.url+'", "'+e+"\")'>"+c+"</a></li>"):d+("<li>"+c+"</li>")}d+="</ul>";
d+="<div align='center'><a href='javascript:s3_gis_zoomToSelectedFeature("+f.lon+","+f.lat+", 3)'>Zoom in</a></div>"}else if("kml"==c){g=a.attributes;if(void 0!=a.style.balloonStyle)d=a.style.balloonStyle.replace(/{([^{}]*)}/g,function(a,b){var c=g[b];return"string"===typeof c||"number"===typeof c?c:a});else{k=typeof g[b];c="object"==k?g[b].value:g[b];d="<h3>"+c+"</h3>";for(var c=a.layer.body.split(" "),p,b=0;b<c.length;b++)k=typeof g[c[b]],"object"==k?(k=g[c[b]].displayName,""===k&&(k=c[b]),h=g[c[b]].value,
p='<div class="gis_popup_row"><div class="gis_popup_label">'+k+':</div><div class="gis_popup_cell">'+h+"</div></div>"):p=void 0!=g[c[b]]?'<div class="gis_popup_row">'+g[c[b]]+"</div>":"",d+=p}-1!=d.search("<script")&&(d="Content contained Javascript! Escaped content below.<br />"+d.replace(/</g,"<"))}else if("gpx"!=c)if("shapefile"==c)g=a.attributes,d="<div>",$.each(g,function(a,b){"id_orig"==a&&(a="id");p='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_cell">'+
b+"</div></div>";d+=p}),d+="</div>";else if("wfs"==c)g=a.attributes,c=g[b],d="<h3>"+c+"</h3>",$.each(g,function(a,b){p='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_val">'+b+"</div></div>";d+=p});else if(void 0!=a.attributes.url)n=a.attributes.url,d=i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 />";else{g=a.attributes;c=void 0==g.name?"":"<h3>"+g.name+"</h3>";b=void 0==g.description?"":"<p>"+g.description+"</p>";k=void 0==g.link?"":'<a href="'+
g.link+'" target="_blank">'+g.link+"</a>";if(void 0==g.data)h="";else if(0===g.data.indexOf("http://")){l=!0;var r=S3.uid(),h='<div id="'+r+'">'+i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 /></div>"}else h="<p>"+g.data+"</p>";m=void 0==g.image?"":0===g.image.indexOf("http://")?'<img src="'+g.image+'" height=300 width=300>':"";d=c+b+k+h+m}f=new OpenLayers.Popup.FramedCloud(e,f,new OpenLayers.Size(200,200),d,null,!0,onPopupClose);void 0!=n?s3_gis_loadDetails(n,e+"_contentDiv",f):
l&&s3_gis_loadDetails(a.attributes.data,r,f);a.popup=f;map.addPopup(f)}
function addControls(){map.addControl(new OpenLayers.Control.Navigation);void 0==S3.gis.zoomcontrol&&map.addControl(new OpenLayers.Control.Zoom);map.addControl(new OpenLayers.Control.ArgParser);map.addControl(new OpenLayers.Control.Attribution);void 0==S3.gis.scaleline&&map.addControl(new OpenLayers.Control.ScaleLine);"mgrs"==S3.gis.mouse_position?map.addControl(new OpenLayers.Control.MGRSMousePosition):S3.gis.mouse_position&&map.addControl(new OpenLayers.Control.MousePosition);void 0==S3.gis.permalink&&
map.addControl(new OpenLayers.Control.Permalink);void 0==S3.gis.overview&&(S3.gis.options.controls=null,map.addControl(new OpenLayers.Control.OverviewMap({mapOptions:S3.gis.options})));addPopupControls()}
function addPopupControls(){S3.gis.popupControl=new OpenLayers.Control.SelectFeature(S3.gis.layers_all,{toggle:!0});S3.gis.highlightControl=new OpenLayers.Control.SelectFeature(S3.gis.layers_all,{hover:!0,highlightOnly:!0,eventListeners:{featurehighlighted:s3_gis_tooltipSelect,featureunhighlighted:s3_gis_tooltipUnselect}});map.addControl(S3.gis.highlightControl);map.addControl(S3.gis.popupControl);S3.gis.highlightControl.activate();S3.gis.popupControl.activate()}
function onFeatureUnselect(a){a=a.feature;a.popup&&(map.removePopup(a.popup),a.popup.destroy(),delete a.popup)}function onPopupClose(a){for(;map.popups.length;)map.removePopup(map.popups[0])}
function s3_gis_tooltipSelect(a){a=a.feature;if(!a.cluster&&null===a.popup){null!==S3.gis.tooltipPopup&&void 0!==S3.gis.tooltipPopup&&(map.removePopup(S3.gis.tooltipPopup),S3.gis.tooltipPopup.destroy(),null!==S3.gis.lastFeature&&delete S3.gis.lastFeature.popup,S3.gis.tooltipPopup=null);S3.gis.lastFeature=a;var b=a.geometry.getBounds().getCenterLonLat(),c=a.attributes,f;void 0!=c.popup?f=c.popup:void 0!=c.name?f=c.name:void 0!=a.layer.title&&(f=c[a.layer.title],f="object"==typeof f?f.value:f);f&&(S3.gis.tooltipPopup=
new OpenLayers.Popup("activetooltip",b,new OpenLayers.Size(80,12),f,!1));null!==S3.gis.tooltipPopup&&void 0!==S3.gis.tooltipPopup&&(S3.gis.tooltipPopup.contentDiv.style.backgroundColor="ffffcb",S3.gis.tooltipPopup.contentDiv.style.overflow="hidden",S3.gis.tooltipPopup.contentDiv.style.padding="3px",S3.gis.tooltipPopup.contentDiv.style.margin="10px",S3.gis.tooltipPopup.closeOnMove=!0,S3.gis.tooltipPopup.autoSize=!0,S3.gis.tooltipPopup.opacity=0.7,a.popup=S3.gis.tooltipPopup,map.addPopup(S3.gis.tooltipPopup))}}
function s3_gis_tooltipUnselect(a){a=a.feature;null!==a&&null!==a.popup&&(map.removePopup(a.popup),a.popup.destroy(),delete a.popup,S3.gis.tooltipPopup=null,S3.gis.lastFeature=null)}function s3_gis_loadClusterPopup(a,b){var c=i18n.gis_loading+"...<img src='"+S3.gis.ajax_loader+"' border=0 />";$("#"+b+"_contentDiv").html(c);$.get(a,function(a){$("#"+b+"_contentDiv").html(a);map.popups[0].updateSize()},"html")}
function s3_gis_zoomToSelectedFeature(a,b,c){a=new OpenLayers.LonLat(a,b);c=map.getZoom()+c;map.setCenter(a,c);for(c=0;c<map.popups.length;c++)map.removePopup(map.popups[c])}
function addGeolocateControl(a){var b=S3.gis.draftLayer,c={fillColor:"#000",fillOpacity:0.1,strokeWidth:0},f=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:7E3}});map.addControl(f);f.events.register("locationupdated",this,function(a){b.removeAllFeatures();var f=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,40,0),{},c);b.addFeatures([new OpenLayers.Feature.Vector(a.point,
{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),f]);map.zoomToExtent(b.getDataExtent());s3_gis_pulsate(f)});f.events.register("locationfailed",this,function(){OpenLayers.Console.log("Location detection failed")});S3.gis.geolocateControl=f;f=new Ext.Toolbar.Button({iconCls:"geolocation",tooltip:i18n.gis_geoLocate,handler:function(){S3.gis.draftLayer.removeAllFeatures();S3.gis.geolocateControl.activate()}});a.addButton(f)}
function s3_gis_pulsate(a){var b=a.geometry.getCentroid(),c=a.geometry.getBounds(),f=Math.abs((c.right-c.left)/2),e=0,d="up";window.resizeInterval=window.setInterval(function(){16<e&&clearInterval(window.resizeInterval);var c=0.03*f/f;switch(e){case 4:case 12:d="down";break;case 8:d="up"}"up"!==d&&(c=-Math.abs(c));a.geometry.resize(1+c,b);S3.gis.draftLayer.drawFeature(a);e++},50,b,f)}
function addGoogleEarthControl(a){var b=new Ext.Toolbar.Button({iconCls:"googleearth",tooltip:S3.gis.Google.Earth,enableToggle:!0,toggleHandler:function(a,b){!0===b?(S3.gis.mapPanelContainer.getLayout().setActiveItem(1),S3.gis.mapWin.items.items[0].collapse(),S3.gis.googleEarthPanel.on("pluginready",function(){addGoogleEarthKmlLayers()})):(S3.gis.mapPanelContainer.getLayout().setActiveItem(0),S3.gis.mapWin.items.items[0].expand())}});a.addSeparator();a.addButton(b)}
function addGoogleEarthKmlLayers(){if(S3.gis.layers_features)for(var a=0;a<S3.gis.layers_features.length;a++){var b=S3.gis.layers_features[a];if(void 0!=b.visibility?b.visibility:1)b=S3.public_url+b.url.replace("geojson","kml"),google.earth.fetchKml(S3.gis.googleEarthPanel.earth,b,googleEarthKmlLoaded)}}function googleEarthKmlLoaded(a){a&&S3.gis.googleEarthPanel.earth.getFeatures().appendChild(a)}
function addGoogleStreetviewControl(a){var b=OpenLayers.Class(OpenLayers.Control,{defaults:{pixelTolerance:1,stopSingle:!0},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(a){openStreetviewPopup(map.getLonLatFromViewPortPx(a.xy))}});S3.gis.StreetviewClicker=new b({autoactivate:!1});map.addControl(S3.gis.StreetviewClicker);
b=new Ext.Toolbar.Button({iconCls:"streetview",tooltip:S3.gis.Google.StreetviewButton,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",toggleHandler:function(a,b){!0===b?S3.gis.StreetviewClicker.activate():S3.gis.StreetviewClicker.deactivate()}});a.addSeparator();a.addButton(b)}
function openStreetviewPopup(a){a||(a=map.getCenter());S3.gis.sv_popup&&S3.gis.sv_popup.anc&&S3.gis.sv_popup.close();S3.gis.sv_popup=new GeoExt.Popup({title:S3.gis.Google.StreetviewTitle,location:a,width:300,height:300,collapsible:!0,map:S3.gis.mapPanel,items:[new gxp.GoogleStreetViewPanel]});S3.gis.sv_popup.show()}
function addMeasureControls(a){var b=new OpenLayers.Style;b.addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:5,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#f5902e"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#f5902e",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#f5902e",fillColor:"white",fillOpacity:0.5}}})]);var b=new OpenLayers.StyleMap({"default":b}),c=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,
{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}});c.events.on({measure:function(a){alert(i18n.gis_length_message+" "+a.measure.toFixed(2)+" "+a.units)}});c=new GeoExt.Action({control:c,map:map,iconCls:"measure-off",tooltip:i18n.gis_length_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"});a.add(c);void 0===S3.gis.loc_select&&(b=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}}),b.events.on({measure:function(a){alert(i18n.gis_area_message+
" "+a.measure.toFixed(2)+" "+a.units+"2")}}),b=new GeoExt.Action({control:b,map:map,iconCls:"measure-area",tooltip:i18n.gis_area_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"}),a.add(b))}
function addNavigationControl(a){var b=new OpenLayers.Control.NavigationHistory;map.addControl(b);b.activate();var c=new Ext.Toolbar.Button({iconCls:"back",tooltip:i18n.gis_navPrevious,handler:b.previous.trigger}),b=new Ext.Toolbar.Button({iconCls:"next",tooltip:i18n.gis_navNext,handler:b.next.trigger});a.addButton(c);a.addButton(b)}
function addPointControl(a,b){OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(a){return!0},CLASS_NAME:"OpenLayers.Handler.PointS3"});var c=new OpenLayers.Control.DrawFeature(S3.gis.draftLayer,OpenLayers.Handler.PointS3,{featureAdded:function(a){S3.gis.lastDraftFeature?S3.gis.lastDraftFeature.destroy():1<S3.gis.draftLayer.features.length&&S3.gis.draftLayer.features[0].destroy();var b=$("#gis_location_lon");if(b.length){var c=a.geometry.getBounds().getCenterLonLat();
c.transform(map.getProjectionObject(),S3.gis.proj4326);b.val(c.lon);$("#gis_location_lat").val(c.lat);$("#gis_location_wkt").val("")}S3.gis.lastDraftFeature=a}});a?(S3.gis.pointButton=new GeoExt.Action({control:c,handler:function(){S3.gis.pointButton.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:map,iconCls:"drawpoint-off",tooltip:i18n.gis_draw_feature,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:b}),a.add(S3.gis.pointButton)):
(map.addControl(c),b&&(c.activate(),$(".olMapViewport").addClass("crosshair")))}
function addPolygonControl(a,b,c){S3.gis.polygonButton=new GeoExt.Action({control:new OpenLayers.Control.DrawFeature(S3.gis.draftLayer,c?OpenLayers.Handler.Polygon:OpenLayers.Handler.RegularPolygon,{handlerOptions:c?{sides:4,snapAngle:90}:{},featureAdded:function(a){S3.gis.lastDraftFeature&&S3.gis.lastDraftFeature.destroy();var b=a.geometry.transform(map.getProjectionObject(),S3.gis.proj4326).toString();$("#gis_search_polygon_input").val(b).trigger("change");$("#gis_location_wkt").val(b);$("#gis_location_lat").val("");
$("#gis_location_lon").val("");S3.gis.lastDraftFeature=a}}),handler:function(){S3.gis.polygonButton.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:map,iconCls:"drawpolygon-off",tooltip:i18n.gis_draw_polygon,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:b,activateOnEnable:!0,deactivateOnDisable:!0});a.add(S3.gis.polygonButton)}
function addPotlatchButton(a){var b=new Ext.Toolbar.Button({iconCls:"potlatch",tooltip:i18n.gis_potlatch,handler:function(){var a=map.getZoom();if(14>a)alert(S3.gis.osm_oauth);else{var b=map.getCenter();b.transform(map.getProjectionObject(),S3.gis.proj4326);a=S3.Ap.concat("/gis/potlatch2/potlatch2.html")+"?lat="+b.lat+"&lon="+b.lon+"&zoom="+a;window.open(a)}}});a.addSeparator();a.addButton(b)}
function addSaveButton(a){var b=new Ext.Toolbar.Button({iconCls:"save",tooltip:i18n.gis_save,handler:function(){var a=getState(),b=Ext.util.JSON.encode(a.layers),e=Ext.util.JSON.encode(a.plugins),d;d=S3.gis.config_id?S3.Ap.concat("/gis/config/"+S3.gis.config_id+".url/update"):S3.Ap.concat("/gis/config.url/create");Ext.Ajax.request({url:d,method:"POST",success:function(a,b){var c=Ext.decode(a.responseText).message.split("=",2)[1];c&&(S3.gis.config_id=c,c=S3.Ap.concat("/gis/config/",c,"/layer_entity"),
$("#gis_menu_config").attr("href",c))},params:{lat:a.lat,lon:a.lon,zoom:a.zoom,layers:b,plugins:e}})}});a.addSeparator();a.addButton(b)}
function getState(){var a={},b=map.getCenter();b.transform(map.getProjectionObject(),S3.gis.proj4326);a.lon=b.lon;a.lat=b.lat;a.zoom=map.getZoom();var c=[],f,e,d=map.baseLayer.s3_layer_id;Ext.iterate(map.layers,function(a,b,h){f=a.s3_layer_id;e={id:f};a.visibility&&(e.visible=a.visibility);f==d&&(e.base=!0);a.s3_style&&(e.style=a.s3_style);c.push(e)});a.layers=c;var l=[];Ext.iterate(S3.gis.plugins,function(a,b,c){a.getState&&l.push(a.getState())});a.plugins=l;return a}
function addPdfControl(a){selectPdfControl=new OpenLayers.Control;OpenLayers.Util.extend(selectPdfControl,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{done:this.getPdf});this.box.activate()},response:function(a){this.w.destroy();a=(new OpenLayers.Format.GML).read(a.responseText);var b=a.length+" pdfs. <br /><ul>";if(a.length)for(var e=0;e<a.length;e++)var d=a[e],b=b+("<li><a href='"+a[e].attributes.url+"'>"+(d.attributes.utm_zone+d.attributes.grid_zone+d.attributes.grid_square+d.attributes.easting+
d.attributes.northing)+"</a></li>");this.w=new Ext.Window({html:b+"</ul>",width:300,title:"Results",height:200});this.w.show()},getPdf:function(a){var b=map.getLonLatFromPixel(new OpenLayers.Pixel(a.left,a.bottom)).transform(map.getProjectionObject(),S3.gis.proj4326);a=map.getLonLatFromPixel(new OpenLayers.Pixel(a.right,a.top)).transform(map.getProjectionObject(),S3.gis.proj4326);bbox=(new OpenLayers.Bounds(b.lon,b.lat,a.lon,a.lat)).toBBOX();OpenLayers.Request.GET({url:S3.gis.mgrs_url+"&bbox="+bbox,
callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({html:"Searching "+S3.gis.mgrs_name+", please wait.",width:200,title:"Please Wait."});this.w.show()}});var b="Select "+S3.gis.mgrs_name,b=new GeoExt.Action({text:b,control:selectPdfControl,map:map,allowDepress:!1,toggleGroup:"controls",tooltip:b});a.addSeparator();a.add(b)}
function addWMSGetFeatureInfoControl(a){S3.gis.wmsGetFeatureInfo=new gxp.plugins.WMSGetFeatureInfo({actionTarget:"gis_toolbar",outputTarget:"map",outputConfig:{width:400,height:200},toggleGroup:"controls",format:"grid",infoActionTip:i18n.gis_get_feature_info,popupTitle:i18n.gis_feature_info});S3.gis.wmsGetFeatureInfo.target=S3.gis;S3.gis.wmsGetFeatureInfo.addActions()}
function addRemoveLayersControl(){S3.gis.addLayersControl=new gxp.plugins.AddLayers({actionTarget:"treepanel.tbar",addActionTip:"Add layers",addActionMenuText:"Add layers",addServerText:"Add a New Server",doneText:"Done",upload:{url:null},uploadText:i18n.gis_uploadlayer,relativeUploadOnly:!1});var a=new GeoExt.data.LayerStore;S3.gis.addLayersControl.target=S3.gis.layerTree;S3.gis.layerTree.proxy=OpenLayers.ProxyHost;S3.gis.layerTree.layerSources={};S3.gis.layerTree.layerSources.local=new gxp.plugins.LayerSource({title:"local",
store:a});S3.gis.addLayersControl.addActions()[0].enable();S3.gis.removeLayerControl=new gxp.plugins.RemoveLayer({actionTarget:"treepanel.tbar",removeActionTip:"Remove layer"});S3.gis.removeLayerControl.target=S3.gis.layerTree;S3.gis.layerTree.mapPanel=S3.gis.mapPanel;S3.gis.removeLayerControl.addActions()}
function addLayerPropertiesButton(){var a=new Ext.Toolbar.Button({iconCls:"gxp-icon-layerproperties",tooltip:i18n.gis_properties,handler:function(){var a=S3.gis.layerTree.root.findChildBy(function(a){return a.isSelected()?a.leaf?!0:!1:!1},null,!0);if(a){var c=a.layer.s3_layer_type,f=S3.Ap.concat("/gis/layer_"+c+".plain?layer_"+c+".layer_id="+a.layer.s3_layer_id+"&update=1");Ext.Ajax.request({url:f,method:"GET",success:function(e,d){S3.gis.propertiesWindow&&S3.gis.propertiesWindow.close();var f;"feature"==
c?(f=new Ext.TabPanel({activeTab:0,items:[{title:"Layer Properties",html:e.responseText},{title:"Filter",id:"s3_gis_layer_filter_tab",html:""}]}),f.items.items[1].on("activate",function(){var c;Ext.iterate(S3.gis.layers_features,function(d,e,f){d.id==a.layer.s3_layer_id&&(c=d.url.replace(/.geojson.+/,"/search.plain"))});Ext.get("s3_gis_layer_filter_tab").load({url:c,discardUrl:!1,callback:function(){S3.addTooltips();S3.search.select_letter_label()},text:"Loading...",timeout:30,scripts:!1})})):f=new Ext.Panel({title:"Layer Properties",
html:e.responseText});S3.gis.propertiesWindow=new Ext.Window({width:400,layout:"fit",items:[f]});S3.gis.propertiesWindow.show();$("#plain form").submit(function(){var a=$('#plain input[name="id"]').val(),a=S3.Ap.concat("/gis/layer_"+c+"/"+a+".plain/update"),b=$("#plain input"),d=[];Ext.iterate(b,function(a,b,c){b.id&&-1!=b.id.indexOf("gis_layer_")&&d.push(b.id)});b=[];for(i=0;i<d.length;i++)(q=$("#"+d[i]).serialize())&&b.push(q);(q=$('#plain input[name="id"]').serialize())&&b.push(q);(q=$('#plain input[name="_formkey"]').serialize())&&
b.push(q);(q=$('#plain input[name="_formname"]').serialize())&&b.push(q);0<b.length&&(b=b.join("&"),$.ajax({type:"POST",url:a,data:b,success:function(a){$("#plain").html(a)}}));return!1});S3.addTooltips();S3.autocomplete("role","admin","group","gis_layer_"+c+"_role_required")}})}}});S3.gis.layerTree.getTopToolbar().add(a)};
