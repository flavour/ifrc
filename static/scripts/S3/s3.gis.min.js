S3.gis.maps={};S3.gis.proj4326=new OpenLayers.Projection("EPSG:4326");OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";OpenLayers.ProxyHost=S3.Ap.concat("/gis/proxy?url=");
(function(){function K(c){var a=this.map.getResolution(),b=Math.round((c.left-this.maxExtent.left)/(a*this.tileSize.w));c=Math.round((this.maxExtent.top-c.top)/(a*this.tileSize.h));var a=this.map.getZoom(),d=Math.pow(2,a);if(0>c||c>=d)return OpenLayers.Util.getImagesLocation()+"404.png";b=a+"/"+(b%d+d)%d+"/"+c+"."+this.type;c=this.url;c instanceof Array&&(c=this.selectUrl(b,c));return c+b}function L(c){c=c.feature;if(!c.cluster){var a=c.layer.map,b=a.s3.lastFeature,d=a.s3.tooltipPopup;if(null===c.popup){null!==
d&&void 0!==d&&(a.removePopup(d),d.destroy(),null!==b&&delete b.popup,d=null);var b=c.geometry.getBounds().getCenterLonLat(),e=c.attributes,f;void 0!=e.popup?f=e.popup:void 0!=e.name?f=e.name:void 0!=c.layer.title&&(f=e[c.layer.title],f="object"==typeof f?f.value:f);f&&(d=new OpenLayers.Popup("activetooltip",b,new OpenLayers.Size(80,12),f,!1));null!==d&&void 0!==d&&(d.contentDiv.style.backgroundColor="ffffcb",d.contentDiv.style.overflow="hidden",d.contentDiv.style.padding="3px",d.contentDiv.style.margin=
"10px",d.closeOnMove=!0,d.autoSize=!0,d.opacity=0.7,c.popup=d,a.addPopup(d))}}}function D(c){c=c.feature;if(null!==c&&null!==c.popup){var a=c.layer.map;a.removePopup(c.popup);c.popup.destroy();delete c.popup;a.s3.tooltipPopup=null;a.s3.lastFeature=null}}function E(c,a,b){0===c.indexOf("http://")&&(c=OpenLayers.ProxyHost+encodeURIComponent(c));$.ajax({url:c,dataType:"html"}).done(function(b){try{$("#"+a).html(b)}catch(c){}}).fail(function(b,c,f){msg="UNAUTHORIZED"==f?i18n.gis_requires_login:b.responseText;
$("#"+a+"_contentDiv").html(msg)}).always(function(){b.updateSize()})}function y(c){D(c);c=c.feature;var a=c.layer,b=a.s3_layer_type,d=a.map,e=c.geometry.getBounds().getCenterLonLat(),f=S3.uid(),a=void 0!=a.title?a.title:"name",g,k,m;if(c.cluster){var h=c.cluster;g=i18n.gis_cluster_multiple+":<ul>";for(var n=h.length,p=d.s3.id,r=0;r<n;r++){var l=h[r].attributes,b=void 0!=l.popup?l.popup.split("<br />",1)[0]:l[a];g=void 0!=l.url?g+("<li><a href='javascript:S3.gis.loadClusterPopup(\""+p+'", "'+l.url+
'", "'+f+"\")'>"+b+"</a></li>"):g+("<li>"+b+"</li>")}g+="</ul>";g+="<div align='center'><a href='javascript:S3.gis.zoomToSelectedFeature(\""+p+'", '+e.lon+","+e.lat+", 3)'>"+i18n.gis_zoomin+"</a></div>"}else if("kml"==b){l=c.attributes;if(void 0!=c.style.balloonStyle)g=c.style.balloonStyle.replace(/{([^{}]*)}/g,function(a,b){var c=l[b];return"string"===typeof c||"number"===typeof c?c:a});else{h=typeof l[a];b="object"==h?l[a].value:l[a];g="<h3>"+b+"</h3>";for(var b=c.layer.body.split(" "),t,a=0;a<
b.length;a++)h=typeof l[b[a]],"object"==h?(h=l[b[a]].displayName,""===h&&(h=b[a]),n=l[b[a]].value,t='<div class="gis_popup_row"><div class="gis_popup_label">'+h+':</div><div class="gis_popup_cell">'+n+"</div></div>"):t=void 0!=l[b[a]]?'<div class="gis_popup_row">'+l[b[a]]+"</div>":"",g+=t}-1!=g.search("<script")&&(g="Content contained Javascript! Escaped content below.<br />"+g.replace(/</g,"<"))}else if("gpx"!=b)if("shapefile"==b)l=c.attributes,g="<div>",$.each(l,function(a,b){"id_orig"==a&&(a="id");
t='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_cell">'+b+"</div></div>";g+=t}),g+="</div>";else if("wfs"==b)l=c.attributes,b=l[a],g="<h3>"+b+"</h3>",$.each(l,function(a,b){t='<div class="gis_popup_row"><div class="gis_popup_label">'+a+':</div><div class="gis_popup_val">'+b+"</div></div>";g+=t});else if(void 0!=c.attributes.url)m=c.attributes.url,g=i18n.gis_loading+"...<img src='"+w+"' border=0 />";else{l=c.attributes;b=void 0==l.name?"":"<h3>"+l.name+
"</h3>";a=void 0==l.description?"":"<p>"+l.description+"</p>";h=void 0==l.link?"":'<a href="'+l.link+'" target="_blank">'+l.link+"</a>";if(void 0==l.data)n="";else if(0===l.data.indexOf("http://")){k=!0;var s=S3.uid(),n='<div id="'+s+'">'+i18n.gis_loading+"...<img src='"+w+"' border=0 /></div>"}else n="<p>"+l.data+"</p>";p=void 0==l.image?"":0===l.image.indexOf("http://")?'<img src="'+l.image+'" height=300 width=300>':"";g=b+a+h+n+p}e=new OpenLayers.Popup.FramedCloud(f,e,new OpenLayers.Size(200,200),
g,null,!0,M);e.disableFirefoxOverflowHack=!0;void 0!=m?E(m,f+"_contentDiv",e):k&&E(c.attributes.data,s,e);c.popup=e;d.addPopup(e)}function x(c){c=c.feature;c.popup&&(c.layer.map.removePopup(c.popup),c.popup.destroy(),delete c.popup)}function M(c){for(c=this.map;c.popups.length;)c.removePopup(c.popups[0])}function N(c,a){var b=a.geometry.getCentroid(),d=a.geometry.getBounds(),e=Math.abs((d.right-d.left)/2),f=0,g="up";window.resizeInterval=window.setInterval(function(){16<f&&clearInterval(window.resizeInterval);
var d=0.03*e/e;switch(f){case 4:case 12:g="down";break;case 8:g="up"}"up"!==g&&(d=-Math.abs(d));a.geometry.resize(1+d,b);c.s3.draftLayer.drawFeature(a);f++},50,b,e)}function O(c){c&&S3.gis.googleEarthPanel.earth.getFeatures().appendChild(c)}function P(c){var a={},b=c.getCenter();b.transform(c.getProjectionObject(),u);a.lon=b.lon;a.lat=b.lat;a.zoom=c.getZoom();var d=[],e,f,g=c.baseLayer.s3_layer_id;Ext.iterate(c.layers,function(a,b,c){e=a.s3_layer_id;f={id:e};a.visibility&&(f.visible=a.visibility);
e==g&&(f.base=!0);a.s3_style&&(f.style=a.s3_style);d.push(f)});a.layers=d;var k=[];Ext.iterate(c.s3.plugins,function(a,b,c){a.getState&&k.push(a.getState())});a.plugins=k;return a}var w=S3.Ap.concat("/static/img/ajax-loader.gif"),z=new OpenLayers.Format.GeoJSON;z.ignoreExtraDims=!0;var A=S3.Ap.concat("/static/img/markers/"),u=S3.gis.proj4326;S3.gis.show_map=function(c,a){c||(c="default_map");void 0==a&&(a=S3.gis.options[c]);var b=a.projection,d=new OpenLayers.Projection("EPSG:"+b);a.projection_current=
d;900913==b?(a.maxExtent=new OpenLayers.Bounds(-20037508,-20037508,20037508,2.003750834E7),a.maxResolution=156543.0339,a.units="m"):4326==b?(a.maxExtent=new OpenLayers.Bounds(-180,-90,180,90),a.maxResolution=1.40625,a.units="degrees"):(b=a.maxExtent.split(","),a.maxExtent=new OpenLayers.Bounds(b[0],b[1],b[2],b[3]),a.maxResolution="auto");var e,b=a.lat,f=a.lon;b&&f?(b=new OpenLayers.LonLat(f,b),b.transform(u,d)):(b=a.bbox,f=new OpenLayers.LonLat(b[0],b[1]),f.transform(u,d),e=f.lon,f=f.lat,b=new OpenLayers.LonLat(b[2],
b[3]),b.transform(u,d),e=OpenLayers.Bounds.fromArray([e,f,b.lon,b.lat]),b=e.getCenterLonLat());a.center=b;d=Q(c,a);a.renderTo="map_panel";R(d);e&&d.zoomToExtent(e);return d};var B=function(c){c=c.object;for(var a=c.getDataExtent(),b,d=c.strategies,e=0,f=d.length;e<f;e++)b=d[e],"OpenLayers.Strategy.AttributeCluster"==b.CLASS_NAME&&b.activate();c.map.zoomToExtent(a);c.events.un({loadend:B})};S3.gis.search_layer_loadend=B;S3.gis.refreshLayer=function(c,a){var b=S3.gis.maps,d,e,f,g,k,m,h,n,p;for(d in b)for(e=
b[d],f=e.layers,g=0,k=f.length;g<k;g++)if(m=f[g],m.s3_layer_id==c&&(h=m.protocol.url,h=S3.search.filterURL(h,a),m.protocol.options.url=h,e.s3.mapWin.isVisible())){m.events.on({loadend:B});m=m.strategies;n=m.length;for(h=0;h<n;h++)if(p=m[h],"OpenLayers.Strategy.AttributeCluster"==p.CLASS_NAME){p.deactivate();break}for(h=0;h<n;h++)if(p=m[h],"OpenLayers.Strategy.Refresh"==p.CLASS_NAME){p.refresh();break}}};var Q=function(c,a){var b=new OpenLayers.Map("center",{controls:[],displayProjection:u,projection:a.projection_current,
theme:null,maxResolution:a.maxResolution,maxExtent:a.maxExtent,numZoomLevels:a.numZoomLevels,units:a.units});S3.gis.maps[c]=b;b.s3={};b.s3.id=c;b.s3.options=a;b.s3.plugins=[];b.registerPlugin=function(a){a.map=this;this.s3.plugins.push(a)};b.showThrobber=function(a){$(".layer_throbber").show().removeClass("hide");this.s3.layers_loading.pop(a);this.s3.layers_loading.push(a)};b.hideThrobber=function(a){this.s3.layers_loading.pop(a);0===this.s3.layers_loading.length&&$(".layer_throbber").hide().addClass("hide")};
S(b);T(b);return b},R=function(c){var a=c.s3,b=a.options,d=new GeoExt.MapPanel({height:b.map_height,width:b.map_width,xtype:"gx_mappanel",map:c,center:b.center,zoom:b.zoom,plugins:[]});a.mapPanel=d;var e={};e.map=d;a.portal=e;if(i18n.gis_legend||b.layers_wms)for(var e=c.layers,d=d.layers.data.items,f=0;f<e.length;f++)e[f].legendURL&&(d[f].data.legendURL=e[f].legendURL),e[f].queryable&&(d[f].data.queryable=1);e=U(c);d=[e];b.wms_browser_url&&(f=V(c))&&d.push(f);i18n.gis_legend&&(f=new GeoExt.LegendPanel({title:i18n.gis_legend,
defaults:{},autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1}),d.push(f));for(var f=a.plugins,g=0,k=f.length;g<k;++g)f[g].setup(c),f[g].addToMapWindow(d);a.west_panel_items=d;b.window?F(c):G(c);e.root.eachChild(function(){this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||c.hideThrobber(this.layer.s3_layer_id)});else this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(a,b){b||c.hideThrobber(this.layer.s3_layer_id)})})})});Ext.QuickTips.init()},
G=function(c){var a=c.s3,b=a.options,d=H(c);c=I(c);b=new Ext.Panel({renderTo:b.renderTo,autoScroll:!0,titleCollapse:!0,height:b.map_height,width:b.map_width,layout:"border",items:[d,c]});a.mapWin=b};S3.gis.addMapPanel=G;var F=function(c){var a=c.s3,b=a.options,d=H(c);c=I(c);d=new Ext.Window({cls:"gis-map-window",collapsible:!1,constrain:!0,closable:!b.windowNotClosable,closeAction:"hide",autoScroll:!0,maximizable:b.maximizable,titleCollapse:!1,height:b.map_height,width:b.map_width,layout:"border",
items:[d,c]});d.on("beforehide",function(a){a.maximized&&a.restore()});b.windowHide||(d.show(),d.maximize());a.mapWin=d};S3.gis.addMapWindow=F;var H=function(c){c=c.s3;var a=c.options.west_collapsed||!1,b=new Ext.Panel({cls:"map_tools",header:!1,border:!1,split:!0,items:c.west_panel_items}),a=new Ext.Panel({region:"west",header:!1,border:!0,width:250,autoScroll:!0,collapsible:!0,collapseMode:"mini",collapsed:a,items:[b]});return c.westPanelContainer=a},I=function(c){var a=c.s3,b=a.options;if(b.toolbar){var d,
e=c.s3.options;d=new Ext.Toolbar({height:34});d.map=c;var f=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtent,map:c,iconCls:"zoomfull",tooltip:i18n.gis_zoomfull}),g=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:!0}),map:c,iconCls:"zoomout",tooltip:i18n.gis_zoomout,toggleGroup:"controls"}),k=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox,map:c,iconCls:"zoomin",tooltip:i18n.gis_zoominbutton,toggleGroup:"controls"}),m,h,n;"active"==e.draw_polygon?(m=!0,n=h=
!1):("active"==e.draw_feature?(n=!0,h=!1):(h=!0,n=!1),m=!1);d.add(f);navigator.geolocation&&W(d);void 0===e.nav&&(f=new GeoExt.Action({control:new OpenLayers.Control.Navigation,map:c,iconCls:"pan-off",tooltip:i18n.gis_pan,allowDepress:!0,toggleGroup:"controls",pressed:h}),d.add(g),d.add(k),d.add(f),d.addSeparator(),k=new OpenLayers.Control.NavigationHistory,d.map.addControl(k),k.activate(),g=new Ext.Toolbar.Button({iconCls:"back",tooltip:i18n.gis_navPrevious,handler:k.previous.trigger}),k=new Ext.Toolbar.Button({iconCls:"next",
tooltip:i18n.gis_navNext,handler:k.next.trigger}),d.addButton(g),d.addButton(k));e.save&&X(d);d.addSeparator();Y(d);e.mgrs_url&&Z(d);if(e.draw_feature||e.draw_polygon)d.addSeparator(),e.draw_feature&&J(c,d,n),e.draw_polygon&&aa(d,m,!0);i18n.gis_get_feature_info&&(m=new gxp.plugins.WMSGetFeatureInfo({actionTarget:"gis_toolbar",outputTarget:"map",outputConfig:{width:400,height:200},toggleGroup:"controls",format:"grid",infoActionTip:i18n.gis_get_feature_info,popupTitle:i18n.gis_feature_info}),m.target=
c.s3,m.addActions());i18n.gis_potlatch&&ba(d);e.Google&&e.Google.StreetviewButton&&ca(d);try{e.Google.Earth&&google&da(d)}catch(p){}i18n.gis_search&&(e=Math.min(350,!1===e.nav?e.map_width-500:e.map_width-680),c=new GeoExt.ux.GeoNamesSearchCombo({map:c,width:e,listWidth:e,minChars:2,emptyText:i18n.gis_search}),d.addSeparator(),d.add(c));c=new Ext.BoxComponent({autoEl:{tag:"img",src:w},cls:"layer_throbber hide"});d.add(c)}else b.draw_feature&&J(c,null,"active"==b.draw_feature?!0:!1);d=new Ext.Panel({layout:"card",
region:"center",cls:"mappnlcntr",defaults:{border:!1},items:[a.mapPanel],activeItem:0,tbar:d,scope:this});a.mapPanelContainer=d;b.Google&&b.Google.Earth&&(b=new gxp.GoogleEarthPanel({mapPanel:a.mapPanel}),d.items.items.push(b),a.googleEarthPanel=b,S3.gis.googleEarthPanel=b);return d},U=function(c){for(var a=c.s3.mapPanel.layers,b=[{text:i18n.gis_base_layers,nodeType:"gx_baselayercontainer",layerStore:a,loader:{filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!0===a.isBaseLayer&&
(void 0===a.dir||""===a.dir)}},leaf:!1,expanded:!0},{text:i18n.gis_overlays,nodeType:"gx_overlaylayercontainer",layerStore:a,loader:{filter:function(a){a=a.getLayer();return!0===a.displayInLayerSwitcher&&!1===a.isBaseLayer&&(void 0===a.dir||""===a.dir)}},leaf:!1,expanded:!0}],d=c.s3.dirs,e=0;e<d.length;e++){var f={text:d[e],nodeType:"gx_layercontainer",layerStore:a,loader:{filter:function(a){return function(b){if("undefined"!==b.data.layer.dir)return b.data.layer.dir===a}}(d[e])},leaf:!1,expanded:!0};
b.push(f)}a=new Ext.tree.AsyncTreeNode({expanded:!0,children:b});b=i18n.gis_properties||i18n.gis_uploadlayer?new Ext.Toolbar:null;a=new Ext.tree.TreePanel({title:i18n.gis_layers,loader:new Ext.tree.TreeLoader({applyLoader:!1}),root:a,rootVisible:!1,split:!0,autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1,tbar:b,enableDD:!0});i18n.gis_uploadlayer&&ea(c,a);i18n.gis_properties&&fa(c,a);return a},V=function(c){var a=c.s3.options,b=new Ext.tree.AsyncTreeNode({expanded:!0,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+
a.wms_browser_url,layerOptions:{buffer:1,singleTile:!1,ratio:1,wrapDateLine:!0},layerParams:{TRANSPARENT:"TRUE"},createNode:function(a){a.checked=a.leaf?!1:void 0;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[a])}})});return new Ext.tree.TreePanel({title:a.wms_browser_name,root:b,rootVisible:!1,split:!0,autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1,listeners:{checkchange:function(a,b){!0===b?c.addLayer(a.attributes.layer):c.removeLayer(a.attributes.layer)}}})},
S=function(c){var a=c.s3,b=a.options;a.layers_all=[];a.dirs=[];a.layers_loading=[];a.common_cluster_strategy=new OpenLayers.Strategy.AttributeClusterMultiple({attribute:"colour",distance:20,threshold:2});if(b.layers_osm)for(var d=b.layers_osm,a=d.length;0<a;a--)ga(c,d[a-1]);try{google&ha(c)}catch(e){}b.Bing&&ia(c);if(b.layers_tms)for(d=b.layers_tms,a=d.length;0<a;a--)ja(c,d[a-1]);if(b.layers_wms)for(d=b.layers_wms,a=d.length;0<a;a--)ka(c,d[a-1]);if(b.layers_xyz)for(d=b.layers_xyz,a=d.length;0<a;a--)la(c,
d[a-1]);b.EmptyLayer&&(a=new OpenLayers.Layer(b.EmptyLayer.name,{isBaseLayer:!0,displayInLayerSwitcher:!0,s3_layer_id:b.EmptyLayer.id,s3_layer_type:"empty"}),c.addLayer(a),b.EmptyLayer.base&&c.setBaseLayer(a));if(b.layers_js)for(d=b.layers_js,a=d.length;0<a;a--)eval(c,d[a-1]);if(b.layers_theme)for(d=b.layers_theme,a=d.length;0<a;a--)v(c,d[a-1]);if(b.layers_geojson)for(d=b.layers_geojson,a=d.length;0<a;a--)v(c,d[a-1]);if(b.layers_gpx)for(d=b.layers_gpx,a=d.length;0<a;a--)ma(c,d[a-1]);if(b.layers_arcrest)for(d=
b.layers_arcrest,a=d.length;0<a;a--)na(c,d[a-1]);b.CoordinateGrid&&oa(c);if(b.layers_georss)for(d=b.layers_georss,a=d.length;0<a;a--)v(c,d[a-1]);if(b.layers_kml)for(c.s3.format_kml=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2}),d=b.layers_kml,a=d.length;0<a;a--)pa(c,d[a-1]);b.OWM&&qa(c);if(b.layers_shapefile)for(d=b.layers_shapefile,a=d.length;0<a;a--)v(c,d[a-1]);if(b.layers_wfs)for(d=b.layers_wfs,a=d.length;0<a;a--)ra(c,d[a-1]);if(b.feature_queries)for(d=b.feature_queries,
a=d.length;0<a;a--)v(c,d[a-1]);if(b.feature_resources)for(d=b.feature_resources,a=d.length;0<a;a--)v(c,d[a-1]);if(b.layers_feature)for(d=b.layers_feature,a=d.length;0<a;a--)v(c,d[a-1]);if(b.features||b.draw_feature||b.draw_polygon||navigator.geolocation)var f=sa(c);if(b.features)for(b=b.features,c=c.getProjectionObject(),a=0;a<b.length;a++)d=z.parseFeature(b[a]),d.geometry.transform(u,c),f.addFeatures([d])},na=function(c,a){var b=a.name,d=[a.url],e=void 0!=a.layers?a.layers.join():0;if(void 0!=a.dir){var f=
a.dir;-1==$.inArray(f,c.s3.dirs)&&c.s3.dirs.push(f)}else f="";var g=void 0!=a.visibility?a.visibility:!0,b=new OpenLayers.Layer.ArcGIS93Rest(b,d,{layers:"show:"+e,isBaseLayer:void 0!=a.base?a.base:!1,transparent:void 0!=a.transparent?a.transparent:!0,dir:f,s3_layer_id:a.id,s3_layer_type:"arcrest"});b.setVisibility(g);c.addLayer(b);a._base&&c.setBaseLayer(b)},ia=function(c){var a=c.s3.options.Bing,b=a.ApiKey,d;a.Aerial&&(d=new OpenLayers.Layer.Bing({key:b,type:"Aerial",name:a.Aerial.name,s3_layer_id:a.Aerial.id,
s3_layer_type:"bing"}),c.addLayer(d),"aerial"==a.Base&&c.setBaseLayer(d));a.Road&&(d=new OpenLayers.Layer.Bing({key:b,type:"Road",name:a.Road.name,s3_layer_id:a.Road.id,s3_layer_type:"bing"}),c.addLayer(d),"road"==a.Base&&c.setBaseLayer(d));a.Hybrid&&(d=new OpenLayers.Layer.Bing({key:b,type:"AerialWithLabels",name:a.Hybrid.name,s3_layer_id:a.Hybrid.id,s3_layer_type:"bing"}),c.addLayer(d),"hybrid"==a.Base&&c.setBaseLayer(d))},oa=function(c){var a=c.s3.options.CoordinateGrid;c.addLayer(new OpenLayers.Layer.cdauth.CoordinateGrid(null,
{name:a.name,shortName:"grid",visibility:a.visibility,s3_layer_id:a.id,s3_layer_type:"coordinate"}))},sa=function(c){var a=c.s3.options.marker_default,b=A+a.i,d=a.h,a=a.w,e=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);e.graphicOpacity=1;e.graphicWidth=a;e.graphicHeight=d;e.graphicXOffset=-(a/2);e.graphicYOffset=-d;e.externalGraphic=b;b=new OpenLayers.Layer.Vector(i18n.gis_draft_layer,{style:e,displayInLayerSwitcher:!1});b.setVisibility(!0);c.addLayer(b);return c.s3.draftLayer=
b},v=function(c,a){var b=a.name,d=a.url,e=void 0!=a.refresh?a.refresh:900;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,c.s3.dirs)&&c.s3.dirs.push(f)}else f="";var g=void 0!=a.visibility?a.visibility:!0,k=void 0!=a.cluster_attribute?a.cluster_attribute:"colour",m=void 0!=a.cluster_distance?a.cluster_distance:20,h=void 0!=a.cluster_threshold?a.cluster_threshold:2,n=void 0!=a.projection?a.projection:4326,n=4326==n?u:new OpenLayers.Projection("EPSG:"+n),p=void 0!=a.type?a.type:"feature",r=C(c,a),l=r[0],
r=r[1],b=new OpenLayers.Layer.Vector(b,{dir:f,projection:n,protocol:new OpenLayers.Protocol.HTTP({url:d,format:z}),strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*e}),new OpenLayers.Strategy.AttributeCluster({attribute:k,distance:m,threshold:h})],legendURL:r,styleMap:l,s3_layer_id:a.id,s3_layer_type:p,s3_style:a.style});b.setVisibility(g);b.events.on({featureselected:y,featureunselected:x,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},
loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});c.addLayer(b);c.s3.layers_all.push(b)},ha=function(c){var a=c.s3.options.Google,b;a.MapMaker||a.MapMakerHybrid?(a.Satellite&&(b=new OpenLayers.Layer.Google(a.Satellite.name,{type:G_SATELLITE_MAP,sphericalMercator:!0,s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),c.addLayer(b),"satellite"==a.Base&&c.setBaseLayer(b)),a.Maps&&(b=new OpenLayers.Layer.Google(a.Maps.name,{type:G_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),
c.addLayer(b),"maps"==a.Base&&c.setBaseLayer(b)),a.Hybrid&&(b=new OpenLayers.Layer.Google(a.Hybrid.name,{type:G_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),c.addLayer(b),"maps"==a.Base&&c.setBaseLayer(b)),a.Terrain&&(b=new OpenLayers.Layer.Google(a.Terrain.name,{type:G_PHYSICAL_MAP,sphericalMercator:!0,s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),c.addLayer(b),"terrain"==a.Base&&c.setBaseLayer(b)),a.MapMaker&&(b=new OpenLayers.Layer.Google(a.MapMaker.name,
{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:b.id,s3_layer_type:"google"}),c.addLayer(b),"mapmaker"==a.Base&&c.setBaseLayer(b)),a.MapMakerHybrid&&(b=new OpenLayers.Layer.Google(a.MapMakerHybrid.name,{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:b.id,s3_layer_type:"google"}),c.addLayer(b),"mapmakerhybrid"==a.Base&&c.setBaseLayer(b))):(a.Satellite&&(b=new OpenLayers.Layer.Google(a.Satellite.name,{type:"satellite",numZoomLevels:22,s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),
c.addLayer(b),"satellite"==a.Base&&c.setBaseLayer(b)),a.Maps&&(b=new OpenLayers.Layer.Google(a.Maps.name,{numZoomLevels:20,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),c.addLayer(b),"maps"==a.Base&&c.setBaseLayer(b)),a.Hybrid&&(b=new OpenLayers.Layer.Google(a.Hybrid.name,{type:"hybrid",numZoomLevels:20,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),c.addLayer(b),"hybrid"==a.Base&&c.setBaseLayer(b)),a.Terrain&&(b=new OpenLayers.Layer.Google(a.Terrain.name,{type:"terrain",s3_layer_id:a.Terrain.id,
s3_layer_type:"google"}),c.addLayer(b),"terrain"==a.Base&&c.setBaseLayer(b)))},ma=function(c,a){var b=a.name,d=a.url,e=a.marker,f=A+e.i,g=e.h,k=e.w,m=void 0!=a.waypoints?a.waypoints:!0,h=void 0!=a.tracks?a.tracks:!0,n=void 0!=a.routes?a.routes:!0,e=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var p=a.dir;-1==$.inArray(p,c.s3.dirs)&&c.s3.dirs.push(p)}else p="";var r=void 0!=a.opacity?a.opacity:1,l=void 0!=a.cluster_distance?a.cluster_distance:20,t=void 0!=a.cluster_threshold?a.cluster_threshold:
2,s=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);m?(s.graphicOpacity=r,s.graphicWidth=k,s.graphicHeight=g,s.graphicXOffset=-(k/2),s.graphicYOffset=-g,s.externalGraphic=f):s.externalGraphic="";s.strokeColor="blue";s.strokeWidth=6;s.strokeOpacity=r;b=new OpenLayers.Layer.Vector(b,{dir:p,projection:u,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:l,threshold:t})],legendURL:f,s3_layer_id:a.id,s3_layer_type:"gpx",style:s,protocol:new OpenLayers.Protocol.HTTP({url:d,
format:new OpenLayers.Format.GPX({extractAttributes:!0,extractWaypoints:m,extractTracks:h,extractRoutes:n})})});b.setVisibility(e);b.events.on({featureselected:y,featureunselected:x,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});c.addLayer(b);c.s3.layers_all.push(b)},pa=function(c,a){var b=c.s3,d=a.name,e=a.url,f=void 0!=a.title?a.title:"name",g=void 0!=a.body?a.body:"description",k=void 0!=a.refresh?a.refresh:900,m=void 0!=
a.visibility?a.visibility:!0;if(void 0!=a.dir){var h=a.dir;-1==$.inArray(h,b.dirs)&&b.dirs.push(h)}else h="";var n=void 0!=a.cluster_distance?a.cluster_distance:20,p=void 0!=a.cluster_threshold?a.cluster_threshold:2,r=C(c,a),l=r[0],r=r[1],d=new OpenLayers.Layer.Vector(d,{dir:h,projection:u,protocol:new OpenLayers.Protocol.HTTP({url:e,format:b.format_kml}),strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:n,threshold:p}),new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*
k})],legendURL:r,styleMap:l,s3_layer_id:a.id,s3_layer_type:"kml",s3_style:a.style});d.title=f;d.body=g;d.setVisibility(m);d.events.on({featureselected:y,featureunselected:x,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});c.addLayer(d);b.layers_all.push(d)},ga=function(c,a){var b=a.name,d=[a.url1];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var f=a.dir;
-1==$.inArray(f,c.s3.dirs)&&c.s3.dirs.push(f)}else f="";b=new OpenLayers.Layer.TMS(b,d,{dir:f,type:"png",getURL:K,displayOutsideMaxExtent:!0,numZoomLevels:void 0!=a.zoomLevels?a.zoomLevels:19,isBaseLayer:void 0!=a.base?a.base:!0,s3_layer_id:a.id,s3_layer_type:"openstreetmap"});void 0!=a.attribution&&(b.attribution=a.attribution);b.setVisibility(e);c.addLayer(b);a._base&&c.setBaseLayer(b)},qa=function(c){var a=c.s3.options.OWM,b;a.station&&(b=new OpenLayers.Layer.Vector.OWMStations(a.station.name,
{dir:a.station.dir,s3_layer_id:a.station.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.station.visibility),b.events.on({featureselected:b.onSelect,featureunselected:b.onUnselect,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}}),c.addLayer(b),c.s3.layers_all.push(b));a.city&&(b=new OpenLayers.Layer.Vector.OWMWeather(a.city.name,{dir:a.city.dir,s3_layer_id:a.city.id,s3_layer_type:"openweathermap"}),b.setVisibility(a.city.visibility),
b.events.on({featureselected:b.onSelect,featureunselected:b.onUnselect,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}}),c.addLayer(b),c.s3.layers_all.push(b))},ja=function(c,a){var b=a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=a.layername,f=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,c.s3.dirs)&&c.s3.dirs.push(g)}else g="";b=new OpenLayers.Layer.TMS(b,
d,{dir:g,s3_layer_id:a.id,s3_layer_type:"tms",layername:e,type:void 0!=a.format?a.format:"png",numZoomLevels:f});void 0!=a.attribution&&(b.attribution=a.attribution);c.addLayer(b);a._base&&c.setBaseLayer(b)},ra=function(c,a){var b=a.name,d=a.url;void 0!=a.username&&void 0!=a.password&&(d=d.replace("://","://"+a.username+":"+a.password+"@"));var e=a.title,f=a.featureType,g=a.featureNS,k=a.schema,m=void 0!=a.version?a.version:"1.1.0",h=void 0!=a.geometryName?a.geometryName:"the_geom",n=void 0!=a.visibility?
a.visibility:!0;if(void 0!=a.dir){var p=a.dir;-1==$.inArray(p,c.s3.dirs)&&c.s3.dirs.push(p)}else p="";var r=void 0!=a.cluster_distance?a.cluster_distance:20,l=void 0!=a.cluster_threshold?a.cluster_threshold:2;if(void 0!=a.projection)var t=a.projection,s="EPSG:"+t;else t="4326",s="EPSG:4326";d=new OpenLayers.Protocol.WFS({version:m,srsName:s,url:d,featureType:f,featureNS:g,geometryName:h,schema:k});g=C(c,a);f=g[0];g=g[1];t="4326"==t?u:new OpenLayers.Projection("EPSG:"+t);b=new OpenLayers.Layer.Vector(b,
{maxFeatures:1E3,strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Cluster({distance:r,threshold:l})],dir:p,legendURL:g,projection:t,protocol:d,styleMap:f,s3_layer_id:a.id,s3_layer_type:"wfs",s3_style:a.style});b.title=e;b.setVisibility(n);b.events.on({featureselected:y,featureunselected:x,loadstart:function(a){c.showThrobber(a.object.s3_layer_id)},loadend:function(a){c.hideThrobber(a.object.s3_layer_id)}});c.addLayer(b);c.s3.layers_all.push(b)},ka=function(c,a){var b=
a.name,d=a.url;void 0!=a.username&&void 0!=a.password&&(d=d.replace("://","://"+a.username+":"+a.password+"@"));var e=a.layers,f=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,c.s3.dirs)&&c.s3.dirs.push(g)}else g="";var k=void 0!=a.base?a.base:!1,m=void 0!=a.format?a.format:"image/png",h=void 0!=a.version?a.version:"1.1.1",n=void 0!=a.map?a.map:"",p=void 0!=a.style?a.style:"",r=void 0!=a.bgcolor?"0x"+a.bgcolor:"",l=void 0!=a.buffer?a.buffer:0,t=void 0!=a.tiled?
a.tiled:!1,s=void 0!=a.opacity?a.opacity:1;if(void 0!=a.legendURL)var u=a.legendURL;b=new OpenLayers.Layer.WMS(b,d,{layers:e,transparent:void 0!=a.transparent?a.transparent:!0},{dir:g,wrapDateLine:!0,isBaseLayer:k,s3_layer_id:a.id,s3_layer_type:"wms",queryable:void 0!=a.queryable?a.queryable:1,visibility:f});n&&(b.params.MAP=n);m&&(b.params.FORMAT=m);h&&(b.params.VERSION=h);p&&(b.params.STYLES=p);r&&(b.params.BGCOLOR=r);t&&(b.params.TILED=!0,b.params.TILESORIGIN=[c.maxExtent.left,c.maxExtent.bottom]);
k||(b.opacity=s,b.buffer=l?l:0);u&&(b.legendURL=u);c.addLayer(b);a._base&&c.setBaseLayer(b)},la=function(c,a){var b=a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=a.layername,f=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,c.s3.dirs)&&c.s3.dirs.push(g)}else g="";b=new OpenLayers.Layer.XYZ(b,d,{dir:g,s3_layer_id:a.id,s3_layer_type:"xyz",layername:e,type:void 0!=a.format?a.format:"png",numZoomLevels:f});void 0!=a.attribution&&
(b.attribution=a.attribution);c.addLayer(b);a._base&&c.setBaseLayer(b)},T=function(c){var a=c.s3.options;c.addControl(new OpenLayers.Control.Navigation);void 0==a.zoomcontrol&&c.addControl(new OpenLayers.Control.Zoom);c.addControl(new OpenLayers.Control.ArgParser);c.addControl(new OpenLayers.Control.Attribution);void 0==a.scaleline&&c.addControl(new OpenLayers.Control.ScaleLine);"mgrs"==a.mouse_position?c.addControl(new OpenLayers.Control.MGRSMousePosition):a.mouse_position&&c.addControl(new OpenLayers.Control.MousePosition);
void 0==a.permalink&&c.addControl(new OpenLayers.Control.Permalink);if(void 0==a.overview){var a={},b=c.options,d;for(d in b)"controls"!=d&&(a[d]=b[d]);c.addControl(new OpenLayers.Control.OverviewMap({mapOptions:a}))}a=c.s3.layers_all;d=new OpenLayers.Control.SelectFeature(a,{toggle:!0});a=new OpenLayers.Control.SelectFeature(a,{hover:!0,highlightOnly:!0,eventListeners:{featurehighlighted:L,featureunhighlighted:D}});c.addControl(a);c.addControl(d);a.activate();d.activate()};S3.gis.loadClusterPopup=
function(c,a,b){var d="#"+b+"_contentDiv",e=$(d);e.html(i18n.gis_loading+"...<img src='"+w+"' border=0 />");var f=S3.gis.maps[c];$.get(a,function(a){e.html(a);f.popups[0].updateSize();a=$(d+" .dropdown-toggle");a.length&&(e.parent().css("overflow","visible").parent().css("overflow","visible"),a.dropdown())},"html")};S3.gis.zoomToSelectedFeature=function(c,a,b,d){c=S3.gis.maps[c];a=new OpenLayers.LonLat(a,b);d=c.getZoom()+d;c.setCenter(a,d);for(d=0;d<c.popups.length;d++)c.removePopup(c.popups[d])};
var W=function(c){var a=c.map,b=a.s3.draftLayer,d={fillColor:"#000",fillOpacity:0.1,strokeWidth:0},e=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:7E3}});a.addControl(e);e.events.register("locationupdated",this,function(c){b.removeAllFeatures();var e=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(c.point.x,c.point.y),c.position.coords.accuracy/2,40,0),{},d);b.addFeatures([new OpenLayers.Feature.Vector(c.point,
{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),e]);a.zoomToExtent(b.getDataExtent());N(a,e)});e.events.register("locationfailed",this,function(){OpenLayers.Console.log("Location detection failed")});var f=new Ext.Toolbar.Button({iconCls:"geolocation",tooltip:i18n.gis_geoLocate,handler:function(){b.removeAllFeatures();e.activate()}});c.addButton(f)},da=function(c){var a=c.map,b=a.s3,d=new Ext.Toolbar.Button({iconCls:"googleearth",tooltip:b.options.Google.Earth,
enableToggle:!0,toggleHandler:function(c,d){!0===d?(b.mapPanelContainer.getLayout().setActiveItem(1),b.mapWin.items.items[0].collapse(),b.googleEarthPanel.on("pluginready",function(){var b=a.s3.options.layers_feature;if(b)for(var c=0;c<b.length;c++){var d=b[c];if(void 0!=d.visibility?d.visibility:1)d=S3.public_url+d.url.replace("geojson","kml"),google.earth.fetchKml(a.s3.googleEarthPanel.earth,d,O)}})):(b.mapPanelContainer.getLayout().setActiveItem(0),b.mapWin.items.items[0].expand())}});c.addSeparator();
c.addButton(d)},ca=function(c){var a=c.map;StreetviewClicker=new (OpenLayers.Class(OpenLayers.Control,{defaults:{pixelTolerance:1,stopSingle:!0},initialize:function(a){this.handlerOptions=OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(b){(b=a.getLonLatFromViewPortPx(b.xy))||(b=a.getCenter());a.s3.sv_popup&&a.s3.sv_popup.anc&&a.s3.sv_popup.close();
a.s3.sv_popup=new GeoExt.Popup({title:a.s3.options.Google.StreetviewTitle,location:b,width:300,height:300,collapsible:!0,map:a.s3.mapPanel,items:[new gxp.GoogleStreetViewPanel]});a.s3.sv_popup.show()}}))({autoactivate:!1});a.addControl(StreetviewClicker);var b=new Ext.Toolbar.Button({iconCls:"streetview",tooltip:a.s3.options.Google.StreetviewButton,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",toggleHandler:function(a,b){!0===b?StreetviewClicker.activate():StreetviewClicker.deactivate()}});
c.addSeparator();c.addButton(b)},Y=function(c){var a=c.map,b=new OpenLayers.Style;b.addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:5,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#f5902e"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#f5902e",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#f5902e",fillColor:"white",fillOpacity:0.5}}})]);var b=new OpenLayers.StyleMap({"default":b}),d=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,
{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}});d.events.on({measure:function(a){alert(i18n.gis_length_message+" "+a.measure.toFixed(2)+" "+a.units)}});d=new GeoExt.Action({control:d,map:a,iconCls:"measure-off",tooltip:i18n.gis_length_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"});c.add(d);!1===a.s3.options.area&&(b=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:b}}}),b.events.on({measure:function(a){alert(i18n.gis_area_message+
" "+a.measure.toFixed(2)+" "+a.units+"2")}}),a=new GeoExt.Action({control:b,map:a,iconCls:"measure-area",tooltip:i18n.gis_area_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"}),c.add(a))},J=function(c,a,b){OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(a){return!0},CLASS_NAME:"OpenLayers.Handler.PointS3"});var d=c.s3.draftLayer,e=new OpenLayers.Control.DrawFeature(d,OpenLayers.Handler.PointS3,{featureAdded:function(a){c.s3.lastDraftFeature?c.s3.lastDraftFeature.destroy():
1<d.features.length&&d.features[0].destroy();var b=$("#gis_location_lon");if(b.length){var e=a.geometry.getBounds().getCenterLonLat();e.transform(c.getProjectionObject(),u);b.val(e.lon);$("#gis_location_lat").val(e.lat);$("#gis_location_wkt").val("")}c.s3.lastDraftFeature=a}});if(a){var f=new GeoExt.Action({control:e,handler:function(){f.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:c,iconCls:"drawpoint-off",tooltip:i18n.gis_draw_feature,
allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:b});a.add(f);c.s3.pointButton=f}else c.addControl(e),b&&(e.activate(),$(".olMapViewport").addClass("crosshair"))},aa=function(c,a,b){var d=c.map,e=new GeoExt.Action({control:new OpenLayers.Control.DrawFeature(d.s3.draftLayer,b?OpenLayers.Handler.Polygon:OpenLayers.Handler.RegularPolygon,{handlerOptions:b?{sides:4,snapAngle:90}:{},featureAdded:function(a){d.s3.lastDraftFeature&&d.s3.lastDraftFeature.destroy();var b=a.geometry.transform(d.getProjectionObject(),
u).toString();$("#gis_search_polygon_input").val(b).trigger("change");$("#gis_location_wkt").val(b);$("#gis_location_lat").val("");$("#gis_location_lon").val("");d.s3.lastDraftFeature=a}}),handler:function(){e.items[0].pressed?$(".olMapViewport").addClass("crosshair"):$(".olMapViewport").removeClass("crosshair")},map:d,iconCls:"drawpolygon-off",tooltip:i18n.gis_draw_polygon,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:a,activateOnEnable:!0,deactivateOnDisable:!0});c.add(e);d.s3.polygonButton=
e},ba=function(c){var a=c.map,b=new Ext.Toolbar.Button({iconCls:"potlatch",tooltip:i18n.gis_potlatch,handler:function(){var b=a.getZoom();if(14>b)alert(i18n.gis_osm_zoom_closer);else{var c=a.getCenter();c.transform(a.getProjectionObject(),u);b=S3.Ap.concat("/gis/potlatch2/potlatch2.html")+"?lat="+c.lat+"&lon="+c.lon+"&zoom="+b;window.open(b)}}});c.addSeparator();c.addButton(b)},X=function(c){var a=c.map,b=a.s3.options.config_id,d=new Ext.Toolbar.Button({iconCls:"save",tooltip:i18n.gis_save,handler:function(){var c=
P(a),d=Ext.util.JSON.encode,g=d(c.layers),d=d(c.plugins),k;k=b?S3.Ap.concat("/gis/config/"+b+".url/update"):S3.Ap.concat("/gis/config.url/create");Ext.Ajax.request({url:k,method:"POST",success:function(a,c){var d=Ext.decode(a.responseText).message.split("=",2)[1];d&&(b=d,d=S3.Ap.concat("/gis/config/",d,"/layer_entity"),$("#gis_menu_config").attr("href",d))},params:{lat:c.lat,lon:c.lon,zoom:c.zoom,layers:g,plugins:d}})}});c.addSeparator();c.addButton(d)},Z=function(c){var a=c.map,b=a.s3.options;selectPdfControl=
new OpenLayers.Control;OpenLayers.Util.extend(selectPdfControl,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{done:this.getPdf});this.box.activate()},response:function(a){this.w.destroy();a=(new OpenLayers.Format.GML).read(a.responseText);var b=a.length+" pdfs. <br /><ul>";if(a.length)for(var c=0;c<a.length;c++)var d=a[c],b=b+("<li><a href='"+a[c].attributes.url+"'>"+(d.attributes.utm_zone+d.attributes.grid_zone+d.attributes.grid_square+d.attributes.easting+d.attributes.northing)+"</a></li>");
this.w=new Ext.Window({html:b+"</ul>",width:300,title:"Results",height:200});this.w.show()},getPdf:function(c){var d=a.getProjectionObject(),g=a.getLonLatFromPixel(new OpenLayers.Pixel(c.left,c.bottom)).transform(d,u);c=a.getLonLatFromPixel(new OpenLayers.Pixel(c.right,c.top)).transform(d,u);bbox=(new OpenLayers.Bounds(g.lon,g.lat,c.lon,c.lat)).toBBOX();OpenLayers.Request.GET({url:b.mgrs_url+"&bbox="+bbox,callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({html:"Searching "+
b.mgrs_name+", please wait.",width:200,title:"Please Wait."});this.w.show()}});var d="Select "+b.mgrs_name,d=new GeoExt.Action({text:d,control:selectPdfControl,map:a,allowDepress:!1,toggleGroup:"controls",tooltip:d});c.addSeparator();c.add(d)},ea=function(c,a){var b=new gxp.plugins.AddLayers({actionTarget:"treepanel.tbar",addActionTip:"Add layers",addActionMenuText:"Add layers",addServerText:"Add a New Server",doneText:"Done",upload:{url:null},uploadText:i18n.gis_uploadlayer,relativeUploadOnly:!1}),
d=new GeoExt.data.LayerStore;b.target=a;a.proxy=OpenLayers.ProxyHost;a.layerSources={};a.layerSources.local=new gxp.plugins.LayerSource({title:"local",store:d});b.addActions()[0].enable();b=new gxp.plugins.RemoveLayer({actionTarget:"treepanel.tbar",removeActionTip:"Remove layer"});b.target=a;a.mapPanel=c.s3.mapPanel;b.addActions()},fa=function(c,a){var b=c.s3.propertiesWindow,d=new Ext.Toolbar.Button({iconCls:"gxp-icon-layerproperties",tooltip:i18n.gis_properties,handler:function(){var d=a.root.findChildBy(function(a){return a.isSelected()?
a.leaf?!0:!1:!1},null,!0);if(d){var f=d.layer.s3_layer_type,g=S3.Ap.concat("/gis/layer_"+f+".plain?layer_"+f+".layer_id="+d.layer.s3_layer_id+"&update=1");Ext.Ajax.request({url:g,method:"GET",success:function(a,g){b&&b.close();var h;"feature"==f?(h=new Ext.TabPanel({activeTab:0,items:[{title:"Layer Properties",html:a.responseText},{title:"Filter",id:"s3_gis_layer_filter_tab",html:""}]}),h.items.items[1].on("activate",function(){var a;Ext.iterate(c.s3.layers_feature,function(b,c,f){b.id==d.layer.s3_layer_id&&
(a=b.url.replace(/.geojson.+/,"/search.plain"))});Ext.get("s3_gis_layer_filter_tab").load({url:a,discardUrl:!1,callback:function(){S3.addTooltips();S3.search.select_letter_label()},text:"Loading...",timeout:30,scripts:!1})})):h=new Ext.Panel({title:"Layer Properties",html:a.responseText});b=new Ext.Window({width:400,layout:"fit",items:[h]});b.show();$("#plain form").submit(function(){var a=$('#plain input[name="id"]').val(),a=S3.Ap.concat("/gis/layer_"+f+"/"+a+".plain/update"),b=$("#plain input"),
c=[];Ext.iterate(b,function(a,b,d){b.id&&-1!=b.id.indexOf("gis_layer_")&&c.push(b.id)});b=[];for(i=0;i<c.length;i++)(q=$("#"+c[i]).serialize())&&b.push(q);(q=$('#plain input[name="id"]').serialize())&&b.push(q);(q=$('#plain input[name="_formkey"]').serialize())&&b.push(q);(q=$('#plain input[name="_formname"]').serialize())&&b.push(q);0<b.length&&(b=b.join("&"),$.ajax({type:"POST",url:a,data:b}).done(function(a){$("#plain").html(a)}));return!1});S3.addTooltips();S3.autocomplete("role","admin","group",
"gis_layer_"+f+"_role_required")}})}}});a.getTopToolbar().add(d)},C=function(c,a){if(void 0!=a.marker)var b=a.marker,d=A+b.i,e=b.h,f=b.w;else d="";var g=a.opacity||1,k=a.style,m=c.s3.options,b=new Image;b.onload=function(){var a=m.max_h||35,b=this.height/this.width,c=Math.min(this.width,m.max_w||30),b=c*b;b>a&&(b=a,c*=c/b);this.height=b;this.width=c};b.src=d;var h="[object Array]"===Object.prototype.toString.call(k)?!0:!1;if(h){var b={label:"",labelAlign:"cm",pointRadius:10,fillColor:"#f5902e",fillOpacity:g,
strokeColor:"#f5902e",strokeWidth:2,strokeOpacity:g,graphicWidth:1,graphicHeight:1,graphicXOffset:-1,graphicYOffset:-1,graphicOpacity:g,graphicName:"square",externalGraphic:""},b=new OpenLayers.Style(b),n=[],p,r,l,t,s,u,v,y,w,x;$.each(k,function(a,b){p=void 0!=b.prop?b.prop:"value";void 0!=b.cat?(x=b.cat,w=b.label||x,s=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:p,value:x})):(w=b.label||b.low+"-"+b.high,s=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,
property:p,lowerBoundary:b.low,upperBoundary:b.high}));r=void 0!=b.externalGraphic?S3.Ap.concat("/static/"+b.externalGraphic):"";void 0!=b.fill?l="#"+b.fill:void 0!=b.stroke&&(l="#"+b.stroke);t=void 0!=b.fillOpacity?b.fillOpacity:1;graphic=void 0!=b.graphic?b.graphic:"square";v=void 0!=b.size?b.size:10;y=void 0!=b.strokeWidth?b.strokeWidth:2;u=new OpenLayers.Rule({filter:s,symbolizer:{externalGraphic:r,fillColor:l,fillOpacity:t,strokeColor:l,strokeWidth:y,graphicName:graphic,pointRadius:v},title:w});
n.push(u)});b.addRules(n)}else b={label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:"${fillOpacity}",strokeColor:"${stroke}",strokeWidth:"${strokeWidth}",strokeOpacity:g,graphicWidth:"${graphicWidth}",graphicHeight:"${graphicHeight}",graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicOpacity:g,graphicName:"${graphicName}",externalGraphic:"${externalGraphic}"},b=new OpenLayers.Style(b,{context:{graphicWidth:function(a){var b=1;a.cluster||
(a.attributes.marker_width?b=a.attributes.marker_width:void 0!=f&&(b=f));return b},graphicHeight:function(a){var b=1;a.cluster||(a.attributes.marker_height?b=a.attributes.marker_height:void 0!=e&&(b=e));return b},graphicXOffset:function(a){var b=-1;a.cluster||(a.attributes.marker_width?b=-(a.attributes.marker_width/2):void 0!=f&&(b=-(f/2)));return b},graphicYOffset:function(a){var b=-1;a.cluster||(a.attributes.marker_height?b=-a.attributes.marker_height:void 0!=e&&(b=-e));return b},graphicName:function(a){var b=
"circle";a.cluster||(a.attributes.shape?b=a.attributes.shape:k&&!h&&void 0!=k.graphic&&(b=k.graphic));return b},externalGraphic:function(a){var b="";if(!a.cluster)if(a.attributes.marker_url)b=a.attributes.marker_url;else if(k)h||void 0!=k.externalGraphic&&(b=S3.Ap.concat("/static/"+k.externalGraphic));else return d;return b},radius:function(a){var b=10;a.cluster?b=Math.min(a.attributes.count/2,8)+10:a.attributes.size?b=a.attributes.size:k&&!h&&(b=k.size);return b},fill:function(a){var b;a.cluster?
b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#8087ff":a.attributes.colour?b=a.attributes.colour:k?(h||(b=k.fill),b=void 0!=b?"#"+b:"#000000"):b="#f5902e";return b},fillOpacity:function(a){var b;a.cluster?b=a.cluster[0].attributes.opacity?a.cluster[0].attributes.opacity:g:a.attributes.opacity?b=a.attributes.opacity:k&&!h&&(b=k.fillOpacity);return b||g},stroke:function(a){var b;a.cluster?b=a.cluster[0].attributes.colour?a.cluster[0].attributes.colour:"#2b2f76":a.attributes.colour?
b=a.attributes.colour:k?(h||(b=k.stroke||k.fill),b=void 0!=b?"#"+b:"#000000"):b="#f5902e";return b},strokeWidth:function(a){var b=2;a.cluster?a.cluster[0].attributes.strokeWidth&&(b=a.cluster[0].attributes.strokeWidth):k&&!h&&(b=k.strokeWidth);return b||2},label:function(a){var b;a.cluster?1<a.attributes.count&&(b=a.attributes.count):a.layer&&void 0!=a.layer.s3_style&&(a=a.layer.s3_style,!h&&a.show_label&&(b=a.label));return b||""}}});return[new OpenLayers.StyleMap({"default":b,select:{fillColor:"#ffdc33",
strokeColor:"#ff9933"}}),d]}})();
