(function(){S3.addPersonWidget=function(b,d){var a="#"+b,e=$(a),c=$(a+"__row"),f=e.next(".error_wrapper"),h=c.hasClass("control-group")||c.hasClass("form-row");if(h){var l=$(a+"_title__row"),k=$(a+"_organisation_id__row"),g=$(a+"_full_name__row"),r=$(a+"_date_of_birth__row"),s=$(a+"_gender__row"),n=$(a+"_occupation__row"),p=$(a+"_mobile_phone__row"),t=$(a+"_home_phone__row"),u=$(a+"_email__row"),v=$(a+"_box_bottom");c.hide().after(v).after(u).after(t).after(p).after(n).after(s).after(r).after(g).after(k).after(l).after(f);
l.removeClass("hide").show();k.removeClass("hide").show();g.removeClass("hide").show();r.removeClass("hide").show();s.removeClass("hide").show();n.removeClass("hide").show();p.removeClass("hide").show();t.removeClass("hide").show();u.removeClass("hide").show();v.removeClass("hide").show()}else $(a+"__row1").hide(),c.hide().after(f);e.val()?(w(b),$(a+"_edit_bar .icon-remove").hide()):(x(b),$(a+"_edit_bar .icon-edit").hide());e.data("lookup_contact",z);$(a+"_edit_bar").removeClass("hide").show();$(a+
"_edit_bar .icon-edit").click(function(){var a="#"+b;x(b);$(a+"_full_name").prop("disabled",!1).val("");m(b);$(a+"_edit_bar .icon-edit").hide();$(a+"_edit_bar .icon-remove").removeClass("hide").show()});$(a+"_edit_bar .icon-remove").click(function(){var a="#"+b,c=$(a).data("existing");c?($(a).val(c.value),$(a+"_organisation_id").prop("disabled",!0).val(c.organisation_id),$(a+"_full_name").prop("disabled",!0).val(c.full_name),$(a+"_gender").prop("disabled",!0).val(c.gender),$(a+"_date_of_birth").prop("disabled",
!0).val(c.date_of_birth),$(a+"_date_of_birth__row .ui-datepicker-trigger").show(),$(a+"_occupation").prop("disabled",!0).val(c.occupation),$(a+"_mobile_phone").prop("disabled",!0).val(c.mobile_phone),$(a+"_home_phone").prop("disabled",!0).val(c.home_phone),$(a+"_email").prop("disabled",!0).val(c.email),$(a+"_edit_bar .icon-edit").removeClass("hide").show(),$(a+"_edit_bar .icon-remove").hide()):($(a+"_full_name").prop("disabled",!1).val(""),m(b))});d&&(c='<div id="'+b+'_duplicates"></div>',h?$(a+"_box_bottom").before(c):
$(a+"_box_bottom1").before(c),$(a+"_duplicates").data("results",[]).click(function(){y(b)}),$(a+"_full_name,"+a+"_date_of_birth,"+a+"_gender,"+a+"_occupation,"+a+"_mobile_phone,"+a+"_home_phone,"+a+"_email").change(function(){A(b)}),e.change(function(){e.val()&&q(b)}));$(a+"_organisation_id").change(function(){var a=$(this).val(),b=e.data("url");a?(b=b.split("?")[0],b+="?~.organisation_id="+a):b=b.split("?")[0];e.data("url",b)});e.closest("form").submit(function(){if(d&&$(a+"_duplicates").data("results").length)return $(a+
"_duplicates").data("submit",!0),y(b),!1;S3ClearNavigateAwayConfirm();if(!e.val()){var c="#"+b;$(c+"_organisation_id").prop("disabled",!1);$(c+"_full_name").prop("disabled",!1);$(c+"_gender").prop("disabled",!1);$(c+"_date_of_birth").prop("disabled",!1);$(c+"_occupation").prop("disabled",!1);$(c+"_mobile_phone").prop("disabled",!1);$(c+"_home_phone").prop("disabled",!1);$(c+"_email").prop("disabled",!1)}return!0})};S3.addPersonWidgetReady=function(b){var d=new jQuery.Deferred,a=$("#"+b);setTimeout(function c(){void 0!=
a.data("lookup_contact")?d.resolve("loaded"):"pending"===d.state()&&(d.notify("waiting for Widget to setup..."),setTimeout(c,500))},1);return d.promise()};var w=function(b){b="#"+b;$(b+"_organisation_id").prop("disabled",!0);$(b+"_full_name").prop("disabled",!0);$(b+"_gender").prop("disabled",!0);$(b+"_date_of_birth").prop("disabled",!0);$(b+"_date_of_birth__row .ui-datepicker-trigger").hide();$(b+"_occupation").prop("disabled",!0);$(b+"_mobile_phone").prop("disabled",!0);$(b+"_home_phone").prop("disabled",
!0);$(b+"_email").prop("disabled",!0);$(b+"_edit_bar .icon-edit").removeClass("hide").show();$(b+"_edit_bar .icon-remove").hide()},m=function(b){b="#"+b;$(b).val("");$(b+"_organisation_id").prop("disabled",!1).val("");$(b+"_gender").prop("disabled",!1).val("");$(b+"_date_of_birth").prop("disabled",!1).val("");$(b+"_date_of_birth__row .ui-datepicker-trigger").show();$(b+"_occupation").prop("disabled",!1).val("");$(b+"_mobile_phone").prop("disabled",!1).val("");$(b+"_home_phone").prop("disabled",!1).val("");
$(b+"_email").prop("disabled",!1).val("")},x=function(b){var d="#"+b,a=$(d+"_full_name");if(!a.attr("autocomplete")){var e=$(d),c=e.val(),f=c?{value:c,full_name:a.val(),organisation_id:$(d+"_organisation_id").val(),gender:$(d+"_gender").val(),date_of_birth:$(d+"_date_of_birth").val(),occupation:$(d+"_occupation").val(),mobile_phone:$(d+"_mobile_phone").val(),home_phone:$(d+"_home_phone").val(),email:$(d+"_email").val()}:{};e.data("existing",f);$(d+"_full_name").after('<div id="'+b+'_throbber" class="throbber input_throbber hide"></div>');
var h=$(d+"_throbber"),d=a.attr("data-c"),c=a.attr("data-f"),d=S3.Ap.concat("/"+d+"/"+c+"/search_ac");e.data("url",d);a.autocomplete({delay:450,minLength:2,source:function(a,b){$.ajax({url:e.data("url"),data:{term:a.term}}).done(function(a){0==a.length?e.val(""):a.push({id:0,value:"",label:i18n.none_of_the_above});b(a)})},search:function(a,b){h.removeClass("hide").show();return!0},response:function(a,b,c){h.hide();return c},focus:function(a,b){return!1},select:function(c,d){var g=d.item;if(g.id){var f;
f=void 0!=g.label?g.label:g.name;a.val(f);e.val(g.id).change();n(b,g.id)}else e.val("").change();return!1}}).data("ui-autocomplete")._renderItem=function(a,b){var c;if(void 0!=b.label)c=b.label;else{c=b.name;var d=b.org,e=b.job;if(d||e)e?(c+=" ("+e,d&&(c+=", "+d),c+=")"):c+=" ("+d+")"}return $("<li>").data("item.autocomplete",b).append("<a>"+c+"</a>").appendTo(a)};a.blur(function(){f&&f.full_name!=a.val()&&e.val("").change()})}},n=function(b,d){var a="#"+b,e=$(a+"_full_name");e.prop("disabled",!1);
m(b);var c=$(a),a=e.attr("data-c"),f=e.attr("data-f"),a=S3.Ap.concat("/"+a+"/"+f+"/"+d+"/lookup");$.getJSONS3(a,function(a){try{c.val(d);var f=e.val();c.data("existing",{value:d,full_name:f});p(a,b)}catch(k){c.val(""),m(b)}})},z=function(b,d){var a="#"+b,e=$(a+"_full_name");e.prop("disabled",!1).val("");m(b);var c=$(a),f=S3.Ap.concat("/org/site/"+d+"/site_contact_person");$.getJSONS3(f,function(d){try{var f=d.name;e.val(f);var k=d.id;c.val(k);c.data("existing",{value:k,full_name:f});p(d,b,k)}catch(g){c.val(""),
$(a+"_full_name").prop("disabled",!1).val(""),m(b)}})},p=function(b,d){var a="#"+d,e=$(a).data("existing");if(b.hasOwnProperty("email")){var c=b.email;$(a+"_email").val(c);e.email=c}b.hasOwnProperty("mphone")&&(c=b.mphone,$(a+"_mobile_phone").val(c),e.mobile_phone=c);b.hasOwnProperty("hphone")&&(c=b.hphone,$(a+"_home_phone").val(c),e.home_phone=c);b.hasOwnProperty("sex")&&(c=b.sex,$(a+"_gender").val(c),e.gender=c);b.hasOwnProperty("dob")&&(c=b.dob,$(a+"_date_of_birth").val(c),e.date_of_birth=c);b.hasOwnProperty("occupation")&&
(c=b.occupation,$(a+"_occupation").val(c),e.occupation=c);b.hasOwnProperty("org_id")&&(c=b.org_id,$(a+"_organisation_id").val(c),e.organisation_id=c);w(d)},A=function(b){var d="#"+b;if(!$(d).val()&&(b=$(d+"_full_name").val())){b={name:b};var a=$(d+"_date_of_birth").val();a&&(b.dob=a);(a=$(d+"_gender").val())&&(b.sex=a);(a=$(d+"_occupation").val())&&(b.occupation=a);(a=$(d+"_mobile_phone").val())&&(b.mphone=a);(a=$(d+"_home_phone").val())&&(b.hphone=a);(a=$(d+"_email").val())&&(b.email=a);a=S3.Ap.concat("/pr/person/check_duplicates");
$.ajaxS3({url:a,data:b,type:"POST",dataType:"json",success:function(a){$(d+"_results").remove();if(a.length){var b=i18n.dupes_found.replace("_NUM_",a.length);$(d+"_duplicates").html(b).show().data("results",a)}else $(d+"_duplicates").data("results",[]).hide()}})}},y=function(b){for(var d="#"+b,a=$(d+"_duplicates"),e=a.data("results"),c,f,h,l='<div id="'+b+'_results">',k=e.length,g=0;g<k;g++)f=e[g],h=f.name,c='<div class="card" data-id='+f.id+' data-name="'+h+'">',c+='<a class="fleft"><img width=50 height=50 src="',
f.image?S3.Ap.concat("/default/download/"+f.image):c+=S3.Ap.concat("/static/img/blank-user.gif"),c+='" class="media-object"></a><div>',f.org&&(c+=f.org),c+=h,f.dob&&(c+=f.dob),f.email&&(c+=f.email),f.phone&&(c+=f.phone),c+='<div class="fright"><i class="icon icon-ok"> </i>'+i18n.Yes+"</div></div></div>",l+=c;l+='<div class="fright"><i class="icon icon-remove"> </i>'+i18n.No+"</div></div>";a.after(l);$(d+"_results .card").click(function(){$this=$(this);h=$this.attr("data-name");$(d+"_full_name").val(h);
var c=$this.attr("data-id");q(b);a.data("submit")?($(d).val(c),a.closest("form").submit()):n(b,c)});$(d+"_results .icon-remove").click(function(){q(b);a.data("submit")&&a.closest("form").submit()})},q=function(b){b="#"+b;$(b+"_duplicates").data("results",[]).empty();$(b+"_results").remove()}})();
