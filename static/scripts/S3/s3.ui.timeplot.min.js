/*
 2013-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,k,g){b instanceof String&&(b=String(b));for(var a=b.length,c=0;c<a;c++){var d=b[c];if(k.call(g,d,c,b))return{i:c,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,k,g){b!=Array.prototype&&b!=Object.prototype&&(b[k]=g.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,k,g,a){if(k){g=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var c=b[a];c in g||(g[c]={});g=g[c]}b=b[b.length-1];a=g[b];k=k(a);k!=a&&null!=k&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:k})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,g){return $jscomp.findInternal(this,b,g).v}},"es6","es3");
(function(b,k){var g=0;b.widget("s3.timeplot",{options:{ajaxURL:null,autoSubmit:1E3,burnDown:!1,emptyMessage:"No data available",thousandSeparator:" ",thousandGrouping:"3",precision:null,defaultChartType:"linechart",defaultChartAxis:"totals"},_create:function(){this.id=g;g+=1},_init:function(){var a=b(this.element),c=this.options;this.widget_id=a.attr("id");this.input=a.find('input[type="hidden"][name="tp-data"]').first();this.svg=this.data=null;a=a.find(".tp-chart");this.chart=a.length?a.first():
null;this.currentChart={type:null,chart:null,container:null};c.numberFormatter=function(a){var b=c.precision;if(null===a||"undefined"==typeof a)return"-";b=b||0==b?a.toFixed(b):a.toString();b=b.split(".");a=b[0];b=1<b.length?"."+b[1]:"";a=a.replace(new RegExp("\\B(?=(\\d{"+c.thousandGrouping+"})+(?!\\d))","g"),c.thousandSeparator);return a+b};this.refresh()},_destroy:function(){var a=this.element;this._unbindEvents();this.svg&&(this.svg.remove(),this.svg=null,a.find(".tp-chart").empty());this.data=
null;b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.element;this._unbindEvents();this._renderChart();this._renderChartOptions();this.options.autoSubmit?a.find(".tp-submit").hide():a.find(".tp-submit").show();this._bindEvents();a.find(".tp-throbber").hide()},_renderChartOptions:function(){var a=b(this.element),c=a.find(".tp-chart-controls").first().empty();if(!this.data.e){var d=a.attr("id");a=b('<div class="pt-chart-opts">');var f=d+"-bchart-totals";d+="-lchart-totals";b(a).append(b('<span id="'+
d+'" class="tp-chart-icon tp-lchart"/><span class="tp-chart-label">Line Chart</span>'));b(a).append(b('<span id="'+f+'" class="tp-chart-icon tp-bchart"/><span class="tp-chart-label">Bar Chart</span>'));b(c).append(a)}},_renderChart:function(a){var b=this.chart;if(b){var d=this.options,f=this.currentChart,e=null,p=null;a?(e=a.type,p=a.axis):(f&&(e=f.type,p=f.axis),e&&p||(e=d.defaultChartType,p=d.defaultChartAxis));f.type==e&&f.axis==p||this._removeChart();a=this.element;d=a.find(".tp-empty");f=this.data;
null===f&&(f=JSON.parse(this.input.val()));f||(f={e:!0});this.data=f;if(f.e)this._removeChart(),a.find(".tp-empty").show();else switch(d.hide(),b.show(),p){case "totals":switch(e){case "barchart":this._renderBarChart(b,f.f,f.p);break;default:this._renderLineChart(b,f.f,f.p)}}}},_removeChart:function(){var a=this.chart;a&&(a.empty().hide(),a=this.currentChart,a.container=null,a.chart=null,a.type=null,a.axis=null,b(window).off("resize.tp"))},_renderBarChart:function(a,c,d){var f=[];for(c=0;c<d.length;c++){var e=
d[c];f.push({start:(new Date(e.t[0])).getTime(),value:e.v[0]})}d=this.currentChart;if(d.chart){var p=d.container;var m=d.chart;p.datum([{key:"reportChart",values:f}]).transition().duration(500).call(m)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),p=d3.select(b(a).get(0)).append("svg").attr("class","nv"),m=nv.models.discreteBarChart().x(function(a){return a.start}).y(function(a){return a.value}).color(["silver"]).staggerLabels(!0).showValues(!0).forceY([0,
1]),m.tooltip.enabled(!1),a=this.options.numberFormatter,m.valueFormat(a),m.yAxis.tickFormat(a),m.xAxis.tickFormat(function(a){return(new Date(a)).toLocaleDateString()}),nv.addGraph(function(){p.datum([{key:"reportChart",values:f}]).transition().duration(500).call(m);b(window).off("resize.tp").on("resize.tp",function(a){m.update(a)});return m}),d.container=p,d.chart=m,d.type="barchart",d.axis="totals"},_renderLineChart:function(a,c,d){var f=[],e={},p=0,m=1==c.length,l;for(l=0;l<c.length;l++){var g=
c[l][0];e.hasOwnProperty(g)&&(p=e[g]+1);(e[g]=p)&&(g+=" ["+(p+1)+"]");var k={key:g,label:c[l][0],area:m},t=[];for(g=0;g<d.length;g++){var n=d[g];t.push({start:(new Date(n.t[0])).getTime(),value:n.v[l]})}k.values=t;f.push(k)}c=this.currentChart;if(c.chart){var h=c.container;var q=c.chart;h.datum(f).transition().duration(250).call(q)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),h=d3.select(b(a).get(0)).append("svg").attr("class","nv"),q=nv.models.lineChart().x(function(a){return a.start}).y(function(a){return a.value}).margin({right:50}).duration(250).showLegend(!0).useInteractiveGuideline(!0).forceY([0,
1]),q.yAxis.tickFormat(this.options.numberFormatter),q.xAxis.tickFormat(function(a){return(new Date(a)).toLocaleDateString()}),nv.addGraph(function(){h.datum(f).transition().duration(500).call(q);b(window).off("resize.tp").on("resize.tp",function(a){q.update(a)});return q}),c.container=h,c.chart=q,c.type="linechart",c.axis="totals"},reload:function(a,c,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof c&&(c=this._getFilters());var f=this,e=!1;b(this.element).find(".tp-throbber").show();if(a||c)e=
this._updateAjaxURL(a,c);e||d?(a=this.options.ajaxURL,c=b.ajaxS3,b.searchS3!==k&&(c=b.searchS3),c({url:a,type:"GET",dataType:"json",success:function(a){f.input.val(JSON.stringify(a));f.data=a;f.refresh()},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})):f.refresh()},_getOptions:function(){var a="#"+b(this.element).attr("id"),c=b(a+"-time").val(),d=a=null,f=null;"custom"!=c&&(c=c.split("|"),3==c.length&&(a=c[0],d=c[1],f=c[2]));return{start:a,end:d,slots:f}},
_getFilters:function(){var a=b("#"+this.widget_id+"-filters");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(c){return null}},_updateAjaxURL:function(a,c){var d=this.options.ajaxURL;if(!d)return!1;var f=d.split("?");if(1<f.length){var e=f[1];var g=e.split("&")}else e="",g=[];var m=[];d=!1;if(a)for(var l in a)e=a[l],e=l+"="+e,d||-1!=b.inArray(e,g)||(d=!0),m.push(e);l={};var k={},r;if(c){var t=function(a){var b,c,d=[];["contains","anyof","belongs","eq"].forEach(function(e){b=
new RegExp("__"+e+"$","g");a.match(b)?c=b:d.push(e)});c&&d.forEach(function(b){k[a.replace(c,"__"+b)]=!0})};e=0;for(r=c.length;e<r;e++){var n=c[e];var h=n[0];n=n[1];t(h);null===n?l[h]||(k[h]=!0):(k[h]&&(k[h]=!1),n=h+"="+encodeURIComponent(n),l[h]?l[h].push(n):l[h]=[n])}}e=0;for(r=g.length;e<r;e++)n=g[e].split("="),1<n.length&&(h=decodeURIComponent(n[0]),n=decodeURIComponent(n[1]),k[h]?d=!0:l[h]?d||-1!=b.inArray(h+"="+n,l[h])||(d=!0):a&&a.hasOwnProperty(h)||m.push(g[e]));for(h in l)for(e=0,r=l[h].length;e<
r;e++)d||-1!=b.inArray(l[h][e],g)||(d=!0),m.push(l[h][e]);a=m.join("&");c=f[0];a&&(c=c+"?"+a);this.options.ajaxURL=c;return d},_parseDate:function(a){return d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse(a)},_bindEvents:function(){var a=this,c="#"+this.widget_id;b(c+"-options legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-filters legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-time").on("change.autosubmit",function(){b(c+
"-tp-form").trigger("optionChanged")});if(this.options.autoSubmit){var d=this.options.autoSubmit;b(c+"-tp-form").on("optionChanged",function(){var c=b(this);if(!c.data("noAutoSubmit")){var e=c.data("autoSubmitTimeout");e&&clearTimeout(e);e=setTimeout(function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)},d);c.data("autoSubmitTimeout",e)}})}else b(c+"-tp-form input.tp-submit").on("click.timeplot",function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)});b(c+"-lchart-totals").click(function(){a._renderChart({type:"linechart",
axis:"totals"})});b(c+"-bchart-totals").click(function(){a._renderChart({type:"barchart",axis:"totals"})})},_unbindEvents:function(){var a="#"+this.widget_id;b(window).off("resize.timeplot");b(a+"-tp-form").off("optionChanged");b(a+"-tp-form input.tp-submit").off("click.timeplot");b(a+"-time").unbind("change.autosubmit");b(a+"-options legend").unbind("click");b(a+"-filters legend").unbind("click");b(a+"-lchart-totals,"+a+"-bchart-totals").unbind("click")}})})(jQuery);
