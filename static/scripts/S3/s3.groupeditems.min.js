/*
 2015-2016 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(e,r){var q=0;e.widget("s3.groupedItems",{options:{ajaxURL:null,renderGroupHeaders:!1,totalsLabel:"TOTAL"},_create:function(){e(this.element);this.id=q;q+=1;this.eventNamespace=".groupeditems"},_init:function(){var a=e(this.element);this.widget_id=a.attr("id");this.items=a.find(".gi-data").first();this.refresh()},_destroy:function(){e.Widget.prototype.destroy.call(this)},refresh:function(){var a=e(this.element);a.find(".gi-throbber").show();this._unbindEvents();this.data||this._deserialize();
var b=this.data,d=a.find(".gi-table");b.e?(d.hide(),d.empty(),a.find(".gi-empty").show()):(a.find(".gi-empty").hide(),d.empty(),b=this._renderTable(b),d.append(b).show());this._bindEvents();a.find(".gi-throbber").css("visibility","hidden")},_renderTable:function(a){var b=e('<table class="groupeditems">');this._renderTableHeader(a).appendTo(b);this._renderGroup(b,a);this._renderTableFooter(a).appendTo(b);return b},_renderTableHeader:function(a){var b=e("<thead>"),d=e('<tr class="gi-column-headers">').appendTo(b),
c=a.c;a=a.l;for(var k,h=0,g=c.length;h<g;h++)k=a[c[h]],e("<th>").html(k).appendTo(d);return b},_renderTableFooter:function(a){var b=this.options,d=e("<tfoot>"),c=e('<tr class="gi-column-totals">'),k=a.t,h=!1,g;for(g in k){h=!0;break}if(h){a=a.c;for(var f=null,m=0,n=0,p=a.length;n<p;n++){if(!f){if(!k.hasOwnProperty(a[n])){m++;continue}1<m&&(f=e('<td class="gi-column-totals-label" colspan="'+m+'">'),e("<span> "+b.totalsLabel+"</span>").appendTo(f),f.appendTo(c))}g=e("<td>").appendTo(c);(h=k[a[n]])&&
g.html(h)}c.appendTo(d)}return d},_renderGroup:function(a,b,d,c){"undefined"==typeof d&&(d=b);"undefined"==typeof c&&(c=0);this.options.renderGroupHeaders&&0<c&&this._renderGroupHeader(a,b,d,c);var e=d.d,h=d.i,g,f;if(e)for(g=0,f=e.length;g<f;g++)this._renderGroup(a,b,e[g],c+1);else if(h)for(g=0,f=h.length;g<f;g++)this._renderItem(a,b,h[g],c);0<c&&this._renderGroupFooter(a,b,d,c)},_renderGroupHeader:function(a,b,d,c){b=b.c;d=d.v;c=e('<tr class="gi-group-header gi-level-'+c+'">');e('<td colspan="'+
b.length+'">').html(d).appendTo(c);c.appendTo(a)},_renderGroupFooter:function(a,b,d,c){var k=this.options,h=d.t,g=!1,f;for(f in h){g=!0;break}b=b.c;d=d.v;c=e('<tr class="gi-group-footer gi-level-'+c+'">');if(!g&&!k.renderGroupHeaders)e('<td colspan="'+b.length+'">').html(d).appendTo(c),c.appendTo(a);else if(g){g=0;f=null;for(var m,n,p=0,l=b.length;p<l;p++){if(!f){if(!h.hasOwnProperty(b[p])){g++;continue}1<g&&(f=e('<td class="gi-group-footer-label" colspan="'+g+'">'),k.renderGroupHeaders||f.html(d),
e('<span class="gi-group-footer-inline-label"> '+k.totalsLabel+"</span>").appendTo(f),f.appendTo(c))}n=e("<td>").appendTo(c);(m=h[b[p]])&&n.html(m)}c.appendTo(a)}},_renderItem:function(a,b,d,c){c=e('<tr class="gi-item gi-level-'+c+'">');b=b.c;for(var k,h,g=0,f=b.length;g<f;g++)h=e("<td>"),(k=d[b[g]])&&h.html(k),h.appendTo(c);c.appendTo(a)},reload:function(a,b,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof b&&(b=this._getFilters());var c=this,k=!1;e(this.element).find(".gi-throbber").css("visibility",
"visible");if(a||b)k=this._updateAjaxURL(a,b);k||d?e.ajax({url:this.options.ajaxURL,dataType:"json"}).done(function(a){c.items.val(JSON.stringify(a));c.data=null;c.refresh()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)}):c.refresh()},_getFilters:function(){var a=e("#"+this.widget_id+"-filter-form");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(b){return null}},_updateAjaxURL:function(a,b){var d=this.options.ajaxURL;if(!d)return!1;
var c,k=d.split("?"),h;1<k.length?(c=k[1],h=c.split("&")):h=[];var g=[],d=!1;if(a)for(var f in a)c=a[f],c=f+"="+c,d||-1!=e.inArray(c,h)||(d=!0),g.push(c);f={};c={};var m,n,p,l;if(b)for(n=0,p=b.length;n<p;n++)m=b[n],l=m[0],m=m[1],null===m?f[l]||(c[l]=!0):(c[l]&&(c[l]=!1),m=l+"="+encodeURIComponent(m),f[l]?f[l].push(m):f[l]=[m]);n=0;for(p=h.length;n<p;n++)m=h[n].split("="),1<m.length&&(l=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),c[l]?d=!0:f[l]?d||-1!=e.inArray(l+"="+m,f[l])||(d=!0):a&&a.hasOwnProperty(l)||
g.push(h[n]));for(l in f)for(n=0,p=f[l].length;n<p;n++)d||-1!=e.inArray(f[l][n],h)||(d=!0),g.push(f[l][n]);l=g.join("&");k=k[0];l&&(k=k+"?"+l);this.options.ajaxURL=k;return d},_serialize:function(){var a=this.items;if(a){var b="";this.data&&(b=JSON.stringify(this.data));a.val(b)}return b},_deserialize:function(){this.data={};var a=this.items;a&&(a=a.val())&&(this.data=JSON.parse(a));return this.data},_bindEvents:function(){var a=this;e(this.element).delegate(".gi-export","click"+this.eventNamespace,
function(){var b=e(this).data("url"),d=a._getFilters();d&&(b=S3.search.filterURL(b,d));window.open(b)})},_unbindEvents:function(){e(this.element).undelegate(this.eventNamespace)}})})(jQuery);
