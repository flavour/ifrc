/*
 2015-2016 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
(function(d,x){var v=0,h={},l={};d.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){d(this.element);this.id=v;v+=1;this.namespace=".locationselector"},_init:function(){var a=d(this.element),b=this.options,c=a.attr("id");if(!c)throw"Location selector widget: real input field without id";this.fieldname=c;this.input=a;this.data=null;this._storeHierarchyData(b.labels,
b.locations);this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var a=this._deserialize();this._renderWidget();var b="#"+this.fieldname,c=this.options;d(b+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var e=d(b+"_L0__row");if(e.length){var f=[],g,m;for(m in h)g=h[m],0===g.l&&(g.i=m,f.push(g));f.sort(function(a,b){return a.n.localeCompare(b.n)});for(var r=d(b+"_L0"),q=0,k=f.length;q<k;q++)g=f[q],m=g.i,g='<option value="'+
m+'">'+g.n+"</option>",r.append(g);e.removeClass("hide").show();e=d(b+"_L0__row1");e.length&&e.removeClass("hide").show()}e=a.L0;f=a.L1;r=a.L2;q=a.L3;k=a.L4;g=a.L5;e&&this._lxSelect(0,e,!0);(f||r)&&this._lxSelect(1,f||r,!0);(r||q)&&this._lxSelect(2,r||q,!0);(q||k)&&this._lxSelect(3,q||k,!0);(k||g)&&this._lxSelect(4,k||g,!0);g&&this._lxSelect(5,g,!0);this.lx=[e,f,r,q,k,g].join("|");d(b+"_address").val(a.address);d(b+"_address__row").removeClass("hide").show();d(b+"_address__row1").removeClass("hide").show();
d(b+"_postcode").val(a.postcode);d(b+"_postcode__row").removeClass("hide").show();d(b+"_postcode__row1").removeClass("hide").show();d(b+"_lat").val(a.lat).latloninput({type:"lat",mode:c.latlonMode});d(b+"_lat__row").removeClass("hide").show();d(b+"_lat__row1").removeClass("hide").show();d(b+"_lon").val(a.lon).latloninput({type:"lon",mode:c.latlonMode});d(b+"_lon__row").removeClass("hide").show();d(b+"_lon__row1").removeClass("hide").show();e=d(b+"_map_icon__row").removeClass("hide").show();a.lat||
a.lon||a.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):c.featureRequired?this._showMap():c.openMapOnLoad&&e.is(":visible")&&"#sub_"!=b.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var a=this.fieldname,b="#"+a,c=this.options.reverseLx,e=d(b+"_map_icon__row .map_wrapper");e.attr("id",this.fieldname+"_map_wrapper");var f=d(b+"__row"),g=this.input.next(".error_wrapper"),
m=d(b+"_map_icon__row"),h=d(b+"_L0__row"),q=d(b+"_postcode__row");if(f.is(".control-group, .form-row")){var a=d(b+"_L1__row"),k=d(b+"_L2__row"),l=d(b+"_L3__row"),t=d(b+"_L4__row"),p=d(b+"_L5__row"),u=d(b+"_address__row"),y=d(b+"_lat__row"),z=d(b+"_lon__row"),b=d(b+"_latlon_toggle__row");c?f.hide().after(e).after(m).after(b).after(z).after(y).after(h).after(a).after(k).after(l).after(t).after(p).after(q).after(u).after(g):f.hide().after(e).after(m).after(b).after(z).after(y).after(q).after(u).after(p).after(t).after(l).after(k).after(a).after(h).after(g)}else f.parent().is(".inline-form")?
f.show():(d(b+"__row1").hide(),f.hide().after(g),m.detach(),f.siblings('[id^="'+a+'"][id$="__row"]').last().after(e).after(m));if(g.length)g.one("click"+this.namespace,function(){var a=d(this);a.fadeOut("slow",function(){a.remove()})})},_lxSelect:function(a,b,c){var e="#"+this.fieldname,f=this.options,g=d(e+"_L"+a);b?(g.val(b),g.hasClass("multiselect")&&g.multiselect("instance")&&g.multiselect("refresh")):b=parseInt(g.val(),10);if(0===a){var m=this._readLabels(b),r=l.d,q=["1","2","3","4","5"],k,w,
t,p;for(t=0;5>t;t++)g=q[t],k=m[g]||r[g],p=e+"_L"+g,g=d(p),w=f.showLabels?g.hasClass("required")?"<div>"+k+':<span class="req"> *</span></div>':k+":":"",d(p+"__row label").html(w),d(p+"__row1 label").html(w),d(p+' option[value=""]').html(i18n.select+" "+k),g.hasClass("multiselect")&&g.multiselect("instance")&&g.multiselect("refresh")}t=f.hideLx;for(g=a+1;6>g;g++)p=e+"_L"+g,t?(d(p+"__row").hide(),d(p+"__row1").hide()):d(p+" option").remove('[value != ""]'),d(p).val("");if(b)if(p=a+1,f=d(e+"_L"+p+"__row"),
f.length){var u;if(d(e+"_L"+a+' option[value="'+b+'"]').hasClass("missing"))k=h[b],k.i=b,r=[k];else{t=!0;for(u in h)if(h[u].f==b){t=!1;break}t&&this._readHierarchy(b,p);r=[];for(u in h)k=h[u],k.f==b&&(k.i=u,r.push(k))}if(a=r.length){r.sort(function(a,b){return a.n.localeCompare(b.n)});u=e+"_L"+p;m=d(u);q=d(u+' option[value=""]').html();d(u+" option").remove('[value != ""]');u=null;for(t=0;t<a;t++)k=r[t],u=k.i,g=b==u?' selected="selected"':"",w=k.l==p?"":' class="missing"',k='<option value="'+u+'"'+
g+w+">"+k.n+"</option>",m.append(k);f.removeClass("hide").show();d(e+"_L"+p+"__row1").removeClass("hide").show();m.hasClass("multiselect")&&(b={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:q,multiple:!1},m.hasClass("search")?(m.multiselect(b).multiselectfilter({label:"",placeholder:i18n.search}),d(".ui-multiselect-header").show()):(b.header=!1,m.multiselect(b)));1==a&&u&&this._lxSelect(p,u,c)}}else this.useGeocoder&&!c&&this._geocodeDecision();c?this._serialize():this._collectData();
this._zoomMap()},_collectData:function(){var a=this.data,b="#"+this.fieldname,c=this._lookupParent(),e=d(b+"_address").val(),f=d(b+"_postcode").val();a.address=e;a.postcode=f;if(a.specific)a.id=a.specific,a.parent=c;else{var g=a.lat,m=a.lon,h=a.wkt;e||f||g||m||h?(a.id=null,a.parent=c):(a.id=c,a.parent=null)}this._serialize();d(b+"_lat").val(a.lat).trigger("setvalue");d(b+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.change()},
_collectLx:function(){var a=this.data,b="#"+this.fieldname,c,e;for(e=0;6>e;e++)c=d(b+"_L"+e),c.length&&(c=c.val(),a["L"+e]=c?parseInt(c,10):null);this._serialize()},_hasData:function(){var a=this.data,b=!1;a.specific||a.address||a.postcode||a.lat||a.lon||a.wkt?b=!0:[a.L0,a.L1,a.L2,a.L3,a.L4,a.L5].join("|")!=this.lx&&(b=!0);return b},_lookupParent:function(){this._collectLx();for(var a=this.data,b,c=5;-1<c;c--)if(b=a["L"+c])return b;return(a=h.d)?a.i:null},_readLabels:function(a){a||(a="d");var b=
l[a];if(b==x){var c=S3.Ap.concat("/gis/hdata/"+a);d.ajaxS3({async:!1,url:c,dataType:"script",success:function(c){b={};try{for(var d in n)b[d]=n[d];l[a]=b;n=null}catch(g){}},error:function(a,b,c){s3_debug("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}return b},_readHierarchy:function(a,b){var c="#"+this.fieldname,e=d(c+"_L"+b),f=!1;e.hide();if(e.hasClass("multiselect"))var f=!0,g=d(c+"_L"+b+"__row button").hide();var m=d(c+"_L"+b+"__throbber").removeClass("hide").show(),c=S3.Ap.concat("/gis/ldata/"+
a);d.ajaxS3({async:!1,url:c,dataType:"script",success:function(a){for(var b in n)h[b]=n[b];n=null;m.hide();f?g.removeClass("hide").show():e.removeClass("hide").show()},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;s3_debug(a);S3.showAlert(a,"error");m.hide();f?g.removeClass("hide").show():e.removeClass("hide").show()}})},_geocodeDecision:function(){var a="#"+this.fieldname,b=this.data;this._collectData();if(b.address){for(var b=["1","2","3","4","5"],c=0,e;5>c;c++)if(e=
d(a+"_L"+b[c]),e.length&&!e.val()&&1<e[0].options.length)return;d(a+"_geocode .geocode_success,"+a+"_geocode .geocode_fail").hide();var f=this,b=this.namespace;this.input.data("manually_geocoded")?d(a+"_geocode button").removeClass("hide").show().unbind(b).bind("click"+b,function(){d(this).hide();f._geocode()}):this._geocode()}},_geocode:function(){for(var a=this.fieldname,b=this,c="#"+a,e=d(c+"_geocode .geocode_fail").hide(),f=d(c+"_geocode .geocode_success").hide(),g=d(c+"_geocode .throbber").removeClass("hide").show(),
m=this.data,c={address:m.address},h="postcode L0 L1 L2 L3 L4 L5".split(" "),q=0,k,l;7>q;q++)k=h[q],(l=m[k])&&(c[k]=l);h=S3.Ap.concat("/gis/geocode");d.ajaxS3({url:h,type:"POST",data:c,dataType:"json",success:function(c){var d=c.lat,h=c.lon;if(d||h){m.lat=parseFloat(d);m.lon=parseFloat(h);b._collectData();d=S3.gis;if(d.maps&&(h=d.maps["location_selector_"+a])){c=h.s3.draftLayer;c.removeAllFeatures();var k=new OpenLayers.Geometry.Point(m.lon,m.lat);k.transform(d.proj4326,h.getProjectionObject());d=
new OpenLayers.Feature.Vector(k);c.addFeatures([d]);b._zoomMap()}g.hide();f.html(i18n.address_mapped).removeClass("hide").show()}else g.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(c)},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;g.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(a)}})},_geocodeReverse:function(){var a=this,b="#"+this.fieldname,c=d(b+"_geocode .geocode_fail").hide(),e=d(b+"_geocode .geocode_success").hide(),
f=d(b+"_geocode .throbber").removeClass("hide").show(),b=this.data,b={lat:b.lat,lon:b.lon},g=S3.Ap.concat("/gis/geocode_r");d.ajaxS3({async:!1,url:g,type:"POST",data:b,dataType:"json",success:function(b){b.L0?(a.useGeocoder=!1,a._lxSelect(0,b.L0),b.L1&&a._lxSelect(1,b.L1),b.L2&&a._lxSelect(2,b.L2),b.L3&&a._lxSelect(3,b.L3),b.L4&&a._lxSelect(4,b.L4),b.L5&&a._lxSelect(5,b.L5),a.useGeocoder=!0,f.hide(),e.html(i18n.location_found).removeClass("hide").show()):(f.hide(),c.html(i18n.location_not_found).removeClass("hide").show())},
error:function(a,b,d){a="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;f.hide();c.html(i18n.location_not_found).removeClass("hide").show();s3_debug(a)}})},_latlonInput:function(){var a=this.fieldname,b=this.data,c="#"+a,e=d(c+"_lat").val(),c=d(c+"_lon").val();e||c?(e=e?parseFloat(e):0,c=c?parseFloat(c):0,b.lat=e,b.lon=c,b.wkt=null,this.input.data("manually_geocoded",!0)):(b.lat=null,b.lon=null,b.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(a=e.maps["location_selector_"+
a])&&(c=a.s3.draftLayer,c.removeAllFeatures(),null!==b.lat&&null!==b.lon&&(b=new OpenLayers.Geometry.Point(b.lon,b.lat),b.transform(e.proj4326,a.getProjectionObject()),b=new OpenLayers.Feature.Vector(b),c.addFeatures([b]),a.s3.lastDraftFeature=b),this._zoomMap())},_showMap:function(a){var b=this.fieldname,c=this.namespace,e=this,f="#"+b;d(f+"_map_icon").unbind(c).bind("click"+c,function(){e._hideMap()});d(f+"_map_icon span").html(i18n.hide_map);c=d(f+"_map_wrapper").hide().removeClass("hide").slideDown("medium");
c.length&&a&&d("html,body").animate({scrollTop:c.offset().top},250);var g=this.input;d.when(this._jsLoaded()).then(function(a){var c=S3.gis;a="location_selector_"+b;var h;h=c.maps[a]?c.maps[a]:c.show_map(a);e._zoomMap();var k=e.data;a=k.lat;var l=k.lon,t=k.wkt;if(a||l||t)h.s3.draftLayer.removeAllFeatures(),t!=x&&t?(a={internalProjection:h.getProjectionObject(),externalProjection:c.proj4326},a=(new OpenLayers.Format.WKT(a)).read(t)):(a=new OpenLayers.Geometry.Point(parseFloat(l),parseFloat(a)),a.transform(c.proj4326,
h.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),h.s3.draftLayer.addFeatures([a]),h.s3.lastDraftFeature=a;a=h.controls;for(var p,l=0,u=a.length;l<u;l++)if("OpenLayers.Control.DrawFeature"==a[l].CLASS_NAME){p=a[l];break}p&&(h.s3.pointPlaced=function(a){d(f+"_geocode .geocode_fail").hide();d(f+"_geocode .geocode_success").hide();var l=a.geometry;if("OpenLayers.Geometry.Point"==l.CLASS_NAME)a=l.getBounds().getCenterLonLat(),a.transform(h.getProjectionObject(),c.proj4326),k.wkt=null,k.lat=
a.lat,k.lon=a.lon,!k.address&&e.useGeocoder&&e._geocodeReverse();else{l={internalProjection:h.getProjectionObject(),externalProjection:c.proj4326};k.radius=null;var m=new OpenLayers.Geometry.LinearRing(a.geometry.components[0].components),m=new OpenLayers.Geometry.Polygon([m]);if(1E3==m.getVertices().length){var p=(new OpenLayers.Feature.Vector(m,null)).geometry.getBounds(),m=p.right,u=(p.bottom+p.top)/2,p=new OpenLayers.Geometry.Point((p.left+m)/2,u),m=new OpenLayers.Geometry.Point(m,u),m=new OpenLayers.Geometry.LineString([p,
m]),m=parseFloat(m.getLength());k.radius=m}t=(new OpenLayers.Format.WKT(l)).write(a);k.wkt=t;k.lat=null;k.lon=null}g.data("manually_geocoded",!0);e._collectData();e._removeErrors();"sub_"==b.substring(0,4)&&g.parent().find("div.map_wrapper").trigger("change")})},function(a){s3_debug(a)},function(a){s3_debug(a)})},_hideMap:function(){var a=this.fieldname,b=this.namespace,c="#"+a,e=this;d(c+"_map_icon").unbind(b).bind("click"+b,function(a){e._showMap(a)});d(c+"_map_wrapper").slideUp("medium");var b=
this.data,f;if(b.specific)f=i18n.show_map_view;else if(f=i18n.show_map_add,S3.gis.maps&&(a=S3.gis.maps["location_selector_"+a]))a.s3.draftLayer.removeAllFeatures(),b.lat=null,b.lon=null,b.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();d(c+"_map_icon span").html(f)},_zoomMap:function(a){var b=this.fieldname,c=S3.gis;if(c.maps&&(b=c.maps["location_selector_"+b])){var d=this.data,c=d.lat,f=d.lon,d=d.wkt;if(c&&f)c=OpenLayers.Bounds.fromArray([f,c,f,c]);else if(d)c=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(d))).geometry.getBounds();
else{a||(a=this._lookupParent()||"d");c=h[a].b;if(!c||!c.length)for(f=h[a].f,a=4;f&&a&&(a--,f=h[f],!(c=f.b)&&0!==f.l);)f=f.f;c&&(c=OpenLayers.Bounds.fromArray(c))}c&&S3.gis.zoomBounds(b,c,this.options.minBBOX)}},_validate:function(){var a=this.fieldname;this._removeErrors();var a="#"+a,b=this.data,c=this.options.featureRequired;if(c){var e=!1;switch(c){case "latlon":e=b.lat||b.lon;break;case "wkt":e=b.wkt;break;default:e=b.lat||b.lon||b.wkt}if(!e)return S3.fieldError(a+"_map_icon",i18n.map_feature_required),
!1}var f=b.id,c="address L5 L4 L3 L2 L1 L0".split(" "),g,e=function(a){return a.hasClass("multiselect")?a.next("button.ui-multiselect").is(":visible"):a.is(":visible")};if(f){if(!h[f])return!0;for(var m=h[f].l,b=0;b<6-m;b++)if(f=a+"_"+c[b],g=d(f),g.length&&g.hasClass("required")&&e(g))return S3.fieldError(f,i18n.enter_value),!1}else{if(b.lat||b.lon||b.wkt||b.address||b.postcode)return!0;for(b=0;7>b;b++)if(f=a+"_"+c[b],g=d(f),g.length&&g.hasClass("required")&&e(g))return S3.fieldError(f,i18n.enter_value),
!1}return!0},_serialize:function(){var a=JSON.stringify(this.data);this.input.val(a);return a},_deserialize:function(){var a=this.input.val();return this.data=JSON.parse(a)},_storeHierarchyData:function(a,b){var c;if(b)for(c in b)h[c]=b[c];if(a)for(c in a)l[c]=a[c]},_jsLoaded:function(){var a=new jQuery.Deferred;setTimeout(function c(){S3.gis.maps!=x?a.resolve("loaded"):"pending"===a.state()&&(a.notify("waiting for JS to load..."),setTimeout(c,500))},1);return a.promise()},_removeErrors:function(a){a||
(a="#"+this.fieldname,a=a+"_L0,"+a+"_L1,"+a+"_L2,"+a+"_L3,"+a+"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode,"+a+"_map_icon");d(a).siblings(".error").remove()},_bindEvents:function(){var a=this.fieldname,b=this.namespace,c=this,e="#"+a;d(e+"_L0").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(0)});d(e+"_L1").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(1)});d(e+"_L2").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(2)});d(e+"_L3").bind("change"+b,function(){c._removeErrors(this);
c._lxSelect(3)});d(e+"_L4").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(4)});d(e+"_L5").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(5)});d(e+"_address,"+e+"_postcode").bind("change"+b,function(){c._removeErrors(this);c.useGeocoder?c._geocodeDecision():c._collectData()});d(e+"_lat,"+e+"_lon").bind("change"+b,function(){c._latlonInput()});d(e+"_latlon_toggle").bind("click"+b,function(){var a=d(this).data("mode")||c.options.latlonMode,b;"dms"==a?(a="decimal",b=i18n.latlon_mode.dms):
(a="dms",b=i18n.latlon_mode.decimal);d(e+"_lat").latloninput("option",{mode:a});d(e+"_lon").latloninput("option",{mode:a});d(this).html(b).data("mode",a)});if("sub_"==a.substring(0,4))this.input.closest(".inline-form").bind("validate"+b+this.id,function(a){c._validate()||a.preventDefault()});else{var f=this.input.closest("form");f.bind("submit"+b+this.id,function(a){a.preventDefault();c._validate()&&f.unbind(b+c.id).submit()})}return!0},_unbindEvents:function(){var a="#"+this.fieldname,b=this.namespace;
d(a+"_L0,"+a+"_L1,"+a+"_L2,"+a+"_L3,"+a+"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode,"+a+"_map_icon,"+a+"_latlon_toggle").unbind(b);this.input.next(".error_wrapper").unbind(b);this.input.closest("form").unbind(b+self.id);return!0}})})(jQuery);
(function(d,x){var v=0;d.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){d(this.element);this.id=v;v+=1;this.namespace=".latloninput"},_init:function(){d(this.element).hide();this.refresh()},_destroy:function(){d(this.element).show();d.Widget.prototype.destroy.call(this)},_setOption:function(d,l){this._super(d,l);"mode"==d&&this.refresh()},refresh:function(){this._unbindEvents();var h=d(this.element),l=this.options;this.defaultValue=
h.val();if(!this.input){var a=d("<div>").hide().insertAfter(h),b=d('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var c=l.labels,e=d('<input type="text" class="integer dms-input" size="5">'),f=d('<span class="dms-label">'+c.deg+"</span>"),g=d('<input type="text" class="integer dms-input" size="5">'),m=d('<span class="dms-label">'+c.min+"</span>"),r=d('<input type="text" class="double dms-input" size="8">'),c=d('<span class="dms-label">'+c.sec+"</span>");this.degInput=
e;this.minInput=g;this.secInput=r;this.dmsInput=e=d("<span>").append(e).append(f).append(g).append(m).append(r).append(c).hide();this.input=a.append(b).append(e).show()}this._removeErrors();"dms"==l.mode?(h=this._getDMS(),this.degInput.val(h.d),this.minInput.val(h.m),this.secInput.val(h.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(h.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var h=d(this.element).val();if(isNaN(parseFloat(h))||
!isFinite(h))return{d:"",m:"",s:""};var l=Math.abs(h),l=60*(l-parseInt(l,10));if(1E-10>Math.abs(l-Math.round(l)))l=Math.round(l),a=0;else{var a=60*(l-parseInt(l,10));1E-10>Math.abs(a-Math.round(a))&&(a=Math.round(a))}return{d:parseInt(h,10),m:parseInt(l,10),s:a}},_showError:function(d,l){"all"==d?this.input.find("input").addClass("invalidinput"):d&&d.addClass("invalidinput");l&&this.input.append('<div class="error">'+l+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");
this.input.find(".error").remove()},_validateDMS:function(){this._removeErrors();var d,l;"lat"==this.options.type?(d=90,l=i18n.latlon_error.lat):(d=180,l=i18n.latlon_error.lon);var a=this.degInput.val(),b=this.minInput.val(),c=this.secInput.val(),e=[];if(""===a&&""===b&&""===c)return"";a=parseInt(a,10)||0;b=parseInt(b,10)||0;c=parseFloat(c)||0;60<=Math.abs(b)&&(this._showError(this.minInput),e.push(i18n.latlon_error.min));60<=Math.abs(c)&&(this._showError(this.secInput),e.push(i18n.latlon_error.sec));
b=Math.abs(a)+b/60+c/3600;if(!e.length&&b>d||a>d)this._showError("all"),e.push(l);return e.length?(this._showError(null,e.join(", ")),null):(0>a?-1:1)*b},_validateDecimal:function(){this._removeErrors();var d=this.options.type,l,a,b=i18n.latlon_error.format;"lat"==d?(l=90,a=i18n.latlon_error.lat):(l=180,a=i18n.latlon_error.lon);var c=this.decimalInput.val();if(""===c)return"";c=this._parse(c,d);null===c?this._showError(this.decimalInput,b):Math.abs(c)>l&&(this._showError(this.decimalInput,a),c=null);
return c},_parse:function(d,l){var a;a="lat"==l?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,c=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,e,f=0,g=0,m=0;if(d.match(b))return e=d.replace(b,"$1|$2|$3").split("|"),(b=e[0]||e[2])&&(b=a[b]),f=parseFloat(e[1]),b&&Math.abs(f)!=f&&(b=null),b&&(f*=b),f;if(d.match(c)){e=d.replace(c,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");
(b=e[0]||e[7])&&(b=a[b]);a=[];var c=[],r,q,k;for(k=1;6>k;k+=2)r=e[k],(q=e[k+1])?(a.push(parseFloat(r)||0),c.push(q)):r&&(a.push(parseFloat(r)),c.push(null));if(e=a.length){for(k=1;k<e;k++)a[k]=Math.abs(a[k]);r=a[0];Math.abs(r)!=r&&(b=1);if(1==e)q=c[0],'"'==q?m=a[0]:"'"==q?g=a[0]:q&&"\u00b0"!=q||(f=a[0]);else if(2==e)if(e=c[0],c=c[1],"\u00b0"==e)f=a[0],'"'==c?m=a[1]:"'"!=c&&c||(g=a[1]);else if(e){if("'"!=e||c&&'"'!=c)return null;g=a[0];m=a[1]}else'"'==c?(g=a[0],m=a[1]):"'"!=c&&c||(f=a[0],g=a[1]);else{if(c[0]&&
"\u00b0"!=c[0]||c[1]&&"'"!=c[1]||c[2]&&'"'!=c[2])return null;f=a[0];g=a[1];m=a[2]}f=f+g/60+m/3600;b&&(f*=b);return f}}return null},_bindEvents:function(){var h=this,l=this.namespace;this.dmsInput.find("input").bind("change"+l,function(){var a=h._validateDMS();null!==a?d(h.element).val(a).change():d(h.element).val(h.defaultValue).change()});this.decimalInput.bind("change"+l,function(){var a=h._validateDecimal();null!==a?(d(h.element).val(a).change(),h.decimalInput.val(a)):d(h.element).val(h.defaultValue).change()});
d(this.element).bind("setvalue"+l,function(){h.refresh()});return!0},_unbindEvents:function(){var h=this.namespace;this.input&&this.input.find("input").unbind(h);d(this.element).unbind(h);return!0}})})(jQuery);
