/*
 2015-2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,p,k){c instanceof String&&(c=String(c));for(var f=c.length,e=0;e<f;e++){var a=c[e];if(p.call(k,a,e,c))return{i:e,v:a}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,p,k){c!=Array.prototype&&c!=Object.prototype&&(c[p]=k.value)};
$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,p,k,f){if(p){k=$jscomp.global;c=c.split(".");for(f=0;f<c.length-1;f++){var e=c[f];e in k||(k[e]={});k=k[e]}c=c[c.length-1];f=k[c];p=p(f);p!=f&&null!=p&&$jscomp.defineProperty(k,c,{configurable:!0,writable:!0,value:p})}};
$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,k){return $jscomp.findInternal(this,c,k).v}},"es6","es3");
(function(c,p){var k=0,f={},e={};c.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=k;k+=1;this.eventNamespace=".locationselector"},_init:function(){var a=c(this.element),b=this.options,d=a.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=a;this.data=null;this._storeHierarchyData(b.labels,
b.locations);this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var a=this._deserialize();this._renderWidget();var b="#"+this.fieldname,d=this.options;c(b+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var g=c(b+"_L0__row");if(g.length){var m=[];for(q in f){var h=f[q];0===h.l&&(h.i=q,m.push(h))}m.sort(function(a,b){return a.n.localeCompare(b.n)});for(var l=c(b+"_L0"),n=0,e=m.length;n<e;n++){h=m[n];var q=h.i;h='<option value="'+
q+'">'+h.n+"</option>";l.append(h)}g.removeClass("hide").show();g=c(b+"_L0__row1");g.length&&g.removeClass("hide").show()}g=a.L0;m=a.L1;l=a.L2;n=a.L3;e=a.L4;h=a.L5;g&&this._lxSelect(0,g,!0);(m||l)&&this._lxSelect(1,m||l,!0);(l||n)&&this._lxSelect(2,l||n,!0);(n||e)&&this._lxSelect(3,n||e,!0);(e||h)&&this._lxSelect(4,e||h,!0);h&&this._lxSelect(5,h,!0);this.lx=[g,m,l,n,e,h].join("|");c(b+"_address").val(a.address);c(b+"_address__row").removeClass("hide").show();c(b+"_address__row1").removeClass("hide").show();
c(b+"_postcode").val(a.postcode);c(b+"_postcode__row").removeClass("hide").show();c(b+"_postcode__row1").removeClass("hide").show();c(b+"_lat").val(a.lat).latloninput({type:"lat",mode:d.latlonMode});c(b+"_lat__row").removeClass("hide").show();c(b+"_lat__row1").removeClass("hide").show();c(b+"_lon").val(a.lon).latloninput({type:"lon",mode:d.latlonMode});c(b+"_lon__row").removeClass("hide").show();c(b+"_lon__row1").removeClass("hide").show();g=c(b+"_map_icon__row").removeClass("hide").show();a.lat||
a.lon||a.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&g.is(":visible")&&"#sub_"!=b.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var a=this.fieldname,b="#"+a,d=this.options.reverseLx,g=c(b+"_map_icon__row .map_wrapper");g.attr("id",this.fieldname+"_map_wrapper");var f=c(b+"__row"),h=this.input.next(".error_wrapper"),
l=c(b+"_map_icon__row"),e=c(b+"_L0__row"),z=c(b+"_postcode__row");if(f.is(".control-group, .form-row")){a=c(b+"_L1__row");var q=c(b+"_L2__row"),x=c(b+"_L3__row"),r=c(b+"_L4__row"),t=c(b+"_L5__row"),A=c(b+"_address__row"),k=c(b+"_lat__row"),u=c(b+"_lon__row");b=c(b+"_latlon_toggle__row");d?f.hide().after(g).after(l).after(b).after(u).after(k).after(e).after(a).after(q).after(x).after(r).after(t).after(z).after(A).after(h):f.hide().after(g).after(l).after(b).after(u).after(k).after(z).after(A).after(t).after(r).after(x).after(q).after(a).after(e).after(h)}else f.parent().is(".inline-form")?
f.show():(c(b+"__row1").hide(),f.hide().after(h),l.detach(),f.siblings('[id^="'+a+'"][id$="__row"]').last().after(g).after(l));if(h.length)h.one("click"+this.eventNamespace,function(){var a=c(this);a.fadeOut("slow",function(){a.remove()})})},_lxSelectFinal:function(a){a?this._serialize():this._collectData();this._zoomMap()},_lxSelect:function(a,b,d){var g="#"+this.fieldname,m=this.options,h=c(g+"_L"+a),l;b?(h.val(b),h.hasClass("multiselect")&&h.multiselect("instance")&&h.multiselect("refresh")):b=
parseInt(h.val(),10);if(0===a){var n=this._readLabels(b),z=e.d,q=["1","2","3","4","5"],x,r,t;n.then(function(a){for(t=0;5>t;t++)l=q[t],x=a[l]||z[l],k=g+"_L"+l,h=c(k),r=m.showLabels?h.hasClass("required")?"<div>"+x+':<span class="req"> *</span></div>':x+":":"",c(k+"__row label").html(r),c(k+"__row1 label").html(r),c(k+' option[value=""]').html(i18n.select+" "+x),h.hasClass("multiselect")&&h.multiselect("instance")&&h.multiselect("refresh")})}n=m.hideLx;for(l=a+1;6>l;l++){var k=g+"_L"+l;n?(c(k+"__row").hide(),
c(k+"__row1").hide()):c(k+" option").remove('[value != ""]');c(k).val("")}if(b){var p=!1,u=a+1,B=c(g+"_L"+u+"__row");B.length||(p=!0,u++,B=c(g+"_L"+u+"__row"));if(B.length){var v;n=!1;var C=this;if(c(g+"_L"+a+' option[value="'+b+'"]').hasClass("missing")){var w=f[b];w.i=b;var y=[w]}else for(v in y=[],n=!0,f)if(f[v].f==b){n=!1;break}this._readHierarchy(n,b,u,p).then(function(){if(0==y.length)for(v in f)w=f[v],w.f==b&&(w.i=v,y.push(w));var a=y.length;if(a){y.sort(function(a,b){return a.n.localeCompare(b.n)});
var l=g+"_L"+u;var h=c(l),m=c(l+' option[value=""]').html();c(l+" option").remove('[value != ""]');v=null;for(t=0;t<a;t++)w=y[t],v=w.i,l=b==v?' selected="selected"':"",p=w.l==u?"":' class="missing"',l='<option value="'+v+'"'+l+p+">"+w.n+"</option>",h.append(l);B.removeClass("hide").show();c(g+"_L"+u+"__row1").removeClass("hide").show();h.hasClass("multiselect")&&(m={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:m,multiple:!1},h.hasClass("search")?(h.multiselect(m).multiselectfilter({label:"",
placeholder:i18n.search}),c(".ui-multiselect-header").show()):(m.header=!1,h.multiselect(m)));1==a&&v&&C._lxSelect(u,v,d)}C._lxSelectFinal(d)})}else this.useGeocoder&&!d&&this._geocodeDecision(),this._lxSelectFinal(d)}else this._lxSelectFinal(d)},_collectData:function(){var a=this.data,b="#"+this.fieldname,d=this._lookupParent(),g=c(b+"_address").val(),f=c(b+"_postcode").val();a.address=g;a.postcode=f;if(a.specific)a.id=a.specific,a.parent=d;else{var h=a.lat,l=a.lon,e=a.wkt;g||f||h||l||e?(a.id=null,
a.parent=d):(a.id=d,a.parent=null)}this._serialize();c(b+"_lat").val(a.lat).trigger("setvalue");c(b+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.change()},_collectLx:function(){var a=this.data,b="#"+this.fieldname,d;for(d=0;6>d;d++){var g=c(b+"_L"+d);g.length&&(g=g.val(),a["L"+d]=g?parseInt(g,10):null)}this._serialize()},_hasData:function(){var a=this.data,b=!1;a.specific||a.address||a.postcode||a.lat||a.lon||a.wkt?b=
!0:[a.L0,a.L1,a.L2,a.L3,a.L4,a.L5].join("|")!=this.lx&&(b=!0);return b},_lookupParent:function(){this._collectLx();for(var a=this.data,b,d=5;-1<d;d--)if(b=a["L"+d])return b;return(a=f.d)?a.i:null},_readLabels:function(a){a||(a="d");var b=c.Deferred(),d=e[a];if(d==p){var g=S3.Ap.concat("/gis/hdata/"+a),f;c.ajaxS3({url:g,dataType:"script",success:function(){d={};try{for(var c in f)d[c]=f[c];e[a]=d;f=null}catch(l){}b.resolve(d)},error:function(a,d,c){(a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)&&
s3_debug(a);b.reject()}})}else b.resolve(d);return b.promise()},_readHierarchy:function(a,b,d,g){var m=c.Deferred();if(a){a="#"+this.fieldname;var h=c(a+"_L"+d),l=!1;h.hide();if(h.hasClass("multiselect")){l=!0;var e=c(a+"_L"+d+"__row button").hide()}var k=c(a+"_L"+d+"__throbber").removeClass("hide").show(),q;b=g?S3.Ap.concat("/gis/ldata/"+b+"/"+d):S3.Ap.concat("/gis/ldata/"+b);c.ajaxS3({url:b,dataType:"script",success:function(){for(var a in q)f[a]=q[a];q=null;k.hide();l?e.removeClass("hide").show():
h.removeClass("hide").show();m.resolve()},error:function(a,b,d){if(a="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText)s3_debug(a),S3.showAlert(a,"error");k.hide();l?e.removeClass("hide").show():h.removeClass("hide").show();m.reject()}})}else m.resolve();return m.promise()},_geocodeDecision:function(){var a="#"+this.fieldname,b=this.data;this._collectData();if(b.address){b=["1","2","3","4","5"];for(var d=0,g;5>d;d++)if(g=c(a+"_L"+b[d]),g.length&&!g.val()&&1<g[0].options.length)return;c(a+"_geocode .geocode_success,"+
a+"_geocode .geocode_fail").hide();var f=this;b=this.eventNamespace;this.input.data("manually_geocoded")?c(a+"_geocode button").removeClass("hide").show().unbind(b).bind("click"+b,function(){c(this).hide();f._geocode()}):this._geocode()}},_geocode:function(){var a=this.fieldname,b=this,d="#"+a,g=c(d+"_geocode .geocode_fail").hide(),f=c(d+"_geocode .geocode_success").hide(),h=c(d+"_geocode .throbber").removeClass("hide").show(),l=this.data;d={address:l.address};for(var e="postcode L0 L1 L2 L3 L4 L5".split(" "),
k=0,q,p;7>k;k++)q=e[k],(p=l[q])&&(d[q]=p);e=S3.Ap.concat("/gis/geocode");c.ajaxS3({url:e,type:"POST",data:d,dataType:"json",success:function(d){var c=d.lat,e=d.lon;if(c||e){l.lat=parseFloat(c);l.lon=parseFloat(e);b._collectData();c=S3.gis;if(c.maps&&(e=c.maps["location_selector_"+a])){d=e.s3.draftLayer;d.removeAllFeatures();var m=new OpenLayers.Geometry.Point(l.lon,l.lat);m.transform(c.proj4326,e.getProjectionObject());c=new OpenLayers.Feature.Vector(m);d.addFeatures([c]);b._zoomMap()}h.hide();f.html(i18n.address_mapped).removeClass("hide").show()}else h.hide(),
g.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(d)},error:function(a,b,d){a="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;h.hide();g.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(a)}})},_geocodeReverse:function(){var a=this,b="#"+this.fieldname,d=c(b+"_geocode .geocode_fail").hide(),g=c(b+"_geocode .geocode_success").hide(),f=c(b+"_geocode .throbber").removeClass("hide").show();b=this.data;b={lat:b.lat,lon:b.lon};var e=S3.Ap.concat("/gis/geocode_r");
c.ajaxS3({async:!1,url:e,type:"POST",data:b,dataType:"json",success:function(b){b.L0?(a.useGeocoder=!1,a._lxSelect(0,b.L0),b.L1&&a._lxSelect(1,b.L1),b.L2&&a._lxSelect(2,b.L2),b.L3&&a._lxSelect(3,b.L3),b.L4&&a._lxSelect(4,b.L4),b.L5&&a._lxSelect(5,b.L5),a.useGeocoder=!0,f.hide(),g.html(i18n.location_found).removeClass("hide").show()):(f.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;f.hide();d.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(a)}})},_latlonInput:function(){var a=this.fieldname,b=this.data,d="#"+a,g=c(d+"_lat").val();d=c(d+"_lon").val();g||d?(g=g?parseFloat(g):0,d=d?parseFloat(d):0,b.lat=g,b.lon=d,b.wkt=null,this.input.data("manually_geocoded",!0)):(b.lat=null,b.lon=null,b.wkt||this.input.data("manually_geocoded",!1));this._serialize();g=S3.gis;g.maps&&(a=g.maps["location_selector_"+a])&&(d=a.s3.draftLayer,d.removeAllFeatures(),null!==b.lat&&null!==b.lon&&(b=new OpenLayers.Geometry.Point(b.lon,b.lat),b.transform(g.proj4326,
a.getProjectionObject()),b=new OpenLayers.Feature.Vector(b),d.addFeatures([b]),a.s3.lastDraftFeature=b),this._zoomMap())},_showMap:function(a){var b=this.fieldname,d=this.eventNamespace,g=this,f="#"+b;c(f+"_map_icon").unbind(d).bind("click"+d,function(){g._hideMap()});c(f+"_map_icon span").html(i18n.hide_map);d=c(f+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&a&&c("html,body").animate({scrollTop:d.offset().top},250);var e=this.input;c.when(this._jsLoaded()).then(function(){var a=
S3.gis,d="location_selector_"+b;var h=a.maps[d]?a.maps[d]:a.show_map(d);g._zoomMap();var m=g.data;d=m.lat;var k=m.lon,r=m.wkt;if(d||k||r)h.s3.draftLayer.removeAllFeatures(),r!=p&&r?(d={internalProjection:h.getProjectionObject(),externalProjection:a.proj4326},d=(new OpenLayers.Format.WKT(d)).read(r)):(d=new OpenLayers.Geometry.Point(parseFloat(k),parseFloat(d)),d.transform(a.proj4326,h.getProjectionObject()),d=new OpenLayers.Feature.Vector(d)),h.s3.draftLayer.addFeatures([d]),h.s3.lastDraftFeature=
d;d=h.controls;k=0;for(var t=d.length;k<t;k++)if("OpenLayers.Control.DrawFeature"==d[k].CLASS_NAME){var A=d[k];break}A&&(h.s3.pointPlaced=function(d){c(f+"_geocode .geocode_fail").hide();c(f+"_geocode .geocode_success").hide();var l=d.geometry;if("OpenLayers.Geometry.Point"==l.CLASS_NAME)d=l.getBounds().getCenterLonLat(),d.transform(h.getProjectionObject(),a.proj4326),m.wkt=null,m.lat=d.lat,m.lon=d.lon,!m.address&&g.useGeocoder&&g._geocodeReverse();else{l={internalProjection:h.getProjectionObject(),
externalProjection:a.proj4326};m.radius=null;var k=new OpenLayers.Geometry.LinearRing(d.geometry.components[0].components);k=new OpenLayers.Geometry.Polygon([k]);if(1E3==k.getVertices().length){var n=(new OpenLayers.Feature.Vector(k,null)).geometry.getBounds();k=n.right;var p=(n.bottom+n.top)/2;n=new OpenLayers.Geometry.Point((n.left+k)/2,p);k=new OpenLayers.Geometry.Point(k,p);k=new OpenLayers.Geometry.LineString([n,k]);k=parseFloat(k.getLength());m.radius=k}r=(new OpenLayers.Format.WKT(l)).write(d);
m.wkt=r;m.lat=null;m.lon=null}e.data("manually_geocoded",!0);g._collectData();g._removeErrors();"sub_"==b.substring(0,4)&&e.parent().find("div.map_wrapper").trigger("change")})},function(a){s3_debug(a)},function(a){s3_debug(a)})},_hideMap:function(){var a=this.fieldname,b=this.eventNamespace,d="#"+a,g=this;c(d+"_map_icon").unbind(b).bind("click"+b,function(a){g._showMap(a)});c(d+"_map_wrapper").slideUp("medium");b=this.data;if(b.specific)var f=i18n.show_map_view;else if(f=i18n.show_map_add,S3.gis.maps&&
(a=S3.gis.maps["location_selector_"+a]))a.s3.draftLayer.removeAllFeatures(),b.lat=null,b.lon=null,b.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();c(d+"_map_icon span").html(f)},_zoomMap:function(a){var b=this.fieldname,d=S3.gis;if(d.maps&&(b=d.maps["location_selector_"+b])){var c=this.data;d=c.lat;var e=c.lon;c=c.wkt;if(d&&e)d=OpenLayers.Bounds.fromArray([e,d,e,d]);else if(c)d=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(c))).geometry.getBounds();else{a||(a=this._lookupParent()||
"d");d=f[a].b;if(!d||!d.length)for(e=f[a].f,a=4;e&&a&&(a--,e=f[e],!(d=e.b)&&0!==e.l);)e=e.f;d&&(d=OpenLayers.Bounds.fromArray(d))}d&&S3.gis.zoomBounds(b,d,this.options.minBBOX)}},_validate:function(){var a=this.fieldname;this._removeErrors();a="#"+a;var b=this.data,d=this.options.featureRequired;if(d){var g=!1;switch(d){case "latlon":g=b.lat||b.lon;break;case "wkt":g=b.wkt;break;default:g=b.lat||b.lon||b.wkt}if(!g)return S3.fieldError(a+"_map_icon",i18n.map_feature_required),!1}var e=b.id;d="address L5 L4 L3 L2 L1 L0".split(" ");
g=function(a){return a.hasClass("multiselect")?a.next("button.ui-multiselect").is(":visible"):a.is(":visible")};if(e){if(!f[e])return!0;var h=f[e].l;for(b=0;b<6-h;b++){e=a+"_"+d[b];var l=c(e);if(l.length&&l.hasClass("required")&&g(l))return S3.fieldError(e,i18n.enter_value),!1}}else{if(b.lat||b.lon||b.wkt||b.address||b.postcode)return!0;for(b=0;7>b;b++)if(e=a+"_"+d[b],l=c(e),l.length&&l.hasClass("required")&&g(l))return S3.fieldError(e,i18n.enter_value),!1}return!0},_serialize:function(){var a=JSON.stringify(this.data);
this.input.val(a);return a},_deserialize:function(){var a=this.input.val();return this.data=JSON.parse(a)},_storeHierarchyData:function(a,b){var d;if(b)for(d in b)f[d]=b[d];if(a)for(d in a)e[d]=a[d]},_jsLoaded:function(){var a=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=p?a.resolve("loaded"):"pending"===a.state()&&(a.notify("waiting for JS to load..."),setTimeout(d,500))},1);return a.promise()},_removeErrors:function(a){a||(a="#"+this.fieldname,a=a+"_L0,"+a+"_L1,"+a+"_L2,"+a+"_L3,"+a+
"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode,"+a+"_map_icon");c(a).siblings(".error").remove()},_bindEvents:function(){var a=this.fieldname,b=this.eventNamespace,d=this,f="#"+a;c(f+"_L0").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(0)});c(f+"_L1").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(1)});c(f+"_L2").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(2)});c(f+"_L3").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(3)});c(f+"_L4").bind("change"+
b,function(){d._removeErrors(this);d._lxSelect(4)});c(f+"_L5").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(5)});c(f+"_address,"+f+"_postcode").bind("change"+b,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});c(f+"_lat,"+f+"_lon").bind("change"+b,function(){d._latlonInput()});c(f+"_latlon_toggle").bind("click"+b,function(){var a=c(this).data("mode")||d.options.latlonMode;if("dms"==a){a="decimal";var b=i18n.latlon_mode.dms}else a="dms",b=i18n.latlon_mode.decimal;
c(f+"_lat").latloninput("option",{mode:a});c(f+"_lon").latloninput("option",{mode:a});c(this).html(b).data("mode",a)});if("sub_"==a.substring(0,4))this.input.closest(".inline-form").bind("validate"+b+this.id,function(a){d._validate()||a.preventDefault()});else{var e=this.input.closest("form");e.bind("submit"+b+this.id,function(a){a.preventDefault();d._validate()&&e.unbind(b+d.id).submit()})}return!0},_unbindEvents:function(){var a="#"+this.fieldname,b=this.eventNamespace;c(a+"_L0,"+a+"_L1,"+a+"_L2,"+
a+"_L3,"+a+"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode,"+a+"_map_icon,"+a+"_latlon_toggle").unbind(b);this.input.next(".error_wrapper").unbind(b);this.input.closest("form").unbind(b+this.id);return!0}})})(jQuery);
(function(c,p){var k=0;c.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=k;k+=1;this.eventNamespace=".latloninput"},_init:function(){c(this.element).hide();this.refresh()},_destroy:function(){c(this.element).show();c.Widget.prototype.destroy.call(this)},_setOption:function(c,e){this._super(c,e);"mode"==c&&this.refresh()},refresh:function(){this._unbindEvents();var f=c(this.element),e=this.options;this.defaultValue=f.val();
if(!this.input){var a=c("<div>").hide().insertAfter(f),b=c('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var d=e.labels,g=c('<input type="text" class="integer dms-input" size="5">'),k=c('<span class="dms-label">'+d.deg+"</span>"),h=c('<input type="text" class="integer dms-input" size="5">'),l=c('<span class="dms-label">'+d.min+"</span>"),n=c('<input type="text" class="double dms-input" size="8">');d=c('<span class="dms-label">'+d.sec+"</span>");this.degInput=g;this.minInput=
h;this.secInput=n;this.dmsInput=g=c("<span>").append(g).append(k).append(h).append(l).append(n).append(d).hide();this.input=a.append(b).append(g).show()}this._removeErrors();"dms"==e.mode?(f=this._getDMS(),this.degInput.val(f.d),this.minInput.val(f.m),this.secInput.val(f.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(f.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var f=c(this.element).val();if(isNaN(parseFloat(f))||!isFinite(f))return{d:"",
m:"",s:""};var e=Math.abs(f);e=60*(e-parseInt(e,10));if(1E-10>Math.abs(e-Math.round(e))){e=Math.round(e);var a=0}else a=60*(e-parseInt(e,10)),1E-10>Math.abs(a-Math.round(a))&&(a=Math.round(a));return{d:parseInt(f,10),m:parseInt(e,10),s:a}},_showError:function(c,e){"all"==c?this.input.find("input").addClass("invalidinput"):c&&c.addClass("invalidinput");e&&this.input.append('<div class="error">'+e+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var c=90;var e=i18n.latlon_error.lat}else c=180,e=i18n.latlon_error.lon;var a=this.degInput.val(),b=this.minInput.val(),d=this.secInput.val(),g=[];if(""===a&&""===b&&""===d)return"";a=parseInt(a,10)||0;b=parseInt(b,10)||0;d=parseFloat(d)||0;60<=Math.abs(b)&&(this._showError(this.minInput),g.push(i18n.latlon_error.min));60<=Math.abs(d)&&(this._showError(this.secInput),g.push(i18n.latlon_error.sec));b=Math.abs(a)+b/60+d/3600;
if(!g.length&&b>c||a>c)this._showError("all"),g.push(e);return g.length?(this._showError(null,g.join(", ")),null):(0>a?-1:1)*b},_validateDecimal:function(){this._removeErrors();var c=this.options.type,e=i18n.latlon_error.format;if("lat"==c){var a=90;var b=i18n.latlon_error.lat}else a=180,b=i18n.latlon_error.lon;var d=this.decimalInput.val();if(""===d)return"";d=this._parse(d,c);null===d?this._showError(this.decimalInput,e):Math.abs(d)>a&&(this._showError(this.decimalInput,b),d=null);return d},_parse:function(c,
e){var a="lat"==e?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,d=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,f=e=0,k=0;if(c.match(b))return d=c.replace(b,"$1|$2|$3").split("|"),(c=d[0]||d[2])&&(c=a[c]),e=parseFloat(d[1]),c&&Math.abs(e)!=e&&(c=null),c&&(e*=c),e;if(c.match(d)){d=c.replace(d,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(c=d[0]||d[7])&&
(c=a[c]);a=[];b=[];var h,l;for(l=1;6>l;l+=2){var n=d[l];(h=d[l+1])?(a.push(parseFloat(n)||0),b.push(h)):n&&(a.push(parseFloat(n)),b.push(null))}if(d=a.length){for(l=1;l<d;l++)a[l]=Math.abs(a[l]);n=a[0];Math.abs(n)!=n&&(c=1);if(1==d)h=b[0],'"'==h?k=a[0]:"'"==h?f=a[0]:h&&"\u00b0"!=h||(e=a[0]);else if(2==d)if(d=b[0],b=b[1],"\u00b0"==d)e=a[0],'"'==b?k=a[1]:"'"!=b&&b||(f=a[1]);else if(d){if("'"!=d||b&&'"'!=b)return null;f=a[0];k=a[1]}else'"'==b?(f=a[0],k=a[1]):"'"!=b&&b||(e=a[0],f=a[1]);else{if(b[0]&&
"\u00b0"!=b[0]||b[1]&&"'"!=b[1]||b[2]&&'"'!=b[2])return null;e=a[0];f=a[1];k=a[2]}e=e+f/60+k/3600;c&&(e*=c);return e}}return null},_bindEvents:function(){var f=this,e=this.eventNamespace;this.dmsInput.find("input").bind("change"+e,function(){var a=f._validateDMS();null!==a?c(f.element).val(a).change():c(f.element).val(f.defaultValue).change()});this.decimalInput.bind("change"+e,function(){var a=f._validateDecimal();null!==a?(c(f.element).val(a).change(),f.decimalInput.val(a)):c(f.element).val(f.defaultValue).change()});
c(this.element).bind("setvalue"+e,function(){f.refresh()});return!0},_unbindEvents:function(){var f=this.eventNamespace;this.input&&this.input.find("input").unbind(f);c(this.element).unbind(f);return!0}})})(jQuery);
