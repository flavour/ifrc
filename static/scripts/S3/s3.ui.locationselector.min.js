/*
 2015-2017 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,r,m){c instanceof String&&(c=String(c));for(var h=c.length,k=0;k<h;k++){var a=c[k];if(r.call(m,a,k,c))return{i:k,v:a}}return{i:-1,v:void 0}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(c,r,m){c!=Array.prototype&&c!=Object.prototype&&(c[r]=m.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};
$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,r,m,h){if(r){m=$jscomp.global;c=c.split(".");for(h=0;h<c.length-1;h++){var k=c[h];k in m||(m[k]={});m=m[k]}c=c[c.length-1];h=m[c];r=r(h);r!=h&&null!=r&&$jscomp.defineProperty(m,c,{configurable:!0,writable:!0,value:r})}};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,m){return $jscomp.findInternal(this,c,m).v}},"es6-impl","es3");
(function(c,r){var m=0,h={},k={};c.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){c(this.element);this.id=m;m+=1;this.eventNamespace=".locationselector"},_init:function(){var a=c(this.element),b=this.options,d=a.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=a;this.data=null;
this._storeHierarchyData(b.labels,b.locations);this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var a=this._deserialize();this._renderWidget();var b="#"+this.fieldname,d=this.options;c(b+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var e=c(b+"_L0__row");if(e.length){var f=[];for(k in h){var p=h[k];0===p.l&&(p.i=k,f.push(p))}f.sort(function(a,b){return a.n.localeCompare(b.n)});for(var g=c(b+"_L0"),l=0,q=f.length;l<
q;l++){p=f[l];var k=p.i;p='<option value="'+k+'">'+p.n+"</option>";g.append(p)}e.removeClass("hide").show();e=c(b+"_L0__row1");e.length&&e.removeClass("hide").show()}e=a.L0;f=a.L1;g=a.L2;l=a.L3;q=a.L4;p=a.L5;e&&this._lxSelect(0,e,!0);(f||g)&&this._lxSelect(1,f||g,!0);(g||l)&&this._lxSelect(2,g||l,!0);(l||q)&&this._lxSelect(3,l||q,!0);(q||p)&&this._lxSelect(4,q||p,!0);p&&this._lxSelect(5,p,!0);this.lx=[e,f,g,l,q,p].join("|");c(b+"_address").val(a.address);c(b+"_address__row").removeClass("hide").show();
c(b+"_address__row1").removeClass("hide").show();c(b+"_postcode").val(a.postcode);c(b+"_postcode__row").removeClass("hide").show();c(b+"_postcode__row1").removeClass("hide").show();c(b+"_lat").val(a.lat).latloninput({type:"lat",mode:d.latlonMode});c(b+"_lat__row").removeClass("hide").show();c(b+"_lat__row1").removeClass("hide").show();c(b+"_lon").val(a.lon).latloninput({type:"lon",mode:d.latlonMode});c(b+"_lon__row").removeClass("hide").show();c(b+"_lon__row1").removeClass("hide").show();e=c(b+"_map_icon__row").removeClass("hide").show();
a.lat||a.lon||a.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&e.is(":visible")&&"#sub_"!=b.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var a=this.fieldname,b="#"+a,d=this.options.reverseLx,e=c(b+"_map_icon__row .map_wrapper");e.attr("id",this.fieldname+"_map_wrapper");var f=c(b+"__row"),h=this.input.next(".error_wrapper"),
g=c(b+"_map_icon__row"),l=c(b+"_L0__row"),q=c(b+"_postcode__row");if(f.is(".control-group, .form-row")){var a=c(b+"_L1__row"),k=c(b+"_L2__row"),x=c(b+"_L3__row"),t=c(b+"_L4__row"),w=c(b+"_L5__row"),u=c(b+"_address__row"),m=c(b+"_lat__row"),r=c(b+"_lon__row"),b=c(b+"_latlon_toggle__row");d?f.hide().after(e).after(g).after(b).after(r).after(m).after(l).after(a).after(k).after(x).after(t).after(w).after(q).after(u).after(h):f.hide().after(e).after(g).after(b).after(r).after(m).after(q).after(u).after(w).after(t).after(x).after(k).after(a).after(l).after(h)}else f.parent().is(".inline-form")?
f.show():(c(b+"__row1").hide(),f.hide().after(h),g.detach(),f.siblings('[id^="'+a+'"][id$="__row"]').last().after(e).after(g));if(h.length)h.one("click"+this.eventNamespace,function(){var a=c(this);a.fadeOut("slow",function(){a.remove()})})},_lxSelect:function(a,b,d){var e,f="#"+this.fieldname,p=this.options;var g=c(f+"_L"+a);b?(g.val(b),g.hasClass("multiselect")&&g.multiselect("instance")&&g.multiselect("refresh")):b=parseInt(g.val(),10);if(0===a){var l=this._readLabels(b),q=k.d,v=["1","2","3","4",
"5"];for(e=0;5>e;e++){g=v[e];var m=l[g]||q[g];var t=f+"_L"+g;g=c(t);var w=p.showLabels?g.hasClass("required")?"<div>"+m+':<span class="req"> *</span></div>':m+":":"";c(t+"__row label").html(w);c(t+"__row1 label").html(w);c(t+' option[value=""]').html(i18n.select+" "+m);g.hasClass("multiselect")&&g.multiselect("instance")&&g.multiselect("refresh")}}e=p.hideLx;for(g=a+1;6>g;g++)t=f+"_L"+g,e?(c(t+"__row").hide(),c(t+"__row1").hide()):c(t+" option").remove('[value != ""]'),c(t).val("");if(b)if(q=!1,t=
a+1,p=c(f+"_L"+t+"__row"),p.length||(q=!0,t++,p=c(f+"_L"+t+"__row")),p.length){if(c(f+"_L"+a+' option[value="'+b+'"]').hasClass("missing"))g=h[b],g.i=b,v=[g];else{e=!0;for(u in h)if(h[u].f==b){e=!1;break}e&&this._readHierarchy(b,t,q);v=[];for(u in h)g=h[u],g.f==b&&(g.i=u,v.push(g))}if(a=v.length){v.sort(function(a,b){return a.n.localeCompare(b.n)});var u=f+"_L"+t;l=c(u);m=c(u+' option[value=""]').html();c(u+" option").remove('[value != ""]');u=null;for(e=0;e<a;e++)g=v[e],u=g.i,w=b==u?' selected="selected"':
"",q=g.l==t?"":' class="missing"',q='<option value="'+u+'"'+w+q+">"+g.n+"</option>",l.append(q);p.removeClass("hide").show();c(f+"_L"+t+"__row1").removeClass("hide").show();l.hasClass("multiselect")&&(b={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:m,multiple:!1},l.hasClass("search")?(l.multiselect(b).multiselectfilter({label:"",placeholder:i18n.search}),c(".ui-multiselect-header").show()):(b.header=!1,l.multiselect(b)));1==a&&u&&this._lxSelect(t,u,d)}}else this.useGeocoder&&!d&&
this._geocodeDecision();d?this._serialize():this._collectData();this._zoomMap()},_collectData:function(){var a=this.data,b="#"+this.fieldname,d=this._lookupParent(),e=c(b+"_address").val(),f=c(b+"_postcode").val();a.address=e;a.postcode=f;if(a.specific)a.id=a.specific,a.parent=d;else{var h=a.lat,g=a.lon,l=a.wkt;e||f||h||g||l?(a.id=null,a.parent=d):(a.id=d,a.parent=null)}this._serialize();c(b+"_lat").val(a.lat).trigger("setvalue");c(b+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",
this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.change()},_collectLx:function(){var a=this.data,b="#"+this.fieldname,d;for(d=0;6>d;d++){var e=c(b+"_L"+d);e.length&&(e=e.val(),a["L"+d]=e?parseInt(e,10):null)}this._serialize()},_hasData:function(){var a=this.data,b=!1;a.specific||a.address||a.postcode||a.lat||a.lon||a.wkt?b=!0:[a.L0,a.L1,a.L2,a.L3,a.L4,a.L5].join("|")!=this.lx&&(b=!0);return b},_lookupParent:function(){this._collectLx();for(var a=this.data,b,d=5;-1<d;d--)if(b=a["L"+d])return b;
return(a=h.d)?a.i:null},_readLabels:function(a){a||(a="d");var b=k[a];if(b==r){var d=S3.Ap.concat("/gis/hdata/"+a);c.ajaxS3({async:!1,url:d,dataType:"script",success:function(d){b={};try{for(var c in n)b[c]=n[c];k[a]=b;n=null}catch(p){}},error:function(a,b,d){s3_debug("UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText)}})}return b},_readHierarchy:function(a,b,d){var e="#"+this.fieldname,f=c(e+"_L"+b),p=!1;f.hide();if(f.hasClass("multiselect")){p=!0;var g=c(e+"_L"+b+"__row button").hide()}var l=
c(e+"_L"+b+"__throbber").removeClass("hide").show();a=d?S3.Ap.concat("/gis/ldata/"+a+"/"+b):S3.Ap.concat("/gis/ldata/"+a);c.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)h[b]=n[b];n=null;l.hide();p?g.removeClass("hide").show():f.removeClass("hide").show()},error:function(a,b,d){a="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;s3_debug(a);S3.showAlert(a,"error");l.hide();p?g.removeClass("hide").show():f.removeClass("hide").show()}})},_geocodeDecision:function(){var a=
"#"+this.fieldname,b=this.data;this._collectData();if(b.address){for(var b=["1","2","3","4","5"],d=0,e;5>d;d++)if(e=c(a+"_L"+b[d]),e.length&&!e.val()&&1<e[0].options.length)return;c(a+"_geocode .geocode_success,"+a+"_geocode .geocode_fail").hide();var f=this,b=this.eventNamespace;this.input.data("manually_geocoded")?c(a+"_geocode button").removeClass("hide").show().unbind(b).bind("click"+b,function(){c(this).hide();f._geocode()}):this._geocode()}},_geocode:function(){for(var a=this.fieldname,b=this,
d="#"+a,e=c(d+"_geocode .geocode_fail").hide(),f=c(d+"_geocode .geocode_success").hide(),h=c(d+"_geocode .throbber").removeClass("hide").show(),g=this.data,d={address:g.address},l="postcode L0 L1 L2 L3 L4 L5".split(" "),k=0,v,m;7>k;k++)v=l[k],(m=g[v])&&(d[v]=m);l=S3.Ap.concat("/gis/geocode");c.ajaxS3({url:l,type:"POST",data:d,dataType:"json",success:function(d){var c=d.lat,p=d.lon;if(c||p){g.lat=parseFloat(c);g.lon=parseFloat(p);b._collectData();c=S3.gis;if(c.maps&&(p=c.maps["location_selector_"+
a])){d=p.s3.draftLayer;d.removeAllFeatures();var k=new OpenLayers.Geometry.Point(g.lon,g.lat);k.transform(c.proj4326,p.getProjectionObject());c=new OpenLayers.Feature.Vector(k);d.addFeatures([c]);b._zoomMap()}h.hide();f.html(i18n.address_mapped).removeClass("hide").show()}else h.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(d)},error:function(a,b,d){a="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;h.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();
s3_debug(a)}})},_geocodeReverse:function(){var a=this,b="#"+this.fieldname,d=c(b+"_geocode .geocode_fail").hide(),e=c(b+"_geocode .geocode_success").hide(),f=c(b+"_geocode .throbber").removeClass("hide").show(),b=this.data,b={lat:b.lat,lon:b.lon},h=S3.Ap.concat("/gis/geocode_r");c.ajaxS3({async:!1,url:h,type:"POST",data:b,dataType:"json",success:function(b){b.L0?(a.useGeocoder=!1,a._lxSelect(0,b.L0),b.L1&&a._lxSelect(1,b.L1),b.L2&&a._lxSelect(2,b.L2),b.L3&&a._lxSelect(3,b.L3),b.L4&&a._lxSelect(4,
b.L4),b.L5&&a._lxSelect(5,b.L5),a.useGeocoder=!0,f.hide(),e.html(i18n.location_found).removeClass("hide").show()):(f.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;f.hide();d.html(i18n.location_not_found).removeClass("hide").show();s3_debug(a)}})},_latlonInput:function(){var a=this.fieldname,b=this.data,d="#"+a,e=c(d+"_lat").val(),d=c(d+"_lon").val();e||d?(e=e?parseFloat(e):0,d=d?parseFloat(d):0,
b.lat=e,b.lon=d,b.wkt=null,this.input.data("manually_geocoded",!0)):(b.lat=null,b.lon=null,b.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(a=e.maps["location_selector_"+a])&&(d=a.s3.draftLayer,d.removeAllFeatures(),null!==b.lat&&null!==b.lon&&(b=new OpenLayers.Geometry.Point(b.lon,b.lat),b.transform(e.proj4326,a.getProjectionObject()),b=new OpenLayers.Feature.Vector(b),d.addFeatures([b]),a.s3.lastDraftFeature=b),this._zoomMap())},_showMap:function(a){var b=this.fieldname,
d=this.eventNamespace,e=this,h="#"+b;c(h+"_map_icon").unbind(d).bind("click"+d,function(){e._hideMap()});c(h+"_map_icon span").html(i18n.hide_map);d=c(h+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&a&&c("html,body").animate({scrollTop:d.offset().top},250);var p=this.input;c.when(this._jsLoaded()).then(function(a){var d=S3.gis;a="location_selector_"+b;var g=d.maps[a]?d.maps[a]:d.show_map(a);e._zoomMap();var f=e.data;a=f.lat;var k=f.lon,m=f.wkt;if(a||k||m)g.s3.draftLayer.removeAllFeatures(),
m!=r&&m?(a={internalProjection:g.getProjectionObject(),externalProjection:d.proj4326},a=(new OpenLayers.Format.WKT(a)).read(m)):(a=new OpenLayers.Geometry.Point(parseFloat(k),parseFloat(a)),a.transform(d.proj4326,g.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),g.s3.draftLayer.addFeatures([a]),g.s3.lastDraftFeature=a;a=g.controls;for(var w,k=0,u=a.length;k<u;k++)if("OpenLayers.Control.DrawFeature"==a[k].CLASS_NAME){w=a[k];break}w&&(g.s3.pointPlaced=function(a){c(h+"_geocode .geocode_fail").hide();
c(h+"_geocode .geocode_success").hide();var k=a.geometry;if("OpenLayers.Geometry.Point"==k.CLASS_NAME)a=k.getBounds().getCenterLonLat(),a.transform(g.getProjectionObject(),d.proj4326),f.wkt=null,f.lat=a.lat,f.lon=a.lon,!f.address&&e.useGeocoder&&e._geocodeReverse();else{k={internalProjection:g.getProjectionObject(),externalProjection:d.proj4326};f.radius=null;var l=new OpenLayers.Geometry.LinearRing(a.geometry.components[0].components),l=new OpenLayers.Geometry.Polygon([l]);if(1E3==l.getVertices().length){var q=
(new OpenLayers.Feature.Vector(l,null)).geometry.getBounds(),l=q.right,t=(q.bottom+q.top)/2,q=new OpenLayers.Geometry.Point((q.left+l)/2,t),l=new OpenLayers.Geometry.Point(l,t),l=new OpenLayers.Geometry.LineString([q,l]),l=parseFloat(l.getLength());f.radius=l}m=(new OpenLayers.Format.WKT(k)).write(a);f.wkt=m;f.lat=null;f.lon=null}p.data("manually_geocoded",!0);e._collectData();e._removeErrors();"sub_"==b.substring(0,4)&&p.parent().find("div.map_wrapper").trigger("change")})},function(a){s3_debug(a)},
function(a){s3_debug(a)})},_hideMap:function(){var a=this.fieldname,b=this.eventNamespace,d="#"+a,e=this;c(d+"_map_icon").unbind(b).bind("click"+b,function(a){e._showMap(a)});c(d+"_map_wrapper").slideUp("medium");var b=this.data;if(b.specific)var f=i18n.show_map_view;else if(f=i18n.show_map_add,S3.gis.maps&&(a=S3.gis.maps["location_selector_"+a]))a.s3.draftLayer.removeAllFeatures(),b.lat=null,b.lon=null,b.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();c(d+"_map_icon span").html(f)},
_zoomMap:function(a){var b=this.fieldname,d=S3.gis;if(d.maps&&(b=d.maps["location_selector_"+b])){var c=this.data,d=c.lat,f=c.lon,c=c.wkt;if(d&&f)d=OpenLayers.Bounds.fromArray([f,d,f,d]);else if(c)d=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(c))).geometry.getBounds();else{a||(a=this._lookupParent()||"d");d=h[a].b;if(!d||!d.length)for(f=h[a].f,a=4;f&&a&&(a--,f=h[f],!(d=f.b)&&0!==f.l);)f=f.f;d&&(d=OpenLayers.Bounds.fromArray(d))}d&&S3.gis.zoomBounds(b,d,this.options.minBBOX)}},_validate:function(){var a=
this.fieldname;this._removeErrors();var a="#"+a,b=this.data,d=this.options.featureRequired;if(d){var e=!1;switch(d){case "latlon":e=b.lat||b.lon;break;case "wkt":e=b.wkt;break;default:e=b.lat||b.lon||b.wkt}if(!e)return S3.fieldError(a+"_map_icon",i18n.map_feature_required),!1}var f=b.id,d="address L5 L4 L3 L2 L1 L0".split(" "),e=function(a){return a.hasClass("multiselect")?a.next("button.ui-multiselect").is(":visible"):a.is(":visible")};if(f){if(!h[f])return!0;for(var k=h[f].l,b=0;b<6-k;b++){f=a+
"_"+d[b];var g=c(f);if(g.length&&g.hasClass("required")&&e(g))return S3.fieldError(f,i18n.enter_value),!1}}else{if(b.lat||b.lon||b.wkt||b.address||b.postcode)return!0;for(b=0;7>b;b++)if(f=a+"_"+d[b],g=c(f),g.length&&g.hasClass("required")&&e(g))return S3.fieldError(f,i18n.enter_value),!1}return!0},_serialize:function(){var a=JSON.stringify(this.data);this.input.val(a);return a},_deserialize:function(){var a=this.input.val();return this.data=JSON.parse(a)},_storeHierarchyData:function(a,b){var d;if(b)for(d in b)h[d]=
b[d];if(a)for(d in a)k[d]=a[d]},_jsLoaded:function(){var a=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=r?a.resolve("loaded"):"pending"===a.state()&&(a.notify("waiting for JS to load..."),setTimeout(d,500))},1);return a.promise()},_removeErrors:function(a){a||(a="#"+this.fieldname,a=a+"_L0,"+a+"_L1,"+a+"_L2,"+a+"_L3,"+a+"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode,"+a+"_map_icon");c(a).siblings(".error").remove()},_bindEvents:function(){var a=this.fieldname,b=this.eventNamespace,d=this,
e="#"+a;c(e+"_L0").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(0)});c(e+"_L1").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(1)});c(e+"_L2").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(2)});c(e+"_L3").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(3)});c(e+"_L4").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(4)});c(e+"_L5").bind("change"+b,function(){d._removeErrors(this);d._lxSelect(5)});c(e+"_address,"+e+"_postcode").bind("change"+
b,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});c(e+"_lat,"+e+"_lon").bind("change"+b,function(){d._latlonInput()});c(e+"_latlon_toggle").bind("click"+b,function(){var a=c(this).data("mode")||d.options.latlonMode;if("dms"==a){a="decimal";var b=i18n.latlon_mode.dms}else a="dms",b=i18n.latlon_mode.decimal;c(e+"_lat").latloninput("option",{mode:a});c(e+"_lon").latloninput("option",{mode:a});c(this).html(b).data("mode",a)});if("sub_"==a.substring(0,4))this.input.closest(".inline-form").bind("validate"+
b+this.id,function(a){d._validate()||a.preventDefault()});else{var f=this.input.closest("form");f.bind("submit"+b+this.id,function(a){a.preventDefault();d._validate()&&f.unbind(b+d.id).submit()})}return!0},_unbindEvents:function(){var a="#"+this.fieldname,b=this.eventNamespace;c(a+"_L0,"+a+"_L1,"+a+"_L2,"+a+"_L3,"+a+"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode,"+a+"_map_icon,"+a+"_latlon_toggle").unbind(b);this.input.next(".error_wrapper").unbind(b);this.input.closest("form").unbind(b+self.id);return!0}})})(jQuery);
(function(c,r){var m=0;c.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){c(this.element);this.id=m;m+=1;this.eventNamespace=".latloninput"},_init:function(){c(this.element).hide();this.refresh()},_destroy:function(){c(this.element).show();c.Widget.prototype.destroy.call(this)},_setOption:function(c,k){this._super(c,k);"mode"==c&&this.refresh()},refresh:function(){this._unbindEvents();var h=c(this.element),k=this.options;this.defaultValue=
h.val();if(!this.input){var a=c("<div>").hide().insertAfter(h),b=c('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var d=k.labels,e=c('<input type="text" class="integer dms-input" size="5">'),f=c('<span class="dms-label">'+d.deg+"</span>"),p=c('<input type="text" class="integer dms-input" size="5">'),g=c('<span class="dms-label">'+d.min+"</span>"),l=c('<input type="text" class="double dms-input" size="8">'),d=c('<span class="dms-label">'+d.sec+"</span>");this.degInput=
e;this.minInput=p;this.secInput=l;this.dmsInput=e=c("<span>").append(e).append(f).append(p).append(g).append(l).append(d).hide();this.input=a.append(b).append(e).show()}this._removeErrors();"dms"==k.mode?(h=this._getDMS(),this.degInput.val(h.d),this.minInput.val(h.m),this.secInput.val(h.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(h.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var h=c(this.element).val();if(isNaN(parseFloat(h))||
!isFinite(h))return{d:"",m:"",s:""};var k=Math.abs(h);var a=60*(k-parseInt(k,10));1E-10>Math.abs(a-Math.round(a))?(a=Math.round(a),k=0):(k=60*(a-parseInt(a,10)),1E-10>Math.abs(k-Math.round(k))&&(k=Math.round(k)));return{d:parseInt(h,10),m:parseInt(a,10),s:k}},_showError:function(c,k){"all"==c?this.input.find("input").addClass("invalidinput"):c&&c.addClass("invalidinput");k&&this.input.append('<div class="error">'+k+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");
this.input.find(".error").remove()},_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var c=90;var k=i18n.latlon_error.lat}else c=180,k=i18n.latlon_error.lon;var a=this.degInput.val(),b=this.minInput.val(),d=this.secInput.val(),e=[];if(""===a&&""===b&&""===d)return"";a=parseInt(a,10)||0;b=parseInt(b,10)||0;d=parseFloat(d)||0;60<=Math.abs(b)&&(this._showError(this.minInput),e.push(i18n.latlon_error.min));60<=Math.abs(d)&&(this._showError(this.secInput),e.push(i18n.latlon_error.sec));
b=Math.abs(a)+b/60+d/3600;if(!e.length&&b>c||a>c)this._showError("all"),e.push(k);return e.length?(this._showError(null,e.join(", ")),null):(0>a?-1:1)*b},_validateDecimal:function(){this._removeErrors();var c=this.options.type,k=i18n.latlon_error.format;if("lat"==c){var a=90;var b=i18n.latlon_error.lat}else a=180,b=i18n.latlon_error.lon;var d=this.decimalInput.val();if(""===d)return"";d=this._parse(d,c);null===d?this._showError(this.decimalInput,k):Math.abs(d)>a&&(this._showError(this.decimalInput,
b),d=null);return d},_parse:function(c,k){var a="lat"==k?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,d=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,e=0,f=0,h=0;if(c.match(b)){var g=c.replace(b,"$1|$2|$3").split("|");(b=g[0]||g[2])&&(b=a[b]);e=parseFloat(g[1]);b&&Math.abs(e)!=e&&(b=null);b&&(e*=b);return e}if(c.match(d)){g=c.replace(d,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");
(b=g[0]||g[7])&&(b=a[b]);a=[];var d=[],l,m;for(m=1;6>m;m+=2){var r=g[m];(l=g[m+1])?(a.push(parseFloat(r)||0),d.push(l)):r&&(a.push(parseFloat(r)),d.push(null))}if(g=a.length){for(m=1;m<g;m++)a[m]=Math.abs(a[m]);r=a[0];Math.abs(r)!=r&&(b=1);if(1==g)l=d[0],'"'==l?h=a[0]:"'"==l?f=a[0]:l&&"\u00b0"!=l||(e=a[0]);else if(2==g)if(g=d[0],d=d[1],"\u00b0"==g)e=a[0],'"'==d?h=a[1]:"'"!=d&&d||(f=a[1]);else if(g){if("'"!=g||d&&'"'!=d)return null;f=a[0];h=a[1]}else'"'==d?(f=a[0],h=a[1]):"'"!=d&&d||(e=a[0],f=a[1]);
else{if(d[0]&&"\u00b0"!=d[0]||d[1]&&"'"!=d[1]||d[2]&&'"'!=d[2])return null;e=a[0];f=a[1];h=a[2]}e=e+f/60+h/3600;b&&(e*=b);return e}}return null},_bindEvents:function(){var h=this,k=this.eventNamespace;this.dmsInput.find("input").bind("change"+k,function(){var a=h._validateDMS();null!==a?c(h.element).val(a).change():c(h.element).val(h.defaultValue).change()});this.decimalInput.bind("change"+k,function(){var a=h._validateDecimal();null!==a?(c(h.element).val(a).change(),h.decimalInput.val(a)):c(h.element).val(h.defaultValue).change()});
c(this.element).bind("setvalue"+k,function(){h.refresh()});return!0},_unbindEvents:function(){var h=this.eventNamespace;this.input&&this.input.find("input").unbind(h);c(this.element).unbind(h);return!0}})})(jQuery);
