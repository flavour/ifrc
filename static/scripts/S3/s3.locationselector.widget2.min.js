(function(){S3.gis.locationselector=function(b,a,e,c,f,k,g,q,m,r){var d="#"+b,p=$(d),F=p.next(".error_wrapper"),B=$(d+"_L0__row"),x=$(d+"_L1__row"),t=$(d+"_L2__row"),w=$(d+"_L3__row"),A=$(d+"_L4__row"),D=$(d+"_L5__row"),E=$(d+"_address__row"),K=$(d+"_postcode__row"),H=$(d+"_map_icon__row"),L=$(d+"__row .map_wrapper").attr("id",b+"_map_wrapper");e?$(d+"__row").hide().after(L).after(H).after(B).after(x).after(t).after(w).after(A).after(D).after(K).after(E).after(F):$(d+"__row").hide().after(L).after(H).after(K).after(E).after(D).after(A).after(w).after(t).after(x).after(B).after(F);
r&&p.data("specific",r);p.data("hide_lx",a);a=$(d+"_lat").val();e=$(d+"_lon").val();r=$(d+"_wkt").val();(a||e||r)&&p.data("manually_geocoded",!0);if(c)s(b,0,c);else{B.removeClass("hide").show();c=[];for(var y in l)v=l[y],0==v.l&&(v.i=y,c.push(v));c.sort(M);B=$(d+"_L0");y=0;for(F=c.length;y<F;y++)t=c[y],x=t.i,x='<option value="'+x+'">'+t.n+"</option>",B.append(x)}f&&s(b,1,f);k&&s(b,2,k);g&&s(b,3,g);q&&s(b,4,q);m&&s(b,5,m);O(b);H.removeClass("hide").show();a||e||r?I(b):$(d+"_map_icon").click(function(){I(b);
return!1});var N=$(d+"_L0");N.change(function(){s(b,0)});var J=$(d+"_L1");J.change(function(){s(b,1)});var G=$(d+"_L2");G.change(function(){s(b,2)});var C=$(d+"_L3");C.change(function(){s(b,3)});var z=$(d+"_L4");z.change(function(){s(b,4)});var u=$(d+"_L5");u.change(function(){s(b,5)});p.closest("form").submit(function(){var a=p.val();if(a){if(!l[a])return!0;switch(l[a].l){case 0:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(u.hasClass("required"))return S3.fieldError(d+
"_L5",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),!1;if(C.hasClass("required"))return S3.fieldError(d+"_L3",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(d+"_L2",i18n.enter_value),!1;if(J.hasClass("required"))return S3.fieldError(d+"_L1",i18n.enter_value),!1;a=$("input#"+b+"_L0");a.length&&!a.hasClass("required")&&p.val("");return!0;case 1:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),
!1;if(u.hasClass("required"))return S3.fieldError(d+"_L5",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),!1;if(C.hasClass("required"))return S3.fieldError(d+"_L3",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(d+"_L2",i18n.enter_value),!1;a=$("input#"+b+"_L1");a.length&&!a.hasClass("required")&&p.val("");return!0;case 2:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(u.hasClass("required"))return S3.fieldError(d+
"_L5",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),!1;if(C.hasClass("required"))return S3.fieldError(d+"_L3",i18n.enter_value),!1;a=$("input#"+b+"_L2");a.length&&!a.hasClass("required")&&p.val("");return!0;case 3:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(u.hasClass("required"))return S3.fieldError(d+"_L5",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),
!1;a=$("input#"+b+"_L3");a.length&&!a.hasClass("required")&&p.val("");return!0;case 4:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(u.hasClass("required"))return S3.fieldError(d+"_L5",i18n.enter_value),!1;a=$("input#"+b+"_L4");a.length&&!a.hasClass("required")&&p.val("");return!0;case 5:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;a=$("input#"+b+"_L5");a.length&&!a.hasClass("required")&&p.val("");
return!0;default:return S3.showAlert("LocationSelector cannot validate!","error"),!1}}else return $(d+"_address").hasClass("required")?(S3.fieldError(d+"_address",i18n.enter_value),!1):u.hasClass("required")?(S3.fieldError(d+"_L5",i18n.enter_value),!1):z.hasClass("required")?(S3.fieldError(d+"_L4",i18n.enter_value),!1):C.hasClass("required")?(S3.fieldError(d+"_L3",i18n.enter_value),!1):G.hasClass("required")?(S3.fieldError(d+"_L2",i18n.enter_value),!1):J.hasClass("required")?(S3.fieldError(d+"_L1",
i18n.enter_value),!1):N.hasClass("required")?(S3.fieldError(d+"_L0",i18n.enter_value),!1):!0})};var s=function(b,a,e){var c="#"+b,f=$(c).data("hide_lx");e?$(c+"_L"+a).val(e):e=parseInt($(c+"_L"+a).val());if(0===a){var k=h[e];if(void 0==k){var g=S3.Ap.concat("/gis/hdata/"+e);$.ajaxS3({async:!1,url:g,dataType:"script",success:function(a){k={};for(var c in n)k[c]=n[c];h[e]=k;n=null},error:function(a,c,b){msg="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var q=h.d,m,r,
d=["1","2","3","4","5"],g=0;5>g;g++)m=d[g],r=k[m]||q[m],$(c+"_L"+m).hasClass("required")?$(c+"_L"+m+"__row label").html("<div>"+r+':<span class="req"> *</span></div>'):$(c+"_L"+m+"__row label").html(r+":")}if(e){for(m=a+1;6>m;m++)q=c+"_L"+m,f?$(q+"__row").hide():$(q+" option").remove('[value != ""]'),$(q).val("");t(b);a+=1;f=$(c+"_L"+a+"__row");if(f.length){f.removeClass("hide").show();f=!0;for(g in l)if(l[g].f==e){f=!1;break}f&&P(b,a,e);f=[];for(g in l)m=l[g],m.l==a&&m.f==e&&(m.i=g,f.push(m));f.sort(M);
m=f.length;var p,q=$(c+"_L"+a);$(c+"_L"+a+" option").remove('[value != ""]');for(g=0;g<m;g++)c=f[g],p=c.i,r=e==p?' selected="selected"':"",c='<option value="'+p+'"'+r+">"+c.n+"</option>",q.append(c);if(1==m){s(b,a,p);return}}else $(c+"_geocode button").length&&D(b)}else for(t(b),m=a+1;6>m;m++)q=c+"_L"+m,f?$(q+"__row").hide():$(q+" option").remove('[value != ""]'),$(q).val("");A(b)},M=function(b,a){b=b.n;var e=[b,a.n];e.sort();return e[0]==b?-1:1},P=function(b,a,e){b="#"+b;var c=$(b+"_L"+a);c.hide();
var f=$(b+"_L"+a+"__throbber");f.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+e);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;f.hide();c.removeClass("hide").show()},error:function(a,b,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText;s3_debug(msg);S3.showAlert(msg,"error");f.hide();c.removeClass("hide").show()}})},w=function(b){b="#"+b+"_L";for(var a,e=5;-1<e;e--)if(a=$(b+e).val())return a;return l.d.id},t=function(b){var a=
"#"+b,e=$(a+"_parent"),c=$(a);if(c.data("specific"))c=w(b),e.val(c);else{var f=$(a+"_address").val(),k=$(a+"_postcode").val(),g=$(a+"_lat").val(),q=$(a+"_lon").val(),a=$(a+"_wkt").val();f||k||g||q||a?(c.val("dummy"),c=w(b),e.val(c)):(b=w(b),c.val(b),e.val(""))}},O=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();$(a+"_geocode button").length&&$(a+"_address,"+a+"_postcode").change(function(){D(b)})},D=function(b){var a="#"+b;if($(a+
"_address").val()){var e,c,f=["1","2","3","4","5"];for(e=0;5>e;e++)if(c=f[e],c=$(a+"_L"+c),c.length&&!c.val())return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();E(b);t(b)})):E(b);t(b)}},E=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");e.hide();c.hide();var f=$(a+"_geocode .throbber");f.removeClass("hide").show();
var k={address:$(a+"_address").val()},g=$(a+"_postcode").val();g&&(k.postcode=g);if(g=$(a+"_L0").val())k.L0=g;if(g=$(a+"_L1").val())k.L1=g;if(g=$(a+"_L2").val())k.L2=g;if(g=$(a+"_L3").val())k.L3=g;if(g=$(a+"_L4").val())k.L4=g;if(g=$(a+"_L5").val())k.L5=g;g=S3.Ap.concat("/gis/geocode");$.ajaxS3({url:g,type:"POST",data:k,dataType:"json",success:function(k){var g=k.lat,r=k.lon;if(g||r){$(a+"_lat").val(g);$(a+"_lon").val(r);gis=S3.gis;if(gis.maps){var d=gis.maps["location_selector_"+b];d&&(k=d.s3.draftLayer,
k.removeAllFeatures(),g=new OpenLayers.Geometry.Point(parseFloat(r),parseFloat(g)),g.transform(gis.proj4326,d.getProjectionObject()),g=new OpenLayers.Feature.Vector(g),k.addFeatures([g]),A(b))}f.hide();c.html(i18n.address_mapped).removeClass("hide").show()}else f.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(k)},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;f.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},
Q=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");e.hide();c.hide();var f=$(a+"_geocode .throbber");f.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),
b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),f.hide(),c.html(i18n.location_found).removeClass("hide").show()):(f.hide(),e.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;f.hide();e.html(i18n.location_not_found).removeClass("hide").show();s3_debug(msg)}})},R=function(b){var a="#"+b;$(a+
"_map_icon").unbind("click").click(function(){I(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");t(b)},S=function(){var b=new jQuery.Deferred;setTimeout(function e(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(e,500))},1);return b.promise()},I=function(b,a){var e="#"+b;$(e+"_map_icon").unbind("click").click(function(){R(b)});$(e+"_map_wrapper").removeClass("hide").show();
$.when(S()).then(function(a){a="location_selector_"+b;var f=S3.gis;if(!f.maps[a]){var k=f.show_map(a),g=$(e);$(e+"_parent");A(b);var q=$(e+"_lat"),m=$(e+"_lon"),r=$(e+"_wkt"),d=q.val(),p=m.val();a=r.val();if(d||p||a)void 0!=a?(d={internalProjection:k.getProjectionObject(),externalProjection:f.proj4326},a=(new OpenLayers.Format.WKT(d)).read(a)):(a=new OpenLayers.Geometry.Point(parseFloat(p),parseFloat(d)),a.transform(f.proj4326,k.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),k.s3.draftLayer.addFeatures([a]),
t(b);var s;a=k.controls;d=0;for(p=a.length;d<p;d++)if("OpenLayers.Control.DrawFeature"==a[d].CLASS_NAME){s=a[d];break}s&&(k.s3.pointPlaced=function(a){$(e+"_geocode .geocode_fail").hide();$(e+"_geocode .geocode_success").hide();a=a.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(k.getProjectionObject(),f.proj4326),q.val(a.lat),m.val(a.lon),g.data("manually_geocoded",!0),Q(b)):(a=a.transform(k.getProjectionObject(),f.proj4326).toString(),r.val(a));
t(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},A=function(b,a){var e=S3.gis;if(e.maps&&(e=e.maps["location_selector_"+b])){var c="#"+b,f=$(c+"_lat").val(),c=$(c+"_lon").val();if(f&&c)f=[c-0.032,f-0.032,c+0.032,f+0.032];else if(a||(a=w(b)||"d"),f=l[a].b,!f&&(c=l[a].f,c=l[c]))if(f=c.b,!f&&(c=c.f,c=l[c]))if(f=c.b,!f&&(c=c.f,c=l[c]))f=c.b;f&&(f=OpenLayers.Bounds.fromArray(f),S3.gis.zoomBounds(e,f))}}})();
