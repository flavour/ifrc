(function(){S3.gis.locationselector=function(b,a,c,d,e,g,f,m,r,q){var k="#"+b,u=$(k),w=u.next(".error_wrapper"),A=$(k+"_L0__row"),s=$(k+"_L1__row"),t=$(k+"_L2__row"),y=$(k+"_L3__row"),z=$(k+"_L4__row"),D=$(k+"_L5__row"),E=$(k+"_address__row"),F=$(k+"_postcode__row"),B=$(k+"_map_icon__row"),G=$(k+"__row .map_wrapper").attr("id",b+"_map_wrapper");c?$(k+"__row").hide().after(G).after(B).after(A).after(s).after(t).after(y).after(z).after(D).after(F).after(E).after(w):$(k+"__row").hide().after(G).after(B).after(F).after(E).after(D).after(z).after(y).after(t).after(s).after(A).after(w);
q&&u.data("specific",q);u.data("hide_lx",a);if(d)p(b,0,d);else{A.removeClass("hide").show();a=[];for(var x in l)v=l[x],0==v.l&&(v.i=x,a.push(v));a.sort(H);c=$(k+"_L0");x=0;for(d=a.length;x<d;x++)u=a[x],q=u.i,q='<option value="'+q+'">'+u.n+"</option>",c.append(q)}e&&p(b,1,e);g&&p(b,2,g);f&&p(b,3,f);m&&p(b,4,m);r&&p(b,5,r);I(b);B.removeClass("hide").show();e=$(k+"_lat").val();g=$(k+"_lon").val();f=$(k+"_wkt").val();e||g||f?C(b):$(k+"_map_icon").click(function(){C(b);return!1});$(k+"_L0").change(function(){p(b,
0)});$(k+"_L1").change(function(){p(b,1)});$(k+"_L2").change(function(){p(b,2)});$(k+"_L3").change(function(){p(b,3)});$(k+"_L4").change(function(){p(b,4)});$(k+"_L5").change(function(){p(b,5)})};var p=function(b,a,c){var d="#"+b,e=$(d).data("hide_lx");c?$(d+"_L"+a).val(c):c=parseInt($(d+"_L"+a).val());if(0===a){var g=h[c];if(void 0==g){var f=S3.Ap.concat("/gis/hdata/"+c);$.ajaxS3({async:!1,url:f,dataType:"script",success:function(a){g={};for(var b in n)g[b]=n[b];h[c]=g;n=null},error:function(a,b,
d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}var f=h.d,m=g["1"]||f["1"];$(d+"_L1__row label").html(m+":");m=g["2"]||f["2"];$(d+"_L2__row label").html(m+":");m=g["3"]||f["3"];$(d+"_L3__row label").html(m+":");m=g["4"]||f["4"];$(d+"_L4__row label").html(m+":");m=g["5"]||f["5"];$(d+"_L5__row label").html(m+":")}if(c){for(f=a+1;6>f;f++)m=d+"_L"+f,e?$(m+"__row").hide():$(m+" option").remove('[value != ""]'),$(m).val("");s(b);a+=1;e=$(d+"_L"+a+"__row");if(e.length){e.removeClass("hide").show();
var e=!0,r;for(r in l)l[r].f==c&&(e=!1);e&&J(b,a,c);e=[];for(r in l)v=l[r],v.l==a&&v.f==c&&(v.i=r,e.push(v));e.sort(H);var q,f=$(d+"_L"+a);$(d+"_L"+a+" option").remove('[value != ""]');r=0;for(a=e.length;r<a;r++)m=e[r],d=m.i,q=c==d?' selected="selected"':"",d='<option value="'+d+'"'+q+">"+m.n+"</option>",f.append(d)}}else for(0===a?c="d":(c=$(d+"_L"+(a-1)).val())||(c="d"),s(b),f=a+1;6>f;f++)m=d+"_L"+f,e?$(m+"__row").hide():$(m+" option").remove('[value != ""]'),$(m).val("");y(b,c)},H=function(b,a){b=
b.n;var c=[b,a.n];c.sort();return c[0]==b?-1:1},J=function(b,a,c){b="#"+b;var d=$(b+"_L"+a);d.hide();var e=$(b+"_L"+a+"__throbber");e.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+c);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;e.hide();d.removeClass("hide").show()},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;s3_debug(msg);alert(msg);e.hide();d.removeClass("hide").show()}})},t=function(b){b="#"+b+"_L";
for(var a,c=5;-1<c;c--)if(a=$(b+c).val())return a;return l.d.id},s=function(b){var a="#"+b,c=$(a+"_parent"),d=$(a);if(d.data("specific"))d=t(b),c.val(d);else{var e=$(a+"_address").val(),g=$(a+"_postcode").val(),f=$(a+"_lat").val(),m=$(a+"_lon").val(),a=$(a+"_wkt").val();e||g||f||m||a?(d.val("dummy"),d=t(b),c.val(d)):(b=t(b),d.val(b),c.val(""))}},I=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();var c=$(a+"_geocode button");c.length&&
$(a+"_address").change(function(){$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),c.removeClass("hide").show().click(function(){$(this).hide();z(b);s(b)})):z(b);s(b)})},z=function(b){var a="#"+b,c=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");c.hide();d.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();var g={address:$(a+"_address").val()},f=$(a+"_postcode").val();f&&(g.postcode=f);if(f=$(a+"_L0").val())g.L0=
f;if(f=$(a+"_L1").val())g.L1=f;if(f=$(a+"_L2").val())g.L2=f;if(f=$(a+"_L3").val())g.L3=f;if(f=$(a+"_L4").val())g.L4=f;if(f=$(a+"_L5").val())g.L5=f;f=S3.Ap.concat("/gis/geocode");$.ajaxS3({async:!1,url:f,type:"POST",data:g,dataType:"json",success:function(g){var f=g.lat,q=g.lon;if(f||q){$(a+"_lat").val(f);$(a+"_lon").val(q);gis=S3.gis;if(gis.maps){var k=gis.maps["location_selector_"+b];k&&(g=k.s3.draftLayer,g.removeAllFeatures(),f=new OpenLayers.Geometry.Point(parseFloat(q),parseFloat(f)),f.transform(gis.proj4326,
k.getProjectionObject()),f=new OpenLayers.Feature.Vector(f),g.addFeatures([f]))}e.hide();d.html(i18n.address_mapped).removeClass("hide").show()}else e.hide(),c.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(g)},error:function(a,b,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;e.hide();c.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},K=function(b){var a="#"+b,c=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");c.hide();
d.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),
$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),e.hide(),d.html(i18n.location_found).removeClass("hide").show()):(e.hide(),c.html(i18n.location_not_found).removeClass("hide").show())},error:function(b,a,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:b.responseText;e.hide();c.html(i18n.location_not_found).removeClass("hide").show();s3_debug(msg)}})},L=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){C(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+
b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");s(b)},M=function(){var b=new jQuery.Deferred;setTimeout(function c(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(c,500))},1);return b.promise()},C=function(b,a){var c="#"+b;$(c+"_map_icon").unbind("click").click(function(){L(b)});$(c+"_map_wrapper").removeClass("hide").show();$.when(M()).then(function(a){a="location_selector_"+b;var e=S3.gis;if(!e.maps[a]){var g=
e.show_map(a),f=$(c);$(c+"_parent");(a=t(b))||(a="d");y(b,a);var m=$(c+"_lat"),r=$(c+"_lon"),q=$(c+"_wkt"),k=m.val(),p=r.val();a=q.val();if(k||p||a)void 0!=a?(k={internalProjection:g.getProjectionObject(),externalProjection:e.proj4326},a=(new OpenLayers.Format.WKT(k)).read(a)):(a=new OpenLayers.Geometry.Point(parseFloat(p),parseFloat(k)),a.transform(e.proj4326,g.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),g.s3.draftLayer.addFeatures([a]),s(b);var w;a=g.controls;k=0;for(p=a.length;k<
p;k++)if("OpenLayers.Control.DrawFeature"==a[k].CLASS_NAME){w=a[k];break}w&&w.events.register("featureadded",null,function(a){$(c+"_geocode .geocode_fail").hide();$(c+"_geocode .geocode_success").hide();a=a.feature.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(g.getProjectionObject(),e.proj4326),m.val(a.lat),r.val(a.lon),f.data("manually_geocoded",!0),K(b)):(a=a.transform(g.getProjectionObject(),e.proj4326).toString(),q.val(a));s(b)})}},function(a){s3_debug(a)},
function(a){s3_debug(a)})},y=function(b,a){if(S3.gis.maps){var c=S3.gis.maps["location_selector_"+b];if(c){var d=l[a].b;if(!d){var e=l[a].f;if(e=l[e])if(d=e.b,!d&&(e=e.f,e=l[e]))if(d=e.b,!d&&(e=e.f,e=l[e]))d=e.b}d&&(d=OpenLayers.Bounds.fromArray(d).transform(S3.gis.proj4326,c.getProjectionObject()),c.zoomToExtent(d))}}}})();
