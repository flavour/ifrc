(function(){S3.gis.locationselector=function(b,a,c,d,e,f,g,p,m,q){var k="#"+b,w=$(k),D=w.next(".error_wrapper"),A=$(k+"_L0__row"),s=$(k+"_L1__row"),u=$(k+"_L2__row"),t=$(k+"_L3__row"),y=$(k+"_L4__row"),z=$(k+"_L5__row"),E=$(k+"_address__row"),F=$(k+"_postcode__row"),B=$(k+"_map_icon__row"),G=$(k+"__row .map_wrapper").attr("id",b+"_map_wrapper");c?$(k+"__row").hide().after(G).after(B).after(A).after(s).after(u).after(t).after(y).after(z).after(F).after(E).after(D):$(k+"__row").hide().after(G).after(B).after(F).after(E).after(z).after(y).after(t).after(u).after(s).after(A).after(D);
q&&w.data("specific",q);w.data("hide_lx",a);if(d)r(b,0,d);else{A.removeClass("hide").show();a=[];for(var x in l)v=l[x],0==v.l&&(v.i=x,a.push(v));a.sort(H);c=$(k+"_L0");x=0;for(d=a.length;x<d;x++)w=a[x],q=w.i,q='<option value="'+q+'">'+w.n+"</option>",c.append(q)}e&&r(b,1,e);f&&r(b,2,f);g&&r(b,3,g);p&&r(b,4,p);m&&r(b,5,m);I(b);B.removeClass("hide").show();e=$(k+"_lat").val();f=$(k+"_lon").val();g=$(k+"_wkt").val();e||f||g?C(b):$(k+"_map_icon").click(function(){C(b);return!1});$(k+"_L0").change(function(){r(b,
0)});$(k+"_L1").change(function(){r(b,1)});$(k+"_L2").change(function(){r(b,2)});$(k+"_L3").change(function(){r(b,3)});$(k+"_L4").change(function(){r(b,4)});$(k+"_L5").change(function(){r(b,5)})};var r=function(b,a,c){var d="#"+b,e=$(d).data("hide_lx");c?$(d+"_L"+a).val(c):c=parseInt($(d+"_L"+a).val());if(0===a){var f=h[c];if(void 0==f){var g=S3.Ap.concat("/gis/hdata/"+c);$.ajaxS3({async:!1,url:g,dataType:"script",success:function(a){f={};for(var b in n)f[b]=n[b];h[c]=f;n=null},error:function(a,b,
d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var p=h.d,m,q,k=["1","2","3","4","5"],g=0;5>g;g++)m=k[g],q=f[m]||p[m],m=$(d+"_L"+m+"__row label"),m.hasClass("required")?m.html("<div>"+q+':<span class="req"> *</span></div>'):m.html(q+":")}if(c){for(m=a+1;6>m;m++)p=d+"_L"+m,e?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");s(b);a+=1;e=$(d+"_L"+a+"__row");if(e.length){e.removeClass("hide").show();e=!0;for(g in l)l[g].f==c&&(e=!1);e&&J(b,a,
c);e=[];for(g in l)v=l[g],v.l==a&&v.f==c&&(v.i=g,e.push(v));e.sort(H);p=$(d+"_L"+a);$(d+"_L"+a+" option").remove('[value != ""]');g=0;for(a=e.length;g<a;g++)m=e[g],d=m.i,q=c==d?' selected="selected"':"",d='<option value="'+d+'"'+q+">"+m.n+"</option>",p.append(d)}else $(d+"_geocode button").length&&t(b)}else for(0===a?c="d":(c=$(d+"_L"+(a-1)).val())||(c="d"),s(b),m=a+1;6>m;m++)p=d+"_L"+m,e?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");y(b,c)},H=function(b,a){b=b.n;var c=[b,
a.n];c.sort();return c[0]==b?-1:1},J=function(b,a,c){b="#"+b;var d=$(b+"_L"+a);d.hide();var e=$(b+"_L"+a+"__throbber");e.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+c);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;e.hide();d.removeClass("hide").show()},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;s3_debug(msg);alert(msg);e.hide();d.removeClass("hide").show()}})},u=function(b){b="#"+b+"_L";for(var a,
c=5;-1<c;c--)if(a=$(b+c).val())return a;return l.d.id},s=function(b){var a="#"+b,c=$(a+"_parent"),d=$(a);if(d.data("specific"))d=u(b),c.val(d);else{var e=$(a+"_address").val(),f=$(a+"_postcode").val(),g=$(a+"_lat").val(),p=$(a+"_lon").val(),a=$(a+"_wkt").val();e||f||g||p||a?(d.val("dummy"),d=u(b),c.val(d)):(b=u(b),d.val(b),c.val(""))}},I=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();$(a+"_geocode button").length&&$(a+"_address,"+
a+"_postcode").change(function(){t(b)})},t=function(b){var a="#"+b;if($(a+"_address").val()){var c,d,e=["1","2","3","4","5"];for(c=0;5>c;c++)if(d=e[c],d=$(a+"_L"+d),d.length&&!d.val())return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();z(b);s(b)})):z(b);s(b)}},z=function(b){var a="#"+b,c=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");c.hide();
d.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();var f={address:$(a+"_address").val()},g=$(a+"_postcode").val();g&&(f.postcode=g);if(g=$(a+"_L0").val())f.L0=g;if(g=$(a+"_L1").val())f.L1=g;if(g=$(a+"_L2").val())f.L2=g;if(g=$(a+"_L3").val())f.L3=g;if(g=$(a+"_L4").val())f.L4=g;if(g=$(a+"_L5").val())f.L5=g;g=S3.Ap.concat("/gis/geocode");$.ajaxS3({async:!1,url:g,type:"POST",data:f,dataType:"json",success:function(f){var g=f.lat,q=f.lon;if(g||q){$(a+"_lat").val(g);$(a+"_lon").val(q);
gis=S3.gis;if(gis.maps){var k=gis.maps["location_selector_"+b];k&&(f=k.s3.draftLayer,f.removeAllFeatures(),g=new OpenLayers.Geometry.Point(parseFloat(q),parseFloat(g)),g.transform(gis.proj4326,k.getProjectionObject()),g=new OpenLayers.Feature.Vector(g),f.addFeatures([g]))}e.hide();d.html(i18n.address_mapped).removeClass("hide").show()}else e.hide(),c.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(f)},error:function(a,b,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;
e.hide();c.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},K=function(b){var a="#"+b,c=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");c.hide();d.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),
$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),e.hide(),d.html(i18n.location_found).removeClass("hide").show()):(e.hide(),c.html(i18n.location_not_found).removeClass("hide").show())},error:function(b,a,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:b.responseText;e.hide();c.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(msg)}})},L=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){C(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");s(b)},M=function(){var b=new jQuery.Deferred;setTimeout(function c(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(c,500))},1);return b.promise()},C=function(b,a){var c="#"+b;$(c+"_map_icon").unbind("click").click(function(){L(b)});
$(c+"_map_wrapper").removeClass("hide").show();$.when(M()).then(function(a){a="location_selector_"+b;var e=S3.gis;if(!e.maps[a]){var f=e.show_map(a),g=$(c);$(c+"_parent");(a=u(b))||(a="d");y(b,a);var p=$(c+"_lat"),m=$(c+"_lon"),q=$(c+"_wkt"),k=p.val(),r=m.val();a=q.val();if(k||r||a)void 0!=a?(k={internalProjection:f.getProjectionObject(),externalProjection:e.proj4326},a=(new OpenLayers.Format.WKT(k)).read(a)):(a=new OpenLayers.Geometry.Point(parseFloat(r),parseFloat(k)),a.transform(e.proj4326,f.getProjectionObject()),
a=new OpenLayers.Feature.Vector(a)),f.s3.draftLayer.addFeatures([a]),s(b);var t;a=f.controls;k=0;for(r=a.length;k<r;k++)if("OpenLayers.Control.DrawFeature"==a[k].CLASS_NAME){t=a[k];break}t&&(f.s3.pointPlaced=function(a){$(c+"_geocode .geocode_fail").hide();$(c+"_geocode .geocode_success").hide();a=a.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(f.getProjectionObject(),e.proj4326),p.val(a.lat),m.val(a.lon),g.data("manually_geocoded",!0),K(b)):(a=
a.transform(f.getProjectionObject(),e.proj4326).toString(),q.val(a));s(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},y=function(b,a){var c=S3.gis;if(c.maps){var d=c.maps["location_selector_"+b];if(d){var e=l[a].b;if(!e){var f=l[a].f;if(f=l[f])if(e=f.b,!e&&(f=f.f,f=l[f]))if(e=f.b,!e&&(f=f.f,f=l[f]))e=f.b}e&&(e=OpenLayers.Bounds.fromArray(e).transform(c.proj4326,d.getProjectionObject()),d.zoomToExtent(e))}}}})();
