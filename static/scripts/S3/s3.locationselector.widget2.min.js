(function(){S3.gis.locationselector=function(b,a,c,d,e,k,h,q){var f="#"+b,m=$(f),p=m.next(".error_wrapper"),r=$(f+"_L0__row"),t=$(f+"_L1__row"),u=$(f+"_L2__row"),w=$(f+"_L3__row"),y=$(f+"_L4__row"),z=$(f+"_L5__row"),A=$(f+"_address__row"),x=$(f+"_map_icon__row"),B=$(f+"__row .map_wrapper").attr("id",b+"_map_wrapper");$(f+"__row").hide().after(B).after(x).after(A).after(z).after(y).after(w).after(u).after(t).after(r).after(p);q&&m.data("specific",q);a&&g(b,0,a);c&&g(b,1,c);d&&g(b,2,d);e&&g(b,3,e);
k&&g(b,4,k);h&&g(b,5,h);C(b);x.show();a=$(f+"_lat").val();c=$(f+"_lon").val();a||c?s(b):$(f+"_map_icon").click(function(){s(b)});$(f+"_L0").change(function(){g(b,0)});$(f+"_L1").change(function(){g(b,1)});$(f+"_L2").change(function(){g(b,2)});$(f+"_L3").change(function(){g(b,3)});$(f+"_L4").change(function(){g(b,4)});$(f+"_L5").change(function(){g(b,5)})};var g=function(b,a,c){var d="#"+b;c?$(d+"_L"+a).val(c):c=$(d+"_L"+a).val();if(c){for(var e=a+1;6>e;e++){var k=d+"_L"+e;$(k+"__row").hide();$(k).val("")}m(b);
a+=1;e=$(d+"_L"+a+"__row");if(e.length){e.show();var e=!0,h;for(h in l)l[h].f==c&&(e=!1);e&&t(b,a,c);e=[];for(h in l)v=l[h],v.l==a&&v.f==c&&(v.i=h,e.push(v));e.sort(u);var g,f,k=$(d+"_L"+a);$(d+"_L"+a+" option").remove('[value != ""]');h=0;for(a=e.length;h<a;h++)g=e[h],d=g.i,f=c==d?' selected="selected"':"",d='<option value="'+d+'"'+f+">"+g.n+"</option>",k.append(d)}}else{0===a?c="d":(c=$(d+"_L"+(a-1)).val())||(c="d");m(b);for(e=a+1;6>e;e++)k=d+"_L"+e,$(k+"__row").hide(),$(k).val("")}r(b,c)},u=function(b,
a){b=b.n;var c=[b,a.n];c.sort();return c[0]==b?-1:1},t=function(b,a,c){var d=$("#"+b+"_L"+a+"__throbber");d.show();b=S3.Ap.concat("/gis/ldata/"+c);$.ajax({async:!1,url:b,success:function(a){for(var b in n)l[b]=n[b];n=null;d.hide()},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText},dataType:"script"})},p=function(b){b="#"+b+"_L";for(var a,c=5;-1<c;c--)if(a=$(b+c).val())return a;return l.d.id},m=function(b){var a="#"+b,c=$(a+"_parent"),d=$(a);if(d.data("specific"))d=
p(b),c.val(d);else{var e=$(a+"_address").val(),g=$(a+"_lat").val(),a=$(a+"_lon").val();!e&&!g&&!a?(b=p(b),d.val(b),c.val("")):(d.val("dummy"),d=p(b),c.val(d))}},C=function(b){var a="#"+b;$(a+"_address__row").show();$(a+"_address").change(function(){m(b)})},w=function(b){var a="#"+b,c=$(a+"_map_icon");c.unbind("click");c.click(function(){s(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");m(b)},s=function(b){var a=
"#"+b,c=$(a+"_map_icon");c.unbind("click");c.click(function(){w(b)});$(a+"_map_wrapper").show();c="location_selector_"+b;if(!S3.gis.maps||!S3.gis.maps[c]){var d=S3.gis.show_map(c,{});$(a);$(a+"_parent");(c=p(b))||(c="d");r(b,c);var e=$(a+"_lat"),g=$(a+"_lon"),a=e.val(),c=g.val();void 0!=a&&(a=new OpenLayers.Geometry.Point(parseFloat(c),parseFloat(a)),a.transform(S3.gis.proj4326,d.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),d.s3.draftLayer.addFeatures([a]),m(b));for(var h,a=d.controls,
c=0,q=a.length;c<q;c++)"OpenLayers.Control.DrawFeature"==a[c].CLASS_NAME&&(h=a[c]);h&&h.events.register("featureadded",null,function(a){a=a.feature.geometry.getBounds().getCenterLonLat();a.transform(d.getProjectionObject(),S3.gis.proj4326);e.val(a.lat);g.val(a.lon);m(b)})}},r=function(b,a){if(S3.gis.maps){var c=S3.gis.maps["location_selector_"+b];if(c){var d=l[a].b;if(!d){var e=l[a].f;if(e=l[e])if(d=e.b,!d&&(e=e.f,e=l[e]))if(d=e.b,!d&&(e=e.f,e=l[e]))d=e.b}d&&(d=OpenLayers.Bounds.fromArray(d).transform(S3.gis.proj4326,
c.getProjectionObject()),c.zoomToExtent(d))}}}})();
