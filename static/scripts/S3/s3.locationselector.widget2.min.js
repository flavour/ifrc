(function(){S3.gis.locationselector=function(b,a,d,c,e,k,f,p,m,q){var g="#"+b,r=$(g),w=r.next(".error_wrapper"),z=$(g+"_L0__row"),t=$(g+"_L1__row"),u=$(g+"_L2__row"),y=$(g+"_L3__row"),A=$(g+"_L4__row"),B=$(g+"_L5__row"),E=$(g+"_address__row"),F=$(g+"_postcode__row"),C=$(g+"_map_icon__row"),G=$(g+"__row .map_wrapper").attr("id",b+"_map_wrapper");d?$(g+"__row").hide().after(G).after(C).after(z).after(t).after(u).after(y).after(A).after(B).after(F).after(E).after(w):$(g+"__row").hide().after(G).after(C).after(F).after(E).after(B).after(A).after(y).after(u).after(t).after(z).after(w);
q&&r.data("specific",q);r.data("hide_lx",a);a=$(g+"_lat").val();d=$(g+"_lon").val();q=$(g+"_wkt").val();(a||d||q)&&r.data("manually_geocoded",!0);if(c)s(b,0,c);else{z.removeClass("hide").show();c=[];for(var x in l)v=l[x],0==v.l&&(v.i=x,c.push(v));c.sort(H);r=$(g+"_L0");x=0;for(z=c.length;x<z;x++)t=c[x],w=t.i,w='<option value="'+w+'">'+t.n+"</option>",r.append(w)}e&&s(b,1,e);k&&s(b,2,k);f&&s(b,3,f);p&&s(b,4,p);m&&s(b,5,m);I(b);C.removeClass("hide").show();a||d||q?D(b):$(g+"_map_icon").click(function(){D(b);
return!1});$(g+"_L0").change(function(){s(b,0)});$(g+"_L1").change(function(){s(b,1)});$(g+"_L2").change(function(){s(b,2)});$(g+"_L3").change(function(){s(b,3)});$(g+"_L4").change(function(){s(b,4)});$(g+"_L5").change(function(){s(b,5)})};var s=function(b,a,d){var c="#"+b,e=$(c).data("hide_lx");d?$(c+"_L"+a).val(d):d=parseInt($(c+"_L"+a).val());if(0===a){var k=h[d];if(void 0==k){var f=S3.Ap.concat("/gis/hdata/"+d);$.ajaxS3({async:!1,url:f,dataType:"script",success:function(a){k={};for(var c in n)k[c]=
n[c];h[d]=k;n=null},error:function(a,c,b){msg="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var p=h.d,m,q,g=["1","2","3","4","5"],f=0;5>f;f++)m=g[f],q=k[m]||p[m],m=$(c+"_L"+m+"__row label"),m.hasClass("required")?m.html("<div>"+q+':<span class="req"> *</span></div>'):m.html(q+":")}if(d){for(m=a+1;6>m;m++)p=c+"_L"+m,e?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");t(b);a+=1;e=$(c+"_L"+a+"__row");if(e.length){e.removeClass("hide").show();e=!0;
for(f in l)l[f].f==d&&(e=!1);e&&J(b,a,d);e=[];for(f in l)v=l[f],v.l==a&&v.f==d&&(v.i=f,e.push(v));e.sort(H);var p=e.length,r;m=$(c+"_L"+a);$(c+"_L"+a+" option").remove('[value != ""]');for(f=0;f<p;f++)c=e[f],r=c.i,q=d==r?' selected="selected"':"",c='<option value="'+r+'"'+q+">"+c.n+"</option>",m.append(c);if(1==p){s(b,a,r);return}}else $(c+"_geocode button").length&&A(b)}else for(t(b),m=a+1;6>m;m++)p=c+"_L"+m,e?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");y(b)},H=function(b,
a){b=b.n;var d=[b,a.n];d.sort();return d[0]==b?-1:1},J=function(b,a,d){b="#"+b;var c=$(b+"_L"+a);c.hide();var e=$(b+"_L"+a+"__throbber");e.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+d);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;e.hide();c.removeClass("hide").show()},error:function(a,b,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;s3_debug(msg);S3.showAlert(msg,"error");e.hide();c.removeClass("hide").show()}})},u=function(b){b=
"#"+b+"_L";for(var a,d=5;-1<d;d--)if(a=$(b+d).val())return a;return l.d.id},t=function(b){var a="#"+b,d=$(a+"_parent"),c=$(a);if(c.data("specific"))c=u(b),d.val(c);else{var e=$(a+"_address").val(),k=$(a+"_postcode").val(),f=$(a+"_lat").val(),p=$(a+"_lon").val(),a=$(a+"_wkt").val();e||k||f||p||a?(c.val("dummy"),c=u(b),d.val(c)):(b=u(b),c.val(b),d.val(""))}},I=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();$(a+"_geocode button").length&&
$(a+"_address,"+a+"_postcode").change(function(){A(b)})},A=function(b){var a="#"+b;if($(a+"_address").val()){var d,c,e=["1","2","3","4","5"];for(d=0;5>d;d++)if(c=e[d],c=$(a+"_L"+c),c.length&&!c.val())return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();B(b);t(b)})):B(b);t(b)}},B=function(b){var a="#"+b,d=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");
d.hide();c.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();var k={address:$(a+"_address").val()},f=$(a+"_postcode").val();f&&(k.postcode=f);if(f=$(a+"_L0").val())k.L0=f;if(f=$(a+"_L1").val())k.L1=f;if(f=$(a+"_L2").val())k.L2=f;if(f=$(a+"_L3").val())k.L3=f;if(f=$(a+"_L4").val())k.L4=f;if(f=$(a+"_L5").val())k.L5=f;f=S3.Ap.concat("/gis/geocode");$.ajaxS3({url:f,type:"POST",data:k,dataType:"json",success:function(k){var f=k.lat,q=k.lon;if(f||q){$(a+"_lat").val(f);$(a+"_lon").val(q);
gis=S3.gis;if(gis.maps){var g=gis.maps["location_selector_"+b];g&&(k=g.s3.draftLayer,k.removeAllFeatures(),f=new OpenLayers.Geometry.Point(parseFloat(q),parseFloat(f)),f.transform(gis.proj4326,g.getProjectionObject()),f=new OpenLayers.Feature.Vector(f),k.addFeatures([f]),y(b))}e.hide();c.html(i18n.address_mapped).removeClass("hide").show()}else e.hide(),d.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(k)},error:function(a,c,b){msg="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText;
e.hide();d.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},K=function(b){var a="#"+b,d=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");d.hide();c.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),
$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),e.hide(),c.html(i18n.location_found).removeClass("hide").show()):(e.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(b,a,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:b.responseText;e.hide();d.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(msg)}})},L=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){D(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");t(b)},M=function(){var b=new jQuery.Deferred;setTimeout(function d(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(d,500))},1);return b.promise()},D=function(b,a){var d="#"+b;$(d+"_map_icon").unbind("click").click(function(){L(b)});
$(d+"_map_wrapper").removeClass("hide").show();$.when(M()).then(function(a){a="location_selector_"+b;var e=S3.gis;if(!e.maps[a]){var k=e.show_map(a),f=$(d);$(d+"_parent");y(b);var p=$(d+"_lat"),m=$(d+"_lon"),q=$(d+"_wkt"),g=p.val(),r=m.val();a=q.val();if(g||r||a)void 0!=a?(g={internalProjection:k.getProjectionObject(),externalProjection:e.proj4326},a=(new OpenLayers.Format.WKT(g)).read(a)):(a=new OpenLayers.Geometry.Point(parseFloat(r),parseFloat(g)),a.transform(e.proj4326,k.getProjectionObject()),
a=new OpenLayers.Feature.Vector(a)),k.s3.draftLayer.addFeatures([a]),t(b);var s;a=k.controls;g=0;for(r=a.length;g<r;g++)if("OpenLayers.Control.DrawFeature"==a[g].CLASS_NAME){s=a[g];break}s&&(k.s3.pointPlaced=function(a){$(d+"_geocode .geocode_fail").hide();$(d+"_geocode .geocode_success").hide();a=a.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(k.getProjectionObject(),e.proj4326),p.val(a.lat),m.val(a.lon),f.data("manually_geocoded",!0),K(b)):(a=
a.transform(k.getProjectionObject(),e.proj4326).toString(),q.val(a));t(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},y=function(b,a){var d=S3.gis;if(d.maps&&(d=d.maps["location_selector_"+b])){var c="#"+b,e=$(c+"_lat").val(),c=$(c+"_lon").val();if(e&&c)e=[c-0.032,e-0.032,c+0.032,e+0.032];else if(a||(a=u(b)||"d"),e=l[a].b,!e&&(c=l[a].f,c=l[c]))if(e=c.b,!e&&(c=c.f,c=l[c]))if(e=c.b,!e&&(c=c.f,c=l[c]))e=c.b;e&&(e=OpenLayers.Bounds.fromArray(e),S3.gis.zoomBounds(d,e))}}})();
