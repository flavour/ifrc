(function(){S3.gis.locationselector=function(b,a,c,e,d,f,g,p,m,q){var k="#"+b,w=$(k),t=w.next(".error_wrapper"),z=$(k+"_L0__row"),s=$(k+"_L1__row"),u=$(k+"_L2__row"),y=$(k+"_L3__row"),A=$(k+"_L4__row"),B=$(k+"_L5__row"),E=$(k+"_address__row"),F=$(k+"_postcode__row"),C=$(k+"_map_icon__row"),G=$(k+"__row .map_wrapper").attr("id",b+"_map_wrapper");c?$(k+"__row").hide().after(G).after(C).after(z).after(s).after(u).after(y).after(A).after(B).after(F).after(E).after(t):$(k+"__row").hide().after(G).after(C).after(F).after(E).after(B).after(A).after(y).after(u).after(s).after(z).after(t);
q&&w.data("specific",q);w.data("hide_lx",a);a=$(k+"_lat").val();c=$(k+"_lon").val();q=$(k+"_wkt").val();(a||c||q)&&w.data("manually_geocoded",!0);if(e)r(b,0,e);else{z.removeClass("hide").show();e=[];for(var x in l)v=l[x],0==v.l&&(v.i=x,e.push(v));e.sort(H);w=$(k+"_L0");x=0;for(z=e.length;x<z;x++)s=e[x],t=s.i,t='<option value="'+t+'">'+s.n+"</option>",w.append(t)}d&&r(b,1,d);f&&r(b,2,f);g&&r(b,3,g);p&&r(b,4,p);m&&r(b,5,m);I(b);C.removeClass("hide").show();a||c||q?D(b):$(k+"_map_icon").click(function(){D(b);
return!1});$(k+"_L0").change(function(){r(b,0)});$(k+"_L1").change(function(){r(b,1)});$(k+"_L2").change(function(){r(b,2)});$(k+"_L3").change(function(){r(b,3)});$(k+"_L4").change(function(){r(b,4)});$(k+"_L5").change(function(){r(b,5)})};var r=function(b,a,c){var e="#"+b,d=$(e).data("hide_lx");c?$(e+"_L"+a).val(c):c=parseInt($(e+"_L"+a).val());if(0===a){var f=h[c];if(void 0==f){var g=S3.Ap.concat("/gis/hdata/"+c);$.ajaxS3({async:!1,url:g,dataType:"script",success:function(a){f={};for(var b in n)f[b]=
n[b];h[c]=f;n=null},error:function(a,b,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var p=h.d,m,q,k=["1","2","3","4","5"],g=0;5>g;g++)m=k[g],q=f[m]||p[m],m=$(e+"_L"+m+"__row label"),m.hasClass("required")?m.html("<div>"+q+':<span class="req"> *</span></div>'):m.html(q+":")}if(c){for(m=a+1;6>m;m++)p=e+"_L"+m,d?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");s(b);a+=1;d=$(e+"_L"+a+"__row");if(d.length){d.removeClass("hide").show();d=!0;
for(g in l)l[g].f==c&&(d=!1);d&&J(b,a,c);d=[];for(g in l)v=l[g],v.l==a&&v.f==c&&(v.i=g,d.push(v));d.sort(H);p=$(e+"_L"+a);$(e+"_L"+a+" option").remove('[value != ""]');g=0;for(a=d.length;g<a;g++)m=d[g],e=m.i,q=c==e?' selected="selected"':"",e='<option value="'+e+'"'+q+">"+m.n+"</option>",p.append(e)}else $(e+"_geocode button").length&&A(b)}else for(0===a?c="d":(c=$(e+"_L"+(a-1)).val())||(c="d"),s(b),m=a+1;6>m;m++)p=e+"_L"+m,d?$(p+"__row").hide():$(p+" option").remove('[value != ""]'),$(p).val("");
y(b,c)},H=function(b,a){b=b.n;var c=[b,a.n];c.sort();return c[0]==b?-1:1},J=function(b,a,c){b="#"+b;var e=$(b+"_L"+a);e.hide();var d=$(b+"_L"+a+"__throbber");d.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+c);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;d.hide();e.removeClass("hide").show()},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;s3_debug(msg);S3.showAlert(msg,"error");d.hide();e.removeClass("hide").show()}})},
u=function(b){b="#"+b+"_L";for(var a,c=5;-1<c;c--)if(a=$(b+c).val())return a;return l.d.id},s=function(b){var a="#"+b,c=$(a+"_parent"),e=$(a);if(e.data("specific"))e=u(b),c.val(e);else{var d=$(a+"_address").val(),f=$(a+"_postcode").val(),g=$(a+"_lat").val(),p=$(a+"_lon").val(),a=$(a+"_wkt").val();d||f||g||p||a?(e.val("dummy"),e=u(b),c.val(e)):(b=u(b),e.val(b),c.val(""))}},I=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();$(a+
"_geocode button").length&&$(a+"_address,"+a+"_postcode").change(function(){A(b)})},A=function(b){var a="#"+b;if($(a+"_address").val()){var c,e,d=["1","2","3","4","5"];for(c=0;5>c;c++)if(e=d[c],e=$(a+"_L"+e),e.length&&!e.val())return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();B(b);s(b)})):B(b);s(b)}},B=function(b){var a="#"+b,c=$(a+"_geocode .geocode_fail"),
e=$(a+"_geocode .geocode_success");c.hide();e.hide();var d=$(a+"_geocode .throbber");d.removeClass("hide").show();var f={address:$(a+"_address").val()},g=$(a+"_postcode").val();g&&(f.postcode=g);if(g=$(a+"_L0").val())f.L0=g;if(g=$(a+"_L1").val())f.L1=g;if(g=$(a+"_L2").val())f.L2=g;if(g=$(a+"_L3").val())f.L3=g;if(g=$(a+"_L4").val())f.L4=g;if(g=$(a+"_L5").val())f.L5=g;g=S3.Ap.concat("/gis/geocode");$.ajaxS3({url:g,type:"POST",data:f,dataType:"json",success:function(f){var g=f.lat,q=f.lon;if(g||q){$(a+
"_lat").val(g);$(a+"_lon").val(q);gis=S3.gis;if(gis.maps){var k=gis.maps["location_selector_"+b];k&&(f=k.s3.draftLayer,f.removeAllFeatures(),g=new OpenLayers.Geometry.Point(parseFloat(q),parseFloat(g)),g.transform(gis.proj4326,k.getProjectionObject()),g=new OpenLayers.Feature.Vector(g),f.addFeatures([g]),y(b))}d.hide();e.html(i18n.address_mapped).removeClass("hide").show()}else d.hide(),c.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(f)},error:function(a,b,e){msg="UNAUTHORIZED"==
e?i18n.gis_requires_login:a.responseText;d.hide();c.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},K=function(b){var a="#"+b,c=$(a+"_geocode .geocode_fail"),e=$(a+"_geocode .geocode_success");c.hide();e.hide();var d=$(a+"_geocode .throbber");d.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),
$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),d.hide(),e.html(i18n.location_found).removeClass("hide").show()):(d.hide(),c.html(i18n.location_not_found).removeClass("hide").show())},error:function(b,a,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:
b.responseText;d.hide();c.html(i18n.location_not_found).removeClass("hide").show();s3_debug(msg)}})},L=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){D(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");s(b)},M=function(){var b=new jQuery.Deferred;setTimeout(function c(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(c,
500))},1);return b.promise()},D=function(b,a){var c="#"+b;$(c+"_map_icon").unbind("click").click(function(){L(b)});$(c+"_map_wrapper").removeClass("hide").show();$.when(M()).then(function(a){a="location_selector_"+b;var d=S3.gis;if(!d.maps[a]){var f=d.show_map(a),g=$(c);$(c+"_parent");(a=u(b))||(a="d");y(b,a);var p=$(c+"_lat"),m=$(c+"_lon"),q=$(c+"_wkt"),k=p.val(),r=m.val();a=q.val();if(k||r||a)void 0!=a?(k={internalProjection:f.getProjectionObject(),externalProjection:d.proj4326},a=(new OpenLayers.Format.WKT(k)).read(a)):
(a=new OpenLayers.Geometry.Point(parseFloat(r),parseFloat(k)),a.transform(d.proj4326,f.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),f.s3.draftLayer.addFeatures([a]),s(b);var t;a=f.controls;k=0;for(r=a.length;k<r;k++)if("OpenLayers.Control.DrawFeature"==a[k].CLASS_NAME){t=a[k];break}t&&(f.s3.pointPlaced=function(a){$(c+"_geocode .geocode_fail").hide();$(c+"_geocode .geocode_success").hide();a=a.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(f.getProjectionObject(),
d.proj4326),p.val(a.lat),m.val(a.lon),g.data("manually_geocoded",!0),K(b)):(a=a.transform(f.getProjectionObject(),d.proj4326).toString(),q.val(a));s(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},y=function(b,a){var c=S3.gis;if(c.maps){var e=c.maps["location_selector_"+b];if(e){var d="#"+b,f=$(d+"_lat"),d=$(d+"_lon"),f=f.val(),d=d.val();if(f&&d)f=[d-0.032,f-0.032,d+0.032,f+0.032];else if(f=l[a].b,!f&&(d=l[a].f,d=l[d]))if(f=d.b,!f&&(d=d.f,d=l[d]))if(f=d.b,!f&&(d=d.f,d=l[d]))f=d.b;f&&(f=
OpenLayers.Bounds.fromArray(f).transform(c.proj4326,e.getProjectionObject()),e.zoomToExtent(f))}}}})();
