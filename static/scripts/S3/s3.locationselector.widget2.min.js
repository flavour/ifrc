(function(){S3.gis.locationselector=function(b,d,a,c,e,h,k,q){var f="#"+b,m=$(f),y=m.next(".error_wrapper"),p=$(f+"_L0__row"),s=$(f+"_L1__row"),t=$(f+"_L2__row"),u=$(f+"_L3__row"),w=$(f+"_L4__row"),z=$(f+"_L5__row"),A=$(f+"_address__row"),x=$(f+"_map_icon__row"),B=$(f+"__row .map_wrapper").attr("id",b+"_map_wrapper");$(f+"__row").hide().after(B).after(x).after(A).after(z).after(w).after(u).after(t).after(s).after(p).after(y);q&&m.data("specific",q);d&&g(b,0,d);a&&g(b,1,a);c&&g(b,2,c);e&&g(b,3,e);
h&&g(b,4,h);k&&g(b,5,k);C(b);x.show();d=$(f+"_lat").val();a=$(f+"_lon").val();d||a?r(b):$(f+"_map_icon").click(function(){r(b)});$(f+"_L0").change(function(){g(b,0)});$(f+"_L1").change(function(){g(b,1)});$(f+"_L2").change(function(){g(b,2)});$(f+"_L3").change(function(){g(b,3)});$(f+"_L4").change(function(){g(b,4)});$(f+"_L5").change(function(){g(b,5)})};var g=function(b,d,a){var c="#"+b;a?$(c+"_L"+d).val(a):a=$(c+"_L"+d).val();if(a){for(var e=d+1;6>e;e++){var h=c+"_L"+e;$(h+"__row").hide();$(h).val("")}m(b);
d+=1;e=$(c+"_L"+d+"__row");if(e.length){e.show();var e=!0,k;for(k in l)l[k].f==a&&(e=!1);e&&t(b,d,a);e=[];for(k in l)v=l[k],v.l==d&&v.f==a&&(v.i=k,e.push(v));e.sort(u);var g,f,h=$(c+"_L"+d);$(c+"_L"+d+" option").remove('[value != ""]');k=0;for(d=e.length;k<d;k++)g=e[k],c=g.i,f=a==c?' selected="selected"':"",c='<option value="'+c+'"'+f+">"+g.n+"</option>",h.append(c)}}else for(0===d?a="d":(a=$(c+"_L"+(d-1)).val())||(a="d"),m(b),e=d+1;6>e;e++)h=c+"_L"+e,$(h+"__row").hide(),$(h).val("");s(b,a)},u=function(b,
d){b=b.n;var a=[b,d.n];a.sort();return a[0]==b?-1:1},t=function(b,d,a){b="#"+b;var c=$(b+"_L"+d);c.hide();var e=$(b+"_L"+d+"__throbber");e.show();d=S3.Ap.concat("/gis/ldata/"+a);$.ajax({async:!1,url:d,dataType:"script"}).done(function(b){for(var a in n)l[a]=n[a];n=null;e.hide();c.show()}).fail(function(b,a,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:b.responseText})},p=function(b){b="#"+b+"_L";for(var d,a=5;-1<a;a--)if(d=$(b+a).val())return d;return l.d.id},m=function(b){var d="#"+b,a=$(d+"_parent"),
c=$(d);if(c.data("specific"))c=p(b),a.val(c);else{var e=$(d+"_address").val(),h=$(d+"_lat").val(),d=$(d+"_lon").val();e||h||d?(c.val("dummy"),c=p(b),a.val(c)):(b=p(b),c.val(b),a.val(""))}},C=function(b){var d="#"+b;$(d+"_address__row").show();$(d+"_address").change(function(){m(b)})},w=function(b){var d="#"+b,a=$(d+"_map_icon");a.unbind("click");a.click(function(){r(b)});$(d+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(d+"_lat").val("");$(d+"_lon").val("");
m(b)},r=function(b,d){var a="#"+b,c=$(a+"_map_icon");c.unbind("click");c.click(function(){w(b)});$(a+"_map_wrapper").show();var c="location_selector_"+b,e=S3.gis;if(!e.maps||!e.maps[c]){var h=e.show_map(c);$(a);$(a+"_parent");(c=p(b))||(c="d");s(b,c);var g=$(a+"_lat"),q=$(a+"_lon"),a=g.val(),c=q.val();void 0!=a&&(a=new OpenLayers.Geometry.Point(parseFloat(c),parseFloat(a)),a.transform(e.proj4326,h.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),h.s3.draftLayer.addFeatures([a]),m(b));for(var f,
a=h.controls,c=0,r=a.length;c<r;c++)"OpenLayers.Control.DrawFeature"==a[c].CLASS_NAME&&(f=a[c]);f&&f.events.register("featureadded",null,function(a){a=a.feature.geometry.getBounds().getCenterLonLat();a.transform(h.getProjectionObject(),e.proj4326);g.val(a.lat);q.val(a.lon);m(b)})}},s=function(b,d){if(S3.gis.maps){var a=S3.gis.maps["location_selector_"+b];if(a){var c=l[d].b;if(!c){var e=l[d].f;if(e=l[e])if(c=e.b,!c&&(e=e.f,e=l[e]))if(c=e.b,!c&&(e=e.f,e=l[e]))c=e.b}c&&(c=OpenLayers.Bounds.fromArray(c).transform(S3.gis.proj4326,
a.getProjectionObject()),a.zoomToExtent(c))}}}})();
