(function(){S3.gis.locationselector=function(b,a,e,d,f,k,g,r,q,p){var c="#"+b,m=$(c),s=$(c+"__row"),C=m.next(".error_wrapper"),D=$(c+"_L0__row"),E=$(c+"_map_icon__row"),x=$(c+"_map_icon__row .map_wrapper").attr("id",b+"_map_wrapper"),u=s.hasClass("control-group")||s.hasClass("form-row");if(u){var F=$(c+"_L1__row"),w=$(c+"_L2__row"),B=$(c+"_L3__row"),H=$(c+"_L4__row"),I=$(c+"_L5__row"),N=$(c+"_address__row"),O=$(c+"_postcode__row");e?s.hide().after(x).after(E).after(D).after(F).after(w).after(B).after(H).after(I).after(O).after(N).after(C):
s.hide().after(x).after(E).after(O).after(N).after(I).after(H).after(B).after(w).after(F).after(D).after(C)}else $(c+"__row1").hide(),s.hide().after(C),e?D.after(x).after(E):$(c+"_postcode__row").after(x).after(E);p&&m.data("specific",p);m.data("hide_lx",a);a=$(c+"_lat").val();e=$(c+"_lon").val();p=$(c+"_wkt").val();(a||e||p)&&m.data("manually_geocoded",!0);var K=$(c+"_L0");if(D.length){var s=[],y;for(y in l)v=l[y],0==v.l&&(v.i=y,s.push(v));s.sort(P);y=0;for(C=s.length;y<C;y++)F=s[y],x=F.i,x='<option value="'+
x+'">'+F.n+"</option>",K.append(x);D.removeClass("hide").show();u||$(c+"_L0__row1").removeClass("hide").show()}d&&t(b,0,d);f&&t(b,1,f);k&&t(b,2,k);g&&t(b,3,g);r&&t(b,4,r);q&&t(b,5,q);Q(b);E.removeClass("hide").show();a||e||p?L(b):$(c+"_map_icon").click(function(){L(b);return!1});K.change(function(){t(b,0)});var M=$(c+"_L1");M.change(function(){t(b,1)});var J=$(c+"_L2");J.change(function(){t(b,2)});var G=$(c+"_L3");G.change(function(){t(b,3)});var A=$(c+"_L4");A.change(function(){t(b,4)});var z=$(c+
"_L5");z.change(function(){t(b,5)});m.closest("form").submit(function(){if("sub_"==b.slice(0,4)&&m.parent().parent().is(":hidden"))return $(c+"_L0,"+c+"_L1,"+c+"_L2,"+c+"_L3,"+c+"_L4,"+c+"_L5,"+c+"_address,"+c+"_lat,"+c+"_lon,"+c+"_parent,"+c+"_postcode,"+c+"_wkt").prop("disabled",!0),!0;var a=m.val();if(a){if(!l[a])return!0;switch(l[a].l){case 0:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),
!1;if(A.hasClass("required"))return S3.fieldError(c+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(c+"_L3",i18n.enter_value),!1;if(J.hasClass("required"))return S3.fieldError(c+"_L2",i18n.enter_value),!1;if(M.hasClass("required"))return S3.fieldError(c+"_L1",i18n.enter_value),!1;a=$("input#"+b+"_L0");a.length&&!a.hasClass("required")&&m.val("");return!0;case 1:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+
"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(c+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(c+"_L3",i18n.enter_value),!1;if(J.hasClass("required"))return S3.fieldError(c+"_L2",i18n.enter_value),!1;a=$("input#"+b+"_L1");a.length&&!a.hasClass("required")&&m.val("");return!0;case 2:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),
!1;if(A.hasClass("required"))return S3.fieldError(c+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(c+"_L3",i18n.enter_value),!1;a=$("input#"+b+"_L2");a.length&&!a.hasClass("required")&&m.val("");return!0;case 3:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(c+"_L4",i18n.enter_value),!1;a=$("input#"+b+"_L3");
a.length&&!a.hasClass("required")&&m.val("");return!0;case 4:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),!1;a=$("input#"+b+"_L4");a.length&&!a.hasClass("required")&&m.val("");return!0;case 5:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;a=$("input#"+b+"_L5");a.length&&!a.hasClass("required")&&m.val("");return!0;default:return S3.showAlert("LocationSelector cannot validate!",
"error"),!1}}else return $(c+"_address").hasClass("required")?(S3.fieldError(c+"_address",i18n.enter_value),!1):z.hasClass("required")?(S3.fieldError(c+"_L5",i18n.enter_value),!1):A.hasClass("required")?(S3.fieldError(c+"_L4",i18n.enter_value),!1):G.hasClass("required")?(S3.fieldError(c+"_L3",i18n.enter_value),!1):J.hasClass("required")?(S3.fieldError(c+"_L2",i18n.enter_value),!1):M.hasClass("required")?(S3.fieldError(c+"_L1",i18n.enter_value),!1):K.hasClass("required")?(S3.fieldError(c+"_L0",i18n.enter_value),
!1):!0})};var t=function(b,a,e){var d="#"+b,f=$(d).data("hide_lx");if(e){var k=$(d+"_L"+a);k.val(e);k.hasClass("multiselect")&&k.multiselect("refresh")}else e=parseInt($(d+"_L"+a).val());if(0===a){var g=h[e];if(void 0==g){var r=S3.Ap.concat("/gis/hdata/"+e);$.ajaxS3({async:!1,url:r,dataType:"script",success:function(a){g={};try{for(var b in n)g[b]=n[b];h[e]=g;n=null}catch(c){}},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var k=h.d,q,p,c=
["1","2","3","4","5"],m,r=0;5>r;r++)q=c[r],p=g[q]||k[q],m=d+"_L"+q,$(m).hasClass("required")?($(m+"__row label").html("<div>"+p+':<span class="req"> *</span></div>'),$(m+"__row1 label").html("<div>"+p+':<span class="req"> *</span></div>')):($(m+"__row label").html(p+":"),$(m+"__row1 label").html(p+":")),$(m+' option[value=""]').html(i18n.select+" "+p)}if(e){for(q=a+1;6>q;q++)m=d+"_L"+q,f?($(m+"__row").hide(),$(m+"__row1").hide()):$(m+" option").remove('[value != ""]'),$(m).val("");u(b);a+=1;k=$(d+
"_L"+a+"__row");if(k.length){k.removeClass("hide").show();$(d+"_L"+a+"__row1").removeClass("hide").show();f=!0;for(r in l)if(l[r].f==e){f=!1;break}f&&R(b,a,e);f=[];for(r in l)k=l[r],k.l==a&&k.f==e&&(k.i=r,f.push(k));f.sort(P);var k=f.length,s;q=$(d+"_L"+a);$(d+"_L"+a+" option").remove('[value != ""]');for(r=0;r<k;r++)p=f[r],s=p.i,c=e==s?' selected="selected"':"",p='<option value="'+s+'"'+c+">"+p.n+"</option>",q.append(p);q.hasClass("multiselect")&&q.multiselect({header:!1,height:300,minWidth:0,selectedList:3,
noneSelectedText:$(d+"_L"+a+' option[value=""]').html(),multiple:!1});if(1==k){t(b,a,s);return}}else $(d+"_geocode button").length&&H(b)}else for(u(b),q=a+1;6>q;q++)m=d+"_L"+q,f?($(m+"__row").hide(),$(m+"__row1").hide()):$(m+" option").remove('[value != ""]'),$(m).val("");B(b)},P=function(b,a){b=b.n;var e=[b,a.n];e.sort();return e[0]==b?-1:1},R=function(b,a,e){b="#"+b;var d=$(b+"_L"+a);d.hide();var f=$(b+"_L"+a+"__throbber");f.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+e);$.ajaxS3({async:!1,
url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;f.hide();d.removeClass("hide").show()},error:function(a,b,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText;s3_debug(msg);S3.showAlert(msg,"error");f.hide();d.removeClass("hide").show()}})},w=function(b){b="#"+b+"_L";for(var a,e=5;-1<e;e--)if(a=$(b+e).val())return a;return l.d.id},u=function(b){var a="#"+b,e=$(a+"_parent"),d=$(a);if(d.data("specific")){var f=w(b);e.val(f)}else{var f=$(a+"_address").val(),k=$(a+
"_postcode").val(),g=$(a+"_lat").val(),r=$(a+"_lon").val(),a=$(a+"_wkt").val();f||k||g||r||a?(d.val("dummy"),f=w(b),e.val(f)):(f=w(b),d.val(f),e.val(""));"sub_"==b.slice(0,4)&&d.change()}},Q=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_address__row1").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();$(a+"_postcode__row1").removeClass("hide").show();$(a+"_geocode button").length&&$(a+"_address,"+a+"_postcode").change(function(){H(b)})},H=
function(b){var a="#"+b;if($(a+"_address").val()){var e,d,f=["1","2","3","4","5"];for(e=0;5>e;e++)if(d=f[e],d=$(a+"_L"+d),d.length&&!d.val()&&1<d[0].options.length)return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();I(b);u(b)})):I(b);u(b)}},I=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");e.hide();d.hide();var f=
$(a+"_geocode .throbber");f.removeClass("hide").show();var k={address:$(a+"_address").val()},g=$(a+"_postcode").val();g&&(k.postcode=g);if(g=$(a+"_L0").val())k.L0=g;if(g=$(a+"_L1").val())k.L1=g;if(g=$(a+"_L2").val())k.L2=g;if(g=$(a+"_L3").val())k.L3=g;if(g=$(a+"_L4").val())k.L4=g;if(g=$(a+"_L5").val())k.L5=g;g=S3.Ap.concat("/gis/geocode");$.ajaxS3({url:g,type:"POST",data:k,dataType:"json",success:function(k){var g=k.lat,p=k.lon;if(g||p){$(a+"_lat").val(g);$(a+"_lon").val(p);gis=S3.gis;if(gis.maps){var c=
gis.maps["location_selector_"+b];c&&(k=c.s3.draftLayer,k.removeAllFeatures(),g=new OpenLayers.Geometry.Point(parseFloat(p),parseFloat(g)),g.transform(gis.proj4326,c.getProjectionObject()),g=new OpenLayers.Feature.Vector(g),k.addFeatures([g]),B(b))}f.hide();d.html(i18n.address_mapped).removeClass("hide").show()}else f.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(k)},error:function(a,b,k){msg="UNAUTHORIZED"==k?i18n.gis_requires_login:a.responseText;f.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();
s3_debug(msg)}})},S=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");e.hide();d.hide();var f=$(a+"_geocode .throbber");f.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),
$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),f.hide(),d.html(i18n.location_found).removeClass("hide").show()):(f.hide(),e.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;f.hide();e.html(i18n.location_not_found).removeClass("hide").show();s3_debug(msg)}})},T=function(b){var a=
"#"+b;$(a+"_map_icon").unbind("click").click(function(){L(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");u(b)},U=function(){var b=new jQuery.Deferred;setTimeout(function e(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(e,500))},1);return b.promise()},L=function(b,a){var e="#"+b;$(e+"_map_icon").unbind("click").click(function(){T(b)});var d=
$(e+"_map_wrapper");d.removeClass("hide").show();$("html,body").animate({scrollTop:d.offset().top},250);$.when(U()).then(function(a){a="location_selector_"+b;var d=S3.gis;if(!d.maps[a]){var g=d.show_map(a),r=$(e);$(e+"_parent");B(b);var q=$(e+"_lat"),p=$(e+"_lon"),c=$(e+"_wkt");a=q.val();var m=p.val(),s=c.val();if(a||m||s)void 0!=s?(a={internalProjection:g.getProjectionObject(),externalProjection:d.proj4326},a=(new OpenLayers.Format.WKT(a)).read(s)):(a=new OpenLayers.Geometry.Point(parseFloat(m),
parseFloat(a)),a.transform(d.proj4326,g.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),g.s3.draftLayer.addFeatures([a]),u(b);var t;a=g.controls;for(var m=0,w=a.length;m<w;m++)if("OpenLayers.Control.DrawFeature"==a[m].CLASS_NAME){t=a[m];break}t&&(g.s3.pointPlaced=function(a){$(e+"_geocode .geocode_fail").hide();$(e+"_geocode .geocode_success").hide();var f=a.geometry;"OpenLayers.Geometry.Point"==f.CLASS_NAME?(a=f.getBounds().getCenterLonLat(),a.transform(g.getProjectionObject(),d.proj4326),
c.val(""),q.val(a.lat),p.val(a.lon),r.data("manually_geocoded",!0),S(b)):(f={internalProjection:g.getProjectionObject(),externalProjection:d.proj4326},s=(new OpenLayers.Format.WKT(f)).write(a),c.val(s),q.val(""),p.val(""),r.data("manually_geocoded",!0));u(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},B=function(b,a){var e=S3.gis;if(e.maps&&(e=e.maps["location_selector_"+b])){var d="#"+b,f=$(d+"_lat").val(),d=$(d+"_lon").val();if(f&&d)f=[d-.032,f-.032,d+.032,f+.032];else if(a||(a=w(b)||
"d"),f=l[a].b,!f&&(d=l[a].f,d=l[d]))if(f=d.b,!f&&(d=d.f,d=l[d]))if(f=d.b,!f&&(d=d.f,d=l[d]))f=d.b;f&&(f=OpenLayers.Bounds.fromArray(f),S3.gis.zoomBounds(e,f))}}})();
