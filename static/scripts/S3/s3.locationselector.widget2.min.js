(function(){S3.gis.locationselector=function(b,a,c,d,e,g,h,m,r,k){a="#"+b;var q=$(a),x=q.next(".error_wrapper"),p=$(a+"_L0__row"),s=$(a+"_L1__row"),y=$(a+"_L2__row"),z=$(a+"_L3__row"),A=$(a+"_L4__row"),B=$(a+"_L5__row"),C=$(a+"_address__row"),D=$(a+"_postcode__row"),u=$(a+"_map_icon__row"),E=$(a+"__row .map_wrapper").attr("id",b+"_map_wrapper");c?$(a+"__row").hide().after(E).after(u).after(p).after(s).after(y).after(z).after(A).after(B).after(D).after(C).after(x):$(a+"__row").hide().after(E).after(u).after(D).after(C).after(B).after(A).after(z).after(y).after(s).after(p).after(x);
k&&q.data("specific",k);d&&f(b,0,d);e&&f(b,1,e);g&&f(b,2,g);h&&f(b,3,h);m&&f(b,4,m);r&&f(b,5,r);F(b);u.show();c=$(a+"_lat").val();d=$(a+"_lon").val();e=$(a+"_wkt").val();c||d||e?w(b):$(a+"_map_icon").click(function(){w(b)});$(a+"_L0").change(function(){f(b,0)});$(a+"_L1").change(function(){f(b,1)});$(a+"_L2").change(function(){f(b,2)});$(a+"_L3").change(function(){f(b,3)});$(a+"_L4").change(function(){f(b,4)});$(a+"_L5").change(function(){f(b,5)})};var f=function(b,a,c){var d="#"+b;c?$(d+"_L"+a).val(c):
c=$(d+"_L"+a).val();if(c){for(var e=a+1;6>e;e++){var g=d+"_L"+e;$(g+"__row").hide();$(g).val("")}k(b);a+=1;e=$(d+"_L"+a+"__row");if(e.length){e.show();var e=!0,h;for(h in l)l[h].f==c&&(e=!1);e&&G(b,a,c);e=[];for(h in l)v=l[h],v.l==a&&v.f==c&&(v.i=h,e.push(v));e.sort(H);var m,f,g=$(d+"_L"+a);$(d+"_L"+a+" option").remove('[value != ""]');h=0;for(a=e.length;h<a;h++)m=e[h],d=m.i,f=c==d?' selected="selected"':"",d='<option value="'+d+'"'+f+">"+m.n+"</option>",g.append(d)}}else for(0===a?c="d":(c=$(d+"_L"+
(a-1)).val())||(c="d"),k(b),e=a+1;6>e;e++)g=d+"_L"+e,$(g+"__row").hide(),$(g).val("");s(b,c)},H=function(b,a){b=b.n;var c=[b,a.n];c.sort();return c[0]==b?-1:1},G=function(b,a,c){b="#"+b;var d=$(b+"_L"+a);d.hide();var e=$(b+"_L"+a+"__throbber");e.show();a=S3.Ap.concat("/gis/ldata/"+c);$.ajax({async:!1,url:a,dataType:"script"}).done(function(a){for(var b in n)l[b]=n[b];n=null;e.hide();d.show()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText})},p=function(b){b="#"+
b+"_L";for(var a,c=5;-1<c;c--)if(a=$(b+c).val())return a;return l.d.id},k=function(b){var a="#"+b,c=$(a+"_parent"),d=$(a);if(d.data("specific"))d=p(b),c.val(d);else{var e=$(a+"_address").val(),g=$(a+"_postcode").val(),h=$(a+"_lat").val(),f=$(a+"_lon").val(),a=$(a+"_wkt").val();e||g||h||f||a?(d.val("dummy"),d=p(b),c.val(d)):(b=p(b),d.val(b),c.val(""))}},F=function(b){var a="#"+b;$(a+"_address__row").show();$(a+"_postcode__row").show();$(a+"_address").change(function(){I(b);k(b)});$(a+"_postcode").change(function(){k(b)})},
I=function(b){var a="#"+b;b={address:$(a+"_address").val()};var c=$(a+"_postcode").val();c&&(b.postcode=c);if(c=$(a+"_L0").val())b.L0=c;c=S3.Ap.concat("/gis/geocode");$.ajax({async:!1,url:c,type:"POST",data:b,dataType:"json"}).done(function(b){$(a+"_lat").val(b.lat);$(a+"_lon").val(b.lon)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText})},J=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){w(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+
b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");k(b)},w=function(b,a){var c="#"+b;$(c+"_map_icon").unbind("click").click(function(){J(b)});$(c+"_map_wrapper").show();var d="location_selector_"+b,e=S3.gis;if(!e.maps||!e.maps[d]){var g=e.show_map(d);$(c);$(c+"_parent");(d=p(b))||(d="d");s(b,d);var f=$(c+"_lat"),m=$(c+"_lon"),r=$(c+"_wkt"),d=f.val(),t=m.val(),c=r.val();if(d||t||c)void 0!=c?(d={internalProjection:g.getProjectionObject(),externalProjection:e.proj4326},c=(new OpenLayers.Format.WKT(d)).read(c)):
(c=new OpenLayers.Geometry.Point(parseFloat(t),parseFloat(d)),c.transform(e.proj4326,g.getProjectionObject()),c=new OpenLayers.Feature.Vector(c)),g.s3.draftLayer.addFeatures([c]),k(b);for(var q,c=g.controls,d=0,t=c.length;d<t;d++)if("OpenLayers.Control.DrawFeature"==c[d].CLASS_NAME)return q=c[d],!1;q&&q.events.register("featureadded",null,function(a){a=a.feature.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(g.getProjectionObject(),e.proj4326),f.val(a.lat),
m.val(a.lon)):(a=a.transform(g.getProjectionObject(),e.proj4326).toString(),r.val(a));k(b)})}},s=function(b,a){if(S3.gis.maps){var c=S3.gis.maps["location_selector_"+b];if(c){var d=l[a].b;if(!d){var e=l[a].f;if(e=l[e])if(d=e.b,!d&&(e=e.f,e=l[e]))if(d=e.b,!d&&(e=e.f,e=l[e]))d=e.b}d&&(d=OpenLayers.Bounds.fromArray(d).transform(S3.gis.proj4326,c.getProjectionObject()),c.zoomToExtent(d))}}}})();
