(function(){S3.gis.locationselector=function(b,a,d,c,e,g,f,m,u,y){var h="#"+b,q=$(h),p=q.next(".error_wrapper"),z=$(h+"_L0__row"),t=$(h+"_L1__row"),w=$(h+"_L2__row"),r=$(h+"_L3__row"),A=$(h+"_L4__row"),B=$(h+"_L5__row"),C=$(h+"_address__row"),D=$(h+"_postcode__row"),x=$(h+"_map_icon__row"),E=$(h+"__row .map_wrapper").attr("id",b+"_map_wrapper");d?$(h+"__row").hide().after(E).after(x).after(z).after(t).after(w).after(r).after(A).after(B).after(D).after(C).after(p):$(h+"__row").hide().after(E).after(x).after(D).after(C).after(B).after(A).after(r).after(w).after(t).after(z).after(p);
y&&q.data("specific",y);q.data("hide_lx",a);c&&k(b,0,c);e&&k(b,1,e);g&&k(b,2,g);f&&k(b,3,f);m&&k(b,4,m);u&&k(b,5,u);F(b);x.show();a=$(h+"_lat").val();d=$(h+"_lon").val();c=$(h+"_wkt").val();a||d||c?s(b):$(h+"_map_icon").click(function(){s(b);return!1});$(h+"_L0").change(function(){k(b,0)});$(h+"_L1").change(function(){k(b,1)});$(h+"_L2").change(function(){k(b,2)});$(h+"_L3").change(function(){k(b,3)});$(h+"_L4").change(function(){k(b,4)});$(h+"_L5").change(function(){k(b,5)})};var k=function(b,a,
d){var c="#"+b,e=$(c).data("hide_lx");d?$(c+"_L"+a).val(d):d=$(c+"_L"+a).val();if(d){for(var g=a+1;6>g;g++){var f=c+"_L"+g;e?$(f+"__row").hide():$(f+" option").remove('[value != ""]');$(f).val("")}p(b);a+=1;e=$(c+"_L"+a+"__row");if(e.length){e.show();var e=!0,m;for(m in l)l[m].f==d&&(e=!1);e&&G(b,a,d);e=[];for(m in l)v=l[m],v.l==a&&v.f==d&&(v.i=m,e.push(v));e.sort(H);var u,g=$(c+"_L"+a);$(c+"_L"+a+" option").remove('[value != ""]');m=0;for(a=e.length;m<a;m++)f=e[m],c=f.i,u=d==c?' selected="selected"':
"",c='<option value="'+c+'"'+u+">"+f.n+"</option>",g.append(c)}}else for(0===a?d="d":(d=$(c+"_L"+(a-1)).val())||(d="d"),p(b),g=a+1;6>g;g++)f=c+"_L"+g,e?$(f+"__row").hide():$(f+" option").remove('[value != ""]'),$(f).val("");w(b,d)},H=function(b,a){b=b.n;var d=[b,a.n];d.sort();return d[0]==b?-1:1},G=function(b,a,d){b="#"+b;var c=$(b+"_L"+a);c.hide();var e=$(b+"_L"+a+"__throbber");e.show();a=S3.Ap.concat("/gis/ldata/"+d);$.ajax({async:!1,url:a,dataType:"script"}).done(function(a){for(var b in n)l[b]=
n[b];n=null;e.hide();c.show()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText})},t=function(b){b="#"+b+"_L";for(var a,d=5;-1<d;d--)if(a=$(b+d).val())return a;return l.d.id},p=function(b){var a="#"+b,d=$(a+"_parent"),c=$(a);if(c.data("specific"))c=t(b),d.val(c);else{var e=$(a+"_address").val(),g=$(a+"_postcode").val(),f=$(a+"_lat").val(),m=$(a+"_lon").val(),a=$(a+"_wkt").val();e||g||f||m||a?(c.val("dummy"),c=t(b),d.val(c)):(b=t(b),c.val(b),d.val(""))}},F=function(b){var a=
"#"+b;$(a+"_address__row").show();$(a+"_postcode__row").show();var d=$(a+"_geocode button");d.length&&$(a+"_address").change(function(){$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),d.removeClass("hide").show().click(function(){$(this).hide();r(b);p(b)})):r(b);p(b)})},r=function(b){var a="#"+b,d=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");d.hide();c.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();
var g={address:$(a+"_address").val()},f=$(a+"_postcode").val();f&&(g.postcode=f);if(f=$(a+"_L0").val())g.L0=f;if(f=$(a+"_L1").val())g.L1=f;if(f=$(a+"_L2").val())g.L2=f;if(f=$(a+"_L3").val())g.L3=f;if(f=$(a+"_L4").val())g.L4=f;if(f=$(a+"_L5").val())g.L5=f;f=S3.Ap.concat("/gis/geocode");$.ajax({async:!1,url:f,type:"POST",data:g,dataType:"json"}).done(function(g){var f=g.lat,k=g.lon;if(f||k){$(a+"_lat").val(f);$(a+"_lon").val(k);gis=S3.gis;if(gis.maps){var h=gis.maps["location_selector_"+b];h&&(g=h.s3.draftLayer,
g.removeAllFeatures(),f=new OpenLayers.Geometry.Point(parseFloat(k),parseFloat(f)),f.transform(gis.proj4326,h.getProjectionObject()),f=new OpenLayers.Feature.Vector(f),g.addFeatures([f]))}e.hide();c.removeClass("hide").show()}else e.hide(),d.removeClass("hide").show(),s3_debug(g)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;e.hide();d.removeClass("hide").show();s3_debug(msg)})},I=function(b){var a="#"+b,d=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");
d.hide();c.hide();var e=$(a+"_geocode .throbber");e.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajax({async:!1,url:b,type:"POST",data:post_data,dataType:"json"}).done(function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),
$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),e.hide(),c.removeClass("hide").show()):(e.hide(),d.removeClass("hide").show())}).fail(function(b,a,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:b.responseText;e.hide();d.removeClass("hide").show();s3_debug(msg)})},J=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){s(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");
p(b)},s=function(b,a){var d="#"+b;$(d+"_map_icon").unbind("click").click(function(){J(b)});$(d+"_map_wrapper").show();var c="location_selector_"+b,e=S3.gis;if(!e.maps||!e.maps[c]){var g=e.show_map(c),f=$(d);$(d+"_parent");(c=t(b))||(c="d");w(b,c);var m=$(d+"_lat"),k=$(d+"_lon"),r=$(d+"_wkt"),h=m.val(),q=k.val(),c=r.val();if(h||q||c)void 0!=c?(h={internalProjection:g.getProjectionObject(),externalProjection:e.proj4326},c=(new OpenLayers.Format.WKT(h)).read(c)):(c=new OpenLayers.Geometry.Point(parseFloat(q),
parseFloat(h)),c.transform(e.proj4326,g.getProjectionObject()),c=new OpenLayers.Feature.Vector(c)),g.s3.draftLayer.addFeatures([c]),p(b);for(var s,c=g.controls,h=0,q=c.length;h<q;h++)if("OpenLayers.Control.DrawFeature"==c[h].CLASS_NAME){s=c[h];break}s&&s.events.register("featureadded",null,function(a){$(d+"_geocode .geocode_fail").hide();$(d+"_geocode .geocode_success").hide();a=a.feature.geometry;"OpenLayers.Geometry.Point"==a.CLASS_NAME?(a=a.getBounds().getCenterLonLat(),a.transform(g.getProjectionObject(),
e.proj4326),m.val(a.lat),k.val(a.lon),f.data("manually_geocoded",!0),I(b)):(a=a.transform(g.getProjectionObject(),e.proj4326).toString(),r.val(a));p(b)})}},w=function(b,a){if(S3.gis.maps){var d=S3.gis.maps["location_selector_"+b];if(d){var c=l[a].b;if(!c){var e=l[a].f;if(e=l[e])if(c=e.b,!c&&(e=e.f,e=l[e]))if(c=e.b,!c&&(e=e.f,e=l[e]))c=e.b}c&&(c=OpenLayers.Bounds.fromArray(c).transform(S3.gis.proj4326,d.getProjectionObject()),d.zoomToExtent(c))}}}})();
