/*
: 2013 (c) Sahana Software Foundation
 @license: MIT

 requires: jQuery 1.9.1+
 requires: jQuery UI 1.10 widget factory

*/
(function(a,p){var n=0;a.widget("s3.pivottable",{options:{showTotals:!0,collapseForm:!0,ajaxURL:null},_create:function(){this.id=n;n+=1;this.table=null},_init:function(){this.refresh();var e=this.element;this.options.collapseForm&&(e=a(e).attr("id"),a("#"+e+"-options legend").siblings().toggle(),a("#"+e+"-options legend").children().toggle())},_destroy:function(){this.table.remove()},refresh:function(){var e=this.element,c;this._unbindEvents();var b=a(e).find('input[type="hidden"][name="pivotdata"]');
b.length&&(c=JSON.parse(a(b).first().val()));if(c){var d=c.cells,g=c.cols,f=c.rows,k=c.total,h=c.labels,b=this._renderHeader(g,h);b.append(this._renderColumns(g,h));d=this._renderRows(f,h,d);g=this._renderFooter(f,g,h,k);b=a('<table class="dataTable display report"/>').append(b).append(d);null!==g&&b.append(g);this.table=a(b);a(e).find(".pt-table").first().empty().append(this.table);a(e).find(".pt-empty").hide()}else c={};this._bindEvents(c);a(e).find(".pt-throbber").hide()},_renderHeader:function(e,
c){var b=a("<tr>");b.append(a('<th scope="col">'+c.layer+"</th>")).append(a('<th scope="col" colspan="'+e.length+'">'+c.cols+"</th>"));this.options.showTotals&&b.append(a('<th class="totals_header row_totals" scope="col" rowspan="2">'+c.total+"</th>"));return a("<thead>").append(b)},_renderColumns:function(e,c){var b=a("<tr>");b.append(a('<th scope="col">'+c.rows+"</th>"));for(var d=0;d<e.length;d++)b.append(a('<th scope="col">'+e[d][2]+"</th>"));return b},_renderRows:function(e,c,b){for(var d=a("<tbody>"),
g=this.options.showTotals,f,k,h=0;h<b.length;h++)f=e[h],k=a('<tr class="'+(h%2?"odd":"even")+'"><td>'+f[2]+"</td></tr>").append(this._renderCells(b[h],c)),g&&k.append(a("<td>"+f[3]+"</td>")),d.append(k);return d},_renderCells:function(e,c){for(var b,d,g=c.none,f=[],k,h,m=0;m<e.length;m++){b=e[m];d=b.items;k=a("<td>");if(null===d)h=a('<div class="pt-cell-value">'+g+"</div>");else if(a.isArray(d)){h=a('<div class="pt-cell-value">');list=a("<ul>");for(var l=0;l<d.length;l++)list.append(a("<li>"+d[l]+
"</li>"));h.append(list)}else h=a('<div class="pt-cell-value">'+d+"</div>");k.append(h);b=b.keys;d&&(b&&b.length)&&k.data("records",b).append(a('<div class="pt-cell-zoom"></div>'));f.push(k)}return f},_renderFooter:function(e,c,b,d){if(this.options.showTotals){e=a('<tr class="'+(e.length%2?"odd":"even")+' totals_row"><th class="totals_header" scope="row">'+b.total+"</th></tr>");for(b=0;b<c.length;b++)e.append(a("<td>"+c[b][3]+"</td>"));e.append(a("<td>"+d+"</td>"));return a("<tfoot>").append(e)}return null},
_getOptions:function(){var e="#"+a(this.element).attr("id");return{rows:a(e+"-rows").val(),cols:a(e+"-cols").val(),fact:a(e+"-fact").val(),totals:a(e+"-totals").is(":checked")?1:0}},_getFilters:function(){var e="#"+a(this.element).attr("id"),c=a(e+"-filters"),e=[];try{if(c.length)e=S3.search.getCurrentFilters(c.first());else return null}catch(b){}for(var c={},d=0,g=e.length,f;d<g;d++)f=e[d].split("="),1<f.length&&(c[f[0]]=f[1]);return c},_updateAjaxURL:function(a,c){var b=this.options.ajaxURL.split("?"),
d={};if(1<b.length){var g=b[1].split("&"),f,k,h;k=0;for(h=g.length;k<h;k++)f=g[k].split("="),1<f.length&&"aggregate"!=f[0]&&(d[decodeURIComponent(f[0])]=decodeURIComponent(f[1]))}g=!1;if(a)for(option in a)f=a[option],"totals"==option?this.options.showTotals=f?!0:!1:d[option]!=f&&(g=!0),d[option]=f?f:null;if(c){for(option in c)f=c[option],d[option]!=f&&(g=!0),d[option]=f?f:null;for(option in d)a.hasOwnProperty(option)||(f=c[option],d[option]!=f&&(g=!0),d[option]=f?f:null)}f=[];for(option in d)null!==
d[option]&&f.push(option+"="+d[option]);d=f.join("&");b=b[0];d&&(b=b+"?"+d);this.options.ajaxURL=b;return g},reload:function(e,c,b){b="undefined"!=typeof b?b:!0;"undefined"==typeof c&&(c=this._getFilters());var d=this,g=this.element,f,k=a(g).find('input[type="hidden"][name="pivotdata"]');if(k.length){if(e||c)f=this._updateAjaxURL(e,c);f||b?(e=this.options.ajaxURL,a(g).find(".pt-throbber").show(),a.ajax({url:e,dataType:"json"}).done(function(a){k.first().val(JSON.stringify(a));d.refresh()}).fail(function(a,
b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)})):(a(g).find(".pt-throbber").show(),d.refresh())}},_bindEvents:function(e){var c=this,b=this.element,d=a(b).attr("id");a("#"+d+"-options legend").click(function(){a(this).siblings().toggle();a(this).children().toggle()});a("#"+d+"-filters legend").click(function(){a(this).siblings().toggle();a(this).children().toggle()});a("#"+d+"-totals").click(function(){var b=a(this).is(":checked");c.options.showTotals!=b&&c.reload({totals:b},
null,!1)});a(b).find("input.pt-submit").click(function(){var a=c._getOptions(),b=c._getFilters();c.reload(a,b,!1)});a("#"+d+" div.pt-table div.pt-cell-zoom").click(function(b){b=a(b.currentTarget);var c=b.closest("td"),d=c.find(".pt-cell-records");if(0<d.length)d.remove(),b.removeClass("opened");else{for(var h=c.data("records"),d=a("<div/>").addClass("pt-cell-records"),m=a("<ul/>"),l=0;l<h.length;l++)m.append("<li>"+e.lookup[h[l]]+"</li>");d.append(m);c.append(d);b.addClass("opened")}})},_unbindEvents:function(){var e=
this.element,c=a(e).attr("id");a(e).find("input.pt-submit").unbind("click");a("#"+c+" div.pt-table div.pt-cell-zoom").unbind("click");a("#"+c+"-options legend").unbind("click");a("#"+c+"-filters legend").unbind("click");a(c+"-totals").unbind("click")}})})(jQuery);
