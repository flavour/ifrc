function s3_popup_refresh_caller(f){var p,l,a;var b=getQueryParams(document.location.search);var d=b.refresh;if("undefined"!=typeof d){var g=self.parent.$("#"+d);if(g.hasClass("dl")){var c=b.record;void 0!==c?g.datalist("ajaxReloadItem",c):g.datalist("ajaxReload")}else try{g.dataTable().fnReloadAjax()}catch(F){}var h=self.parent.S3.gis.maps;if("undefined"!=typeof h)for(a in h){var q=h[a];c=d.replace(/-/g,"_");var u=q.layers;f=0;for(b=u.length;f<b;f++){var e=u[f];if(e.s3_layer_id==c){var v=e.strategies;
e=0;for(l=v.length;e<l;e++){var m=v[e];if("OpenLayers.Strategy.Refresh"==m.CLASS_NAME){m.refresh();break}}break}}}self.parent.$(".filter-form").trigger("dataChanged",d);self.parent.S3.popup_remove()}else if(c=b.refresh_layer,"undefined"!=typeof c){if(h=self.parent.S3.gis.maps,"undefined"!=typeof h)for(a in"undefined"!=c&&(c=parseInt(c)),d=self.parent.i18n.gis_draft_layer,h)for(q=h[a],u=q.layers,f=0,b=u.length;f<b;f++)if(e=u[f],e.s3_layer_id==c)for(v=e.strategies,e=0,l=v.length;e<l;e++){if(m=v[e],
"OpenLayers.Strategy.Refresh"==m.CLASS_NAME){m.refresh();break}}else if(e.name==d){for(;q.popups.length;)q.removePopup(q.popups[0]);m=e.features;for(e=m.length-1;0<=e;e--)m[e].destroy()}}else if(a=b.node)c=self.parent.$("#"+b.hierarchy),a=self.parent.$("#"+a),c&&a&&c.hierarchicalcrud("refreshNode",a),self.parent.S3.popup_remove();else if(a=b.agent,"undefined"!=typeof a)c="undefined"!=typeof f?[f]:[],self.parent.$("#"+a).trigger("configSaved",c);else if("undefined"!=typeof b.level)self.parent.S3.popup_remove();
else{var k=b.caller;if(void 0===k)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),self.parent.S3.popup_remove();else if(s3_debug("Caller: ",k),a=b.person_id,"undefined"!=typeof a)self.parent.$("#"+k).val(a).change(),self.parent.S3.popup_remove();else{c=new RegExp(".*\\"+S3.Ap+"\\/");a=b.child;if("undefined"===typeof a){d=(new String(self.location)).replace(c,"");d=d.split("?")[0].split("/");var r=d[1].split(".")[0]+"_id"}else r=a;s3_debug("child_resource",r);var w=b.parent;
f=new String(self.parent.location);a=b.prefix;d=f.replace(c,"");"undefined"===typeof w?(c=k.replace("_"+r,""),s3_debug("parent_field",c),b=c.replace(/_.*/,""),b=c.replace(b+"_",""),d=d.split("?")[0].split("/"),c=null,a||(a=d[0]),f=d[1],2<d.length&&(null!==d[2].match(/\d*/)?3<d.length&&(c=d[3]):c=d[2]),null!==c&&b!=f&&b==c&&(b=f+"/"+c)):(b=w,a||(d=f.replace(c,""),d=d.split("?")[0].split("/"),a=d[0]));s3_debug("parent_resource",b);s3_debug("lookup_prefix",a);a=S3.Ap.concat("/"+a+"/"+b+"/options.s3json?field="+
r);g=self.parent.$("#"+k);s3_debug("selector",g);var C="sub_"==k.substring(0,4),y=self.parent.$("#dummy_"+k),z=void 0!=y.val();s3_debug("has_dummy",z);var x=g.hasClass("checkboxes-widget-s3"),A=g.hasClass("s3-hierarchy-input");if(x){var D=self.parent.$("#"+k+" tbody tr:first").children().length;var n=[]}else{var E=self.parent.$("#"+k+" >option");(p="select"==g.prop("tagName").toLowerCase())?n=[]:a=A?a+"&hierarchy=1&only_last=1":a+"&only_last=1"}var t=1,B="";$.getJSONS3(a,function(a){var c,b,f,d=0;
$.each(a.option,function(){c=this["@value"];b=this.$;"undefined"===typeof b&&(b="");p?n.push(["<option value='",c,"'>",b,"</option>"].join("")):x?(f="id_"+r+"-"+d,n.push(["<td><input id='",f,"' name='",r,"' value='",c,"' type='checkbox'><label for='",f,"'>",b,"</label></td>"].join("")),d++):A&&(w=this["@parent"],g.parent().hierarchicalopts("addNode",w,c,b,!0));numeric_value=+c;numeric_value>t&&(t=numeric_value,B=b)});z&&(y.val(B),g.val(t).change());if(p){if(C){var e=["_0","_none","_default"],l=k.split("_").slice(0,
-1).join("_");for(a=0;a<e.length;a++){var m=e[a];self.parent.$("#"+l+m).empty().append(n.join(""))}}else E.remove(),g.append(n.join("")).val(t).change();g.val(t).change();g.prop("disabled",!1);if(g.hasClass("multiselect-widget")&&g.multiselect("instance"))try{g.multiselect("refresh")}catch(G){}}else if(x){var h=[];self.parent.$("#"+k+" input").each(function(a){$(this).prop("checked")&&h.push($(this).val())});e=[];for(a=d=0;a<n.length;a++)0===d?(e.push("<tr>"),e.push(n[a]),d++):d==D-1?(e.push(n[a]),
e.push("</tr>"),d=0):(e.push(n[a]),d++);g.html(e.join(""));h.push(t);for(a=0;a<h.length;a++)self.parent.$("#"+k+' input[value="'+h[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(f){f=f.substring(1);var p={};if(f){f=f.split("&");for(var l,a=0,b=f.length;a<b;a++)l=f[a].split("="),p[decodeURIComponent(l[0])]=decodeURIComponent(l[1])}return p};
