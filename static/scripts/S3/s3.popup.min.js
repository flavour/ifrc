function s3_popup_refresh_main_form(){var c=getQueryParams(document.location.search),a=c.refresh;if("undefined"!=typeof a){var f=self.parent.$("#"+a);if(f.hasClass("dl")){var b=c.record;void 0!==b?f.datalist("ajaxReloadItem",b):f.datalist("ajaxReload")}else try{f.dataTable().fnReloadAjax()}catch(E){}c=self.parent.S3.gis.maps;if("undefined"!=typeof c){var d,g,p,m,s,e,h,t,l;for(d in c)for(g=c[d],b=a.replace(/-/g,"_"),p=g.layers,m=0,s=p.length;m<s;m++)if(e=p[m],e.s3_layer_id==b){h=e.strategies;e=0;for(t=
h.length;e<t;e++)if(l=h[e],"OpenLayers.Strategy.Refresh"==l.CLASS_NAME){l.refresh();break}break}}d=self.parent.$("#"+a+"-filter-form");d.length&&self.parent.S3.search.ajaxUpdateOptions(d);self.parent.S3.popup_remove()}else if(b=c.refresh_layer,"undefined"!=typeof b){if(c=self.parent.S3.gis.maps,"undefined"!=typeof c)for(d in"undefined"!=b&&(b=parseInt(b)),a=self.parent.i18n.gis_draft_layer,c)for(g=c[d],p=g.layers,m=0,s=p.length;m<s;m++)if(e=p[m],e.s3_layer_id==b)for(h=e.strategies,e=0,t=h.length;e<
t;e++){if(l=h[e],"OpenLayers.Strategy.Refresh"==l.CLASS_NAME){l.refresh();break}}else if(e.name==a){for(;g.popups.length;)g.removePopup(g.popups[0]);h=e.features;for(e=h.length-1;0<=e;e--)h[e].destroy()}}else if(d=c.node)b=self.parent.$("#"+c.hierarchy),d=self.parent.$("#"+d),b&&d&&b.hierarchicalcrud("refreshNode",d),self.parent.S3.popup_remove();else if("undefined"!=typeof c.level)self.parent.S3.popup_remove();else{var k=c.caller;if(void 0===k)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),
self.parent.S3.popup_remove();else if(s3_debug("Caller: ",k),d=c.person_id,"undefined"!=typeof d)self.parent.$("#"+k).val(d).change(),self.parent.S3.popup_remove();else{d=new RegExp(".*\\"+S3.Ap+"\\/");var b=c.child,q;"undefined"===typeof b?(a=(new String(self.location)).replace(d,""),a=a.split("?")[0].split("/"),q=a[1].split(".")[0]+"_id"):q=b;s3_debug("child_resource",q);var u=c.parent;"undefined"===typeof u?(b=k.replace("_"+q,""),s3_debug("parent_field",b),a=b.replace(/_.*/,""),b=b.replace(a+"_",
""),a=new String(self.parent.location),a=a.replace(d,""),a=a.split("?")[0].split("/"),c=null,d=a[0],g=a[1],2<a.length&&(null!==a[2].match(/\d*/)?3<a.length&&(c=a[3]):c=a[2]),null!==c&&b!=g&&b==c&&(b=g+"/"+c)):(b=u,a=new String(self.parent.location),a=a.replace(d,""),a=a.split("?")[0].split("/"),d=a[0]);s3_debug("parent_resource",b);s3_debug("caller_prefix",d);d=S3.Ap.concat("/"+d+"/"+b+"/options.s3json?field="+q);f=self.parent.$("#"+k);s3_debug("selector",f);var B="sub_"==k.substring(0,4),x=self.parent.$("#dummy_"+
k),y=void 0!=x.val();s3_debug("has_dummy",y);var v=f.hasClass("checkboxes-widget-s3"),z=f.hasClass("s3-hierarchy-input"),n;if(v){var C=self.parent.$("#"+k+" tbody tr:first").children().length;n=[]}else{var D=self.parent.$("#"+k+" >option"),w="select"==f.prop("tagName").toLowerCase();w?n=[]:d=z?d+"&hierarchy=1&only_last=1":d+"&only_last=1"}var r=1,A="";$.getJSONS3(d,function(a){var c,b,d,e=0;$.each(a.option,function(){c=this["@value"];b=this.$;"undefined"===typeof b&&(b="");w?n.push(["<option value='",
c,"'>",b,"</option>"].join("")):v?(d="id_"+q+"-"+e,n.push(["<td><input id='",d,"' name='",q,"' value='",c,"' type='checkbox'><label for='",d,"'>",b,"</label></td>"].join("")),e++):z&&(u=this["@parent"],f.parent().hierarchicalopts("addNode",u,c,b,!0));numeric_value=+c;numeric_value>r&&(r=numeric_value,A=b)});y&&(x.val(A),f.val(r).change());if(w){if(B){var g=["_0","_none","_default"],h,m=k.split("_").slice(0,-1).join("_");for(a=0;a<g.length;a++)h=g[a],self.parent.$("#"+m+h).empty().append(n.join(""))}else D.remove(),
f.append(n.join("")).val(r).change();f.val(r).change();f.prop("disabled",!1);if(f.hasClass("multiselect-widget"))try{f.multiselect("refresh")}catch(p){}}else if(v){var l=[];self.parent.$("#"+k+" input").each(function(a){$(this).prop("checked")&&l.push($(this).val())});g=[];for(a=e=0;a<n.length;a++)0===e?(g.push("<tr>"),g.push(n[a]),e++):e==C-1?(g.push(n[a]),g.push("</tr>"),e=0):(g.push(n[a]),e++);f.html(g.join(""));l.push(r);for(a=0;a<l.length;a++)self.parent.$("#"+k+' input[value="'+l[a]+'"]').prop("checked",
!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(c){var a={};if(c=c.substring(1)){c=c.split("&");for(var f=[],b=0;b<c.length;b++)f=c[b].split("="),a[decodeURIComponent(f[0])]=decodeURIComponent(f[1])}return a};
