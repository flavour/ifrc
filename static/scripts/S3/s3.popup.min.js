function s3_popup_refresh_main_form(){var a=getQueryParams(document.location.search),l=a.refresh;if("undefined"!=typeof l){var k=self.parent.$("#"+l);if(k.hasClass("dl")){var b=a.record;void 0!==b?k.datalist("ajaxReloadItem",b):k.datalist("ajaxReload")}else try{k.dataTable().fnReloadAjax()}catch(B){}a=self.parent.S3.gis.maps;if("undefined"!=typeof a){var d,n,g,e,f,h,r;for(d in a)for(n=a[d],b=l.replace(/-/g,"_"),g=n.layers,e=0,f=g.length;e<f;e++)if(h=g[e],h.s3_layer_id==b){f=h.strategies;e=0;for(h=
f.length;e<h;e++)if(r=f[e],"OpenLayers.Strategy.Refresh"==r.CLASS_NAME){r.refresh();break}break}}d=self.parent.$("#"+l+"-filter-form");d.length&&self.parent.S3.search.ajaxUpdateOptions(d);self.parent.S3.popup_remove()}else if(b=a.refresh_layer,"undefined"!=typeof b){if(a=self.parent.S3.gis.maps,"undefined"!=typeof a){var b=parseInt(b),c;for(d in a){n=a[d];g=n.layers;e=0;for(f=g.length;e<f;e++)if(h=g[e],h.s3_layer_id==b){c=!0;f=h.strategies;e=0;for(h=f.length;e<h;e++)if(r=f[e],"OpenLayers.Strategy.Refresh"==
r.CLASS_NAME){r.refresh();break}break}if(c)if(-1!=document.location.pathname.indexOf("/create"))for(l=self.parent.i18n.gis_draft_layer,e=0,f=g.length;e<f;e++){if(h=g[e],h.name==l){l=h.features;for(e=l.length-1;0<=e;e--)g=l[e],f=g.popup,n.removePopup(f),f.destroy(),delete g.popup,g.destroy();break}}else for(;n.popups.length;)n.removePopup(n.popups[0])}}}else if("undefined"!=typeof a.level)self.parent.S3.popup_remove();else{var m=a.caller;if(void 0===m)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),
self.parent.S3.popup_remove();else if(s3_debug("Caller: ",m),d=a.person_id,"undefined"!=typeof d)self.parent.$("#"+m).val(d).change(),self.parent.S3.popup_remove();else{d=RegExp(".*\\"+S3.Ap+"\\/");var b=a.child,q;"undefined"===typeof b?(c=(new String(self.location)).replace(d,""),c=c.split("?")[0].split("/"),q=c[1]+"_id"):q=b;s3_debug("child_resource",q);b=a.parent;"undefined"===typeof b?(b=m.replace("_"+q,""),s3_debug("parent_field",b),c=b.replace(/_.*/,""),b=b.replace(c+"_",""),c=new String(self.parent.location),
c=c.replace(d,""),c=c.split("?")[0].split("/"),a=null,d=c[0],n=c[1],2<c.length&&(null!==c[2].match(/\d*/)?3<c.length&&(a=c[3]):a=c[2]),null!==a&&(b!=n&&b==a)&&(b=n+"/"+a)):(c=new String(self.parent.location),c=c.replace(d,""),c=c.split("?")[0].split("/"),d=c[0]);s3_debug("parent_resource",b);s3_debug("caller_prefix",d);d=S3.Ap.concat("/"+d+"/"+b+"/options.s3json?field="+q);k=self.parent.$("#"+m);s3_debug("selector",k);var z="sub_"==m.substring(0,4),v=self.parent.$("#dummy_"+m),w=void 0!=v.val();s3_debug("has_dummy",
w);var t=k.hasClass("checkboxes-widget-s3"),p;if(t){var A=self.parent.$("#"+m+" tbody tr:first").children().length;p=[]}else{var x=self.parent.$("#"+m+" >option"),u=x.length;u?p=[]:d+="&only_last=1"}var s=1,y="";$.getJSONS3(d,function(a){var b,c,e,d=0;$.each(a.option,function(){b=this["@value"];c=this.$;"undefined"===typeof c&&(c="");u?p.push(["<option value='",b,"'>",c,"</option>"].join("")):t&&(e="id_"+q+"-"+d,p.push(["<td><input id='",e,"' name='",q,"' value='",b,"' type='checkbox'><label for='",
e,"'>",c,"</label></td>"].join("")),d++);numeric_value=+b;numeric_value>s&&(s=numeric_value,y=c)});w&&(v.val(y),k.val(s).change());if(u){if(z){var f=["_0","_none","_default"],h,l=m.split("_").slice(0,-1).join("_");for(a=0;a<f.length;a++)h=f[a],self.parent.$("#"+l+h).empty().append(p.join(""))}else x.remove(),k.append(p.join("")).val(s).change();k.val(s).change()}else if(t){var g=[];self.parent.$("#"+m+" input").each(function(a){$(this).prop("checked")&&g.push($(this).val())});f=[];for(a=d=0;a<p.length;a++)0===
d?(f.push("<tr>"),f.push(p[a]),d++):d==A-1?(f.push(p[a]),f.push("</tr>"),d=0):(f.push(p[a]),d++);k.html(f.join(""));g.push(s);for(a=0;a<g.length;a++)self.parent.$("#"+m+' input[value="'+g[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(a){var l={};if(a=a.substring(1)){a=a.split("&");for(var k=[],b=0;b<a.length;b++)k=a[b].split("="),l[decodeURIComponent(k[0])]=decodeURIComponent(k[1])}return l};
