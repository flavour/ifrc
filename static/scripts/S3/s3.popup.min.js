function s3_popup_refresh_main_form(){var c=getQueryParams(document.location.search),a=c.refresh;if("undefined"!=typeof a){var g=self.parent.$("#"+a);if(g.hasClass("dl")){var b=c.record;void 0!==b?g.datalist("ajaxReloadItem",b):g.datalist("ajaxReload")}else try{g.dataTable().fnReloadAjax()}catch(C){}c=self.parent.S3.gis.maps;if("undefined"!=typeof c){var e,f,p,m,s,d,h,t,l;for(e in c)for(f=c[e],b=a.replace(/-/g,"_"),p=f.layers,m=0,s=p.length;m<s;m++)if(d=p[m],d.s3_layer_id==b){h=d.strategies;d=0;for(t=
h.length;d<t;d++)if(l=h[d],"OpenLayers.Strategy.Refresh"==l.CLASS_NAME){l.refresh();break}break}}e=self.parent.$("#"+a+"-filter-form");e.length&&self.parent.S3.search.ajaxUpdateOptions(e);self.parent.S3.popup_remove()}else if(b=c.refresh_layer,"undefined"!=typeof b){if(c=self.parent.S3.gis.maps,"undefined"!=typeof c)for(e in"undefined"!=b&&(b=parseInt(b)),a=self.parent.i18n.gis_draft_layer,c)for(f=c[e],p=f.layers,m=0,s=p.length;m<s;m++)if(d=p[m],d.s3_layer_id==b)for(h=d.strategies,d=0,t=h.length;d<
t;d++){if(l=h[d],"OpenLayers.Strategy.Refresh"==l.CLASS_NAME){l.refresh();break}}else if(d.name==a){for(;f.popups.length;)f.removePopup(f.popups[0]);h=d.features;for(d=h.length-1;0<=d;d--)h[d].destroy()}}else if("undefined"!=typeof c.level)self.parent.S3.popup_remove();else{var k=c.caller;if(void 0===k)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),self.parent.S3.popup_remove();else if(s3_debug("Caller: ",k),e=c.person_id,"undefined"!=typeof e)self.parent.$("#"+k).val(e).change(),
self.parent.S3.popup_remove();else{e=new RegExp(".*\\"+S3.Ap+"\\/");var b=c.child,q;"undefined"===typeof b?(a=(new String(self.location)).replace(e,""),a=a.split("?")[0].split("/"),q=a[1]+"_id"):q=b;s3_debug("child_resource",q);b=c.parent;"undefined"===typeof b?(b=k.replace("_"+q,""),s3_debug("parent_field",b),a=b.replace(/_.*/,""),b=b.replace(a+"_",""),a=new String(self.parent.location),a=a.replace(e,""),a=a.split("?")[0].split("/"),c=null,e=a[0],f=a[1],2<a.length&&(null!==a[2].match(/\d*/)?3<a.length&&
(c=a[3]):c=a[2]),null!==c&&b!=f&&b==c&&(b=f+"/"+c)):(a=new String(self.parent.location),a=a.replace(e,""),a=a.split("?")[0].split("/"),e=a[0]);s3_debug("parent_resource",b);s3_debug("caller_prefix",e);e=S3.Ap.concat("/"+e+"/"+b+"/options.s3json?field="+q);g=self.parent.$("#"+k);s3_debug("selector",g);var z="sub_"==k.substring(0,4),w=self.parent.$("#dummy_"+k),x=void 0!=w.val();s3_debug("has_dummy",x);var u=g.hasClass("checkboxes-widget-s3"),n;if(u){var A=self.parent.$("#"+k+" tbody tr:first").children().length;
n=[]}else{var B=self.parent.$("#"+k+" >option"),v="select"==g.prop("tagName").toLowerCase();v?n=[]:e+="&only_last=1"}var r=1,y="";$.getJSONS3(e,function(a){var c,b,e,d=0;$.each(a.option,function(){c=this["@value"];b=this.$;"undefined"===typeof b&&(b="");v?n.push(["<option value='",c,"'>",b,"</option>"].join("")):u&&(e="id_"+q+"-"+d,n.push(["<td><input id='",e,"' name='",q,"' value='",c,"' type='checkbox'><label for='",e,"'>",b,"</label></td>"].join("")),d++);numeric_value=+c;numeric_value>r&&(r=numeric_value,
y=b)});x&&(w.val(y),g.val(r).change());if(v){if(z){var f=["_0","_none","_default"],h,m=k.split("_").slice(0,-1).join("_");for(a=0;a<f.length;a++)h=f[a],self.parent.$("#"+m+h).empty().append(n.join(""))}else B.remove(),g.append(n.join("")).val(r).change();g.val(r).change();g.prop("disabled",!1);if(g.hasClass("multiselect-widget"))try{g.multiselect("refresh")}catch(p){}}else if(u){var l=[];self.parent.$("#"+k+" input").each(function(a){$(this).prop("checked")&&l.push($(this).val())});f=[];for(a=d=0;a<
n.length;a++)0===d?(f.push("<tr>"),f.push(n[a]),d++):d==A-1?(f.push(n[a]),f.push("</tr>"),d=0):(f.push(n[a]),d++);g.html(f.join(""));l.push(r);for(a=0;a<l.length;a++)self.parent.$("#"+k+' input[value="'+l[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(c){var a={};if(c=c.substring(1)){c=c.split("&");for(var g=[],b=0;b<c.length;b++)g=c[b].split("="),a[decodeURIComponent(g[0])]=decodeURIComponent(g[1])}return a};
