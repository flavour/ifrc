function s3_popup_refresh_main_form(){var a=getQueryParams(document.location.search),m=a.refresh;if("undefined"!=typeof m){var g=self.parent.$("#"+m);if(g.hasClass("dl")){var b=a.record;void 0!==b?g.datalist("ajaxReloadItem",b):g.datalist("ajaxReload")}else try{g.dataTable().fnReloadAjax()}catch(D){}a=self.parent.S3.gis.maps;if("undefined"!=typeof a){var f,p,q,e,k,d,h;for(f in a)for(p=a[f],b=m.replace(/-/g,"_"),q=p.layers,e=0,k=q.length;e<k;e++)if(d=q[e],d.s3_layer_id==b){e=d.strategies;d=0;for(k=
e.length;d<k;d++)if(h=e[d],"OpenLayers.Strategy.Refresh"==h.CLASS_NAME){h.refresh();break}break}}f=self.parent.$("#"+m+"-filter-form");f.length&&self.parent.S3.search.ajaxUpdateOptions(f);self.parent.S3.popup_remove()}else if(b=a.refresh_layer,"undefined"!=typeof b){if(a=self.parent.S3.gis.maps,"undefined"!=typeof a){var b=parseInt(b),c;for(f in a){p=a[f];q=p.layers;e=0;for(k=q.length;e<k;e++)if(d=q[e],d.s3_layer_id==b){c=!0;e=d.strategies;d=0;for(k=e.length;d<k;d++)if(h=e[d],"OpenLayers.Strategy.Refresh"==
h.CLASS_NAME){h.refresh();break}break}if(c){var t,u,m=self.parent.i18n.gis_draft_layer;e=0;for(k=q.length;e<k;e++)if(d=q[e],d.name==m)for(h=d.features,d=h.length-1;0<=d;d--)t=h[d],u=t.popup,p.removePopup(u),u.destroy(),delete t.popup,t.destroy()}}}}else if("undefined"!=typeof a.level)self.parent.S3.popup_remove();else{var l=a.caller;if(void 0===l)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),self.parent.S3.popup_remove();else if(s3_debug("Caller: ",l),f=a.person_id,
"undefined"!=typeof f)self.parent.$("#"+l).val(f).change(),self.parent.S3.popup_remove();else{f=RegExp(".*\\"+S3.Ap+"\\/");var b=a.child,r;"undefined"===typeof b?(c=(new String(self.location)).replace(f,""),c=c.split("?")[0].split("/"),r=c[1]+"_id"):r=b;s3_debug("child_resource",r);b=a.parent;"undefined"===typeof b?(b=l.replace("_"+r,""),s3_debug("parent_field",b),c=b.replace(/_.*/,""),b=b.replace(c+"_",""),c=new String(self.parent.location),c=c.replace(f,""),c=c.split("?")[0].split("/"),a=null,f=
c[0],p=c[1],2<c.length&&(null!==c[2].match(/\d*/)?3<c.length&&(a=c[3]):a=c[2]),null!==a&&(b!=p&&b==a)&&(b=p+"/"+a)):(c=new String(self.parent.location),c=c.replace(f,""),c=c.split("?")[0].split("/"),f=c[0]);s3_debug("parent_resource",b);s3_debug("caller_prefix",f);f=S3.Ap.concat("/"+f+"/"+b+"/options.s3json?field="+r);g=self.parent.$("#"+l);s3_debug("selector",g);var B="sub_"==l.substring(0,4),x=self.parent.$("#dummy_"+l),y=void 0!=x.val();s3_debug("has_dummy",y);var v=g.hasClass("checkboxes-widget-s3"),
n;if(v){var C=self.parent.$("#"+l+" tbody tr:first").children().length;n=[]}else{var z=self.parent.$("#"+l+" >option"),w=z.length;w?n=[]:f+="&only_last=1"}var s=1,A="";$.getJSONS3(f,function(a){var b,c,f,d=0;$.each(a.option,function(){b=this["@value"];c=this.$;"undefined"===typeof c&&(c="");w?n.push(["<option value='",b,"'>",c,"</option>"].join("")):v&&(f="id_"+r+"-"+d,n.push(["<td><input id='",f,"' name='",r,"' value='",b,"' type='checkbox'><label for='",f,"'>",c,"</label></td>"].join("")),d++);
numeric_value=+b;numeric_value>s&&(s=numeric_value,A=c)});y&&(x.val(A),g.val(s).change());if(w){if(B){var e=["_0","_none","_default"],k,m=l.split("_").slice(0,-1).join("_");for(a=0;a<e.length;a++)k=e[a],self.parent.$("#"+m+k).empty().append(n.join(""))}else z.remove(),g.append(n.join("")).val(s).change();g.val(s).change()}else if(v){var h=[];self.parent.$("#"+l+" input").each(function(a){$(this).prop("checked")&&h.push($(this).val())});e=[];for(a=d=0;a<n.length;a++)0===d?(e.push("<tr>"),e.push(n[a]),
d++):d==C-1?(e.push(n[a]),e.push("</tr>"),d=0):(e.push(n[a]),d++);g.html(e.join(""));h.push(s);for(a=0;a<h.length;a++)self.parent.$("#"+l+' input[value="'+h[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(a){var m={};if(a=a.substring(1)){a=a.split("&");for(var g=[],b=0;b<a.length;b++)g=a[b].split("="),m[decodeURIComponent(g[0])]=decodeURIComponent(g[1])}return m};
