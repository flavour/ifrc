/*
 2016 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(c,l){var m=0;c.widget("dvr.eventRegistration",{options:{tablename:"case_event",ajax:null,ajaxURL:""},_create:function(){this.id=m;m+=1;this.eventNamespace=".eventRegistration"},_init:function(){this.idPrefix="#"+this.options.tablename;var a=c(this.element);this.flagInfo=a.find("input[type=hidden][name=flags]");this.permissionInfo=a.find("input[type=hidden][name=permitted]");this.actionableInfo=a.find("input[type=hidden][name=actionable]");this.eventType=a.find('input[type="hidden"][name="event"]');
this.blockingInfo=a.find('input[type="hidden"][name="intervals"]');this.actionDetails=a.find('input[type="hidden"][name="actions"]');this.blockedEvents=(a=this.blockingInfo.val())?JSON.parse(a):{};this.blockingMessage=null;this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,b=this.idPrefix;this._unbindEvents();a.ajaxURL&&null===a.ajax&&(a.ajax=!0);this._showFlagInfo();c(this.element).find(b+"_details__row .controls").addClass("has-details");
this.actionDetails.length?JSON.parse(this.actionDetails.val()).length?this._showDetails(!0):this._hideDetails():this._hideDetails();this._checkBlockedEvents()||this._toggleSubmit(!1);a=c(b+"_label");a.focus().val(a.val());this._bindEvents()},_checkID:function(){this._clearAlert();c(this.element);var a=this.idPrefix,b=c(a+"_label"),d=b.val().trim();b.val(d);if(d){var b={l:d,c:!0},d=this.options.ajaxURL,e=c(a+"_person__row .controls").empty(),g=c('<div class="inline-throbber">').insertAfter(e),f=this;
this._clearDetails();c.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(b),success:function(b){g.remove();if(b.e)c('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+b.e+"</div></div>").hide().insertAfter(c(a+"_label")).slideDown();else{e.html(b.p).removeClass("hide").show();var d=f.flagInfo;b.f?d.val(JSON.stringify(b.f)):d.val("[]");d=f.permissionInfo;b.s!==l?d.val(JSON.stringify(b.s)):d.val("false");
var d=f.actionableInfo,k=b.u;d.length&&(k!==l?d.val(JSON.stringify(b.u)):(k=!0,d.val("true")));b.d&&f._updateDetails(b.d,k);f.blockedEvents=b.i||{};f.blockingInfo.val(JSON.stringify(f.blockedEvents));f.eventType.val()&&f._toggleSubmit(!0);f._showFlagInfo()}b.a?S3.showAlert(b.a,"error"):b.m&&S3.showAlert(b.m,"success")},error:function(){g.remove();f._clearForm(!0)}})}},_registerEvent:function(){this._clearAlert();var a=this.idPrefix,b=c(a+"_label").val(),d=this.eventType.val();if(b&&d){var b={l:b,
t:d},d=this.options.ajaxURL,e=c(a+"_person__row .controls"),g=c('<div class="inline-throbber">').insertAfter(e),f=this,e=this.actionDetails;e.length&&(e=e.val(),b.d=e?JSON.parse(e):[]);b.c=c(a+"comments").val();c.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(b),success:function(b){g.remove();b.e?c('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+b.e+"</div></div>").hide().insertAfter(c(a+"_label")).slideDown():
f._clearForm();b.a?S3.showAlert(b.a,"error",!1):b.m&&S3.showAlert(b.m,"success",!1)},error:function(){g.remove();this._clearForm(!0)}})}},_checkBlockedEvents:function(){var a=this.eventType.val(),a=this.blockedEvents[a];this.blockingMessage&&this.blockingMessage.remove();if(a){var b='<div class="small-12 columns">'+a[0]+"</div>";if(new Date(a[1])>new Date)return this.blockingMessage=c(b).css({color:"red"}).prependTo(c("#submit_record__row")),!1}return!0},_showFlagInfo:function(){var a=this.flagInfo,
b=c(this.idPrefix+"_flaginfo__row .controls").empty(),a=a.length?JSON.parse(a.val()):[],d=a.length;if(d){b.addClass("has-flaginfo");for(var b=c('<div class="checkpoint-advise">').hide().appendTo(b),e,g,f=0;f<d;f++)e=a[f],g=c('<div class="checkpoint-instructions">').appendTo(b),c("<h4>"+e.n+"</h4>").appendTo(g),e.i&&c("<p>"+e.i+"</p>").appendTo(g);b.slideDown()}},_hideDetails:function(){var a=this.idPrefix;c(a+"_person__row .controls").text()?c(a+"_details__row").show():c(a+"_details__row").hide();
c(a+"_date__row").hide();c(a+"_comments__row").hide()},_showDetails:function(a){var b=this.idPrefix;c(b+"_details__row").show();a&&(c(b+"_date__row").show(),c(b+"_comments__row").show())},_updateDetails:function(a,b){var d=this.idPrefix;c(d+"_details__row .controls");c(d+"_date__row .controls");var e=this.actionDetails;e.length&&(""!==a.h?e.val(JSON.stringify(a.h)):e.val("[]"));c(d+"_details__row .controls").html(a.d);c(d+"_date__row .controls").html(a.t);this._showDetails(b)},_clearDetails:function(){var a=
this.idPrefix;this._hideDetails();this.flagInfo.val("[]");this.permissionInfo.val("false");c(a+"_flaginfo__row .controls").empty();c(a+"_details__row .controls").empty();c(a+"_date__row .controls").empty();c(a+"_comments").val("");this.blockedEvents={};this.blockingMessage&&this.blockingMessage.remove();this.blockingInfo.val(JSON.stringify(this.blockedEvents))},_toggleSubmit:function(a){var b=c(this.element),d=[".check-btn",".submit-btn"],e=this.permissionInfo,g=this.actionableInfo;if(a){var f=a=
!1;e.length&&(e=e.val())&&(a=JSON.parse(e));a&&(f=!0,g.length&&(g=g.val())&&(f=JSON.parse(g)));a&&f&&(f=this._checkBlockedEvents());a&&f&&d.reverse()}e=b.find(d[0]);b.find(d[1]).prop("disabled",!0).hide().insertAfter(e);e.prop("disabled",!1).hide().removeClass("hide").show()},_clearAlert:function(){c(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");c(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(a,b){var d=this.idPrefix;c(".inline-throbber").remove();
a||this._clearAlert();b||c(d+"_label").val("");c(d+"_person__row .controls").hide().empty();this._clearDetails();this._toggleSubmit(!1)},_bindEvents:function(){var a=c(this.element),b=this.idPrefix,d=this.eventNamespace,e=this,g=c(".zxing-button"),f=c("#event-type-toggle"),h=c("#event-type-selector");-1==navigator.userAgent.toLowerCase().indexOf("android")?g.addClass("disabled").click(function(a){a.preventDefault();a.stopPropagation();return!1}):g.bind("click"+d,function(){e._clearAlert()});f.bind("click"+
d,function(){e._clearAlert();h.hasClass("hide")?h.hide().removeClass("hide").slideDown():h.slideToggle()});h.find("a.event-type-selector").bind("click"+d,function(){var a=c(this),d=a.data("code"),a=a.data("name");c('input[type="hidden"][name="event"]').val(d);c(".event-type-name").text(a);c(b+"_person__row .controls").text()&&e._toggleSubmit(!0);g.each(function(){var a=c(this),b=a.data("tmp");b&&a.attr("href",b.replace("%7BEVENT%7D",d))});h.slideUp()});a.find("a.cancel-action").bind("click"+d,function(a){a.preventDefault();
e._clearForm()});this.options.ajax&&(a.find(".check-btn").bind("click"+d,function(a){a.preventDefault();e._checkID()}),a.find(".submit-btn").unbind(d).bind("click"+d,function(a){a.preventDefault();e._registerEvent()}));a=c(b+"_label");a.bind("input"+d,function(a){e._clearForm(!1,!0)});a.bind("keyup"+d,function(a){switch(a.which){case 27:e._clearForm()}});return!0},_unbindEvents:function(){var a=c(this.element),b=this.eventNamespace,d=this.idPrefix;c(".zxing-button").unbind(b).unbind("click");c("#event-type-toggle").unbind(b);
c("#event-type-selector").find("a.event-type-selector").unbind(b);c(d+"_label").unbind(b);a.find("a.cancel-action").unbind(b);a.find(".check-btn").unbind(b);a.find(".submit-btn").unbind(b);return!0}})})(jQuery);
