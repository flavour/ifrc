var drawerOpen=!1,colors={"0":"#999999",1:"#ff5121",2:"#f4961c",3:"#d6b317",4:"#77b826",5:"#059346"},map,parser,proj4326,resilienceLayer,current_l0,current_l1,current_l2,current_l3,current_l4;S3.i18n.gis_requires_login="Requires Login";yepnope({load:[S3.Ap.concat("/static/scripts/gis/OpenLayers.js")],complete:function(){showMap()}});
$(document).ready(function(){$("#dataTopBar").hover(function(){$("#dataTopBar img").css("background-color","#f7941d");$("#dataTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowOverPng8.png"));$("#dataOptions").fadeIn(150);$("#defaultDataLink").css("color","#c47a21")},function(){$("#dataTopBar img").css("background-color","transparent");$("#dataTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowPng8.png"));$("#dataOptions").fadeOut(150);
$("#defaultDataLink").css("color","#f7941d")});$("#reportsTopBar").hover(function(){$("#reportsTopBar img").css("background-color","#f7941d");$("#reportsTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowOverPng8.png"));$("#reportsOptions").fadeIn(150);$("#defaultReportsLink").css("color","#c47a21")},function(){$("#reportsTopBar img").css("background-color","transparent");$("#reportsTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowPng8.png"));
$("#reportsOptions").fadeOut(150);$("#defaultReportsLink").css("color","#f7941d")});var b=$("#dummy_location_search").val(),a=!1,d=function(a){switch(a.level){case "L0":return a.name;case "L1":return a.name+","+a.L0;case "L2":return a.name+","+a.L1+","+a.L0;case "L3":return a.name+","+a.L2+","+a.L1+","+a.L0;case "L4":return a.name+","+a.L3+","+a.L2+","+a.L1+","+a.L0;case "None":return a.label}},e=$.ui.autocomplete.prototype._response;$.ui.autocomplete.prototype._response=function(a){e.apply(this,
[a]);this.element.trigger("autocompletesearchcomplete",[a])};$("#dummy_location_search").autocomplete({source:S3.Ap.concat("/gis/location/search.json?location.level__ne=None&filter=~&field=name&simple=1"),delay:450,minLength:2,position:{my:"left bottom",at:"left top"},search:function(){$("#dummy_location_search_throbber").removeClass("hidden").show();return!0},response:function(a,b,c){$("#dummy_location_search_throbber").hide();0==b.content.length&&($().autocomplete("widget"),a=$("#dummy_location_search").autocomplete("option",
"source"),$("#dummy_location_search").autocomplete("option","source",[{label:"No matching result",value:0,id:0,name:"No matching result",level:"None"}]),$("#dummy_location_search").autocomplete("search","No"),c=[{label:"No matching result",value:0,level:"None",id:0,name:"No matching result"}],$("#dummy_location_search").autocomplete("option","source",a));return c},focus:function(a,b){$("#dummy_location_search").val(b.item.name);return!1},select:function(b,c){var d=c.item.id;$("#dummy_location_search").val(c.item.name);
$("#location_search").val(d);$("#location_search").change();a=!0;$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+d),success:function(){for(var a in n)vdata[a]=n[a];n=null;v_select_region(parseInt(c.item.level[1]),d)},error:function(a,b,j){msg="UNAUTHORIZED"==j?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"script"});return!1}}).data("autocomplete")._renderItem=function(a,b){return $("<li></li>").data("item.autocomplete",b).append("<a>"+d(b)+"</a>").appendTo(a)};$("#dummy_location_search").blur(function(){$("#dummy_location_search").val()||
($("#location_search").val(""),a=!0);a?b=$("#dummy_location_search").val():$("#dummy_location_search").val(b);a=!1});$("#dummy_location_search").bind("autocompletesearchcomplete",function(a,b){0==b.length&&$("#dummy_location_search").autocomplete("widget").show()});var c=[],f,i;for(i in idata)f="        <li>            <div class='indicatorRatingLabel'>                <div class='listText'>"+idata[i].n+"</div>                <div class='popup'>                    <div class='popupContent'>                        <h3>"+
idata[i].n+"</h3>                        <p>"+idata[i].d+"</p>                    </div>                    <div class='popupBottom'></div>                </div>            </div>            <div class='visRange'>                <div class='indicatorRange' id='visRange"+i+"'>                    <div class='leftBox'></div>                    <div class='medianDot'></div>                    <div class='rightBox'></div>                </div>            </div>        </li>",c.push(f);$("#indicatorRatingChart ul").html(c.join(""));
for(var h in vdata){switch(vdata[h].r){case 1:c="one";break;case 2:c="two";break;case 3:c="three";break;case 4:c="four";break;case 5:c="five";break;default:c="none"}f=h==start?' selected="selected"':"";0==vdata[h].l?$("#l0_select").append('<option value="'+h+'" class="'+c+'"'+f+">"+vdata[h].n+"</option>"):1==vdata[h].l&&$("#l1_select").append('<option value="'+h+'" class="'+c+'">'+vdata[h].n+"</option>")}$("#l0_select").change(function(){var a=$("#l0_select").val(),b=hdata[a];$("#l1_select").html('<option value="" selected="selected" class="none">Choose '+
b.l1+"</option>");try{var c,d;for(d in vdata){switch(vdata[d].r){case 1:c="one";break;case 2:c="two";break;case 3:c="three";break;case 4:c="four";break;case 5:c="five";break;default:c="none"}null!=vdata[d].f&&vdata[d].f==a&&$("#l1_select").append('<option value="'+d+'" class="'+c+'">'+vdata[d].n+"</option>")}$("#l1 label").html(capitalize(b.l1)+":");$("#l2 label").html(capitalize(b.l2)+":");$("#l3 label").html(capitalize(b.l3)+":");$("#l4 label").html(capitalize(b.l4)+":");$("#browseOtherRegions select").selectmenu({style:"popup",
maxHeight:280,width:160,menuWidth:160,icons:[{find:".one"},{find:".two"},{find:".three"},{find:".four"},{find:".five"}]})}catch(e){$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+a),success:function(){for(var j in n)vdata[j]=n[j];n=null;var c;for(j in vdata){switch(vdata[j].r){case 1:c="one";break;case 2:c="two";break;case 3:c="three";break;case 4:c="four";break;case 5:c="five";break;default:c="none"}null!=vdata[j].f&&vdata[j].f==a&&$("#l1_select").append('<option value="'+j+'" class="'+c+'">'+vdata[j].n+
"</option>")}$("#l1 label").html(capitalize(b.l1)+":");$("#l2 label").html(capitalize(b.l2)+":");$("#l3 label").html(capitalize(b.l3)+":");$("#l4 label").html(capitalize(b.l4)+":");$("#browseOtherRegions select").selectmenu({style:"popup",maxHeight:280,width:160,menuWidth:160,icons:[{find:".one"},{find:".two"},{find:".three"},{find:".four"},{find:".five"}]})},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText},dataType:"script"})}});TypeHelpers.insertClasses();$(".closechromeframe").click(function(){$(".chromeframe").hide()});
$("#show-hide").click(function(){drawerSlide()});$("#risingTab").click(function(){drawerSlide()});$(".calculationLink").click(function(){$("#lightbox, #calculationView").fadeIn(300)});$("#calculationView .closePanel").click(function(){$("#lightbox, #calculationView").fadeOut(300)});$("#lightbox").click(function(){$("#lightbox, #reportsSection, #calculationView, #photoPanel").fadeOut(300)});$("#reportsSection .closePanel").click(function(){$("#lightbox, #reportsSection").fadeOut(300)});$(".listText").hover(function(){$(this).siblings(".popup").show()},
function(){$(this).siblings(".popup").hide()});$(".reviewButton").click(function(){$(".rowForApproval").hide();$(".rowForApproval").prev().find(".closeReviewButton").hide();$(".rowForApproval").prev().find(".reviewButton").fadeIn(200);$(this).parent().parent().next(".hiddenRow").addClass("rowForApproval").show("slow");$(this).hide();$(this).siblings(".closeReviewButton").fadeIn(200);resizeReports()});$(".closeReviewButton").click(function(){$(this).parent().parent().next(".hiddenRow").hide();$(this).hide();
$(this).siblings(".reviewButton").fadeIn(200);resizeReports()});$(".approveButton, .declineButton").click(function(){console.log($(this).parent().parent().parent());console.log($(this).parent().parent().parent().prev());$(this).parent().parent().parent().hide();$(this).parent().parent().parent().prev().hide();$(this).hasClass("approveButton")?$(".approvalScreen .thanks").html("Thank you for your approval."):$(".approvalScreen .thanks").html("Thank you, the submission<br />has been declined.");$(".approvalScreen").fadeIn(300);
$(".approvalScreen").data("approvalTimeout",setTimeout(function(){$(".approvalScreen").fadeOut(300)},5E3));resizeReports()});$(".headerRow").click(function(){$(".rowForApproval").hide();$(".rowForApproval").prev().find(".closeReviewButton").hide();$(".rowForApproval").prev().find(".reviewButton").show();$(".headerRow.activeSection td.arrowCell .arrow").html("&rarr;");$(".headerRow.activeSection").removeClass("activeSection");$(this).addClass("activeSection");$(".headerRow.activeSection .arrow").html("&darr;");
$(".activeContent").hide("slow");$(".activeContent").removeClass("activeContent");$(this).next().addClass("activeContent");$(this).parent().next().addClass("activeContent");$(".activeContent").fadeIn(200);resizeReports()});$("#filterSubmit").click(function(){var a={};$("#table-container").empty();$("#table-container").append("<span class='loading'>Loading Reports...</span>");var b=-1;"na"!=$("#l4_reports").val()?b=$("#l4_reports").val():"na"!=$("#l3_reports").val()?b=$("#l3_reports").val():"na"!=
$("#l2_reports").val()?b=$("#l2_reports").val():"na"!=$("#l1_reports").val()?b=$("#l1_reports").val():"na"!=$("#l0_reports").val()&&(b=$("#l0_reports").val());a.location_id=b;a.from_date=$("#dateFromReports").val();a.to_date=$("#dateToReports").val();$("#indicatorsCheckbox").is(":checked")&&(a.indicator=!0);$("#mapCheckbox").is(":checked")&&(a.map=!0);$("#imagesCheckbox").is(":checked")&&(a.images=!0);$("#reportsCheckbox").is(":checked")&&(a.reports=!0);$("#demographicsCheckbox").is(":checked")&&
(a.demographics=!0);$.ajax({type:"POST",url:"report/filter",data:a}).done(function(a){displayReport(a)}).fail(function(){alert("error")})})});
function showMap(){OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");proj4326=new OpenLayers.Projection("EPSG:4326");map=new OpenLayers.Map("map",{theme:null});var b=new OpenLayers.Layer.OSM("OpenStreetMap",["http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png"],{attribution:'Tiles Courtesy of <a href="http://open.mapquest.co.uk/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" border="0">'});
map.addLayer(b);parser=new OpenLayers.Format.GeoJSON({});b=new OpenLayers.Style({fillColor:"${fill}",fillOpacity:"${fillOpacity}",strokeColor:"#ffffff",strokeWidth:"${strokeWidth}",strokeOpacity:1,graphicWidth:14,graphicHeight:14,graphicXOffset:-7,graphicYOffset:-14,graphicOpacity:1,externalGraphic:"${externalGraphic}"},{context:{fill:function(a){return colors[a.attributes.r]},fillOpacity:function(a){return a.attributes.outline?0.1:0.5},strokeWidth:function(a){return a.attributes.outline?3:1},externalGraphic:function(a){a=
a.attributes.r;if(5==a)a="/static/themes/Vulnerability/img/rating5.png";else if(4==a)a="/static/themes/Vulnerability/img/rating4.png";else if(3==a)a="/static/themes/Vulnerability/img/rating3.png";else if(2==a)a="/static/themes/Vulnerability/img/rating2.png";else if(1==a)a="/static/themes/Vulnerability/img/rating1.png";else return"";return S3.Ap.concat(a)}}});b=new OpenLayers.StyleMap({"default":b,select:{fillOpacity:1}});strategy=new OpenLayers.Strategy.Fixed;protocol=new OpenLayers.Protocol.HTTP({url:S3.Ap.concat("/static/cache/countries.geojson"),
format:parser});resilienceLayer=new OpenLayers.Layer.Vector("Resilience",{strategies:[strategy],protocol:protocol,styleMap:b});map.addLayer(resilienceLayer);resilienceLayer.events.on({beforefeatureadded:addAttributes,featureselected:onResilienceFeatureSelect,featureunselected:onFeatureUnselect});""==start?globalView():v_select_region(0,start);b=new OpenLayers.Control.SelectFeature(resilienceLayer,{toggle:!0});b.handlers.feature.callbacks.dblclick=function(a){closePopups();v_select_region(a.attributes.l,
a.attributes.id)};map.addControl(b);b.activate()}
function addAttributes(b){var a=b.feature,d=a.attributes.id,e;try{e=vdata[d].l}catch(c){$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+d),async:!1,success:function(){for(var a in n)vdata[a]=n[a];n=null;e=vdata[d].l},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"script"})}b=vdata[d].r;a.attributes.l=e;a.attributes.r=b;a=a.geometry;0!=a.getArea()&&(b=new OpenLayers.Feature.Vector(a.getCentroid(),{id:parseInt(d),l:e,r:b}),resilienceLayer.addFeatures([b]))}
function onFeatureUnselect(b){b=b.feature;b.popup&&(map.removePopup(b.popup),b.popup.destroy(),delete b.popup)}
function onResilienceFeatureSelect(b){drawerOpen&&drawerSlide;var b=b.feature,a=b.attributes.id,d=b.attributes.l,e="    <h3>DATA QUALITY:</h3>     <div class='windowQualityRatings'>        <div class='poor'>POOR            <div class='popup'>                <div class='popupContent'>                    <h3>POOR</h3>                    <p>0&ndash;25% of total data reported.</p>                </div>                <div class='popupBottom'></div>            </div>        </div> |         <div class='fair'>FAIR            <div class='popup'>                <div class='popupContent'>                    <h3>FAIR</h3>                    <p>25&ndash;50% of total data reported.</p>                </div>                <div class='popupBottom'></div>            </div>        </div> |         <div class='moderate'>MODERATE            <div class='popup'>                <div class='popupContent'>                    <h3>MODERATE</h3>                    <p>50&ndash;75% of total data reported.</p>                </div>                <div class='popupBottom'></div>            </div>        </div> |         <div class='strong'>STRONG            <div class='popup'>                <div class='popupContent'>                    <h3>STRONG</h3>                    <p>75&ndash;100% of total data reported.</p>                </div>                <div class='popupBottom'></div>            </div>        </div>    </div>",c=
vdata[a];switch(d){case 0:var f=hdata[a],i="Country",h="COUNTRY",k=capitalize(f.l1),g=f.l4,k="            <h3>"+k+"S IN THIS "+h+":</h3>            <select class='subGeoSelect'></select>\t\t\t<a id='goToSubRegion' class='goToSubRegion'>GO TO THE "+k+" <span class='arrow'>&rarr;</span></a>";break;case 1:f=hdata[current_l0];i=f.l1;h=capitalize(i);k=capitalize(f.l2);g=f.l4;k="            <h3>"+k+"S IN THIS "+h+":</h3>            <select class='subGeoSelect'></select>\t\t\t<a id='goToSubRegion' class='goToSubRegion'>GO TO THE "+
k+" <span class='arrow'>&rarr;</span></a>";break;case 2:f=hdata[current_l0];i=f.l2;h=capitalize(i);k=capitalize(f.l3);g=f.l4;k="            <h3>"+k+"S IN THIS "+h+":</h3>            <select class='subGeoSelect'></select>\t\t\t<a id='goToSubRegion' class='goToSubRegion'>GO TO THE "+k+" <span class='arrow'>&rarr;</span></a>";break;case 3:f=hdata[current_l0];i=f.l3;h=capitalize(i);k=capitalize(f.l4);g=f.l4;k="            <h3>"+k+"S IN THIS "+h+":</h3>            <select class='subGeoSelect'></select>\t\t\t<a id='goToSubRegion' class='goToSubRegion'>GO TO THE "+
k+" <span class='arrow'>&rarr;</span></a>";break;case 4:f=hdata[current_l0],i=f.l4,h=capitalize(i),k="",e="<div class='lastCollected'></div>"}var l=c.n,f=c.r;0==f&&(f="");g&&(e+="<div class='subGeoCommunesReported'> out of  "+capitalize(g)+"S Reported</div>");var i="    <section class='infoWindow'>\t\t<div class='infoWindowMain'>\t\t\t<div id='subGeoIndicator'>"+f+"</div>\t\t\t<h2 class='subGeoName'>"+l+"</h2>\t\t\t<h2 class='subGeoType'>"+i+"</h2>\t\t\t<a id='goToRegion' class='goToSubRegion'>GO TO THE "+
h+" <span class='arrow'>&rarr;</span></a>\t\t\t"+e+"\t\t\t<h3 id='population'>POPULATION: </h3>\t\t\t"+k+"\t\t\t<div class='infoWindowButtons'>\t\t\t\t<div class='subGeoSubmitDataButton'>Submit Data</div>\t\t\t\t<div class='subGeoAnalysisButton'>Analysis</div>\t\t\t\t<div class='subGeoReportsButton'>Reports</div>\t\t\t</div>\t\t</div>\t</section>",h=b.geometry.getBounds().getCenterLonLat(),m=new OpenLayers.Popup.FramedCloud(a,h,new OpenLayers.Size(200,200),i,null,!0,closePopups);b.popup=m;map.addPopup(m);
$("#goToRegion").click(function(){v_select_region(d,a)});$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+a),success:function(){for(var b in n)vdata[b]=n[b];n=null;c=vdata[a];g?$(".subGeoCommunesReported").html(c.c+" out of "+c.t+" "+g+"s Reported"):$(".windowQualityRatings").html("Last Data Collected on "+c.t+" by "+c.c);var j=c.p;null!=j&&$("#population").html("POPULATION: "+j);switch(c.q){case "p":$(".poor").addClass("currentQuality");break;case "f":$(".fair").addClass("currentQuality");break;
case "m":$(".moderate").addClass("currentQuality");break;case "s":$(".strong").addClass("currentQuality")}for(b in vdata)if(vdata[b].l==d+1&&vdata[b].f==a){switch(vdata[b].r){case 1:j="one";break;case 2:j="two";break;case 3:j="three";break;case 4:j="four";break;case 5:j="five";break;default:j="none"}$(".subGeoSelect").append('<option value="'+b+'" class="'+j+'">'+vdata[b].n+"</option>")}$(".subGeoSelect").selectmenu({style:"popup",maxHeight:280,width:160,menuWidth:160,icons:[{find:".one"},{find:".two"},
{find:".three"},{find:".four"},{find:".five"}]});$("#goToSubRegion").click(function(){var a=$(".subGeoSelect").val();v_select_region(d+1,a)});m.updateSize()},error:function(b,j,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:b.responseText;$("#"+a+"_contentDiv").html(msg);m.updateSize()},dataType:"script"});""==f?$("#subGeoIndicator").css("background-color",colors[0]):$("#subGeoIndicator").css("background-color",colors[f])}
function closePopups(){for(;map.popups.length;)map.removePopup(map.popups[0])}function hideFeature(b){var b=resilienceLayer.getFeaturesByAttribute("id",parseInt(b)),a;for(a in b)try{var d=b[a];0==d.geometry.getArea()?d.destroy():(d.attributes.outline=1,resilienceLayer.drawFeature(d))}catch(e){}}
function showFeature(b){if(null!=b){var a=resilienceLayer.getFeaturesByAttribute("id",parseInt(b)),d;for(d in a)try{var e=a[d];e.attributes.outline=0;resilienceLayer.drawFeature(e);var c=new OpenLayers.Feature.Vector(e.geometry.getCentroid(),{id:parseInt(b),l:e.attributes.l,r:e.attributes.r});resilienceLayer.addFeatures([c])}catch(f){}}}
function removeFeatures(b){var a,d=[],e;for(e in resilienceLayer.features){a=resilienceLayer.features[e];try{a.attributes.l>=b&&d.push(a)}catch(c){}}resilienceLayer.destroyFeatures(d)}
var globalView=function(){closePopups();removeFeatures(1);var b=(new OpenLayers.LonLat(80,-50)).transform(proj4326,map.getProjectionObject()),a=(new OpenLayers.LonLat(180,50)).transform(proj4326,map.getProjectionObject());map.zoomToExtent([b.lon,b.lat,a.lon,a.lat]);showFeature(current_l0);showFeature(current_l1);showFeature(current_l2);showFeature(current_l3);showFeature(current_l4);$("#l0_breadcrumb, #l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb, #show-hide, #divider, #analysisLink, #indicator, #risingTab").hide();
$(".geoName").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a country");$(".geoType").html("");$(".year").html("");markersOff();current_l4=current_l3=current_l2=current_l1=current_l0=null},v_select_region=function(b,a){closePopups();var d=vdata[a];switch(b){case 0:current_l0!=a&&showFeature(current_l0);current_l0=a;var e=hdata[a],c=d.n;$("#l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();$("#l0_breadcrumb").html(" &raquo; "+c).show();$("#geoName").html(c);$(".geoType").html("Country in");
$("#l0").val(a);$("#l1, #l2, #l3, #l4, #l5").val("");$("#l2, #l3, #l4, #l5").hide("");markersOff();removeFeatures(1);hideFeature(a);$.ajax({url:S3.Ap.concat("/static/cache/1_"+a+".geojson"),success:function(a){var a=parser.read(a),b;for(b in a)try{a[b].geometry&&a[b].geometry.transform(proj4326,map.getProjectionObject())}catch(c){}resilienceLayer.addFeatures(a)},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"json"});break;case 1:current_l1!=
a&&showFeature(current_l1);current_l1=a;current_l0!=d.f&&showFeature(current_l0);current_l0=d.f;var e=hdata[current_l0],c=vdata[current_l0].n,f=d.n;$("#l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();$("#l0_breadcrumb").html(" &raquo; "+c).show();$("#l1_breadcrumb").html(" &raquo; "+f).show();$("#geoName").html(f);c=e.l1;$(".geoType").html(c+" in");$("#l0").val(current_l0);$("#l1").val(a);$("#l2, #l3, #l4, #l5").val("");$("#l3, #l4, #l5").hide("");markersOff();removeFeatures(2);
c=resilienceLayer.getFeaturesByAttribute("id",parseInt(a));(c=[])&&$.ajax({url:S3.Ap.concat("/static/cache/1_"+current_l0+".geojson"),async:!1,success:function(b){var b=parser.read(b),c=[],d;for(d in b)try{b[d].attributes.id==a&&(b[d].geometry.transform(proj4326,map.getProjectionObject()),c.push(b[d]))}catch(e){}resilienceLayer.addFeatures(c)},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"json"});hideFeature(a);$.ajax({url:S3.Ap.concat("/static/cache/2_"+
a+".geojson"),success:function(a){var a=parser.read(a),b;for(b in a)try{a[b].geometry&&a[b].geometry.transform(proj4326,map.getProjectionObject())}catch(c){}resilienceLayer.addFeatures(a)},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"json"});break;case 2:current_l2!=a&&showFeature(current_l2);current_l2=a;current_l1!=d.f&&showFeature(current_l1);current_l1=d.f;current_l0!=vdata[current_l1].f&&showFeature(current_l0);current_l0=vdata[current_l1].f;
var e=hdata[current_l0],c=vdata[current_l0].n,f=vdata[current_l1].n,i=d.n;$("#l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();$("#l0_breadcrumb").html(" &raquo; "+c).show();$("#l1_breadcrumb").html(" &raquo; "+f).show();$("#l2_breadcrumb").html(" &raquo; "+i).show();$("#geoName").html(i);c=e.l2;$(".geoType").html(c+" in");$("#l0").val(current_l0);$("#l1").val(current_l1);$("#l2").val(a);$("#l3, #l4, #l5").val("");$("#l4, #l5").hide("");markersOn();removeFeatures(3);c=resilienceLayer.getFeaturesByAttribute("id",
parseInt(a));(c=[])&&$.ajax({url:S3.Ap.concat("/static/cache/2_"+current_l1+".geojson"),async:!1,success:function(b){var b=parser.read(b),c=[],d;for(d in b)try{b[d].id==a&&(b[d].geometry.transform(proj4326,map.getProjectionObject()),c.push(b[d]))}catch(e){}resilienceLayer.addFeatures(c)},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"json"});hideFeature(a);$.ajax({url:S3.Ap.concat("/static/cache/3_"+a+".geojson"),success:function(a){var a=
parser.read(a),b;for(b in a)try{a[b].geometry&&a[b].geometry.transform(proj4326,map.getProjectionObject())}catch(c){}resilienceLayer.addFeatures(a)},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"json"});break;case 3:current_l3!=a&&showFeature(current_l3);current_l3=a;current_l2!=d.f&&showFeature(current_l2);current_l2=d.f;current_l1!=vdata[current_l2].f&&showFeature(current_l1);current_l1=vdata[current_l2].f;current_l0!=vdata[current_l1].f&&
showFeature(current_l0);current_l0=vdata[current_l1].f;var e=hdata[current_l0],c=vdata[current_l0].n,f=vdata[current_l1].n,i=vdata[current_l2].n,h=d.n;$("#l4_breadcrumb, #l5_breadcrumb").hide();$("#l0_breadcrumb").html(" &raquo; "+c).show();$("#l1_breadcrumb").html(" &raquo; "+f).show();$("#l2_breadcrumb").html(" &raquo; "+i).show();$("#l3_breadcrumb").html(" &raquo; "+h).show();$("#geoName").html(h);c=e.l3;$(".geoType").html(c+" in");$("#l0").val(current_l0);$("#l1").val(current_l1);$("#l2").val(current_l2);
$("#l3").val(a);$("#l4, #l5").val("");$("#l4").hide("");markersOn();removeFeatures(4);c=resilienceLayer.getFeaturesByAttribute("id",parseInt(a));(c=[])&&$.ajax({url:S3.Ap.concat("/static/cache/3_"+current_l2+".geojson"),async:!1,success:function(b){var b=parser.read(b),c=[],d;for(d in b)try{b[d].id==a&&(b[d].geometry.transform(proj4326,map.getProjectionObject()),c.push(b[d]))}catch(e){}resilienceLayer.addFeatures(c)},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;
console.log(msg)},dataType:"json"});hideFeature(a);$.ajax({url:S3.Ap.concat("/static/cache/4_"+a+".geojson"),success:function(a){var a=parser.read(a),b;for(b in a)try{a[b].geometry&&a[b].geometry.transform(proj4326,map.getProjectionObject())}catch(c){}resilienceLayer.addFeatures(a)},error:function(a,b,c){msg="UNAUTHORIZED"==c?S3.i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"json"});break;case 4:current_l4=a;current_l3!=d.f&&showFeature(current_l3);current_l3=d.f;current_l2!=vdata[current_l3].f&&
showFeature(current_l2);current_l2=vdata[current_l3].f;current_l1!=vdata[current_l2].f&&showFeature(current_l1);current_l1=vdata[current_l2].f;current_l0!=vdata[current_l1].f&&showFeature(current_l0);current_l0=vdata[current_l1].f;current_l4=a;var c=vdata[current_l0].n,f=vdata[current_l1].n,i=vdata[current_l2].n,h=vdata[current_l3].n,k=d.n;$("#l5_breadcrumb").hide();$("#l0_breadcrumb").html(" &raquo; "+c).show();$("#l1_breadcrumb").html(" &raquo; "+f).show();$("#l2_breadcrumb").html(" &raquo; "+i).show();
$("#l3_breadcrumb").html(" &raquo; "+h).show();$("#l4_breadcrumb").html(" &raquo; "+k).show();$("#geoName").html(k);c=e.l4;$(".geoType").html(c+" in");$("#l0").val(current_l0);$("#l1").val(current_l1);$("#l2").val(current_l2);$("#l3").val(current_l3);$("#l4").val(a);$("#l5").val("");markersOn()}var c=resilienceLayer.getFeaturesByAttribute("id",parseInt(a)),g;for(g in c)try{var l=c[g];if(0!=l.geometry.getArea()){var m=l.geometry.getBounds();map.zoomToExtent(m)}}catch(o){}$(".year").html("2012");l=
d.r;null==l?($("#indicator").css("background-color",colors[0]),$("#mainRating").css("background-color",colors[0])):($("#indicator").html(l),$("#mainRating").html(l),$("#indicator").css("background-color",colors[l]),$("#mainRating").css("background-color",colors[l]));$("#show-hide").html('<span class="arrow">&uarr;</span> SHOW MORE').show();$("#divider").show();$("#analysisLink").show();l=S3.Ap.concat("/static/themes/Vulnerability/img/openTabPng8.png");$("#risingTab").css("background-image","url("+
l+")").show();$("#qualityCommunes").html(d.c+" out of "+d.t+" "+e.l4+"s Reported");switch(d.q){case "p":$("#poor").addClass("currentQuality");break;case "f":$("#fair").addClass("currentQuality");break;case "m":$("#moderate").addClass("currentQuality");break;case "s":$("#strong").addClass("currentQuality")}$("#populationCount .listText").html(d.p);$("#populationCount .popupContent p").html(d.s);if(4==b)for(g in d.b)l=d.b[g],$("#dataBreakdown ul").append("            <li>                <p>"+l.n+":</p>                <div class='statistic'>                    <div class='listText'>"+
l.v+"</div>                    <div class='popup'>                        <div class='popupContent'>                            <p>Source: "+l.s+"</p>                        </div>                        <div class='popupBottom'></div>                    </div>                </div>            </li>            ");current_l1?$("#l1_select").html('<option value="" class="none">Choose '+e.l1+"</option>"):$("#l1_select").html('<option value="" selected="selected" class="none">Choose '+e.l1+"</option>");
current_l2?$("#l2_select").html('<option value="" class="none">Choose '+e.l2+"</option>"):$("#l2_select").html('<option value="" selected="selected" class="none">Choose '+e.l2+"</option>");current_l3?$("#l3_select").html('<option value="" class="none">Choose '+e.l3+"</option>"):$("#l3_select").html('<option value="" selected="selected" class="none">Choose '+e.l3+"</option>");current_l4?$("#l4_select").html('<option value="" class="none">Choose '+e.l4+"</option>"):$("#l4_select").html('<option value="" selected="selected" class="none">Choose '+
e.l4+"</option>");for(g in vdata){switch(vdata[g].r){case 1:res="one";break;case 2:res="two";break;case 3:res="three";break;case 4:res="four";break;case 5:res="five";break;default:res="none"}null!=vdata[g].f&&(vdata[g].f==current_l0?$("#l1_select").append('<option value="'+g+'" class="'+res+'">'+vdata[g].n+"</option>"):vdata[g].f==current_l1?$("#l2_select").append('<option value="'+g+'" class="'+res+'">'+vdata[g].n+"</option>"):vdata[g].f==current_l2?$("#l3_select").append('<option value="'+g+'" class="'+
res+'">'+vdata[g].n+"</option>"):vdata[g].f==current_l3&&$("#l4_select").append('<option value="'+g+'" class="'+res+'">'+vdata[g].n+"</option>"))}$("#l1 label").html(capitalize(e.l1)+":");$("#l2 label").html(capitalize(e.l2)+":");$("#l3 label").html(capitalize(e.l3)+":");$("#l4 label").html(capitalize(e.l4)+":");switch(b){case 0:$("#l0").val(a);$("#l1, #l2, #l3, #l4, #l5").val("");break;case 1:$("#l0").val(current_l0);$("#l1").val(a);$("#l2, #l3, #l4, #l5").val("");break;case 2:$("#l0").val(current_l0);
$("#l1").val(current_l1);$("#l2").val(a);$("#l3, #l4, #l5").val("");break;case 3:$("#l0").val(current_l0);$("#l1").val(current_l1);$("#l2").val(current_l2);$("#l3").val(a);$("#l4, #l5").val("");break;case 4:$("#l0").val(current_l0),$("#l1").val(current_l1),$("#l2").val(current_l2),$("#l3").val(current_l3),$("#l4").val(a),$("#l5").val("")}$("#browseOtherRegions select").val(a).selectmenu({style:"popup",maxHeight:280,width:160,menuWidth:160,icons:[{find:".one"},{find:".two"},{find:".three"},{find:".four"},
{find:".five"}]});$("#chartSwitcher").selectmenu("destroy").selectmenu({style:"popup",maxHeight:280,width:125,menuWidth:125})},drawerSlide=function(){switch(drawerOpen){case !0:$(".hidden").hide("slow");$("#show-hide").html('<span class="arrow">&uarr;</span> SHOW MORE');var b=S3.Ap.concat("/static/themes/Vulnerability/img/openTabPng8.png");$("#risingTab").css("background-image","url("+b+")");$(".olPopup").fadeIn(300);$("#dummy_location_search").autocomplete("option","position",{my:"left bottom",at:"left top"});
drawerOpen=!1;break;case !1:$("#drawerInside").show("slow"),$("#drawerInside").data("fade",setTimeout(function(){$("#resilienceSummary, #drawerQuickActions, #indicatorRatingChart, #browseOtherRegions, #dataBreakdown").fadeIn(500);$(".communeOnly").hide()},500)),$("#show-hide").html('<span class="arrow">&darr;</span> SHOW LESS'),b=S3.Ap.concat("/static/themes/Vulnerability/img/closeTabPng8.png"),$("#risingTab").css("background-image","url("+b+")"),$(".olPopup").fadeOut(300),$("#dummy_location_search").autocomplete("option",
"position",{my:"left top",at:"left bottom"}),drawerOpen=!0}},markersOn=function(){var b=S3.Ap.concat("/static/themes/Vulnerability/img/mapIconOnPng8.png");$("#mapSection").css("background","url("+b+") no-repeat center top transparent");b=S3.Ap.concat("/static/themes/Vulnerability/img/volunteerIconOnPng8.png");$("#volunteerSection").css("background","url("+b+") no-repeat center top transparent");$(".iconSection").css("color","#565656")},markersOff=function(){var b=S3.Ap.concat("/static/themes/Vulnerability/img/mapIconOffPng8.png");
$("#mapSection").css("background","url("+b+") no-repeat center top transparent");b=S3.Ap.concat("/static/themes/Vulnerability/img/volunteerIconOffPng8.png");$("#volunteerSection").css("background","url("+b+") no-repeat center top transparent");$(".iconSection").css("color","#ccc")};function capitalize(b){for(var a=[],d=0;d<b.length;d++)a.push(b[d].toUpperCase());return a.join("")}S3.dataTables=[];S3.dataTables.id=["report"];
resizeReports=function(){reportsHeight=window.innerHeight-111;activeContentHeight=0;$(".activeContent.contentTable .content").children("tr:visible").each(function(){activeContentHeight+=$(this).innerHeight()});507>reportsHeight&&(reportsHeight=507);activeContentHeight>reportsHeight-180&&(activeContentHeight=reportsHeight-180);$("#lightbox").css("height",$("#vulnerability").innerHeight()+"px");$("#reportsContent, #reportFilters").css("height",reportsHeight+"px");$(".activeContent.contentTable").css("height",
activeContentHeight+"px").css("display","block")};
var rep_section="pending",showReports=function(b){$("#table-container").empty();$("#table-container").append("<span class='loading'>Loading Reports...</span>");rep_section=b;$.ajax({type:"GET",url:"report/"}).done(function(a){prepareReport(a)}).fail(function(){alert("error")})},prepareReport=function(b){console.log(b);$("#dateFromReports").datepicker({dateFormat:"yy-mm-dd",changeYear:!0,changeMonth:!0,maxDate:"+0d",minDate:"-20y"});$("#dateToReports").datepicker({dateFormat:"yy-mm-dd",changeYear:!0,
changeMonth:!0,maxDate:"+0d",minDate:"-20y"});$(".rowForApproval").hide();$(".rowForApproval").prev().find(".closeReviewButton").hide();$(".rowForApproval").prev().find(".reviewButton").show();$(".headerRow.activeSection td.arrowCell .arrow").html("&rarr;");$(".headerRow.activeSection").removeClass("activeSection");$("."+rep_section+"Header").addClass("activeSection");$(".headerRow.activeSection .arrow").html("&darr;");$(".activeContent").hide();$(".activeContent").removeClass("activeContent");$(".activeSection").next().addClass("activeContent");
$(".activeSection").parent().next().addClass("activeContent");$(".activeContent").css("display","block");$(".approvalScreen").hide();$("#lightbox, #reportsSection").fadeIn(300);$("#table-container").empty();$("#table-container").append(b.report);fnInitDataTable($("#report"),0,!0);formatTable();resizeReports()},displayReport=function(b){$("#table-container").empty();$("#table-container").append(b);fnInitDataTable($("#report"),0,!0);formatTable();resizeReports()},formatTable=function(){$("#report").addClass("reportsTable");
$("#report").addClass("headerTable");$(".group").each(function(){$(this).addClass("headerRow");$(this).addClass("activeSection")});$("#report th");$("#report tr").each(function(){$(this).hasClass("even")&&$(this).addClass("gray");var b=$(this).find("td:first");0==b.length&&(b=$(this).find("th:first"));b.hasClass("headerRow")||(b.addClass("date"),b=b.next(),b.addClass("communeName"),b=b.next(),b.addClass("type"),b=b.next(),b.addClass("submittedBy"),b=b.next(),b.addClass("status"),b=b.next(),b.addClass("action"))})},
toggleReports=function(b){switch(b){case "myReports":$(".allReports").removeClass("active").html("<a href=\"javascript:toggleReports('allReports')\" title='All Reports'>ALL REPORTS</a>");$(".myReports").addClass("active").html("MY REPORTS");break;case "allReports":$(".myReports").removeClass("active").html("<a href=\"javascript:toggleReports('myReports')\" title='My Reports'>MY REPORTS</a>"),$(".allReports").addClass("active").html("ALL REPORTS")}};
