/*
 2018-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(h,q){var m=0;h.widget("s3.uiChart",{options:{height:"280px",colors:null,transition:50,staggerLabels:!0,valueFormat:",.0f"},_create:function(){this.id=m;m+=1;this.eventNamespace=".uiChart"},_init:function(){this.refresh()},_destroy:function(){h.Widget.prototype.destroy.call(this)},refresh:function(){var d=h(this.element),a=this.options;this._unbindEvents();d.empty().css({height:a.height});a=d3.select(d.get(0)).append("svg").attr("class","nv");switch(d.data("type")){case "piechart":this._pieChart(a);
break;case "barchart":this._barChart(a);break;case "multibarchart":this._multiBarChart(a)}this._bindEvents()},_getData:function(d){var a=h(this.element).data("source");a&&h.ajaxS3({url:a,dataType:"json",type:"GET",ignoreStatus:[404],success:function(a){d(a)},error:function(a,b,e){d([]);console.log("UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText)}})},_barChart:function(d){var a=h(this.element),c=this.options,b=nv.models.discreteBarChart().duration(c.transition).x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(c.staggerLabels).showValues(!0),
e=d3.format(c.valueFormat);b.yAxis.tickFormat(e);b.valueFormat(e);c.colors&&b.color(c.colors);var f=a.data("url"),g=a.data("items"),k=this;nv.addGraph(function(){k._getData(function(a){d.datum(a).call(b);b.update();nv.utils.windowResize(b.update);if(f&&g)b.discretebar.dispatch.on("elementClick",function(a){var b={};b[g]=a.data.filterKey;a=k._updateURL(f,b);window.open(a,"_blank")})})});return b},_multiBarChart:function(d){var a=h(this.element),c=this.options,b=nv.models.multiBarChart().duration(c.transition).x(function(a){return a.label}).y(function(a){return a.value}).reduceXTicks(!1).staggerLabels(c.staggerLabels).stacked(!0).groupSpacing(.1),
e=d3.format(c.valueFormat);b.yAxis.tickFormat(e);"off"==a.data("controls")&&b.showControls(!1);"off"==a.data("legend")&&b.showLegend(!1);c.colors&&b.color(c.colors);var f=a.data("url"),g=a.data("items"),k=this;nv.addGraph(function(){k._getData(function(c){d.datum(c).call(b);b.update();nv.utils.windowResize(b.update);if(f&&g){var e=a.data("series");b.multibar.dispatch.on("elementClick",function(a){var b={};b[g]=a.data.filterKey;e&&(b[e]=a.element.parentElement.__data__.filterKey);a=k._updateURL(f,
b);window.open(a,"_blank")})}})});return b},_updateURL:function(d,a){var c=document.createElement("a");c.href=d;d=[];for(var b in a)d.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));d.length&&(c.search=c.search?c.search+d.join("&"):"?"+d.join("&"));return c.href},_pieChart:function(d){var a=h(this.element),c=this.options,b="off"!=a.data("legend"),e=a.data("labels"),f=a.data("labeltype"),g=.05,k=!0;f||(f=b?"percent":"key");switch(e){case "off":e=!1;break;case "outside":e=!0;b&&(g="percent"==
f||"value"==f?.03:.2);break;default:e=!0,k=!1,b?"percent"!=f&&"value"!=f&&(g=.25):g=.1}var l=nv.models.pieChart().duration(c.transition).x(function(a){return a.label}).y(function(a){return a.value}).showLabels(e).labelType(f).showLegend(b).labelsOutside(k).labelThreshold(g).showTooltipPercent(!0);b=d3.format(c.valueFormat);l.valueFormat(b);c.colors&&l.color(c.colors);var m=a.data("url"),n=a.data("items"),p=this;nv.addGraph(function(){p._getData(function(a){d.datum(a).call(l);l.update();nv.utils.windowResize(l.update);
if(m&&n)l.pie.dispatch.on("elementClick",function(a){var b={};b[n]=a.data.filterKey;a=p._updateURL(m,b);window.open(a,"_blank")})})});return l},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
