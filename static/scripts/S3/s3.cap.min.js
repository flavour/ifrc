(function(a,q){function h(a){a=a.find("[name=_formname]").val();if("undefined"!=typeof a){if("cap_alert"==a.substring(0,9))return"cap_alert";if("cap_info"==a.substring(0,8))return"cap_info"}return""}function p(){return 0<a(".cap_info_template_form").length}function m(a){return"cap_alert"==a?"sender sent status msg_type source scope restriction addresses codes note reference incidents".split(" "):"cap_info"==a?"category event response_type urgency severity certainty audience event_code effective onset expires sender_name headline description instruction contact web parameter".split(" "):
[]}function r(c){function g(d,f){var b=h(c),e=m(b),k,g={};"undefined"==typeof f&&(f=!1);d?"cap_alert"==b?(k=d.$_cap_alert&&d.$_cap_alert[0]||{},g=a.parseJSON(k.template_settings)||{},a(".cap_alert_form").addClass("template_loaded")):"cap_info"==b&&(k=d.$_cap_info&&d.$_cap_info[0]||{},g={}):(k={},g={});a.each(e,function(d,b){try{var e=c.find("[name="+b+"]"),n=g.locked&&g.locked[b];switch(typeof k[b]){case "string":"restriction"==b&&(e.val(k[b]||""),""!=e.val()&&l.show());case "undefined":if(e.is(":text")||
e.is("textarea")||e.is("select"))(f||n)&&e.val(k[b]||""),n?e.prop("disabled",!0).attr("title","This field is locked by the template"):e.prop("disabled",!1).attr("title","");break;case "object":var h=["scope","addresses","codes"];for(d=0;d<h.length;d++)b==h[d]&&e.val(k[b]["@value"]||"");"incidents"==b&&(f||n)&&(e.val(k[b]["@value"]||""),a("select#cap_alert_incidents").multiselect("refresh"))}}catch(m){s3_debug("ERROR",m)}})}function e(d,c,b){if(d){"undefined"==typeof b&&(b="template");var e=new RegExp(".*\\"+
S3.Ap+"\\/"),e=(new String(self.location)).replace(e,"").split("?")[0].split("/")[0];d=[S3.Ap,e,b,d].join("/")+".s3json";a.ajax({url:d,type:"GET",dataType:"json",success:function(a){g(a,c)},error:function(a){alert("There was an unexpected error loading template data")}})}}var l=a("#cap_alert_restriction__row, #cap_alert_restriction__row1"),f=a("#cap_alert_addresses__row, #cap_alert_addresses__row1");"Restricted"==a("#cap_alert_scope").val()?l.show():l.hide();a("#cap_alert_scope").change(function(){switch(a(this).val()){case "Public":l.hide();
a("#cap_alert_restriction").val()&&a("#cap_alert_restriction").val("");f.show();break;case "Restricted":l.show();f.hide();break;case "Private":l.hide(),a("#cap_alert_restriction").val()&&a("#cap_alert_restriction").val(""),f.show()}});a("#cap_info_priority").change(function(){if(a(this).val()){var d=S3.cap_priorities,e=d.length;"Undefined"==a(this).find("option:selected").text()&&(a(this).css("border","2px solid gray"),c.find("[name=urgency]").val(""),c.find("[name=severity]").val(""),c.find("[name=certainty]").val(""));
for(var b=0;b<e;b++)d[b][0]==a(this).find("option:selected").text()&&(c.find("[name=urgency]").val(d[b][1]),c.find("[name=severity]").val(d[b][2]),c.find("[name=certainty]").val(d[b][3]),a(this).css("border","2px solid #"+d[b][4]))}else a(this).css("border","1px solid gray")});c.find("[name=urgency],[name=severity],[name=certainty]").change(function(){for(var d=S3.cap_priorities,e=d.length,b=0;b<e;b++){if(c.find("[name=urgency]").val()==d[b][1]&&c.find("[name=severity]").val()==d[b][2]&&c.find("[name=certainty]").val()==
d[b][3]){a("#cap_info_priority option").each(function(){a(this).text()==d[b][0]?(a(this).prop("selected","selected"),c.find("[name=priority]").css("border","2px solid #"+d[b][4])):(c.find("[name=priority]").val(""),c.find("[name=priority]").css("border","2px solid gray"))});return}c.find("[name=priority]").val("");c.find("[name=priority]").css("border","2px solid gray")}c.find("[name=priority]").val("Undefined").css("border","2px solid gray")});c.find("[name=template_id]").change(function(){e(a(this).val(),
!0)});"cap_alert"!=h(c)||0<a(".cap_template_form").length||e(c.find("[name=template_id]").val());"cap_info"!=h(c)||p()||e(c.find("[name=template_info_id]").val(),!1,"info");window.apply_temp=e}function t(c){function g(){try{return a.parseJSON(c.find("[name=template_settings]").val())||{}}catch(e){return s3_debug("Error occured parsing: ",c.find("[name=template_settings]").val()),{}}}function e(e,f){var d="can_edit-"+e,h=a('<label for="'+d+'">'+(i18n.cap_locked||"Locked")+"</label>"),d=a('<input type="checkbox" name="'+
d+'"/>');d.change(function(){var b=g();b.locked=b.locked||{};b.locked[e]=a(this).is(":checked");c.find("[name=template_settings]").val(q.stringify(b))});var b=g();b.locked&&b.locked[e]&&d.prop("checked","checked");f.append(h);f.append(d)}c.find("[name=is_template]").prop("checked","checked");tablename=h(c);fields=m(tablename);c.find("tr").each(function(){var c=a(this),f=c.attr("id");f&&f.match("__row$")&&(f=f.replace(tablename+"_","").replace("__row",""),c=c.find("td.w2p_fc")||c.find("td").eq(1),
0<=fields.indexOf(f)&&e(f,c))})}var v=function(){a(".cap-clone-update").unbind(".cap").bind("click.cap",function(){u(this.id,a(this).attr("data"))})},u=function(c,g){a.ajax({url:S3.Ap.concat("/cap/alert/")+c+"/clone?msg_type="+g,success:function(a){window.location.href=S3.Ap.concat("/cap/alert/")+a.message},error:function(a,c,f){console.log("UNAUTHORIZED"==f?i18n.gis_requires_login:a.responseText)},type:"POST",dataType:"json"})};window.fields=m;a(document).ready(function(){a("form").each(function(){""!==
h(a(this))&&(r(a(this)),(0<a(".cap_template_form").length||p())&&t(a(this)))});v()})})(jQuery,JSON,void 0);
