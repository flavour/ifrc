(function(b,q){function h(a){a=a.find("[name=_formname]").val();if("undefined"!=typeof a){if("cap_alert"==a.substring(0,9))return"cap_alert";if("cap_info"==a.substring(0,8))return"cap_info"}return""}function p(){return 0<b(".cap_info_template_form").length}function m(a){return"cap_alert"==a?"sender sent status msg_type source scope restriction addresses codes note reference incidents".split(" "):"cap_info"==a?"category event response_type urgency severity certainty audience event_code effective onset expires sender_name headline description instruction contact web parameter".split(" "):
[]}function r(a){function g(d,f){var c=h(a),e=m(c),k,g={};"undefined"==typeof f&&(f=!1);d?"cap_alert"==c?(k=d.$_cap_alert&&d.$_cap_alert[0]||{},g=b.parseJSON(k.template_settings)||{},b(".cap_alert_form").addClass("template_loaded")):"cap_info"==c&&(k=d.$_cap_info&&d.$_cap_info[0]||{},g={}):(k={},g={});b.each(e,function(d,c){try{var e=a.find("[name="+c+"]"),n=g.locked&&g.locked[c];switch(typeof k[c]){case "string":"restriction"==c&&(e.val(k[c]||""),""!=e.val()&&l.show());case "undefined":if(e.is(":text")||
e.is("textarea")||e.is("select"))(f||n)&&e.val(k[c]||""),n?e.prop("disabled",!0).attr("title","This field is locked by the template"):e.prop("disabled",!1).attr("title","");break;case "object":var h=["scope","addresses","codes"];for(d=0;d<h.length;d++)c==h[d]&&e.val(k[c]["@value"]||"");"incidents"==c&&(f||n)&&(e.val(k[c]["@value"]||""),b("select#cap_alert_incidents").multiselect("refresh"))}}catch(m){s3_debug("ERROR",m)}})}function e(a,e,c){if(a){"undefined"==typeof c&&(c="template");var f=new RegExp(".*\\"+
S3.Ap+"\\/"),f=(new String(self.location)).replace(f,"").split("?")[0].split("/")[0];a=[S3.Ap,f,c,a].join("/")+".s3json";b.ajax({url:a,type:"GET",dataType:"json",success:function(a){g(a,e)},error:function(a){alert("There was an unexpected error loading template data")}})}}var l=b("#cap_alert_restriction__row, #cap_alert_restriction__row1"),f=b("#cap_alert_addresses__row, #cap_alert_addresses__row1");"Restricted"==b("#cap_alert_scope").val()?l.show():l.hide();b("#cap_alert_scope").change(function(){switch(b(this).val()){case "Public":l.hide();
b("#cap_alert_restriction").val()&&b("#cap_alert_restriction").val("");f.show();break;case "Restricted":l.show();f.show();break;case "Private":l.hide(),b("#cap_alert_restriction").val()&&b("#cap_alert_restriction").val(""),f.show()}});b("#cap_info_priority").change(function(){if(b(this).val()){var d=S3.cap_priorities,e=d.length;"Undefined"==b(this).find("option:selected").text()&&(b(this).css("border","2px solid gray"),a.find("[name=urgency]").val(""),a.find("[name=severity]").val(""),a.find("[name=certainty]").val(""));
for(var c=0;c<e;c++)d[c][0]==b(this).find("option:selected").text()&&(a.find("[name=urgency]").val(d[c][1]),a.find("[name=severity]").val(d[c][2]),a.find("[name=certainty]").val(d[c][3]),b(this).css("border","2px solid #"+d[c][4]))}else b(this).css("border","1px solid gray")});a.find("[name=urgency],[name=severity],[name=certainty]").change(function(){for(var d=S3.cap_priorities,e=d.length,c=0;c<e;c++){if(a.find("[name=urgency]").val()==d[c][1]&&a.find("[name=severity]").val()==d[c][2]&&a.find("[name=certainty]").val()==
d[c][3]){b("#cap_info_priority option").each(function(){b(this).text()==d[c][0]?(b(this).prop("selected","selected"),a.find("[name=priority]").css("border","2px solid #"+d[c][4])):(a.find("[name=priority]").val(""),a.find("[name=priority]").css("border","2px solid gray"))});return}a.find("[name=priority]").val("");a.find("[name=priority]").css("border","2px solid gray")}a.find("[name=priority]").val("Undefined").css("border","2px solid gray")});a.find("[name=template_id]").change(function(){e(b(this).val(),
!0)});"cap_alert"!=h(a)||0<b(".cap_template_form").length||e(a.find("[name=template_id]").val());"cap_info"!=h(a)||p()||e(a.find("[name=template_info_id]").val(),!1,"info");window.apply_temp=e}function t(a){function g(){try{return b.parseJSON(a.find("[name=template_settings]").val())||{}}catch(e){return s3_debug("Error occured parsing: ",a.find("[name=template_settings]").val()),{}}}function e(e,f){var d="can_edit-"+e,h=b('<label for="'+d+'">'+(i18n.cap_locked||"Locked")+"</label>"),d=b('<input type="checkbox" name="'+
d+'"/>');d.change(function(){var c=g();c.locked=c.locked||{};c.locked[e]=b(this).is(":checked");a.find("[name=template_settings]").val(q.stringify(c))});var c=g();c.locked&&c.locked[e]&&d.prop("checked","checked");f.append(h);f.append(d)}a.find("[name=is_template]").prop("checked","checked");tablename=h(a);fields=m(tablename);a.find("tr").each(function(){var a=b(this),f=a.attr("id");f&&f.match("__row$")&&(f=f.replace(tablename+"_","").replace("__row",""),a=a.find("td.w2p_fc")||a.find("td").eq(1),
0<=fields.indexOf(f)&&e(f,a))})}var v=function(){b(".cap-clone-update").unbind(".cap").bind("click.cap",function(){u(b(this).attr("data"))})},u=function(a){var g=a.split("/")[0];(a=a.split("/").pop())&&b.ajax({url:S3.Ap.concat("/cap/alert/")+a+"/clone?msg_type="+g,success:function(a){window.location.href=S3.Ap.concat("/cap/alert/")+a.message},error:function(a,b,f){console.log("UNAUTHORIZED"==f?i18n.gis_requires_login:a.responseText)},type:"POST",dataType:"json"})};window.fields=m;b(document).ready(function(){b("form").each(function(){""!==
h(b(this))&&(r(b(this)),(0<b(".cap_template_form").length||p())&&t(b(this)))});v()})})(jQuery,JSON,void 0);
