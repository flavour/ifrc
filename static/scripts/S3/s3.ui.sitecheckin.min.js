/*
 2016 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(b,k){var g=0;b.widget("s3.siteCheckIn",{options:{tableName:"site_check_in",ajaxURL:"",noPictureAvailable:"No picture available",statusCheckedIn:"checked-in",statusCheckedOut:"checked-out",statusNone:"-",statusLabel:"Status"},_create:function(){b(this.element);this.id=g;g+=1;this.eventNamespace=".siteCheckIn"},_init:function(){this.idPrefix="#"+this.options.tableName;this.personData=b(this.element).find("input[type=hidden][name=data]");this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},
refresh:function(){this._unbindEvents();var a=this.personData.val();a&&"null"!=a&&this._showPersonData(JSON.parse(a));this._bindEvents()},_checkID:function(){var a=this.idPrefix,c=b(a+"_label"),d=c.val().trim();c.val(d);if(d){this._clearForm(!1,!0);var a=b(a+"_person__row .controls").empty(),e=b('<div class="inline-throbber">').insertAfter(a);b("#submit_record__row").find(".button").prop("disabled",!0);var f=this;b.ajaxS3({url:this.options.ajaxURL,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",
data:JSON.stringify({m:"check",l:d}),success:function(a){e.remove();b("#submit_record__row").find(".button").prop("disabled",!1);a.e?b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+a.e+"</div></div>").hide().insertAfter(c).slideDown():(f._showPersonData(a),(a=a.m)&&S3.showAlert(a[0],a[1]))},error:function(){e.remove();b("#submit_record__row").find(".button").prop("disabled",!1);f._clearForm(!0,!1)}})}},_register:function(a){var c=this.idPrefix,d=b(c+"_label"),
e=d.val().trim();d.val(e);if(e){this._clearAlert();var c=b(c+"_person__row .controls"),f=b('<div class="inline-throbber">').insertAfter(c);b("#submit_record__row").find(".button").prop("disabled",!0);var g=!!b.trim(c.html()).length,h=this;b.ajaxS3({url:this.options.ajaxURL,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify({m:a,l:e}),success:function(a){f.remove();b("#submit_record__row").find(".button").prop("disabled",!1);a.e?b('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+
a.e+"</div></div>").hide().insertAfter(d).slideDown():(a.a&&!g?h._showPersonData(a):h._clearForm(),(a=a.m)&&S3.showAlert(a[0],a[1]))},error:function(){f.remove();b("#submit_record__row").find(".button").prop("disabled",!1);h._clearForm(!0,!1)}})}},_showPersonData:function(a){var c=this.idPrefix,d=b(c+"_person__row .controls"),e=b(c+"_status__row .controls"),c=b(c+"_info__row .controls");d.html(a.d).removeClass("hide").show();this._showProfilePicture(a.p);d=this._statusMsg(a.s);e.append(d).removeClass("hide").show();
a.i?1==a.s&&this._toggleAction("check-in-btn","off"):this._toggleAction("check-in-btn","deny");a.o?2==a.s&&this._toggleAction("check-out-btn","off"):this._toggleAction("check-out-btn","deny");a.a&&c.html(a.a).removeClass("hide").show()},_statusMsg:function(a){var c=this.options,d=b('<div class="check-in-status">');b('<span class="status-label">'+c.statusLabel+": </span>").appendTo(d);var e=b('<span class="status-message">').appendTo(d);switch(a){case 1:e.html(c.statusCheckedIn);break;case 2:e.html(c.statusCheckedOut);
break;default:e.html(c.statusNone)}return d},_clearForm:function(a,c){var d=this.idPrefix;b(".inline-throbber").remove();a||this._clearAlert();c||b(d+"_label").val("").focus();b(d+"_person__row .controls").hide().empty();b(d+"_status__row .controls").hide().empty();b(d+"_info__row .controls").hide().empty();this._hideProfilePicture();this._toggleAction("check-in-btn","on");this._toggleAction("check-out-btn","on")},_clearAlert:function(){b(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast").remove();
b(".error_wrapper").fadeOut("fast").remove()},_showProfilePicture:function(a){var c=b("#profile-picture").empty(),c=b('<div class="panel">').hide().appendTo(c);a=a?b("<img>").attr("src",a):b("<p>").text(this.options.noPictureAvailable);c.append(a).show()},_hideProfilePicture:function(){b("#profile-picture").empty()},_toggleAction:function(a,c){var d=b("input."+a),e=d.val();if(d.length)switch(d.siblings(".disabled-"+a).remove(),c){case "off":d.prop("disabled",!0).show();break;case "deny":e=b('<a class="tiny alert button disabled-'+
a+'" disabled="disabled"><i class="fa fa-ban"></i>'+e+"</a>");d.prop("disabled",!0).hide().after(e);break;default:d.siblings(".disabled-"+a).remove(),d.prop("disabled",!1).show()}},_bindEvents:function(){var a=this,c=b(this.element),d=this.eventNamespace,e=this.idPrefix;c.find(".check-btn").bind("click"+d,function(b){b.preventDefault();a._checkID()});c.find(".check-in-btn").unbind(d).bind("click"+d,function(b){b.preventDefault();a._register("check-in")});c.find(".check-out-btn").unbind(d).bind("click"+
d,function(b){b.preventDefault();a._register("check-out")});c.find("a.cancel-action, .clear-btn").bind("click"+d,function(b){b.preventDefault();a._clearForm()});c=b(e+"_label");c.bind("input"+d,function(b){a._clearForm(!1,!0)});c.bind("keyup"+d,function(b){switch(b.which){case 27:a._clearForm()}});return!0},_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace;b(this.idPrefix+"_label").unbind(c);a.find(".check-btn").unbind(c);a.find(".check-in-btn").unbind(c);a.find(".check-out-btn").unbind(c);
a.find("a.cancel-action, .clear-btn").unbind(c);return!0}})})(jQuery);
