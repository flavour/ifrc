/*
 2015-2016 (c) Sahana Software Foundation
 @license MIT
*/
(function(d,q){var p=0;d.widget("s3.personcontacts",{options:{access:1,controller:"pr",personID:null,cancelButtonText:"Cancel"},_create:function(){this.id=p;p+=1;this.eventNamespace=".personcontacts"},_init:function(){this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();this._bindEvents()},_addContact:function(a){d(a).hide().siblings(".throbber").removeClass("hide").show();d(".iframe-container").remove();this._showAll();var f=this.options,
c=f.access,e=f.personID,h=f.controller,b=S3.Ap.concat("/pr/contact/create.iframe?person="+e);c&&(b+="&access="+c);d.get(b,function(b){var g=d('<div class="iframe-container">').hide().html(b);b=S3.Ap.concat("/pr/contact/create?person="+e+"&controller="+h);c&&(b+="&access="+c);var l=g.find("form").attr("action",b);b=d('<a class="cancel action-lnk">'+f.cancelButtonText+"</a>").bind("click",function(){l.slideUp("mediun",function(){g.remove()});d(a).show()});l.find('input[type="submit"]').after(b);l.show();
g.insertAfter(a).slideDown("medium",function(){d(a).siblings(".throbber").hide()})})},_addEmergencyContact:function(a){d(a).hide().siblings(".throbber").removeClass("hide").show();d(".iframe-container").remove();this._showAll();var f=this.options,c=f.access,e=f.personID,h=f.controller,b=S3.Ap.concat("/pr/contact_emergency/create.iframe?person_id="+e);c&&(b+="&access="+c);d.get(b,function(b){var g=d('<div class="iframe-container">').hide().html(b);b=S3.Ap.concat("/pr/contact_emergency/create?person="+
e+"&controller="+h);c&&(b+="&access="+c);var l=g.find("form").attr("action",b);b=d('<a class="cancel action-lnk">'+f.cancelButtonText+"</a>").bind("click",function(){l.slideUp("mediun",function(){g.remove()});d(a).show()});l.find('input[type="submit"]').after(b);l.show();g.insertAfter(a).slideDown("medium",function(){d(a).siblings(".throbber").hide()})})},_editContact:function(a){var f=d(a),c=this.options,e=this;d(".iframe-container").remove();this._showAll();f.find(".pr-contact-actions").children().toggle();
var h=c.personID,b=c.controller,n=f.data("id"),g=c.access;a=S3.Ap.concat("/pr/contact/"+n+".iframe/update?person="+h);d.get(a,function(a){var k=d('<div class="iframe-container">').hide().html(a);a=S3.Ap.concat("/pr/contact/"+n+"/update?person="+h+"&controller="+b);g&&(a+="&access="+g);var m=k.find("form").attr("action",a);a=d('<a class="cancel action-lnk">'+c.cancelButtonText+"</a>").bind("click",function(){m.slideUp("mediun",function(){k.remove()});e._showAll()});m.find('input[type="submit"]').after(a);
f.after(k).hide();m.show();k.slideDown("medium")})},_editEmergencyContact:function(a){var f=d(a),c=this.options,e=this;d(".iframe-container").remove();this._showAll();f.find(".pr-contact-actions").children().toggle();var h=c.personID,b=c.controller,n=f.data("id"),g=c.access;a=S3.Ap.concat("/pr/contact_emergency/"+n+".iframe/update?person="+h);d.get(a,function(a){var k=d('<div class="iframe-container">').hide().html(a);a=S3.Ap.concat("/pr/contact_emergency/"+n+"/update?person="+h+"&controller="+b);
g&&(a+="&access="+g);var m=k.find("form").attr("action",a);a=d('<a class="cancel action-lnk">'+c.cancelButtonText+"</a>").bind("click",function(){m.slideUp("mediun",function(){k.remove()});e._showAll()});m.find('input[type="submit"]').after(a);f.after(k).hide();m.show();k.slideDown("medium")})},_deleteContact:function(a){if(confirm(i18n.delete_confirmation)){var f=a.data("id");d.post(S3.Ap.concat("/pr/contact/"+f+"/delete.json"));a.hide()}},_deleteEmergencyContact:function(a){if(confirm(i18n.delete_confirmation)){var f=
a.data("id");d.post(S3.Ap.concat("/pr/contact_emergency/"+f+"/delete.json"));a.remove()}},_inlineUpdateContact:function(a,f){var c=d(a),e=c.data("id");f.value||(f.value=c.data("value"));var c=S3.Ap.concat("/pr/contact/"+e+".s3json"),h=!1;d.ajaxS3({type:"POST",url:c,data:JSON.stringify({$_pr_contact:f}),dataType:"JSON",async:!1,success:function(a){"success"==a.status&&(h=!0)}});return h},_inlineUpdateEmergencyContact:function(a,f){var c=d(a).data("id"),c=S3.Ap.concat("/pr/contact_emergency/"+c+".s3json"),
e=!1;d.ajaxS3({type:"POST",url:c,data:JSON.stringify({$_pr_contact_emergency:f}),dataType:"JSON",async:!1,success:function(a){"success"==a.status&&(e=!0)}});return e},_showAll:function(){d(this.element).find(".pr-contact, .pr-emergency-contact").each(function(){var a=d(this);a.find(".pr-contact-actions a").show();a.find(".throbber, .inline-throbber").hide();a.show()})},_bindEvents:function(){var a=this,f=d(this.element),c=this.eventNamespace;f.find(".pr-contacts .contact-add-btn").bind("click"+c,
function(){a._addContact(this);return!1});f.find(".pr-emergency-contacts .contact-add-btn").bind("click"+c,function(){a._addEmergencyContact(this);return!1});f.delegate(".pr-contacts .edit-btn","click"+c,function(){a._editContact(d(this).closest(".pr-contact"));return!1}).delegate(".pr-emergency-contacts .edit-btn","click"+c,function(){a._editEmergencyContact(d(this).closest(".pr-emergency-contact"));return!1}).delegate(".pr-contacts .delete-btn-ajax","click"+c,function(){a._deleteContact(d(this).closest(".pr-contact"));
return!1}).delegate(".pr-emergency-contacts .delete-btn-ajax","click"+c,function(){a._deleteEmergencyContact(d(this).closest(".pr-emergency-contact"));return!1});c={style:"display: inline",indicator:'<div class="throbber">'};f.find(".pr-contact-value").editable(function(e,c){var b=d(this).closest(".pr-contact");return a._inlineUpdateContact(b,{value:e})?(b.data("value",e),e):b.data("value")},c);f.find(".pr-contact-description").editable(function(e,c){var b=d(this).closest(".pr-contact");return a._inlineUpdateContact(b,
{contact_description:e})?(b.data("description",e),e):b.data("description")},c);f.find(".pr-contact-comments").editable(function(e,c){var b=d(this).closest(".pr-contact");return a._inlineUpdateContact(b,{comments:e})?(b.data("comments",e),e):b.data("comments")},c);f.find(".pr-emergency-name").editable(function(e,c){var b=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(b,{name:e})?(b.data("name",e),e):b.data("name")},c);f.find(".pr-emergency-relationship").editable(function(e,
c){var b=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(b,{relationship:e})?(b.data("relationship",e),e):b.data("relationship")},c);f.find(".pr-emergency-phone").editable(function(e,c){var b=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(b,{phone:e})?(b.data("phone",e),e):b.data("phone")},c);f.find(".pr-emergency-address").editable(function(e,c){var b=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(b,
{address:e})?(b.data("address",e),e):b.data("address")},c);f.find(".pr-emergency-comments").editable(function(e,c){var b=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(b,{comments:e})?(b.data("comments",e),e):b.data("comments")},c);f.find(".pr-contact-priority").editable(function(c,f){var b=d(this).closest(".pr-contact");return a._inlineUpdateContact(b,{priority:c})?(b.data("priority",c),c):b.data("priority")},{style:"display: inline-block;",data:function(a,c){for(var b=
"{",d=1;10>d;d++)b+='"'+d+'":"'+d+'",';return b+('"selected":"'+a+'"}')},type:"select",submit:"ok"});return!0},_unbindEvents:function(){var a=d(this.element),f=this.eventNamespace;a.undelegate(f);a.find(".pr-contact-add, .pr-emergency-add, .pr-contact-form").unbind(f);return!0}})})(jQuery);
