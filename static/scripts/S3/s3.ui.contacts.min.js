/*
 2015 (c) Sahana Software Foundation
 @license MIT
*/
(function(d,q){var p=0;d.widget("s3.personcontacts",{options:{access:1,controller:"pr",personID:null,cancelButtonText:"Cancel"},_create:function(){this.id=p;p+=1;this.namespace=".personcontacts"},_init:function(){this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();this._bindEvents()},_addContact:function(b){d(b).hide().siblings(".throbber").removeClass("hide").show();d(".iframe-container").remove();this._showAll();var e=this.options,a=
e.access,f=e.personID,h=e.controller,c=S3.Ap.concat("/pr/contact/create.iframe?person="+f);a&&(c+="&access="+a);d.get(c,function(c){var g=d('<div class="iframe-container">').hide().html(c);c=S3.Ap.concat("/pr/contact/create?person="+f+"&controller="+h);a&&(c+="&access="+a);var l=g.find("form").attr("action",c);c=d('<a class="cancel action-lnk">'+e.cancelButtonText+"</a>").bind("click",function(){l.slideUp("mediun",function(){g.remove()});d(b).show()});l.find('input[type="submit"]').after(c);l.show();
g.insertAfter(b).slideDown("medium",function(){d(b).siblings(".throbber").hide()})})},_addEmergencyContact:function(b){d(b).hide().siblings(".throbber").removeClass("hide").show();d(".iframe-container").remove();this._showAll();var e=this.options,a=e.access,f=e.personID,h=e.controller,c=S3.Ap.concat("/pr/contact_emergency/create.iframe?person_id="+f);a&&(c+="&access="+a);d.get(c,function(c){var g=d('<div class="iframe-container">').hide().html(c);c=S3.Ap.concat("/pr/contact_emergency/create?person="+
f+"&controller="+h);a&&(c+="&access="+a);var l=g.find("form").attr("action",c);c=d('<a class="cancel action-lnk">'+e.cancelButtonText+"</a>").bind("click",function(){l.slideUp("mediun",function(){g.remove()});d(b).show()});l.find('input[type="submit"]').after(c);l.show();g.insertAfter(b).slideDown("medium",function(){d(b).siblings(".throbber").hide()})})},_editContact:function(b){var e=d(b),a=this.options,f=this;d(".iframe-container").remove();this._showAll();e.find(".pr-contact-actions").children().toggle();
var h=a.personID,c=a.controller,n=e.data("id"),g=a.access;b=S3.Ap.concat("/pr/contact/"+n+".iframe/update?person="+h);d.get(b,function(b){var k=d('<div class="iframe-container">').hide().html(b);b=S3.Ap.concat("/pr/contact/"+n+"/update?person="+h+"&controller="+c);g&&(b+="&access="+g);var m=k.find("form").attr("action",b);b=d('<a class="cancel action-lnk">'+a.cancelButtonText+"</a>").bind("click",function(){m.slideUp("mediun",function(){k.remove()});f._showAll()});m.find('input[type="submit"]').after(b);
e.after(k).hide();m.show();k.slideDown("medium")})},_editEmergencyContact:function(b){var e=d(b),a=this.options,f=this;d(".iframe-container").remove();this._showAll();e.find(".pr-contact-actions").children().toggle();var h=a.personID,c=a.controller,n=e.data("id"),g=a.access;b=S3.Ap.concat("/pr/contact_emergency/"+n+".iframe/update?person="+h);d.get(b,function(b){var k=d('<div class="iframe-container">').hide().html(b);b=S3.Ap.concat("/pr/contact_emergency/"+n+"/update?person="+h+"&controller="+c);
g&&(b+="&access="+g);var m=k.find("form").attr("action",b);b=d('<a class="cancel action-lnk">'+a.cancelButtonText+"</a>").bind("click",function(){m.slideUp("mediun",function(){k.remove()});f._showAll()});m.find('input[type="submit"]').after(b);e.after(k).hide();m.show();k.slideDown("medium")})},_deleteContact:function(b){if(confirm(i18n.delete_confirmation)){var e=b.data("id");d.post(S3.Ap.concat("/pr/contact/"+e+"/delete.json"));b.hide()}},_deleteEmergencyContact:function(b){if(confirm(i18n.delete_confirmation)){var e=
b.data("id");d.post(S3.Ap.concat("/pr/contact_emergency/"+e+"/delete.json"));b.remove()}},_inlineUpdateContact:function(b,e){var a=d(b),f=a.data("id");e.value||(e.value=a.data("value"));var a=S3.Ap.concat("/pr/contact/"+f+".s3json"),h=!1;d.ajaxS3({type:"POST",url:a,data:JSON.stringify({$_pr_contact:e}),dataType:"JSON",async:!1,success:function(b){"success"==b.status&&(h=!0)}});return h},_inlineUpdateEmergencyContact:function(b,e){var a=d(b).data("id"),a=S3.Ap.concat("/pr/contact_emergency/"+a+".s3json"),
f=!1;d.ajaxS3({type:"POST",url:a,data:JSON.stringify({$_pr_contact_emergency:e}),dataType:"JSON",async:!1,success:function(b){"success"==b.status&&(f=!0)}});return f},_showAll:function(){d(this.element).find(".pr-contact, .pr-emergency-contact").each(function(){var b=d(this);b.find(".pr-contact-actions a").show();b.find(".throbber, .inline-throbber").hide();b.show()})},_bindEvents:function(){var b=this,e=d(this.element),a=this.namespace;e.find(".pr-contacts .contact-add-btn").bind("click"+a,function(){b._addContact(this);
return!1});e.find(".pr-emergency-contacts .contact-add-btn").bind("click"+a,function(){b._addEmergencyContact(this);return!1});e.delegate(".pr-contacts .edit-btn","click"+a,function(){b._editContact(d(this).closest(".pr-contact"));return!1}).delegate(".pr-emergency-contacts .edit-btn","click"+a,function(){b._editEmergencyContact(d(this).closest(".pr-emergency-contact"));return!1}).delegate(".pr-contacts .delete-btn-ajax","click"+a,function(){b._deleteContact(d(this).closest(".pr-contact"));return!1}).delegate(".pr-emergency-contacts .delete-btn-ajax",
"click"+a,function(){b._deleteEmergencyContact(d(this).closest(".pr-emergency-contact"));return!1});a={style:"display: inline"};e.find(".pr-contact-value").editable(function(f,a){var c=d(this).closest(".pr-contact");return b._inlineUpdateContact(c,{value:f})?(c.data("value",f),f):c.data("value")},a);e.find(".pr-contact-description").editable(function(f,a){var c=d(this).closest(".pr-contact");return b._inlineUpdateContact(c,{contact_description:f})?(c.data("description",f),f):c.data("description")},
a);e.find(".pr-contact-comments").editable(function(a,e){var c=d(this).closest(".pr-contact");return b._inlineUpdateContact(c,{comments:a})?(c.data("comments",a),a):c.data("comments")},a);e.find(".pr-emergency-name").editable(function(a,e){var c=d(this).closest(".pr-emergency-contact");return b._inlineUpdateEmergencyContact(c,{name:a})?(c.data("name",a),a):c.data("name")},a);e.find(".pr-emergency-relationship").editable(function(a,e){var c=d(this).closest(".pr-emergency-contact");return b._inlineUpdateEmergencyContact(c,
{relationship:a})?(c.data("relationship",a),a):c.data("relationship")},a);e.find(".pr-emergency-phone").editable(function(a,e){var c=d(this).closest(".pr-emergency-contact");return b._inlineUpdateEmergencyContact(c,{phone:a})?(c.data("phone",a),a):c.data("phone")},a);e.find(".pr-emergency-address").editable(function(a,e){var c=d(this).closest(".pr-emergency-contact");return b._inlineUpdateEmergencyContact(c,{address:a})?(c.data("address",a),a):c.data("address")},a);e.find(".pr-emergency-comments").editable(function(a,
e){var c=d(this).closest(".pr-emergency-contact");return b._inlineUpdateEmergencyContact(c,{comments:a})?(c.data("comments",a),a):c.data("comments")},a);return!0},_unbindEvents:function(){var b=d(this.element),e=this.namespace;b.undelegate(e);b.find(".pr-contact-add, .pr-emergency-add, .pr-contact-form").unbind(e);return!0}})})(jQuery);
